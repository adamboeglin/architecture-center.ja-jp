---
title: データのパーティション分割のガイダンス
titleSuffix: Best practices for cloud applications
description: パーティションを個別に管理およびアクセスする方法についてのガイダンス
author: dragon119
ms.date: 11/04/2018
ms.topic: best-practice
ms.service: architecture-center
ms.subservice: cloud-fundamentals
ms.custom: seodec18
ms.openlocfilehash: 561fe6e47a4cd64aa545349dde4c76260d76e78e
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/20/2019
ms.locfileid: "58248957"
---
# <a name="horizontal-vertical-and-functional-data-partitioning"></a><span data-ttu-id="f9042-103">データの水平的、垂直的、および機能的パーティション分割</span><span class="sxs-lookup"><span data-stu-id="f9042-103">Horizontal, vertical, and functional data partitioning</span></span>

<span data-ttu-id="f9042-104">多くの大規模なソリューションでは、個別に管理およびアクセスできる複数の "*パーティション*" にデータが分割されています。</span><span class="sxs-lookup"><span data-stu-id="f9042-104">In many large-scale solutions, data is divided into *partitions* that can be managed and accessed separately.</span></span> <span data-ttu-id="f9042-105">パーティション分割により、スケーラビリティの向上、競合の低減、パフォーマンスの最適化を実現できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-105">Partitioning can improve scalability, reduce contention, and optimize performance.</span></span> <span data-ttu-id="f9042-106">また、使用パターンに基づいてデータを分割するメカニズムも提供できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-106">It can also provide a mechanism for dividing data by usage pattern.</span></span> <span data-ttu-id="f9042-107">たとえば、古いデータを廉価なデータ ストレージにアーカイブできます。</span><span class="sxs-lookup"><span data-stu-id="f9042-107">For example, you can archive older data in cheaper data storage.</span></span>

<span data-ttu-id="f9042-108">ただし、悪影響を最小限に抑え、メリットを最大限に活かすには、パーティション分割戦略を慎重に選択する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-108">However, the partitioning strategy must be chosen carefully to maximize the benefits while minimizing adverse effects.</span></span>

> [!NOTE]
> <span data-ttu-id="f9042-109">この記事で使用されている *パーティション分割* という用語は、データを異なるデータ ストアに物理的に分割するプロセスを指します。</span><span class="sxs-lookup"><span data-stu-id="f9042-109">In this article, the term *partitioning* means the process of physically dividing data into separate data stores.</span></span> <span data-ttu-id="f9042-110">これは SQL Server テーブルのパーティション分割とは異なります。</span><span class="sxs-lookup"><span data-stu-id="f9042-110">It is not the same as SQL Server table partitioning.</span></span>

<!-- markdownlint-disable MD026 -->

## <a name="why-partition-data"></a><span data-ttu-id="f9042-111">データをパーティション分割する理由</span><span class="sxs-lookup"><span data-stu-id="f9042-111">Why partition data?</span></span>

<!-- markdownlint-enable MD026 -->

- <span data-ttu-id="f9042-112">**拡張性の向上**。</span><span class="sxs-lookup"><span data-stu-id="f9042-112">**Improve scalability**.</span></span> <span data-ttu-id="f9042-113">単一のデータベース システムをスケールアップすると、最終的には物理的なハードウェア限界に到達します。</span><span class="sxs-lookup"><span data-stu-id="f9042-113">When you scale up a single database system, it will eventually reach a physical hardware limit.</span></span> <span data-ttu-id="f9042-114">データを複数のパーティションに分割し、各パーティションを個別のサーバー上でホストすると、システムをほぼ無制限にスケールアウトできます。</span><span class="sxs-lookup"><span data-stu-id="f9042-114">If you divide data across multiple partitions, each hosted on a separate server, you can scale out the system almost indefinitely.</span></span>

- <span data-ttu-id="f9042-115">**パフォーマンスの向上**。</span><span class="sxs-lookup"><span data-stu-id="f9042-115">**Improve performance**.</span></span> <span data-ttu-id="f9042-116">各パーティションでのデータ アクセス操作は、より少量のデータに対して実行されます。</span><span class="sxs-lookup"><span data-stu-id="f9042-116">Data access operations on each partition take place over a smaller volume of data.</span></span> <span data-ttu-id="f9042-117">パーティション分割を適切に行うことで、システムの効率を高めることができます。</span><span class="sxs-lookup"><span data-stu-id="f9042-117">Correctly done, partitioning can make your system more efficient.</span></span> <span data-ttu-id="f9042-118">複数のパーティションに影響する操作は、並列に実行できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-118">Operations that affect more than one partition can run in parallel.</span></span>

- <span data-ttu-id="f9042-119">**セキュリティの向上**。</span><span class="sxs-lookup"><span data-stu-id="f9042-119">**Improve security**.</span></span> <span data-ttu-id="f9042-120">場合によっては、機密データとそれ以外のデータを異なるパーティションに分け、機密データにさまざまなセキュリティ制御を適用できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-120">In some cases, you can separate sensitive and non-sensitive data into different partitions and apply different security controls to the sensitive data.</span></span>

- <span data-ttu-id="f9042-121">**運用上の柔軟性の向上**。</span><span class="sxs-lookup"><span data-stu-id="f9042-121">**Provide operational flexibility**.</span></span> <span data-ttu-id="f9042-122">パーティション分割は、運用の微調整、管理効率の最大化、およびコストの最小化を達成するための多くの機会を提供します。</span><span class="sxs-lookup"><span data-stu-id="f9042-122">Partitioning offers many opportunities for fine tuning operations, maximizing administrative efficiency, and minimizing cost.</span></span> <span data-ttu-id="f9042-123">たとえば、各パーティションのデータの重要性に基づいて、管理、監視、バックアップと復元、および他の管理タスクについて、異なる戦略を定義することができます。</span><span class="sxs-lookup"><span data-stu-id="f9042-123">For example, you can define different strategies for management, monitoring, backup and restore, and other administrative tasks based on the importance of the data in each partition.</span></span>

- <span data-ttu-id="f9042-124">**データ ストアと使用パターンの一致**。</span><span class="sxs-lookup"><span data-stu-id="f9042-124">**Match the data store to the pattern of use**.</span></span> <span data-ttu-id="f9042-125">パーティション分割では、コストとデータ ストアが提供する組み込み機能に基づいて、各パーティションを異なるタイプのデータ ストアにデプロイできます。</span><span class="sxs-lookup"><span data-stu-id="f9042-125">Partitioning allows each partition to be deployed on a different type of data store, based on cost and the built-in features that data store offers.</span></span> <span data-ttu-id="f9042-126">たとえば、大量のバイナリ データを Blob Storage に格納し、構造化されたデータをドキュメント データベースに保持することができます。</span><span class="sxs-lookup"><span data-stu-id="f9042-126">For example, large binary data can be stored in blob storage, while more structured data can be held in a document database.</span></span> <span data-ttu-id="f9042-127">「[適切なデータ ストアの選択](../guide/technology-choices/data-store-overview.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="f9042-127">See [Choose the right data store](../guide/technology-choices/data-store-overview.md).</span></span>

- <span data-ttu-id="f9042-128">**可用性の向上**。</span><span class="sxs-lookup"><span data-stu-id="f9042-128">**Improve availability**.</span></span> <span data-ttu-id="f9042-129">データを複数のサーバーにまたがって分割することで、単一障害点を避けることができます。</span><span class="sxs-lookup"><span data-stu-id="f9042-129">Separating data across multiple servers avoids a single point of failure.</span></span> <span data-ttu-id="f9042-130">1 つのインスタンスで障害が発生した場合、使用できなくなるのは、そのパーティションのデータだけです。</span><span class="sxs-lookup"><span data-stu-id="f9042-130">If one instance fails, only the data in that partition is unavailable.</span></span> <span data-ttu-id="f9042-131">その他のパーティションでの操作は、続行できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-131">Operations on other partitions can continue.</span></span> <span data-ttu-id="f9042-132">マネージド PaaS データ ストアの場合、この考慮事項はあまり関係がありません。これらのサービスでは、設計に冗長性が組み込まれているためです。</span><span class="sxs-lookup"><span data-stu-id="f9042-132">For managed PaaS data stores, this consideration is less relevant, because these services are designed with built-in redundancy.</span></span>

## <a name="designing-partitions"></a><span data-ttu-id="f9042-133">パーティションの設計</span><span class="sxs-lookup"><span data-stu-id="f9042-133">Designing partitions</span></span>

<span data-ttu-id="f9042-134">データをパーティション分割する際の一般的な 3 つの戦略を次に示します。</span><span class="sxs-lookup"><span data-stu-id="f9042-134">There are three typical strategies for partitioning data:</span></span>

- <span data-ttu-id="f9042-135">**水平的パーティション分割** (しばしば "*シャーディング*" と呼ばれます)。</span><span class="sxs-lookup"><span data-stu-id="f9042-135">**Horizontal partitioning** (often called *sharding*).</span></span> <span data-ttu-id="f9042-136">この戦略では、各パーティションは個別のデータ ストアですが、すべてのパーティションが同じスキーマを持ちます。</span><span class="sxs-lookup"><span data-stu-id="f9042-136">In this strategy, each partition is a separate data store, but all partitions have the same schema.</span></span> <span data-ttu-id="f9042-137">各パーティションは "*シャード*" と呼ばれ、データの特定のサブセット (特定の顧客セットのすべての注文など) を保持します。</span><span class="sxs-lookup"><span data-stu-id="f9042-137">Each partition is known as a *shard* and holds a specific subset of the data, such as all the orders for a specific set of customers.</span></span>

- <span data-ttu-id="f9042-138">**垂直的パーティション分割**。</span><span class="sxs-lookup"><span data-stu-id="f9042-138">**Vertical partitioning**.</span></span> <span data-ttu-id="f9042-139">この戦略では、各パーティションはデータ ストアに含まれる項目のフィールドのサブセットを含みます。</span><span class="sxs-lookup"><span data-stu-id="f9042-139">In this strategy, each partition holds a subset of the fields for items in the data store.</span></span> <span data-ttu-id="f9042-140">フィールドは、それらの使用パターンに従って分割されます。</span><span class="sxs-lookup"><span data-stu-id="f9042-140">The fields are divided according to their pattern of use.</span></span> <span data-ttu-id="f9042-141">たとえば、頻繁にアクセスされるフィールドを 1 つの垂直的パーティションに、使用頻度の少ないフィールドをまとめて別の垂直的パーティションに配置します。</span><span class="sxs-lookup"><span data-stu-id="f9042-141">For example, frequently accessed fields might be placed in one vertical partition and less frequently accessed fields in another.</span></span>

- <span data-ttu-id="f9042-142">**機能的パーティション分割**。</span><span class="sxs-lookup"><span data-stu-id="f9042-142">**Functional partitioning**.</span></span> <span data-ttu-id="f9042-143">この戦略では、システム内の区分可能な各コンテキストによって使用される方法に従って、データは集約されます。</span><span class="sxs-lookup"><span data-stu-id="f9042-143">In this strategy, data is aggregated according to how it is used by each bounded context in the system.</span></span> <span data-ttu-id="f9042-144">たとえば、e コマース システムでは、請求書データと製品在庫データを、それぞれ異なるパーティションに格納できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-144">For example, an e-commerce system might store invoice data in one partition and product inventory data in another.</span></span>

<span data-ttu-id="f9042-145">これらの戦略は組み合わせることができます。パーティション分割構成を設計するときには、これらをすべて検討することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="f9042-145">These strategies can be combined, and we recommend that you consider them all when you design a partitioning scheme.</span></span> <span data-ttu-id="f9042-146">たとえば、データをシャードに分割し、次に垂直的パーティション分割を使用して、各シャード内のデータをさら分割することができます。</span><span class="sxs-lookup"><span data-stu-id="f9042-146">For example, you might divide data into shards and then use vertical partitioning to further subdivide the data in each shard.</span></span>

### <a name="horizontal-partitioning-sharding"></a><span data-ttu-id="f9042-147">水平的パーティション分割 (シャーディング)</span><span class="sxs-lookup"><span data-stu-id="f9042-147">Horizontal partitioning (sharding)</span></span>

<span data-ttu-id="f9042-148">図 1 は、水平的パーティション分割 (シャーディング) を示しています。</span><span class="sxs-lookup"><span data-stu-id="f9042-148">Figure 1 shows horizontal partitioning or sharding.</span></span> <span data-ttu-id="f9042-149">この例では、製品在庫データが製品キーに基づいてシャードに分割されます。</span><span class="sxs-lookup"><span data-stu-id="f9042-149">In this example, product inventory data is divided into shards based on the product key.</span></span> <span data-ttu-id="f9042-150">各シャードは、シャード キーの連続する範囲 (A ～ G および H ～ Z) のデータを保持し、アルファベット順に編成されます。</span><span class="sxs-lookup"><span data-stu-id="f9042-150">Each shard holds the data for a contiguous range of shard keys (A-G and H-Z), organized alphabetically.</span></span> <span data-ttu-id="f9042-151">シャーディングによって、より多くのコンピューターに負荷を分散することで、競合が減り、パフォーマンスが向上します。</span><span class="sxs-lookup"><span data-stu-id="f9042-151">Sharding spreads the load over more computers, which reduces contention and improves performance.</span></span>

![パーティション キーに基づく水平的パーティション分割 (シャーディング) データ](./images/data-partitioning/DataPartitioning01.png)

<span data-ttu-id="f9042-153">*図 1: パーティション キーに基づく水平的パーティション分割 (シャーディング) データ。*</span><span class="sxs-lookup"><span data-stu-id="f9042-153">*Figure 1. Horizontally partitioning (sharding) data based on a partition key.*</span></span>

<span data-ttu-id="f9042-154">最も重要な要素は、シャーディング キーの選択です。</span><span class="sxs-lookup"><span data-stu-id="f9042-154">The most important factor is the choice of a sharding key.</span></span> <span data-ttu-id="f9042-155">システムが運用状態に移行した後にキーを変更することは、非常に困難になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-155">It can be difficult to change the key after the system is in operation.</span></span> <span data-ttu-id="f9042-156">キーは、ワークロードをシャード間でできるだけ均等に分散するようにデータがパーティション分割されるものである必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-156">The key must ensure that data is partitioned to spread the workload as evenly as possible across the shards.</span></span>

<span data-ttu-id="f9042-157">シャードは同じサイズである必要はありません。</span><span class="sxs-lookup"><span data-stu-id="f9042-157">The shards don't have to be the same size.</span></span> <span data-ttu-id="f9042-158">要求の数のバランスを取ることの方が重要です。</span><span class="sxs-lookup"><span data-stu-id="f9042-158">It's more important to balance the number of requests.</span></span> <span data-ttu-id="f9042-159">シャードのサイズが非常に大きくても、各項目へのアクセス操作が少ないものや、</span><span class="sxs-lookup"><span data-stu-id="f9042-159">Some shards might be very large, but each item has a low number of access operations.</span></span> <span data-ttu-id="f9042-160">項目数は少なくても各項目へのアクセスは非常に頻繁に発生するものがあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-160">Other shards might be smaller, but each item is accessed much more frequently.</span></span> <span data-ttu-id="f9042-161">また、1 つのシャードが (容量と処理リソースの観点で) データ ストアのスケールの上限を超えないようにすることも重要です。</span><span class="sxs-lookup"><span data-stu-id="f9042-161">It's also important to ensure that a single shard does not exceed the scale limits (in terms of capacity and processing resources) of the data store.</span></span>

<span data-ttu-id="f9042-162">パフォーマンスと可用性に影響する可能性のある "ホット" パーティションが発生しないようにします。</span><span class="sxs-lookup"><span data-stu-id="f9042-162">Avoid creating "hot" partitions that can affect performance and availability.</span></span> <span data-ttu-id="f9042-163">たとえば、顧客の名前の最初の文字を使用すると、分散が不均等になります。他の文字よりもよく使用される文字があるためです。代わりに、顧客識別子のハッシュを使用して、パーティション間でデータをより均等に分散させます。</span><span class="sxs-lookup"><span data-stu-id="f9042-163">For example, using the first letter of a customer’s name causes an unbalanced distribution, because some letters are more common Instead, use a hash of a customer identifier to distribute data more evenly across partitions.</span></span>

<span data-ttu-id="f9042-164">大きなシャードの分割、小さなシャードの結合による大きなパーティションの構築、スキーマの変更などの将来の要件を最小限にするシャーディング キーを選択します。</span><span class="sxs-lookup"><span data-stu-id="f9042-164">Choose a sharding key that minimizes any future requirements to split large shards, coalesce small shards into larger partitions, or change the schema.</span></span> <span data-ttu-id="f9042-165">これらの操作は非常に時間がかかる可能性があり、実行時に 1 つ以上のシャードをオフラインにすることが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-165">These operations can be very time consuming, and might require taking one or more shards offline while they are performed.</span></span>

<span data-ttu-id="f9042-166">シャードをレプリケートすると、他のシャードの分割、マージ、または再構成を行うときに、一部のレプリカをオンラインにしておくことができる場合があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-166">If shards are replicated, it might be possible to keep some of the replicas online while others are split, merged, or reconfigured.</span></span> <span data-ttu-id="f9042-167">ただし、システムでは、再構成中に実行できる操作を制限する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-167">However, the system might need to limit the operations that can be performed during the reconfiguration.</span></span> <span data-ttu-id="f9042-168">たとえば、レプリカのデータを読み取り専用としてマークしてデータの不整合を防ぎます。</span><span class="sxs-lookup"><span data-stu-id="f9042-168">For example, the data in the replicas might be marked as read-only to prevent data inconsistences.</span></span>

<span data-ttu-id="f9042-169">水平的パーティション分割の詳細については、「シャーディング パターン」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="f9042-169">For more information about horizontal partitioning, see [Sharding pattern].</span></span>

### <a name="vertical-partitioning"></a><span data-ttu-id="f9042-170">垂直的パーティション分割</span><span class="sxs-lookup"><span data-stu-id="f9042-170">Vertical partitioning</span></span>

<span data-ttu-id="f9042-171">垂直的パーティション分割を使用する最も一般的な目的は、頻繁にアクセスされる項目の取り込みに関連する I/O とパフォーマンスのコストを削減することです。</span><span class="sxs-lookup"><span data-stu-id="f9042-171">The most common use for vertical partitioning is to reduce the I/O and performance costs associated with fetching items that are frequently accessed.</span></span> <span data-ttu-id="f9042-172">図 2 は、垂直的パーティション分割の例です。</span><span class="sxs-lookup"><span data-stu-id="f9042-172">Figure 2 shows an example of vertical partitioning.</span></span> <span data-ttu-id="f9042-173">この例では、項目のさまざまなプロパティが異なるパーティションに格納されています。</span><span class="sxs-lookup"><span data-stu-id="f9042-173">In this example, different properties of an item are stored in different partitions.</span></span> <span data-ttu-id="f9042-174">一方のパーティションには、製品の名前、説明、価格など、アクセス頻度の高いデータが保持されています。</span><span class="sxs-lookup"><span data-stu-id="f9042-174">One partition holds data that is accessed more frequently, including product name, description, and price.</span></span> <span data-ttu-id="f9042-175">もう 1 つのパーティションには、在庫データ (在庫数と最終注文日) が保持されています。</span><span class="sxs-lookup"><span data-stu-id="f9042-175">Another partition holds inventory data: the stock count and last-ordered date.</span></span>

![使用パターンによるデータの垂直的パーティション分割](./images/data-partitioning/DataPartitioning02.png)

<span data-ttu-id="f9042-177">*図 2: 使用パターンによるデータの垂直的パーティション分割。*</span><span class="sxs-lookup"><span data-stu-id="f9042-177">*Figure 2. Vertically partitioning data by its pattern of use.*</span></span>

<span data-ttu-id="f9042-178">この例では、アプリケーションは、製品の詳細を顧客に表示する際は常に、製品の名前、説明、および価格をクエリします。</span><span class="sxs-lookup"><span data-stu-id="f9042-178">In this example, the application regularly queries the product name, description, and price when displaying the product details to customers.</span></span> <span data-ttu-id="f9042-179">通常、在庫数と最終注文日の 2 つの項目は一緒に使用されるので、別のパーティションに保持されています。</span><span class="sxs-lookup"><span data-stu-id="f9042-179">Stock count and last- ordered date are held in a separate partition because these two items are commonly used together.</span></span>

<span data-ttu-id="f9042-180">垂直的パーティション分割のその他の利点は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="f9042-180">Other advantages of vertical partitioning:</span></span>

- <span data-ttu-id="f9042-181">変動が比較的少ないデータ (製品の名前、説明、価格) を、より動的なデータ (在庫レベルと最終注文日) から分離できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-181">Relatively slow-moving data (product name, description, and price) can be separated from the more dynamic data (stock level and last ordered date).</span></span> <span data-ttu-id="f9042-182">変動の少ないデータは、アプリケーションがメモリにキャッシュするのに適しています。</span><span class="sxs-lookup"><span data-stu-id="f9042-182">Slow moving data is a good candidate for an application to cache in memory.</span></span>

- <span data-ttu-id="f9042-183">機密データは、セキュリティ制御が強化された別のパーティションに格納できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-183">Sensitive data can be stored in a separate partition with additional security controls.</span></span>

- <span data-ttu-id="f9042-184">垂直的パーティション分割では、必要な同時アクセスの数を減らすことができます。</span><span class="sxs-lookup"><span data-stu-id="f9042-184">Vertical partitioning can reduce the amount of concurrent access that's needed.</span></span>

<span data-ttu-id="f9042-185">垂直的パーティション分割は、データ ストア内のエンティティ レベルで動作します。エンティティを部分的に正規化して、"*多数の*" 項目で構成されるエンティティを "*少数の*" 項目で構成される複数のエンティティに分割します。</span><span class="sxs-lookup"><span data-stu-id="f9042-185">Vertical partitioning operates at the entity level within a data store, partially normalizing an entity to break it down from a *wide* item to a set of *narrow* items.</span></span> <span data-ttu-id="f9042-186">垂直的パーティション分割は、HBase や Cassandra など、列指向のデータ ストアに理想的に適しています。</span><span class="sxs-lookup"><span data-stu-id="f9042-186">It is ideally suited for column-oriented data stores such as HBase and Cassandra.</span></span> <span data-ttu-id="f9042-187">変化する可能性が低い列コレクションのデータの場合は、SQL Server の列ストアを使用することも検討してください。</span><span class="sxs-lookup"><span data-stu-id="f9042-187">If the data in a collection of columns is unlikely to change, you can also consider using column stores in SQL Server.</span></span>

### <a name="functional-partitioning"></a><span data-ttu-id="f9042-188">機能的パーティション分割</span><span class="sxs-lookup"><span data-stu-id="f9042-188">Functional partitioning</span></span>

<span data-ttu-id="f9042-189">アプリケーションで各ビジネス 領域の区分のあるコンテキストを識別できる場合は、機能的パーティション分割によって、分離性とデータ アクセスのパフォーマンスを向上させることができます。</span><span class="sxs-lookup"><span data-stu-id="f9042-189">When it's possible to identify a bounded context for each distinct business area in an application, functional partitioning is a way to improve isolation and data access performance.</span></span> <span data-ttu-id="f9042-190">機能的パーティション分割のもう 1 つの一般的な用途は、読み書き可能なデータを読み取り専用データから分離することです。</span><span class="sxs-lookup"><span data-stu-id="f9042-190">Another common use for functional partitioning is to separate read-write data from read-only data.</span></span> <span data-ttu-id="f9042-191">図 3 は、機能的パーティション分割の概要を示しており、在庫データが顧客データから分離されています。</span><span class="sxs-lookup"><span data-stu-id="f9042-191">Figure 3 shows an overview of functional partitioning where inventory data is separated from customer data.</span></span>

![区分のあるコンテキストまたはサブドメインによりデータが分割された機能的パーティション分割](./images/data-partitioning/DataPartitioning03.png)

<span data-ttu-id="f9042-193">*図 3: 区分のあるコンテキストまたはサブドメインによりデータが分割された機能的パーティション分割。*</span><span class="sxs-lookup"><span data-stu-id="f9042-193">*Figure 3. Functionally partitioning data by bounded context or subdomain.*</span></span>

<span data-ttu-id="f9042-194">このパーティション分割戦略は、システムのさまざまな部分にまたがるデータ アクセスの競合を少なくするのに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="f9042-194">This partitioning strategy can help reduce data access contention across different parts of a system.</span></span>

## <a name="designing-partitions-for-scalability"></a><span data-ttu-id="f9042-195">拡張性の観点でのパーティション分割の設計</span><span class="sxs-lookup"><span data-stu-id="f9042-195">Designing partitions for scalability</span></span>

<span data-ttu-id="f9042-196">各パーティションのサイズとワークロードを考慮して、それらを均等に分散することにより、最大の拡張性を達成することが重要です。</span><span class="sxs-lookup"><span data-stu-id="f9042-196">It's vital to consider size and workload for each partition and balance them so that data is distributed to achieve maximum scalability.</span></span> <span data-ttu-id="f9042-197">ただし、データのパーティションが単一のパーティション ストアの拡張制限を超えないようにすることも必要です。</span><span class="sxs-lookup"><span data-stu-id="f9042-197">However, you must also partition the data so that it does not exceed the scaling limits of a single partition store.</span></span>

<span data-ttu-id="f9042-198">拡張性の観点でパーティション分割を設計する際には、次の手順に従います。</span><span class="sxs-lookup"><span data-stu-id="f9042-198">Follow these steps when designing partitions for scalability:</span></span>

1. <span data-ttu-id="f9042-199">アプリケーションを分析して、各クエリで返される結果セットのサイズ、アクセス頻度、固有の遅延時間、サーバー側のコンピューティング処理要件など、データ アクセス パターンを理解します。</span><span class="sxs-lookup"><span data-stu-id="f9042-199">Analyze the application to understand the data access patterns, such as the size of the result set returned by each query, the frequency of access, the inherent latency, and the server-side compute processing requirements.</span></span> <span data-ttu-id="f9042-200">多くの場合、少数の主要なエンティティが最大の処理リソースを要求します。</span><span class="sxs-lookup"><span data-stu-id="f9042-200">In many cases, a few major entities will demand most of the processing resources.</span></span>
2. <span data-ttu-id="f9042-201">この分析を使用して、データ サイズやワークロードなどの現在および将来の拡張性目標を決定します。</span><span class="sxs-lookup"><span data-stu-id="f9042-201">Use this analysis to determine the current and future scalability targets, such as data size and workload.</span></span> <span data-ttu-id="f9042-202">そして、拡張性目標を満たすようにパーティション全体にデータを分散します。</span><span class="sxs-lookup"><span data-stu-id="f9042-202">Then distribute the data across the partitions to meet the scalability target.</span></span> <span data-ttu-id="f9042-203">水平的パーティション分割では、均等に分散するために適切なシャード キーを選択することが重要となります。</span><span class="sxs-lookup"><span data-stu-id="f9042-203">For horizontal partitioning, choosing the right shard key is important to make sure distribution is even.</span></span> <span data-ttu-id="f9042-204">詳細については、「シャーディング パターン」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f9042-204">For more information, see the [Sharding pattern].</span></span>
3. <span data-ttu-id="f9042-205">データ サイズとスループットの観点から、スケーラビリティの要件に対処できる十分なリソースが各パーティションにあることを確認します。</span><span class="sxs-lookup"><span data-stu-id="f9042-205">Make sure each partition has enough resources to handle the scalability requirements, in terms of data size and throughput.</span></span> <span data-ttu-id="f9042-206">データ ストアによっては、パーティションあたりのストレージ領域、処理能力、またはネットワーク帯域幅が制限されていることがあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-206">Depending on the data store, there might be a limit on the amount of storage space, processing power, or network bandwidth per partition.</span></span> <span data-ttu-id="f9042-207">要件がこれらの制限を超える可能性がある場合は、パーティション分割戦略を再調整するか、データをさらに分割することが必要になったり、複数の戦略を組み合わせることが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-207">If the requirements are likely to exceed these limits, you may need to refine your partitioning strategy or split data out further, possibly combining two or more strategies.</span></span>
4. <span data-ttu-id="f9042-208">システムを監視して、データが想定どおりに分散されており、各パーティションで負荷が処理されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="f9042-208">Monitor the system to verify that data is distributed as expected and that the partitions can handle the load.</span></span> <span data-ttu-id="f9042-209">実際の使用状況は、分析で予測されたものと必ずしも一致するとは限りません。</span><span class="sxs-lookup"><span data-stu-id="f9042-209">Actual usage does not always match what an analysis predicts.</span></span> <span data-ttu-id="f9042-210">その場合、パーティションを再調整できます。また、必要なバランスを取るために、システムの一部を再設計することも可能です。</span><span class="sxs-lookup"><span data-stu-id="f9042-210">If so, it might be possible to rebalance the partitions, or else redesign some parts of the system to gain the required balance.</span></span>

<span data-ttu-id="f9042-211">クラウド環境によっては、インフラストラクチャ境界の観点でリソースが割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="f9042-211">Some cloud environments allocate resources in terms of infrastructure boundaries.</span></span> <span data-ttu-id="f9042-212">選択した境界の制限が、データ ストレージ、処理能力、および帯域幅の観点で、データ量の想定される成長を収容できることを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-212">Ensure that the limits of your selected boundary provide enough room for any anticipated growth in the volume of data, in terms of data storage, processing power, and bandwidth.</span></span>

<span data-ttu-id="f9042-213">たとえば、Azure Table Storage を使用する場合、一定期間内に単一パーティションで処理できる要求の量に制限があります </span><span class="sxs-lookup"><span data-stu-id="f9042-213">For example, if you use Azure table storage, there is a limit to the volume of requests that can be handled by a single partition in a particular period of time.</span></span> <span data-ttu-id="f9042-214">(「[Azure Storage のスケーラビリティおよびパフォーマンスのターゲット]」をご覧ください)。ビジー状態のシャードでは、単一パーティションで処理できるリソースよりも多くのリソースが必要になることがあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-214">(See [Azure storage scalability and performance targets].) A busy shard might require more resources than a single partition can handle.</span></span> <span data-ttu-id="f9042-215">その場合、負荷を分散するために、シャードを再パーティション分割する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-215">If so, the shard might need to be repartitioned to spread the load.</span></span> <span data-ttu-id="f9042-216">これらのテーブルの合計サイズまたはスループットがストレージ アカウントの容量を超える場合は、追加のストレージ アカウントを作成して、それらのアカウントにテーブルを分散する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-216">If the total size or throughput of these tables exceeds the capacity of a storage account, you might need to create additional storage accounts and spread the tables across these accounts.</span></span>

## <a name="designing-partitions-for-query-performance"></a><span data-ttu-id="f9042-217">クエリ パフォーマンスの観点でのパーティション分割の設計</span><span class="sxs-lookup"><span data-stu-id="f9042-217">Designing partitions for query performance</span></span>

<span data-ttu-id="f9042-218">クエリのパフォーマンスは、多くの場合、小さなデータ セットを使用し、並列クエリを実行することで、格段に向上できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-218">Query performance can often be boosted by using smaller data sets and by running parallel queries.</span></span> <span data-ttu-id="f9042-219">各パーティションには、データ セット全体の小さな割合を収容する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-219">Each partition should contain a small proportion of the entire data set.</span></span> <span data-ttu-id="f9042-220">そうすると、容量が小さくなるので、クエリのパフォーマンスが向上します。</span><span class="sxs-lookup"><span data-stu-id="f9042-220">This reduction in volume can improve the performance of queries.</span></span> <span data-ttu-id="f9042-221">ただし、パーティション分割は、データベースを適切に設計および構成することの代替にはなりません。</span><span class="sxs-lookup"><span data-stu-id="f9042-221">However, partitioning is not an alternative for designing and configuring a database appropriately.</span></span> <span data-ttu-id="f9042-222">たとえば、必要なインデックスが構成されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="f9042-222">For example, make sure that you have the necessary indexes in place.</span></span>

<span data-ttu-id="f9042-223">クエリ パフォーマンスの観点でパーティション分割を設計する際には、次の手順に従います。</span><span class="sxs-lookup"><span data-stu-id="f9042-223">Follow these steps when designing partitions for query performance:</span></span>

1. <span data-ttu-id="f9042-224">アプリケーションの要件とパフォーマンスを検証します。</span><span class="sxs-lookup"><span data-stu-id="f9042-224">Examine the application requirements and performance:</span></span>

   - <span data-ttu-id="f9042-225">ビジネス要件を使用して、常に高速で実行する必要のある重要なクエリを決定します。</span><span class="sxs-lookup"><span data-stu-id="f9042-225">Use business requirements to determine the critical queries that must always perform quickly.</span></span>
   - <span data-ttu-id="f9042-226">システムを監視して、低速で実行するクエリを識別します。</span><span class="sxs-lookup"><span data-stu-id="f9042-226">Monitor the system to identify any queries that perform slowly.</span></span>
   - <span data-ttu-id="f9042-227">最も頻繁に実行されるクエリを見つけます。</span><span class="sxs-lookup"><span data-stu-id="f9042-227">Find which queries are performed most frequently.</span></span> <span data-ttu-id="f9042-228">単一のクエリのコストが最小限であっても、累積されたリソース消費量が多大になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-228">Even if a single query has a minimal cost, the cumulative resource consumption could be significant.</span></span>

2. <span data-ttu-id="f9042-229">パフォーマンスの低下を引き起こしているデータをパーティション分割します。</span><span class="sxs-lookup"><span data-stu-id="f9042-229">Partition the data that is causing slow performance:</span></span>
   - <span data-ttu-id="f9042-230">クエリの応答時間がターゲット時間内になるように各パーティションのサイズを制限します。</span><span class="sxs-lookup"><span data-stu-id="f9042-230">Limit the size of each partition so that the query response time is within target.</span></span>
   - <span data-ttu-id="f9042-231">水平的パーティション分割を使用する場合は、アプリケーションが適切なパーティションを簡単に選択できるようにシャード キーを設計します。</span><span class="sxs-lookup"><span data-stu-id="f9042-231">If you use horizontal partitioning, design the shard key so that the application can easily select the right partition.</span></span> <span data-ttu-id="f9042-232">これにより、クエリがすべてのパーティションを通してスキャンする必要がなくなります。</span><span class="sxs-lookup"><span data-stu-id="f9042-232">This prevents the query from having to scan through every partition.</span></span>
   - <span data-ttu-id="f9042-233">パーティションの場所を検討してください。</span><span class="sxs-lookup"><span data-stu-id="f9042-233">Consider the location of a partition.</span></span> <span data-ttu-id="f9042-234">可能な限り、パーティションのデータを、それにアクセスするアプリケーションやユーザーに地理的に近い場所に維持します。</span><span class="sxs-lookup"><span data-stu-id="f9042-234">If possible, try to keep data in partitions that are geographically close to the applications and users that access it.</span></span>

3. <span data-ttu-id="f9042-235">エンティティにスループットとクエリ パフォーマンスの要件がある場合、そのエンティティに基づく機能的パーティション分割を使用します。</span><span class="sxs-lookup"><span data-stu-id="f9042-235">If an entity has throughput and query performance requirements, use functional partitioning based on that entity.</span></span> <span data-ttu-id="f9042-236">それでも要件が満たされない場合は、水平的パーティション分割も適用します。</span><span class="sxs-lookup"><span data-stu-id="f9042-236">If this still doesn't satisfy the requirements, apply horizontal partitioning as well.</span></span> <span data-ttu-id="f9042-237">ほとんどの場合、単一のパーティション分割戦略で十分ですが、両方の戦略を組み合わせて使用することが効果的な場合があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-237">In most cases a single partitioning strategy will suffice, but in some cases it is more efficient to combine both strategies.</span></span>

4. <span data-ttu-id="f9042-238">パフォーマンスを向上させるために、複数のパーティションでクエリを並列実行することを検討します。</span><span class="sxs-lookup"><span data-stu-id="f9042-238">Consider running queries in parallel across partitions to improve performance.</span></span>

## <a name="designing-partitions-for-availability"></a><span data-ttu-id="f9042-239">可用性の観点でのパーティション分割の設計</span><span class="sxs-lookup"><span data-stu-id="f9042-239">Designing partitions for availability</span></span>

<span data-ttu-id="f9042-240">データをパーティション分割すると、データセット全体が単一障害点となることはなく、またデータセットの個々のサブセットを個別に管理できるので、アプリケーションの可用性が向上します。</span><span class="sxs-lookup"><span data-stu-id="f9042-240">Partitioning data can improve the availability of applications by ensuring that the entire dataset does not constitute a single point of failure and that individual subsets of the dataset can be managed independently.</span></span>

<span data-ttu-id="f9042-241">可用性に影響する次の要素を考慮してください。</span><span class="sxs-lookup"><span data-stu-id="f9042-241">Consider the following factors that affect availability:</span></span>

<span data-ttu-id="f9042-242">**業務に対するデータの重要度**。</span><span class="sxs-lookup"><span data-stu-id="f9042-242">**How critical the data is to business operations**.</span></span> <span data-ttu-id="f9042-243">重要なビジネス情報であるデータ (トランザクションなど) と、重要度の低い運用データ (ログ ファイルなど) を特定します。</span><span class="sxs-lookup"><span data-stu-id="f9042-243">Identify which data is critical business information, such as transactions, and which data is less critical operational data, such as log files.</span></span>

- <span data-ttu-id="f9042-244">適切なバックアップ計画を使用して、重要なデータを可用性の高いパーティションに格納することを検討します。</span><span class="sxs-lookup"><span data-stu-id="f9042-244">Consider storing critical data in highly-available partitions with an appropriate backup plan.</span></span>

- <span data-ttu-id="f9042-245">データセットごとに個別の管理および監視手順を確立します。</span><span class="sxs-lookup"><span data-stu-id="f9042-245">Establish separate management and monitoring procedures for the different datasets.</span></span>

- <span data-ttu-id="f9042-246">同じレベルの重要度を持つデータを同じパーティションに配置して、適切な頻度で一緒にバックアップできるようにします。</span><span class="sxs-lookup"><span data-stu-id="f9042-246">Place data that has the same level of criticality in the same partition so that it can be backed up together at an appropriate frequency.</span></span> <span data-ttu-id="f9042-247">たとえば、トランザクション データを保持するパーティションは、ログ情報やトレース情報を保持するパーティションよりも頻繁にバックアップする必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-247">For example, partitions that hold transaction data might need to be backed up more frequently than partitions that hold logging or trace information.</span></span>

<span data-ttu-id="f9042-248">**個々のパーティションを管理する方法**。</span><span class="sxs-lookup"><span data-stu-id="f9042-248">**How individual partitions can be managed**.</span></span> <span data-ttu-id="f9042-249">個別に管理および保守ができるようにパーティションを設計すると、いくつかのメリットが生じます。</span><span class="sxs-lookup"><span data-stu-id="f9042-249">Designing partitions to support independent management and maintenance provides several advantages.</span></span> <span data-ttu-id="f9042-250">例: </span><span class="sxs-lookup"><span data-stu-id="f9042-250">For example:</span></span>

- <span data-ttu-id="f9042-251">1 つのパーティションで障害が発生した場合、他のパーティションのデータにアクセスするアプリケーションに影響を及ぼすことなく、そのパーティションを個別に復旧できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-251">If a partition fails, it can be recovered independently without applications that access data in other partitions.</span></span>

- <span data-ttu-id="f9042-252">地理的な場所に基づいてデータをパーティション分割すると、各場所のオフピーク時間に保守タスクが実行されるようにスケジュールできます。</span><span class="sxs-lookup"><span data-stu-id="f9042-252">Partitioning data by geographical area allows scheduled maintenance tasks to occur at off-peak hours for each location.</span></span> <span data-ttu-id="f9042-253">計画された保守タスクがこの期間内に完了するように、パーティションのサイズが大きすぎないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="f9042-253">Ensure that partitions are not too big to prevent any planned maintenance from being completed during this period.</span></span>

<span data-ttu-id="f9042-254">**機密データをパーティション全体でレプリケートすることの必要性**。</span><span class="sxs-lookup"><span data-stu-id="f9042-254">**Whether to replicate critical data across partitions**.</span></span> <span data-ttu-id="f9042-255">この戦略では、可用性とパフォーマンスを向上させることができますが、整合性の問題が発生することもあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-255">This strategy can improve availability and performance, but can also introduce consistency issues.</span></span> <span data-ttu-id="f9042-256">変更をすべてのレプリカと同期するには時間がかかります。</span><span class="sxs-lookup"><span data-stu-id="f9042-256">It takes time to synchronize changes with every replica.</span></span> <span data-ttu-id="f9042-257">この期間は、さまざまなパーティションが異なるデータ値を持つ可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-257">During this period, different partitions will contain different data values.</span></span>

## <a name="application-design-considerations"></a><span data-ttu-id="f9042-258">アプリケーション設計に関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="f9042-258">Application design considerations</span></span>

<span data-ttu-id="f9042-259">パーティション分割を使用すると、システムの設計と開発の複雑さが増大します。</span><span class="sxs-lookup"><span data-stu-id="f9042-259">Partitioning adds complexity to the design and development of your system.</span></span> <span data-ttu-id="f9042-260">初期においてシステムが単一のパーティションのみを含んでいる場合でも、パーティション分割をシステム設計の基盤として考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-260">Consider partitioning as a fundamental part of system design even if the system initially only contains a single partition.</span></span> <span data-ttu-id="f9042-261">後からの思い付きでパーティション分割に対処しようとすると、維持する必要があるライブ システムが既に存在するので難しくなります。</span><span class="sxs-lookup"><span data-stu-id="f9042-261">If you address partitioning as an afterthought, it will be more challenging because you already have a live system to maintain:</span></span>

- <span data-ttu-id="f9042-262">データ アクセス ロジックを変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-262">Data access logic will need to be modified.</span></span>
- <span data-ttu-id="f9042-263">既存の大量のデータを複数のパーティションに分散するために、それらのデータを移行することが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-263">Large quantities of existing data may need to be migrated, to distribute it across partitions</span></span>
- <span data-ttu-id="f9042-264">ユーザーは、移行中もシステムを引き続き使用できることを求めています。</span><span class="sxs-lookup"><span data-stu-id="f9042-264">Users expect to be able to continue using the system during the migration.</span></span>

<span data-ttu-id="f9042-265">場合によっては、初期のデータ セットが小さく、単一サーバーで容易に処理できるので、パーティション分割は重要ではないと見なされます。</span><span class="sxs-lookup"><span data-stu-id="f9042-265">In some cases, partitioning is not considered important because the initial dataset is small and can be easily handled by a single server.</span></span> <span data-ttu-id="f9042-266">これは一部のワークロードには当てはまるかもしれませんが、多くの商用システムはユーザー数の増加に伴って拡張する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-266">This might be true for some workloads, but many commercial systems need to expand as the number of users increases.</span></span>

<span data-ttu-id="f9042-267">さらに、パーティション分割によってメリットがもたらされるのは大規模なデータ ストアだけではありません。</span><span class="sxs-lookup"><span data-stu-id="f9042-267">Moreover, it's not only large data stores that benefit from partitioning.</span></span> <span data-ttu-id="f9042-268">たとえば、小さなデータ ストアが数百の同時クライアントによって過度にアクセスされることがあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-268">For example, a small data store might be heavily accessed by hundreds of concurrent clients.</span></span> <span data-ttu-id="f9042-269">このような状況でデータをパーティション分割すると、競合を少なくし、スループットを向上させることができます。</span><span class="sxs-lookup"><span data-stu-id="f9042-269">Partitioning the data in this situation can help to reduce contention and improve throughput.</span></span>

<span data-ttu-id="f9042-270">データパーティション分割構成を設計する際には、次の点を考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-270">Consider the following points when you design a data partitioning scheme:</span></span>

<span data-ttu-id="f9042-271">**パーティションをまたがるデータ アクセス操作を最小限に抑える**: </span><span class="sxs-lookup"><span data-stu-id="f9042-271">**Minimize cross-partition data access operations**.</span></span> <span data-ttu-id="f9042-272">可能であれば、パーティションごとに、最も一般的なデータベース操作の対象となるデータをまとめ、パーティションをまたがるデータ アクセス操作を最小限に抑えます。</span><span class="sxs-lookup"><span data-stu-id="f9042-272">Where possible, keep data for the most common database operations together in each partition to minimize cross-partition data access operations.</span></span> <span data-ttu-id="f9042-273">パーティションをまたがるクエリは、単一パーティション内でのクエリよりも時間がかかる可能性がありますが、あるクエリ セットにパーティションを最適化すると、他のクエリ セットが悪影響を受けることがあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-273">Querying across partitions can be more time-consuming than querying within a single partition, but optimizing partitions for one set of queries might adversely affect other sets of queries.</span></span> <span data-ttu-id="f9042-274">パーティションをまたがるクエリを実行する必要がある場合は、並列クエリを実行し、アプリケーション内で結果を集計することによって、クエリ時間を最小限に抑えます </span><span class="sxs-lookup"><span data-stu-id="f9042-274">If you must query across partitions, minimize query time by running parallel queries and aggregating the results within the application.</span></span> <span data-ttu-id="f9042-275">(クエリの結果を次のクエリで使用する場合など、この方法を使用できない場合もあります)。</span><span class="sxs-lookup"><span data-stu-id="f9042-275">(This approach might not be possible in some cases, such as when the result from one query is used in the next query.)</span></span>

<span data-ttu-id="f9042-276">**静的参照データのレプリケーションを検討する**: </span><span class="sxs-lookup"><span data-stu-id="f9042-276">**Consider replicating static reference data.**</span></span> <span data-ttu-id="f9042-277">クエリで比較的静的な参照データ (郵便番号テーブルや製品リストなど) を使用する場合は、すべてのパーティションでこのデータをレプリケートして、パーティションごとの個別の検索操作を減らすことを検討します。</span><span class="sxs-lookup"><span data-stu-id="f9042-277">If queries use relatively static reference data, such as postal code tables or product lists, consider replicating this data in all of the partitions to reduce separate lookup operations in different partitions.</span></span> <span data-ttu-id="f9042-278">この方法を使用すると、システム全体からの大量のトラフィックによって、参照データが "ホット" データセットになる可能性を低減することもできます。</span><span class="sxs-lookup"><span data-stu-id="f9042-278">This approach can also reduce the likelihood of the reference data becoming a "hot" dataset, with heavy traffic from across the entire system.</span></span> <span data-ttu-id="f9042-279">ただし、参照データに対する変更の同期に関連する追加コストが発生します。</span><span class="sxs-lookup"><span data-stu-id="f9042-279">However, there is an additional cost associated with synchronizing any changes to the reference data.</span></span>

<span data-ttu-id="f9042-280">**パーティション間結合を最小限に抑える**: </span><span class="sxs-lookup"><span data-stu-id="f9042-280">**Minimize cross-partition joins.**</span></span> <span data-ttu-id="f9042-281">可能であれば、垂直的パーティション間および機能的パーティション間での参照整合性の要件を最小限に抑えます。</span><span class="sxs-lookup"><span data-stu-id="f9042-281">Where possible, minimize requirements for referential integrity across vertical and functional partitions.</span></span> <span data-ttu-id="f9042-282">これらの構成では、アプリケーションが、パーティション間での参照整合性を維持する役割を担います。</span><span class="sxs-lookup"><span data-stu-id="f9042-282">In these schemes, the application is responsible for maintaining referential integrity across partitions.</span></span> <span data-ttu-id="f9042-283">複数のパーティション間でデータを結合するクエリは非効率的です。通常、アプリケーションがキーに基づいてクエリを実行し、続いて外部キーに基づいてクエリを実行する必要があるためです。</span><span class="sxs-lookup"><span data-stu-id="f9042-283">Queries that join data across multiple partitions are inefficient because the application typically needs to perform consecutive queries based on a key and then a foreign key.</span></span> <span data-ttu-id="f9042-284">このような状況では、パーティション分割の代わりに、関連するデータのレプリケートまたは非正規化を検討します。</span><span class="sxs-lookup"><span data-stu-id="f9042-284">Instead, consider replicating or de-normalizing the relevant data.</span></span> <span data-ttu-id="f9042-285">パーティション間結合が必要な場合は、パーティションに対して並列クエリを実行し、アプリケーション内でデータを結合します。</span><span class="sxs-lookup"><span data-stu-id="f9042-285">If cross-partition joins are necessary, run parallel queries over the partitions and join the data within the application.</span></span>

<span data-ttu-id="f9042-286">**最終的な整合性の受容**。</span><span class="sxs-lookup"><span data-stu-id="f9042-286">**Embrace eventual consistency**.</span></span> <span data-ttu-id="f9042-287"> 強力な整合性が実際に要件であるかどうかを評価します。</span><span class="sxs-lookup"><span data-stu-id="f9042-287">Evaluate whether strong consistency is actually a requirement.</span></span> <span data-ttu-id="f9042-288">分散システムでの一般的な方法として、最終的な整合性を実装します。</span><span class="sxs-lookup"><span data-stu-id="f9042-288">A common approach in distributed systems is to implement eventual consistency.</span></span> <span data-ttu-id="f9042-289">各パーティションのデータは個別に更新され、アプリケーションのロジックはすべての更新が正常に完了したことを確認します。</span><span class="sxs-lookup"><span data-stu-id="f9042-289">The data in each partition is updated separately, and the application logic ensures that the updates are all completed successfully.</span></span> <span data-ttu-id="f9042-290">また、結果整合性の操作が実行している間、データをクエリすることにより発生する可能性のある不整合を処理することができます。</span><span class="sxs-lookup"><span data-stu-id="f9042-290">It also handles the inconsistencies that can arise from querying data while an eventually consistent operation is running.</span></span>

<span data-ttu-id="f9042-291">**クエリが正しいパーティションを見つける方法を考慮します**。</span><span class="sxs-lookup"><span data-stu-id="f9042-291">**Consider how queries locate the correct partition**.</span></span> <span data-ttu-id="f9042-292">必要なデータを見つけるためにクエリがすべてのパーティションをスキャンする必要がある場合、複数の並列クエリが実行中である場合でも、パフォーマンスに非常に大きな影響を及ぼします。</span><span class="sxs-lookup"><span data-stu-id="f9042-292">If a query must scan all partitions to locate the required data, there is a significant impact on performance, even when multiple parallel queries are running.</span></span> <span data-ttu-id="f9042-293">垂直的パーティション分割と機能的パーティション分割では、クエリでパーティションを自然に指定できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-293">With vertical and functional partitioning, queries can naturally specify the partition.</span></span> <span data-ttu-id="f9042-294">一方、水平的パーティション分割では、すべてのシャードが同じスキーマを持つので、項目を見つけることが困難になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-294">Horizontal partitioning, on the other hand, can make locating an item difficult, because every shard has the same schema.</span></span> <span data-ttu-id="f9042-295">一般的な解決策は、特定の項目のシャードの場所を検索する際に使用するマップを維持することです。</span><span class="sxs-lookup"><span data-stu-id="f9042-295">A typical solution to maintain a map that is used to look up the shard location for specific items.</span></span> <span data-ttu-id="f9042-296">このマップは、アプリケーションのシャーディング ロジックに実装することも、データ ストアが透過的シャーディングをサポートする場合にはデータ ストアにより維持されるようにすることもできます。</span><span class="sxs-lookup"><span data-stu-id="f9042-296">This map can be implemented in the sharding logic of the application, or maintained by the data store if it supports transparent sharding.</span></span>

<span data-ttu-id="f9042-297">**シャードを定期的に再調整することを検討する**: </span><span class="sxs-lookup"><span data-stu-id="f9042-297">**Consider periodically rebalancing shards**.</span></span> <span data-ttu-id="f9042-298">水平的パーティション分割では、シャードの再調整により、サイズとワークロードに基づいてデータを均等に分散することで、ホットスポットを最小限に抑え、クエリ パフォーマンスを最大化し、ストレージの物理的な制限に対処できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-298">With horizontal partitioning, rebalancing shards can help distribute the data evenly by size and by workload to minimize hotspots, maximize query performance, and work around physical storage limitations.</span></span> <span data-ttu-id="f9042-299">ただし、これは複雑なタスクで、多くの場合、カスタム ツールまたはカスタム プロセスの使用が必要になります。</span><span class="sxs-lookup"><span data-stu-id="f9042-299">However, this is a complex task that often requires the use of a custom tool or process.</span></span>

<span data-ttu-id="f9042-300">**パーティションをレプリケートする**: </span><span class="sxs-lookup"><span data-stu-id="f9042-300">**Replicate partitions.**</span></span> <span data-ttu-id="f9042-301">各パーティションをレプリケートすると、障害からの保護を強化できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-301">If you replicate each partition, it provides additional protection against failure.</span></span> <span data-ttu-id="f9042-302">単一のレプリカで障害が発生しても、動作しているコピーにクエリを振り向けることができます。</span><span class="sxs-lookup"><span data-stu-id="f9042-302">If a single replica fails, queries can be directed towards a working copy.</span></span>

<span data-ttu-id="f9042-303">**パーティション分割戦略の物理制限に到達した場合、拡張性を別のレベルに拡張することが必要な場合があります**。</span><span class="sxs-lookup"><span data-stu-id="f9042-303">**If you reach the physical limits of a partitioning strategy, you might need to extend the scalability to a different level**.</span></span> <span data-ttu-id="f9042-304">たとえば、パーティション分割がデータベース レベルで行われる場合、パーティションを複数のデータベースで配置したりレプリケートしたりすることが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-304">For example, if partitioning is at the database level, you might need to locate or replicate partitions in multiple databases.</span></span> <span data-ttu-id="f9042-305">パーティション分割が既にデータベース レベルで行われており、物理制限が問題になっている場合、パーティションを複数のホスティング アカウントで配置したりレプリケートしたりすることが必要な可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-305">If partitioning is already at the database level, and physical limitations are an issue, it might mean that you need to locate or replicate partitions in multiple hosting accounts.</span></span>

<span data-ttu-id="f9042-306">**トランザクションでは、複数のパーティションのデータにアクセスしないようにします**。</span><span class="sxs-lookup"><span data-stu-id="f9042-306">**Avoid transactions that access data in multiple partitions**.</span></span> <span data-ttu-id="f9042-307">一部のデータ ストアには、データを変更する操作に対してトランザクション レベルの一貫性と整合性を保つ機能を実装していますが、これが有効になるのは、データが単一のパーティションに配置されている場合だけです。</span><span class="sxs-lookup"><span data-stu-id="f9042-307">Some data stores implement transactional consistency and integrity for operations that modify data, but only when the data is located in a single partition.</span></span> <span data-ttu-id="f9042-308">複数のパーティションにまたがってトランザクション レベルのサポートを必要とする場合、ほとんどのパーティション分割システムでこの機能はネイティブにサポートされていないので、アプリケーション ロジックの一部として実装することが必要になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-308">If you need transactional support across multiple partitions, you will probably need to implement this as part of your application logic because most partitioning systems do not provide native support.</span></span>

<span data-ttu-id="f9042-309">すべてのデータ ストアで運用の管理および監視のアクティビティが必要です。</span><span class="sxs-lookup"><span data-stu-id="f9042-309">All data stores require some operational management and monitoring activity.</span></span> <span data-ttu-id="f9042-310">これらのタスクには、データのロード、データのバックアップおよび復元、データの再編成、システムが正しく効率よく動作していることの確認などがあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-310">The tasks can range from loading data, backing up and restoring data, reorganizing data, and ensuring that the system is performing correctly and efficiently.</span></span>

<span data-ttu-id="f9042-311">運用管理に影響する次の要因を考慮してください。</span><span class="sxs-lookup"><span data-stu-id="f9042-311">Consider the following factors that affect operational management:</span></span>

- <span data-ttu-id="f9042-312">**データをパーティション分割するとき、適切な管理と運用のタスクを実装する方法**。</span><span class="sxs-lookup"><span data-stu-id="f9042-312">**How to implement appropriate management and operational tasks when the data is partitioned**.</span></span> <span data-ttu-id="f9042-313">バックアップと復元、データのアーカイブ、システムの監視、その他の管理タスクなどです。</span><span class="sxs-lookup"><span data-stu-id="f9042-313">These tasks might include backup and restore, archiving data, monitoring the system, and other administrative tasks.</span></span> <span data-ttu-id="f9042-314">たとえば、バックアップと復元の操作では論理的な一貫性を維持することが課題になります。</span><span class="sxs-lookup"><span data-stu-id="f9042-314">For example, maintaining logical consistency during backup and restore operations can be a challenge.</span></span>

- <span data-ttu-id="f9042-315">**データを複数のパーティションにロードする方法と、他のソースから到着する新しいデータを追加する方法**。</span><span class="sxs-lookup"><span data-stu-id="f9042-315">**How to load the data into multiple partitions and add new data that's arriving from other sources**.</span></span> <span data-ttu-id="f9042-316">一部のツールおよびユーティリティでは、データを正しいパーティションにロードするなど、シャード化されているデータの操作がサポートされていないことがあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-316">Some tools and utilities might not support sharded data operations such as loading data into the correct partition.</span></span>

- <span data-ttu-id="f9042-317">**定期的にデータをアーカイブして削除する方法**。</span><span class="sxs-lookup"><span data-stu-id="f9042-317">**How to archive and delete the data on a regular basis**.</span></span> <span data-ttu-id="f9042-318">パーティションの過度な成長を防止するために、定期的に (たとえば、月単位で) データをアーカイブして削除する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-318">To prevent the excessive growth of partitions, you need to archive and delete data on a regular basis (perhaps monthly).</span></span> <span data-ttu-id="f9042-319">異なるアーカイブ スキーマに一致するように、データを変換することが必要な場合があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-319">It might be necessary to transform the data to match a different archive schema.</span></span>

- <span data-ttu-id="f9042-320">**データ整合性の問題を見つける方法**。</span><span class="sxs-lookup"><span data-stu-id="f9042-320">**How to locate data integrity issues**.</span></span> <span data-ttu-id="f9042-321">あるパーティションのデータが別のパーティションの存在しない情報を参照しているなど、データ整合性の問題を見つけるプロセスを定期的に実行することを検討します。</span><span class="sxs-lookup"><span data-stu-id="f9042-321">Consider running a periodic process to locate any data integrity issues, such as data in one partition that references missing information in another.</span></span> <span data-ttu-id="f9042-322">このプロセスでは、これらの問題の自動修正を試みるか、手動でのレビュー用にレポートを生成できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-322">The process can either attempt to fix these issues automatically or simply generate a report for manual review.</span></span>

## <a name="rebalancing-partitions"></a><span data-ttu-id="f9042-323">パーティションの再調整</span><span class="sxs-lookup"><span data-stu-id="f9042-323">Rebalancing partitions</span></span>

<span data-ttu-id="f9042-324">システムが成熟するにつれて、パーティション分割構成を調整することが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-324">As a system matures, you might have to adjust the partitioning scheme.</span></span> <span data-ttu-id="f9042-325">たとえば、パーティション間でトラフィック量に不均衡が生じ、特定のパーティションがホットスポットになり、過度の競合が発生することがあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-325">For example, individual partitions might start get a disproportionate volume of traffic and become hot, leading to excessive contention.</span></span> <span data-ttu-id="f9042-326">また、一部のパーティションでデータ量が過少に見積もられており、これらのパーティションが容量の上限に近づいていることもあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-326">Or you might have underestimated the volume of data in some partitions, causing some partitions to approach capacity limits.</span></span>

<span data-ttu-id="f9042-327">Cosmos DB などの一部のデータ ストアでは、パーティションを自動的に再調整できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-327">Some data stores, such as Cosmos DB, can automatically rebalance partitions.</span></span> <span data-ttu-id="f9042-328">それ以外の場合、再調整は次の 2 段階で構成される管理タスクとなります。</span><span class="sxs-lookup"><span data-stu-id="f9042-328">In other cases, rebalancing is an administrative task that consists of two stages:</span></span>

1. <span data-ttu-id="f9042-329">新しいパーティション分割戦略を決定します。</span><span class="sxs-lookup"><span data-stu-id="f9042-329">Determine a new partitioning strategy.</span></span>

    - <span data-ttu-id="f9042-330">どのパーティションを分割する (場合によっては結合する) 必要があるか。</span><span class="sxs-lookup"><span data-stu-id="f9042-330">Which partitions need to be split (or possibly combined)?</span></span>
    - <span data-ttu-id="f9042-331">新しいパーティション キーは何か。</span><span class="sxs-lookup"><span data-stu-id="f9042-331">What is the new partition key?</span></span>

2. <span data-ttu-id="f9042-332">データを古いパーティション分割構成から新しいパーティション セットに移行します。</span><span class="sxs-lookup"><span data-stu-id="f9042-332">Migrate data from the old partitioning scheme to the new set of partitions.</span></span>

<span data-ttu-id="f9042-333">データ ストアによっては、パーティションの使用中にパーティション間でデータを移行できる場合もあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-333">Depending on the data store, you might be able to migrate data between partitions while they are in use.</span></span> <span data-ttu-id="f9042-334">これは "*オンライン移行*" と呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="f9042-334">This is called *online migration*.</span></span> <span data-ttu-id="f9042-335">これが不可能な場合は、データを再配置する間、パーティションを使用できないようにする必要があります ("*オフライン移行*")。</span><span class="sxs-lookup"><span data-stu-id="f9042-335">If that's not possible, you might need to make partitions unavailable while the data is relocated (*offline migration*).</span></span>

### <a name="offline-migration"></a><span data-ttu-id="f9042-336">オフライン移行</span><span class="sxs-lookup"><span data-stu-id="f9042-336">Offline migration</span></span>

<span data-ttu-id="f9042-337">オフライン移行は、競合が発生する可能性が低減されるので一般に簡単です。</span><span class="sxs-lookup"><span data-stu-id="f9042-337">Offline migration is generally simpler, because it reduces the chances of contention occurring.</span></span> <span data-ttu-id="f9042-338">概念的には、オフライン移行は次のように動作します。</span><span class="sxs-lookup"><span data-stu-id="f9042-338">Conceptually, offline migration works as follows:</span></span>

1. <span data-ttu-id="f9042-339">パーティションをオフラインにします。</span><span class="sxs-lookup"><span data-stu-id="f9042-339">Mark the partition offline.</span></span>
2. <span data-ttu-id="f9042-340">データを分割/マージし、新しいパーティションに移動します。</span><span class="sxs-lookup"><span data-stu-id="f9042-340">Split-merge and move the data to the new partitions.</span></span>
3. <span data-ttu-id="f9042-341">データを検証します。</span><span class="sxs-lookup"><span data-stu-id="f9042-341">Verify the data.</span></span>
4. <span data-ttu-id="f9042-342">新しいパーティションをオンラインにします。</span><span class="sxs-lookup"><span data-stu-id="f9042-342">Bring the new partitions online.</span></span>
5. <span data-ttu-id="f9042-343">古いパーティションを削除します。</span><span class="sxs-lookup"><span data-stu-id="f9042-343">Remove the old partition.</span></span>

<span data-ttu-id="f9042-344">必要に応じて、手順 1. でパーティションを読み取り専用としてマークすることもできます。これにより、アプリケーションはデータの移動中も、データを読み取ることができます。</span><span class="sxs-lookup"><span data-stu-id="f9042-344">Optionally, you can mark a partition as read-only in step 1, so that applications can still read the data while it is being moved.</span></span>

## <a name="online-migration"></a><span data-ttu-id="f9042-345">オンライン移行</span><span class="sxs-lookup"><span data-stu-id="f9042-345">Online migration</span></span>

<span data-ttu-id="f9042-346">オンライン移行は実行が複雑になりますが、中断は少なくなります。</span><span class="sxs-lookup"><span data-stu-id="f9042-346">Online migration is more complex to perform but less disruptive.</span></span> <span data-ttu-id="f9042-347">プロセスはオフライン移行と似ていますが、元のパーティションがオフラインになることはありません。</span><span class="sxs-lookup"><span data-stu-id="f9042-347">The process is similar to offline migration, except the original partition is not marked offline.</span></span> <span data-ttu-id="f9042-348">移行プロセスの粒度 (たとえば、項目単位か、シャード単位か) に応じて、クライアント アプリケーションのデータ アクセス コードでは、2 つの場所 (元のパーティションと新しいパーティション) に保持されるデータの読み書きを処理することが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-348">Depending on the granularity of the migration process (for example, item by item versus shard by shard), the data access code in the client applications might have to handle reading and writing data that's held in two locations, the original partition and the new partition.</span></span>

## <a name="related-patterns"></a><span data-ttu-id="f9042-349">関連するパターン</span><span class="sxs-lookup"><span data-stu-id="f9042-349">Related patterns</span></span>

<span data-ttu-id="f9042-350">次の設計パターンがシナリオに関連することがあります。</span><span class="sxs-lookup"><span data-stu-id="f9042-350">The following design patterns might be relevant to your scenario:</span></span>

- <span data-ttu-id="f9042-351">[シャーディング パターン](../patterns/sharding.md)は、データのシャーディングのための一般的な戦略を示します。</span><span class="sxs-lookup"><span data-stu-id="f9042-351">The [sharding pattern](../patterns/sharding.md) describes some common strategies for sharding data.</span></span>

- <span data-ttu-id="f9042-352">[インデックス テーブル パターン](../patterns/index-table.md)は、データに対してセカンダリ インデックスを作成する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="f9042-352">The [index table pattern](../patterns/index-table.md) shows how to create secondary indexes over data.</span></span> <span data-ttu-id="f9042-353">この手法を使用すると、アプリケーションは、コレクションのプライマリ キーを参照しないクエリで、データをすばやく取得できます。</span><span class="sxs-lookup"><span data-stu-id="f9042-353">An application can quickly retrieve data with this approach, by using queries that do not reference the primary key of a collection.</span></span>

- <span data-ttu-id="f9042-354">[具体化されたビュー パターン](../patterns/materialized-view.md)は、データを要約して高速のクエリ操作をサポートする、事前設定されたビューを生成する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="f9042-354">The [materialized view pattern](../patterns/materialized-view.md) describes how to generate pre-populated views that summarize data to support fast query operations.</span></span> <span data-ttu-id="f9042-355">この手法は、要約対象のデータを含むパーティションが複数のサイトにまたがって分散されている場合に、パーティション分割されたデータ ストアで役立つ可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f9042-355">This approach can be useful in a partitioned data store if the partitions that contain the data being summarized are distributed across multiple sites.</span></span>

## <a name="next-steps"></a><span data-ttu-id="f9042-356">次の手順</span><span class="sxs-lookup"><span data-stu-id="f9042-356">Next steps</span></span>

- <span data-ttu-id="f9042-357">特定の Azure サービスのパーティション分割戦略の詳細を確認します。</span><span class="sxs-lookup"><span data-stu-id="f9042-357">Learn about partitioning strategies for specific Azure services.</span></span> <span data-ttu-id="f9042-358">「[Data partitioning strategies (データのパーティション分割戦略)](./data-partitioning-strategies.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="f9042-358">See [Data partitioning strategies](./data-partitioning-strategies.md)</span></span>

[Azure Storage のスケーラビリティおよびパフォーマンスのターゲット]: /azure/storage/storage-scalability-targets
[Azure Storage Scalability and Performance Targets]: /azure/storage/storage-scalability-targets

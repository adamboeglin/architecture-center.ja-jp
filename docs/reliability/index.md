---
title: 信頼性の高い Azure アプリケーションを設計する
description: Azure アプリケーションの信頼性と可用性を高める方法の概要
author: MikeWasson
ms.date: 04/10/2019
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.custom: ''
ms.openlocfilehash: 16c1daeed9b1d79f33051eb69571f1574bf9be4d
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2019
ms.locfileid: "59644016"
---
# <a name="designing-reliable-azure-applications"></a>信頼性の高い Azure アプリケーションの設計

クラウド内で信頼性の高いアプリケーションを構築することは、従来のアプリケーション開発とは異なります。 従来は、スケールアップのためによりハイエンドのハードウェアを購入する場合がありましたが、クラウド環境では、スケールアップではなくスケールアウトを行います。 目標は、障害がまったく発生しないように努力することではなく、障害が発生した単一コンポーネントの影響を最小限に抑えることです。

信頼性の高いアプリケーションとは、次のとおりです。

- **回復性があり**、障害から適切に復旧します。アプリケーションは完全に復旧するまで、ダウンタイムおよびデータ損失を最小限に抑えて機能し続けます。
- **高可用性 (HA)** があり、大幅なダウンタイムもなく正常な状態で設計どおり実行されます。

これらの要素の連携&mdash;およびコストに与える影響&mdash;について理解することは、信頼性の高いアプリケーションを構築する上で不可欠です。 これは、許容されるダウンタイムの程度、会社が負担する潜在的なコスト、および復旧中に必要な機能を判断する場合に役立ちます。

この記事では、Azure アプリケーションの設計プロセスの各ステップに信頼性を組み込む方法について概説します。 各セクションには、プロセス内のその特定のステップに信頼性を統合する方法について詳述した記事へのリンクが含まれています。 個々の Azure サービスでの信頼性に関する考慮事項については、「[特定の Azure サービスの回復性のチェックリスト](../checklist/resiliency-per-service.md)」を参照してください。

## <a name="build-for-reliability"></a>信頼性の構築

このセクションでは、信頼性の高い Azure アプリケーションを構築するための 6 つの手順について説明します。 各ステップは、プロセスや用語を詳しく定義したセクションとリンクされています。

1. [**要件を定義する。**](#define-requirements) 分解したワークロードやビジネス ニーズに基づいて可用性と復旧の要件を作成します。
1. [**アーキテクチャのベスト プラクティスを使用する。**](#use-architectural-best-practices) 実証済みプラクティスに従い、アーキテクチャ内で考えられる障害点を識別し、アプリケーションが障害に対応する方法を決定します。
1. [**シミュレーションと強制フェールオーバーをテストする。**](#test-with-simulations-and-forced-failovers) 障害をシミュレートし、強制フェールオーバーをトリガーし、これらの障害の検出テストおよび障害からの復旧テストを行います。
1. [**アプリケーションの一貫性をデプロイする。**](#deploy-the-application-consistently) 信頼性が高く反復可能なプロセスを使用して運用環境にリリースします。
1. [**アプリケーションの正常性を監視する。**](#monitor-application-health) 障害を検出し、潜在的な障害の指標を監視し、ご利用のアプリケーションの正常性を評価します。
1. [**障害と災害に対応する。**](#respond-to-failures-and-disasters) 障害が発生した日時を特定し、確定した戦略に基づいて障害に対処する方法を決定します。

## <a name="define-requirements"></a>要件の定義

ビジネス ニーズを特定し、それに応えるための信頼性計画を作成します。 以下、具体例に沿って説明します。

- **ワークロードと使用状況を特定する。** "*ワークロード*" とは、ビジネス ロジックとデータ ストレージの要件の観点から、他のタスクとは論理的に区別される独特な機能またはタスクです。 各ワークロードでは、可用性、スケーラビリティ、データの一貫性、およびディザスター リカバリーの要件がそれぞれ異なります。
- **使用状況パターンについて計画する。** *使用状況パターン*もまた、要件に関与します。 重要な期間と重大でない期間中での要件の違いを特定します。 たとえば、納税申告用アプリケーションは、申告期間中はフェールバックできません。 稼働時間を確保するには、1 つのリージョンで障害が発生した場合に備えていくつかのリージョン間での冗長性を計画します。 逆に、重大でない期間中はコストを最小限に抑えるために、ご利用のアプリケーションを 1 つのリージョンで実行できます。
- **可用性のメトリックを確定する &mdash; "*平均復旧時間*" (MTTR) と "*平均故障間隔*" (MTBF)。** MTTR は、障害発生後、コンポーネントを復元するために必要な平均時間です。 MTBF は、故障と故障の間の、コンポーネントが持続すると合理的に予測できる時間の長さとなりました。 これらのメジャーを使用して、冗長性を追加する場所を特定し、顧客に合ったサービス レベル アグリーメント (SLA) を決定します。  
- **復旧メトリックを確定する &mdash; 目標復旧時間と復旧ポイントの目標 (RPO)。** *RTO* は、インシデントの発生後に、アプリケーションを使用不可状態にすることができる最大許容時間です。 *RPO* は、障害発生時に許容できるデータ損失の最大期間です。 これらの値を取得するには、リスクの評価を実施して、組織でのダウンタイムまたはデータ損失のコストとリスクを確実に把握してください。
    > [!NOTE]
    > 高可用性の設定内の*任意*の重要なコンポーネントの MTTR がシステム RTO を超えた場合、システム内の障害によって、許容できないビジネスの中断が発生する可能性があります。 つまり、定義されている RTO 内でシステムを復旧させることができなくなります。
- **ワークロードの可用性の目標を決定する。** アプリケーションのアーキテクチャが自社のビジネス要件を確実に満たすようにするには、ワークロードごとにターゲット SLA を定義します。 アプリケーションの依存関係に加えて、可用性の要件を満たす上でのコストと複雑さを考慮します。
- **サービス レベル アグリーメントを理解する。** Azure では、稼働時間と接続に関する Microsoft の確約内容が SLA に記載されています。 特定のサービスの SLA が 99.9% の場合は、そのサービスを 99.9% の時間、使用可能であることが期待できるということになります。  

    使用するソリューション内のワークロードごとに独自のターゲット SLA を定義すれば、アーキテクチャがビジネス要件を満たしているかどうかを判定できます。 たとえば、ワークロードは 99.99% の稼働時間を必要としているが、そのワークロードは SLA が 99.9% のサービスに依存している場合、そのサービスをシステムの単一障害点にしてはなりません。

信頼性の高いアプリケーションの開発要件の詳細については、「[Developing requirements for resilient Azure applications](./requirements.md)」 (回復性がある Azure アプリケーションの開発要件) を参照してください。

## <a name="use-architectural-best-practices"></a>アーキテクチャのベスト プラクティスを使用する

アーキテクチャ フェーズ中には、ビジネス要件を満たし、障害点を特定し、障害の範囲を最小限に抑えるプラクティスを実装することに専念します。

- **障害モード分析 (FMA) を実行する。** FMA では、設計の初期段階でアプリケーションに回復性が組み込まれます。 これは、アプリケーションで発生する可能性がある障害の種類、それぞれが及ぼす潜在的な影響、および考えられる復旧戦略を特定するのに役立ちます。
- **冗長性のプランを作成する。** ワークロードごとに必要な冗長性のレベルは、ビジネスのニーズおよび要素に依存し、アプリケーションの全体的なコストに反映されます。 
- **スケーラビリティを考慮した設計をする。** クラウド アプリケーションは、使用状況の変化に応じてスケーリングできる必要があります。 個別のコンポーネントから初め、必要に応じて、負荷の変化に自動的に対応するアプリケーションを設計します。 設計中は、将来的に容易に拡張できるようにスケーリングの制限を念頭に置いてください。
- **サブスクリプションおよびサービスの要件について計画する。** ストレージ、接続、スループットなどの自社のビジネス要件を満たす十分なリソースをプロビジョニングするために追加のサブスクリプションが必要な場合があります。 
- **負荷分散を使用して要求を分散する。** 負荷分散は、正常でないインスタンスをローテーションから除去することで、アプリケーションの要求を正常なサービス インスタンスに分散します。
- **回復性戦略を実装する。** *回復性*とは、障害から回復して動作を続行する、システムの能力です。 重要なリソースの分離、補正トランザクションの使用、非同期操作の実行などの[回復性設計パターン](../patterns/category/resiliency.md)を必要に応じて実装します。
- **設計に可用性の要件を組み込む。** *可用性*とは、ご利用のシステムが動作し実際に使用可能である時間の割合です。 アプリケーションの可用性がご利用のサービス レベル アグリーメントに確実に準拠するように対策を講じます。 たとえば、単一障害点の回避、サービス レベルの目標によるワークロードの分解、大量のユーザーの調整などが挙げられます。
- **ご利用のデータを管理する。** データを格納、バックアップ、およびレプリケートする方法が重要です。

  - **ご利用のアプリケーション データに合ったレプリケーション方法を選択する。** ご利用のアプリケーション データは、さまざまなデータ ストアに格納され、さまざまな可用性の要件を持つ場合があります。 データ ストアの種類ごとにレプリケーションの方法と場所を評価して、それらが要件を確実に満たすようにします。
  - **ご利用のフェールオーバーおよびフェールバックのプロセスをドキュメント化してテストする。** 新しいデータ ストアにフェールオーバーする手順を明確に文書化し、それを定期的にテストして、手順どおりに正確および簡単に行えることを確認します。
  - **ご利用のデータを保護する。** データのバックアップと検証を定期的に行うと共に、運用環境データとバックアップ データの両方にアクセスできる単一のユーザー アカウントがないことを確認します。
  - **データの復旧について計画する。** バックアップおよびレプリケーション戦略が、ご利用のサービス レベル要件を満たすデータ復旧時間に対応していることを確認します。 アプリケーションで使用されるデータのすべての種類 (参照データやデータベースなど) を考慮します。

信頼性の高いアプリケーションの設計の詳細については、「[Architecting Azure applications for resiliency and availability](./architect.md)」 (回復性と可用性を考慮した Azure アプリケーションの設計) を参照してください。

## <a name="test-with-simulations-and-forced-failovers"></a>シミュレーションと強制フェールオーバーをテストする

信頼性のテストでは、断続的にしか発生しない障害条件下で、エンドツーエンドのワークロードがどのように実行されるかを測定する必要があります。

- **実際の障害をトリガーするか、またはそれらをシミュレートすることにより、一般的な障害シナリオをテストする。** フォールト挿入テストを使用して、一般的なシナリオ (障害の組み合わせを含む) と復旧時間をテストします。
- **負荷がかかっているときのみ発生する障害を特定する。** 運用データまたは運用データに可能な限り近い合成データを使用して、ピーク負荷の場合をテストすることで、実際の条件下でアプリケーションがどのように動作するかを確認します。
- **ディザスター リカバリーの訓練を実施する。** ディザスター リカバリー計画を策定してから、それを定期的にテストして、機能することを確認します。
- **フェールオーバーとフェールバックのテストを実行する。** アプリケーションの依存サービスのフェールオーバーとフェールバックが、確実に正しい順序で行われるようにしてください。
- **シミュレーションを実行する。** 実際のシナリオをテストすることで、対処する必要がある問題を明らかにすることができます。 シナリオは、制御可能なものであり、ビジネスの中断を招かないことが必要です。 シミュレーション テストの計画を管理者に通知します。
- **正常性プローブをテストする。** ロード バランサーおよびトラフィック マネージャーによって重要なシステム コンポーネントがチェックされるように、正常性プローブを構成します。 それをテストして、適切に応答することを確認してください。
- **監視システムをテストする。** 潜在的な障害を識別するのに役立つ重要な情報および正確なデータが監視システムから確実にレポートされるようにしてください。
- **テスト シナリオにサード パーティのサービスを含める。** 復旧に加えて、サード パーティ サービスの中断が原因で発生の可能性がある障害点もテストします。

テストは反復的なプロセスです。 アプリケーションをテストし、結果を測定し、障害があればそれを分析して対応して、さらにプロセスを繰り返します。

アプリケーションの信頼性のテストの詳細については、「[Testing Azure applications for resiliency and availability](./testing.md)」 (アプリケーションの回復性と可用性のテスト) を参照してください。

## <a name="deploy-the-application-consistently"></a>アプリケーションの一貫性をデプロイする

*デプロイ*には、Azure リソースのプロビジョニング、アプリケーション コードのデプロイ、構成設定の適用が含まれます。 更新プログラムでは、この 3 つのタスクすべて、またはその一部が必要となる場合があります。

アプリケーションを運用環境にデプロイした後で、更新プログラムがエラーの原因になることがあります。 予測可能および繰り返し可能なデプロイ プロセスを使用してエラーを最小限に抑えます。

- **アプリケーションのデプロイ プロセスを自動化する。** 可能な限り多くのプロセスを自動化します。
- **可用性を最大限に高められるようにリリース プロセスを設計する。** リリース プロセスでデプロイ中にサービスをオフラインにする必要がある場合、それがオンラインに戻るまでアプリケーションは使用できなくなります。 プラットフォームのステージングおよび運用機能を利用します。 ブルー グリーン リリースまたはカナリヤ リリースを使用します。そうすれば、障害が発生しても、更新プログラムを迅速にロールバックできます。
- **デプロイのロールバック計画を立てます。** デプロイが失敗した場合に、直前の正常なバージョンに戻して、ダウンタイムを最小限に抑えるようにロールバック プロセスを設計してください。
- **デプロイのログを記録して監査する。** ステージング デプロイ手法を使用する場合、運用環境では複数のバージョンのアプリケーションが実行されることになります。 できるだけ多くのバージョン固有の情報を把握するため、確実なログ記録の方法を実装してください。
- **アプリケーションのリリース プロセスを文書化する。** リリース プロセスを明確に定義して文書化し、オペレーション チーム全体が確実に利用できるようにしてください。

アプリケーションの信頼性とデプロイの詳細については、「[Deploying Azure applications for resiliency and availability](./deploy.md)」 (回復性と可用性を考慮した Azure アプリケーションのデプロイ) を参照してください。

## <a name="monitor-application-health"></a>アプリケーションの正常性を監視する

監視およびアラートのためのベスト プラクティスをアプリケーションに実装することで、障害を検出し、それを修正するようオペレーターに警告することができます。

- **正常性プローブを実装して機能を確認する。** それをアプリケーションの外部から定期的に実行して、アプリケーションの正常性とパフォーマンスの低下を識別します。
- **実行時間の長いワークフローを確認する。** 問題を早期に検出すると、ワークフロー全体をロールバックしたり、複数の補正トランザクションを実行したりする必要性を最小限に抑えることができます。
- **アプリケーション ログを維持する。**

  - 運用環境内およびサービス境界でアプリケーションのログに記録します。
  - セマンティックおよび非同期のログ記録を使用します。
  - アプリケーション ログを監査ログから分離します。

- **リモート呼び出しの統計情報を測定し、データをアプリケーション チームと共有する。** 運用チームがアプリケーションの正常性を瞬時に確認できるようにするために、待機時間、スループット、99 パーセンタイルおよび 95 パーセンタイルのエラーなどのリモート呼び出しメトリックをまとめます。 各パーセンタイル内で発生したエラーを明らかにするには、このメトリックで統計分析を実行してください。
- **適切な期間にわたって一時的な例外と再試行を追跡する。** 時間をかけて例外が増加する傾向は、サービスに問題があるか失敗する可能性があることを示します。
- **早期警告システムを設定する。** 一時的な例外やリモート呼び出しの待機時間などのアプリケーションの正常性の主要業績評価指標 (KPI) を特定し、それぞれに適切なしきい値を設定してください。 しきい値に達したときに、操作にアラートを送信します。
- **Azure サブスクリプションの制限内で運用する。** Azure サブスクリプションには、リソース グループの数、コアの数、およびストレージ アカウントの数など、特定のリソースの種類に対する制限があります。 リソースの種類の使用に注意してください。
- **サード パーティーのサービスを監視します。** 呼び出しをログに記録してから、それを一意の識別子を使用してアプリケーションの正常性と診断のログに関連付けます。
- **アプリケーションの監視および手動による復旧手順を行う複数のオペレーターをトレーニングする。** トレーニング済みのオペレーターが少なくとも 1 人以上、常に活動できる状態にあることを確認します。

アプリケーションの信頼性の監視の詳細については、[Azure アプリケーションの正常性の監視](./monitoring.md)に関するページを参照してください。

## <a name="respond-to-failures-and-disasters"></a>障害と災害に対応する

復旧計画を作成し、データの復元、ネットワーク障害、依存サービスのエラー、およびリージョン全体にわたるサービス中断がその計画で網羅されていることを確認します。 復旧戦略では、ご利用の VM、ストレージ、データベース、およびその他の Azure プラットフォーム サービスを検討します。

- **Azure サポートとのやり取りについて計画する。** 必要になる前に、Azure サポートに連絡するためのプロセスを確立します。
- **ディザスター リカバリー計画を文書化し、テストする。** アプリケーションの障害がビジネスに及ぼす影響を反映したディザスター リカバリー計画を作成します。 復旧プロセスは可能な限り自動化し、手動による手順は文書化します。 ディザスター リカバリー プロセスは定期的にテストし、計画の検証と改善を行います。
- **必要な場合に手動でフェールオーバーする。** 一部のシステムは自動的にフェールオーバーせず、手動フェールオーバーが必要です。 アプリケーションがセカンダリ リージョンにフェールオーバーした場合は、運用準備テストを実行します。 フェールバックする前に、プライマリ リージョンが正常で、トラフィックを再び受け取る準備が整っていることを確認します。 アプリケーションの機能制限の内容と、一時的な問題をアプリからユーザーに通知する方法を決定します。
- **アプリケーションの障害に備える。** 自動的に処理される障害、機能制限を引き起こす障害、アプリケーションを使用不能にする障害などの、障害の範囲に対して準備をします。 アプリケーションからユーザーに一時的な問題が通知される必要があります。
- **データ損失から回復する。** データ ストアで障害が発生した場合、ストアを再び使用可能な状態にするとき (特にデータをレプリケートした場合) は、データに整合性があることを確認する必要があります。 破損したデータをバックアップから復元します。
- **ネットワークの停止から回復する。** キャッシュされたデータを使用すれば、ローカルでアプリケーションの機能が制限された状態で実行できる場合があります。 そうしない場合は、アプリケーションのダウンタイムまたは別のリージョンへのフェールオーバーを検討してください。 接続が復元されるまで、別の場所にご利用のデータを格納します。
- **依存サービスの障害から回復する。** まだ利用できる機能を確認し、アプリケーションでの対処方法を決定します。
- **リージョン全体でのサービスの中断から回復する。** リージョン全体にわたるサービスの中断はめったに起こりません。しかし、特に重要なアプリケーションの場合は、それに対応するための戦略が必要です。 別のリージョンへのアプリケーションの再デプロイ、またはトラフィックの再配布が可能な場合があります。

障害とディザスター リカバリーに対応する方法の詳細については、「[Failure and disaster recovery for Azure applications](./disaster-recovery.md)」 (Azure アプリケーションの障害とディザスター リカバリー) を参照してください。

## <a name="next-steps"></a>次の手順

> [!div class="nextstepaction"]
> [回復性があるアプリケーションの要件を作成する](./requirements.md)

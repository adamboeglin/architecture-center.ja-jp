---
title: 回復性がある Azure アプリケーションの要件を定義する
description: Azure アプリケーションの可用性および回復性の要件の収集の概要
author: MikeWasson
ms.date: 04/10/2019
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.openlocfilehash: 2af2ce4200c285abfda1395862d21efc3c17e577
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2019
ms.locfileid: "59642874"
---
# <a name="developing-requirements-for-resilient-azure-applications"></a>回復性がある Azure アプリケーションの要件を作成する

*回復性* (障害からの回復) と*可用性* (大幅なダウンタイムがなく正常な状態で実行) をアプリに組み込むには、要件を収集することから開始します。 たとえば、どの程度のダウンタイムを許容できるのでしょうか? 起こり得るダウンタイムによって貴社のビジネスが被るコストはいくらになるでしょうか? 顧客の可用性の要件はどのようなものでしょうか? ご利用のアプリケーションの可用性を高めることにいくら投資しますか? コストとリスクの比較はどのようになります?

## <a name="identify-distinct-workloads"></a>個別のワークロードを識別する

クラウド ソリューションは、通常、複数のアプリケーション *ワークロード*で構成されます。 ワークロードとは、ビジネス ロジックとデータ ストレージの要件の観点から、他のタスクとは論理的に区別される独特な機能またはタスクです。 たとえば、eコマース アプリには次のようなワークロードがあります。

- 製品カタログの閲覧と検索。
- 注文の作成と追跡。
- 推奨事項の表示。

各ワークロードでは、可用性、スケーラビリティ、データの一貫性、およびディザスター リカバリーの要件がそれぞれ異なります。 ワークロードごとにコストとリスクのバランスを考慮することで、ビジネス上の意思決定を行います。

また、サービス レベル目標に基づいてワークロードを分解します。 サービスが重要なワークロードとあまり重要ではないワークロードで構成されている場合は、それらを異なる方法で管理し、それぞれの可用性の要件を満たすのに必要なサービスの機能とインスタンスの数を指定します。

## <a name="plan-for-usage-patterns"></a>使用状況パターンについて計画する

重要な期間と重大でない期間中での要件の違いを特定します。 システムが使用可能である必要がある特定の重要な期間はありますか。 たとえば、申告期間中に納税申告アプリケーションで障害が発生してはならないし、ライブ イベント中にはビデオ ストリーミング サービスに遅延が発生すべきではありません。 このような状況では、リスクとコストを比較検討します。

- 重要な期間に稼働時間を確保し、サービス レベル アグリーメント (SLA) を満たすには、コストが増加したとしても、1 つのリージョンが失敗した場合に備えていくつかのリージョン間で冗長性を計画します。
- 逆に、重大でない期間中は、ご利用のアプリケーションを 1 つのリージョンで実行して、コストを最小限に抑えます。
- 場合によっては、消費ベースで課金が行われる最新のサーバーレス手法を使用して、追加の費用を軽減することができます。

## <a name="establish-availability-and-recovery-metrics"></a>可用性および復旧のメトリックを確定する

要件プロセスの一部として、2 つのメトリック セットのためにベースライン数値を作成します。 最初のセットは、クラウド サービスへの冗長性を追加する場所および顧客に提供する SLA を決定するのに役立ちます。 2 つ目のセットは、使用するディザスター リカバリーを計画するのに役立ちます。

### <a name="availability-metrics"></a>可用性のメトリック

これらのメジャーを使用して、冗長性を計画し、顧客の SLA を決定します。

- **平均復旧時間** (MTTR) とは、障害発生後にコンポーネントを復旧するためにかかる平均時間です。
- **平均故障間隔**(MTBF) とは、次の障害が発生するまでに合理的に予期されるコンポーネントの稼働時間です。

### <a name="recovery-metrics"></a>回復のメトリック

これらの値を取得するには、リスクの評価を実施して、ダウンタイムとデータ損失におけるコストとリスクを確実に把握してください。 これらはシステムの機能要件ではなく、ビジネス要件によって決定する必要があります。

- **目標復旧時間** (RTO) は、インシデントが発生した後に、アプリケーションに許容する使用不能状態の最大時間です。
- **回復ポイントの目標** (RPO) は、災害発生時に許容できるデータ損失の最大期間です。

高可用性の設定内の*任意*の重要なコンポーネントの MTTR 値がシステム RTO を超えた場合、システム内の障害によって、許容できないビジネスの中断が発生する可能性があります。 つまり、定義されている RTO 内でシステムを復元することができなくなります。

## <a name="determine-workload-availability-targets"></a>ワークロードの可用性の目標を決定する

使用するソリューション内のワークロードごとに独自のターゲット SLA を定義すれば、アーキテクチャがビジネス要件を満たしているかどうかを判定できます。

### <a name="consider-cost-and-complexity"></a>コストと複雑さを検討する

他の項目がすべて同じ場合は、可用性が高いほど望ましくなります。 しかし、9 の個数を増やすことを目指すと、コストと複雑さが増大します。 99.99% のアップタイムは、月あたりの合計ダウンタイムの約 5 分に換算されます。 ファイブ ナイン (99.999%) の実現に、複雑さとコストが増大する価値はありますか? その答えはビジネス要件によって変わります。

SLA を定義する場合の他の考慮事項を次に示します。

- 4 つの 9 (99.99%) を実現するには、手動操作による障害からの復旧には依存できません。 アプリケーションには自己診断機能と自己復旧機能が必要です。
- 4 つの 9 を超えると、SLA を満たすことができるほど迅速に障害を検出することは困難です。
- SLA を測定する時間枠について考慮します。 この時間枠を短くするほど、許容度は厳格になります。 時間単位または日単位のアップタイムという観点で SLA を定義することは意味がありません。
- MTBF と MTTR の測定値を考慮します。 SLA が高ければ高いほど、サービスがダウンする可能性は低くなり、サービスをより短時間で回復させる必要があります。
- アプリケーションの各部分の可用性の目標について顧客から合意を得て、それをドキュメント化します。 そうしないと、顧客の期待を満たす設計にすることはできません。

### <a name="identify-dependencies"></a>依存関係を識別する

依存関係マッピングの演習を行って、内部依存関係と外部依存関係を識別します。 たとえば、セキュリティまたは ID (Active Directory など) や、サード パーティーのサービス (支払プロバイダーや電子メール メッセージ サービスなど) に関連する依存関係があります。

単一障害点になったり、ボトルネックを生じさせたりする可能性がある外部依存関係には、特に注意を払ってください。 ワークロードのアップタイム要件が 99.99% で、SLA が 99.9% のサービスに依存している場合、そのサービスをシステムの単一障害点にしてはなりません。 1 つの救済方法として、サービスが失敗した場合に備えてフォールバック パスを用意します。 あるいは、そのサービス内の障害から復旧するためのその他の手段を実行します。

次の表は、さまざまな SLA レベルで考えられる累積的なダウンタイムの一覧です。

| **SLA** | **週あたりのダウンタイム** | **月あたりのダウンタイム** | **年あたりのダウンタイム** |
|---------|-----------------------|------------------------|-----------------------|
| 99%     | 1.68 時間            | 7.2 時間              | 3.65 日             |
| 99.9%   | 10.1 分          | 43.2 分           | 8.76 時間            |
| 99.95%  | 5 分             | 21.6 分           | 4.38 時間            |
| 99.99%  | 1.01 分          | 4.32 分           | 52.56 分         |
| 99.999% | 6 秒             | 25.9 秒           | 5.26 分          |

## <a name="understand-service-level-agreements"></a>サービス レベル アグリーメントを理解する

Azure では、[サービス レベル アグリーメント](https://azure.microsoft.com/en-us/support/legal/sla/)に、アップタイムと接続性について Microsoft のコミットメントが示されています。 特定のサービスの SLA が 99.9% の場合は、そのサービスを 99.9% の時間、使用可能であることが期待できます。 サービスの種類によって、SLA もそれぞれ異なります。

また、Azure SLA には、SLA が満たされない場合にサービス クレジットを取得するための規定と、各サービスの *可用性* の詳細な定義も含まれています。 SLA のこの側面は、強制ポリシーとして機能します。

### <a name="composite-slas"></a>複合 SLA

*複合 SLA* では、それぞれの可用性レベルが異なる複数のサービスで、1 つのアプリケーションをサポートする必要があります。 たとえば、Azure SQL Database に書き込む App Service Web アプリについて検討します。 この記事の執筆時点で、このような Azure サービスには次の SLA があります。

- App Service Web アプリ = 99.95%
- SQL Database = 99.99%

このアプリケーションで予想される最大ダウンタイムはどのくらいですか。 いずれかのサービスで障害が発生すると、アプリケーション全体で障害が発生します。 各サービスで障害が発生する可能性は独立しているため、このアプリケーションの複合 SLA は 99.95% x 99.99% = 99.94% です。 これは個々の SLA よりも低い値です。複数のサービスに依存するアプリケーションは潜在的な障害点が多くなるため、これは驚くことではありません。

複合 SLA を改善するには、独立したフォールバック パスを作成する方法があります。 たとえば、SQL Database が使用できない場合は、後で処理できるようにトランザクションをキューに格納します。

![複合 SLA](_images/composite-sla.png)

この設計の場合、データベースに接続できない場合でも、アプリケーションは使用可能な状態です。 ただし、データベースとキューの両方で同時に障害が発生すると、アプリケーションは使用できなくなります。 同時に障害が発生する時間の予測される割合は 0.0001 x 0.001 なので、この組み合わせのパスに関する複合 SLA は次のとおりです。

- データベース *or* キュー = 1.0 − (0.0001 × 0.001) = 99.99999%

合計複合 SLA は次のとおりです。

- Web アプリ *and* (データベース *or* キュー) = 99.95% × 99.99999% = \~99.95%

この方法にはトレードオフがあります。 アプリケーション ロジックは複雑になり、キューのコストがかかり、データの一貫性に関する問題も考慮する必要があります。

### <a name="slas-for-multiregion-deployments"></a>複数リージョン デプロイの SLA

"*複数リージョン デプロイの SLA*" では、アプリケーションを複数のリージョンにデプロイすることで、1 つのリージョンのアプリケーションで障害が発生した場合に Azure Traffic Manager を使用してフェールオーバーできるようにする高可用性の方法が必要です。

マルチリージョン デプロイの場合の複合 SLA は次のように計算されます。

- *N* は、1 つのリージョンにデプロイされているアプリケーション用の複合 SLA です。
- *R* は、アプリケーションがデプロイされているリージョンの数です。

すべてのリージョンでアプリケーションの障害が発生する可能性は ((1 − N) \^ R) と予測されます。 たとえば、1 つのリージョンの SLA が 99.95% の場合は次のようになります。

- 2 つのリージョンの複合 SLA = (1 − (1 − 0.9995) \^ 2) = 99.999975%
- 4 つのリージョンの複合 SLA =  (1 − (1 − 0.9995) \^ 4)  = 99.999999%

[Traffic Manager の SLA](https://azure.microsoft.com/en-us/support/legal/sla/traffic-manager/v1_0/) も要因になります。 アクティブ/パッシブ構成ではフェールオーバーは瞬時に完了しないので、フェールオーバー時にはダウンタイムが発生する可能性があります。 [Traffic Manager エンドポイントの監視とフェールオーバー](/azure/traffic-manager/traffic-manager-monitoring)に関するページを参照してください。

## <a name="next-steps"></a>次の手順

> [!div class="nextstepaction"]
> [回復性と可用性を考慮した設計](./architect.md)

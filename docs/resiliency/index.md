---
title: 回復性に優れた Azure 用アプリケーションの設計
description: 高可用性とディザスター リカバリーのために Azure で回復性に優れたアプリケーションを構築する方法。
author: MikeWasson
ms.date: 12/18/2018
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.custom: resiliency
---

# <a name="designing-resilient-applications-for-azure"></a><span data-ttu-id="dbe0b-103">回復性に優れた Azure 用アプリケーションの設計</span><span class="sxs-lookup"><span data-stu-id="dbe0b-103">Designing resilient applications for Azure</span></span>

<span data-ttu-id="dbe0b-104">分散システムでは、障害が発生します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-104">In a distributed system, failures will happen.</span></span> <span data-ttu-id="dbe0b-105">ハードウェアの障害が発生することがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-105">Hardware can fail.</span></span> <span data-ttu-id="dbe0b-106">ネットワークに一時的な障害が起きることがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-106">The network can have transient failures.</span></span> <span data-ttu-id="dbe0b-107">まれに、サービス全体またはリージョン全体で中断が発生する可能性がありますが、こうしたことについても計画しておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-107">Rarely, an entire service or region may experience a disruption, but even those must be planned for.</span></span>

<span data-ttu-id="dbe0b-108">クラウドで信頼性の高いアプリケーションの構築は、エンタープライズ設定で信頼性の高いアプリケーションの構築とは異なります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-108">Building a reliable application in the cloud is different than building a reliable application in an enterprise setting.</span></span> <span data-ttu-id="dbe0b-109">従来は、スケールアップのためにハイエンドなハードウェアを購入していましたが、クラウド環境では、スケールアップではなくスケールアウトする必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-109">While historically you may have purchased higher-end hardware to scale up, in a cloud environment you must scale out instead of scaling up.</span></span> <span data-ttu-id="dbe0b-110">クラウド環境は、汎用的なハードウェアを使用することで低コストを維持できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-110">Costs for cloud environments are kept low through the use of commodity hardware.</span></span> <span data-ttu-id="dbe0b-111">目標は、障害がまったく発生しないように努力することではなく、システム内での障害の影響を最小限に抑えることです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-111">Instead of trying to prevent failures altogether, the goal is to minimize the effects of a failure within the system.</span></span>

<span data-ttu-id="dbe0b-112">この記事では、Microsoft Azure で回復性に優れたアプリケーションを構築する方法の概要について説明します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-112">This article provides an overview of how to build resilient applications in Microsoft Azure.</span></span> <span data-ttu-id="dbe0b-113">まず、*回復性*という用語の定義と関連する概念から説明します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-113">It starts with a definition of the term *resiliency* and related concepts.</span></span> <span data-ttu-id="dbe0b-114">次に、設計、実装からデプロイ、運用までというアプリケーションの有効期間全体に体系的な方法を使用することで、回復性を実現するプロセスについて説明します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-114">Then it describes a process for achieving resiliency, using a structured approach over the lifetime of an application, from design and implementation to deployment and operations.</span></span>

<!-- markdownlint-disable MD026 -->

## <a name="what-is-resiliency"></a><span data-ttu-id="dbe0b-115">回復性とは</span><span class="sxs-lookup"><span data-stu-id="dbe0b-115">What is resiliency?</span></span>

<!-- markdownlint-enable MD026 -->

<span data-ttu-id="dbe0b-116">**回復性**とは、障害から回復して動作を続行する、システムの能力です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-116">**Resiliency** is the ability of a system to recover from failures and continue to function.</span></span> <span data-ttu-id="dbe0b-117">障害を*回避*することではなく、ダウンタイムまたはデータの損失を回避するように障害に*対応*することです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-117">It's not about *avoiding* failures, but *responding* to failures in a way that avoids downtime or data loss.</span></span> <span data-ttu-id="dbe0b-118">回復性の目的は、障害後にアプリケーションを完全に機能している状態に戻すことです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-118">The goal of resiliency is to return the application to a fully functioning state following a failure.</span></span>

<span data-ttu-id="dbe0b-119">回復性には、高可用性とディザスター リカバリーという 2 つの重要な側面があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-119">Two important aspects of resiliency are high availability and disaster recovery.</span></span>

- <span data-ttu-id="dbe0b-120">**高可用性** (HA) は、大幅なダウンタイムなしに、正常な状態で実行を継続するアプリケーションの能力です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-120">**High availability** (HA) is the ability of the application to continue running in a healthy state, without significant downtime.</span></span> <span data-ttu-id="dbe0b-121">"正常な状態" とは、アプリケーションが応答し、ユーザーがアプリケーションに接続して対話できるという意味です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-121">By "healthy state," we mean the application is responsive, and users can connect to the application and interact with it.</span></span>  
- <span data-ttu-id="dbe0b-122">**ディザスター リカバリー** (DR) は、まれに発生する大きなインシデント、すなわち地域全体に影響するサービス中断のように、一時的なものではない大規模な障害から回復する能力です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-122">**Disaster recovery** (DR) is the ability to recover from rare but major incidents: non-transient, wide-scale failures, such as service disruption that affects an entire region.</span></span> <span data-ttu-id="dbe0b-123">ディザスター リカバリーには、データ バックアップやアーカイブの他に、バックアップからのデータベースの復元などの手動操作も含まれる場合があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-123">Disaster recovery includes data backup and archiving, and may include manual intervention, such as restoring a database from backup.</span></span>

<span data-ttu-id="dbe0b-124">HA と DR のとらえ方として、障害の影響が HA 設計で対応できる限度を超えたときに DR が始まると考えることができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-124">One way to think about HA versus DR is that DR starts when the impact of a fault exceeds the ability of the HA design to handle it.</span></span>  

<span data-ttu-id="dbe0b-125">回復性を設計するときは、ご自分の可用性要件を理解する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-125">When you design resiliency, you must understand your availability requirements.</span></span> <span data-ttu-id="dbe0b-126">どの程度のダウンタイムを許容できるのでしょうか。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-126">How much downtime is acceptable?</span></span> <span data-ttu-id="dbe0b-127">これは、ある程度はコストによって決まります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-127">This is partly a function of cost.</span></span> <span data-ttu-id="dbe0b-128">起こり得るダウンタイムによって貴社のビジネスが被るコストはいくらになるでしょうか。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-128">How much will potential downtime cost your business?</span></span> <span data-ttu-id="dbe0b-129">アプリケーションの可用性を高めることにいくら投資したいですか。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-129">How much should you invest in making the application highly available?</span></span> <span data-ttu-id="dbe0b-130">また、何をもってアプリケーションが使用可能であるとするかについても定義する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-130">You also have to define what it means for the application to be available.</span></span> <span data-ttu-id="dbe0b-131">たとえば、ユーザーが注文を送信しても、通常の時間枠内にシステムで処理できない場合、アプリケーションは "停止" 状態でしょうか。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-131">For example, is the application "down" if a customer can submit an order but the system cannot process it within the normal timeframe?</span></span> <span data-ttu-id="dbe0b-132">また、特定の種類の障害が発生する可能性と、リスク軽減戦略のコスト効果が高いかどうかについても考慮します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-132">Also consider the probability of a particular type of outage occurring, and whether a mitigation strategy is cost-effective.</span></span>

<span data-ttu-id="dbe0b-133">もう 1 つの一般的な用語に**ビジネス継続性** (BC) があります。BC とは、自然災害やサービスの停止などの悪条件の発生時と発生後に、重要なビジネス機能を実行できることです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-133">Another common term is **business continuity** (BC), which is the ability to perform essential business functions during and after adverse conditions, such as a natural disaster or a downed service.</span></span> <span data-ttu-id="dbe0b-134">BC は、物理的な設備、人、コミュニティ、運輸、IT を含め、業務全体が対象です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-134">BC covers the entire operation of the business, including physical facilities, people, communications, transportation, and IT.</span></span> <span data-ttu-id="dbe0b-135">この記事ではクラウド アプリケーションを中心に扱いますが、回復性の計画は BC 要件全体のコンテキストで行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-135">This article focuses on cloud applications, but resilience planning must be done in the context of overall BC requirements.</span></span>

<span data-ttu-id="dbe0b-136">**データ バックアップ**は、DR の重要な部分です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-136">**Data backup** is a critical part of DR.</span></span> <span data-ttu-id="dbe0b-137">アプリケーションのステートレスなコンポーネントが失敗した場合、そのコンポーネントはいつでも再展開できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-137">If the stateless components of an application fail, you can always redeploy them.</span></span> <span data-ttu-id="dbe0b-138">ただし、データが失われると、システムは安定した状態に戻ることはできません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-138">But if data is lost, the system can't return to a stable state.</span></span> <span data-ttu-id="dbe0b-139">リージョン全体の障害に備えて、理想的には異なるリージョンにデータをバックアップする必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-139">Data must be backed up, ideally in a different region in case of a region-wide disaster.</span></span>

<span data-ttu-id="dbe0b-140">バックアップは、*データ レプリケーション*とは異なります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-140">Backup is distinct from *data replication*.</span></span> <span data-ttu-id="dbe0b-141">データ レプリケーションでは、システムが迅速にレプリカにフェールオーバーできるように、ほぼリアルタイムでデータがコピーされます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-141">Data replication involves copying data in near-real-time, so that the system can fail over quickly to a replica.</span></span> <span data-ttu-id="dbe0b-142">多くのデータベース システムがレプリケーションをサポートしています。たとえば、SQL Server では、SQL Server Always On 可用性グループがサポートされます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-142">Many databases systems support replication; for example, SQL Server supports SQL Server Always On Availability Groups.</span></span> <span data-ttu-id="dbe0b-143">データ レプリケーションでは、データのレプリカを確実かつ常に待機させることで、障害からの復旧時間を短縮できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-143">Data replication can reduce how long it takes to recover from an outage, by ensuring that a replica of the data is always standing by.</span></span> <span data-ttu-id="dbe0b-144">しかし、データ レプリケーションで人的ミスを防ぐことはできません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-144">However, data replication won't protect against human error.</span></span> <span data-ttu-id="dbe0b-145">人的ミスによりデータが破損すると、その破損したデータはレプリカにコピーされます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-145">If data gets corrupted because of human error, the corrupted data just gets copied to the replicas.</span></span> <span data-ttu-id="dbe0b-146">このため、DR 戦略には引き続き長期的なバックアップを含める必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-146">Therefore, you still need to include long-term backup in your DR strategy.</span></span>

## <a name="process-to-achieve-resiliency"></a><span data-ttu-id="dbe0b-147">回復性を実現するプロセス</span><span class="sxs-lookup"><span data-stu-id="dbe0b-147">Process to achieve resiliency</span></span>

<span data-ttu-id="dbe0b-148">回復性はアドオンではありません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-148">Resiliency is not an add-on.</span></span> <span data-ttu-id="dbe0b-149">システムの設計に追加し、運用方法に組み込む必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-149">It must be designed into the system and put into operational practice.</span></span> <span data-ttu-id="dbe0b-150">一般的なモデルは次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-150">Here is a general model to follow:</span></span>

1. <span data-ttu-id="dbe0b-151">**定義**: ビジネスのニーズに基づいて可用性の要件を定義します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-151">**Define** your availability requirements, based on business needs.</span></span>
2. <span data-ttu-id="dbe0b-152">**設計**: 回復性を考慮してアプリケーションを設計します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-152">**Design** the application for resiliency.</span></span> <span data-ttu-id="dbe0b-153">実証済みの手法に従ったアーキテクチャから始めて、そのアーキテクチャで考えられる障害点を特定します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-153">Start with an architecture that follows proven practices, and then identify the possible failure points in that architecture.</span></span>
3. <span data-ttu-id="dbe0b-154">**実装**: 障害を検出し、回復する戦略を実装します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-154">**Implement** strategies to detect and recover from failures.</span></span>
4. <span data-ttu-id="dbe0b-155">**テスト**: 障害をシミュレートし、強制的なフェールオーバーをトリガーして実装をテストします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-155">**Test** the implementation by simulating faults and triggering forced failovers.</span></span>
5. <span data-ttu-id="dbe0b-156">**デプロイ**: 信頼性が高い反復可能なプロセスを使用して、アプリケーションを運用環境にデプロイします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-156">**Deploy** the application into production using a reliable, repeatable process.</span></span>
6. <span data-ttu-id="dbe0b-157">**監視**: アプリケーションを監視して障害を検出します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-157">**Monitor** the application to detect failures.</span></span> <span data-ttu-id="dbe0b-158">システムを監視することで、アプリケーションの正常性を評価し、必要に応じてインシデントに対応できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-158">By monitoring the system, you can gauge the health of the application and respond to incidents if necessary.</span></span>
7. <span data-ttu-id="dbe0b-159">**対応**: 手動の介入が必要な障害が発生した場合に対応します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-159">**Respond** if there are failure that require manual interventions.</span></span>

<span data-ttu-id="dbe0b-160">以降、これらの各手順について詳しく説明します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-160">In the remainder of this article, we discuss each of these steps in more detail.</span></span>

## <a name="define-your-availability-requirements"></a><span data-ttu-id="dbe0b-161">可用性の要件を定義する</span><span class="sxs-lookup"><span data-stu-id="dbe0b-161">Define your availability requirements</span></span>

<span data-ttu-id="dbe0b-162">回復性の計画は、ビジネス要件から始まります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-162">Resiliency planning starts with business requirements.</span></span> <span data-ttu-id="dbe0b-163">ビジネス要件という点で回復性について考える場合の方法をいくつか挙げます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-163">Here are some approaches for thinking about resiliency in those terms.</span></span>

### <a name="decompose-by-workload"></a><span data-ttu-id="dbe0b-164">ワークロードごとに分解する</span><span class="sxs-lookup"><span data-stu-id="dbe0b-164">Decompose by workload</span></span>

<span data-ttu-id="dbe0b-165">多くのクラウド ソリューションは、複数のアプリケーション ワークロードで構成されます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-165">Many cloud solutions consist of multiple application workloads.</span></span> <span data-ttu-id="dbe0b-166">このコンテキストで "ワークロード" という用語は、ビジネス ロジックとデータ ストレージ要件の点で、他のタスクとは論理的に区別できる個別の機能またはコンピューティング タスクを意味します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-166">The term "workload" in this context means a discrete capability or computing task, which can be logically separated from other tasks, in terms of business logic and data storage requirements.</span></span> <span data-ttu-id="dbe0b-167">たとえば、eコマース アプリには次のようなワークロードがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-167">For example, an e-commerce app might include the following workloads:</span></span>

- <span data-ttu-id="dbe0b-168">製品カタログの閲覧と検索。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-168">Browse and search a product catalog.</span></span>
- <span data-ttu-id="dbe0b-169">注文の作成と追跡。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-169">Create and track orders.</span></span>
- <span data-ttu-id="dbe0b-170">推奨事項の表示。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-170">View recommendations.</span></span>

<span data-ttu-id="dbe0b-171">これらのワークロードでは、可用性、スケーラビリティ、データの一貫性、およびディザスター リカバリーの要件が異なっている可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-171">These workloads might have different requirements for availability, scalability, data consistency, and disaster recovery.</span></span> <span data-ttu-id="dbe0b-172">コストとリスクのバランスを取るという観点から行う必要がある、ビジネス上の意思決定があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-172">There are business decisions to be made in terms of balancing cost versus risk.</span></span>

<span data-ttu-id="dbe0b-173">また、使用パターンについても考慮します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-173">Also consider usage patterns.</span></span> <span data-ttu-id="dbe0b-174">システムが使用可能である必要がある特定の重要な期間はありますか。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-174">Are there certain critical periods when the system must be available?</span></span> <span data-ttu-id="dbe0b-175">たとえば、税金申告書サービスが申告期限の直前に停止してはならない、大規模なスポーツ イベント中にビデオ ストリーミング サービスは稼働している必要がある、などです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-175">For example, a tax-filing service can't go down right before the filing deadline, a video streaming service must stay up during a big sports event, and so on.</span></span> <span data-ttu-id="dbe0b-176">重要な期間中は、複数のリージョンにまたがる冗長的なデプロイにして、1 つのリージョンで障害が発生してもアプリケーションがフェールオーバーできるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-176">During the critical periods, you might have redundant deployments across several regions, so the application could fail over if one region failed.</span></span> <span data-ttu-id="dbe0b-177">ただし、複数リージョンのデプロイはコストが高くなる可能性があるため、重要な期間以外は、1 つのリージョンでアプリケーションを実行することができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-177">However, a multi-region deployment is potentially more expensive, so during less critical times, you might run the application in a single region.</span></span> <span data-ttu-id="dbe0b-178">場合によっては、課金対象となる使用量に達していないコンピューティング リソースには課金しない従量課金制を採用している最新のサーバーレス手法を利用することで、追加費用を軽減できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-178">In some cases, the additional expense can be mitigated by using modern serverless techniques, which use consumption-based billing, so you are not charged for under-utilitzed compute resources.</span></span>

### <a name="rto-and-rpo"></a><span data-ttu-id="dbe0b-179">RTO と RPO</span><span class="sxs-lookup"><span data-stu-id="dbe0b-179">RTO and RPO</span></span>

<span data-ttu-id="dbe0b-180">考慮すべき 2 つの重要なメトリックとして、ディザスター リカバリーに関連している目標復旧時間と目標復旧時点があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-180">Two important metrics to consider are the recovery time objective and recovery point objective, as they pertain to disaster recovery.</span></span>

- <span data-ttu-id="dbe0b-181">**目標復旧時間** (RTO) は、インシデントが発生した後に、アプリケーションに許容する使用不能状態の最大時間です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-181">**Recovery time objective** (RTO) is the maximum acceptable time that an application can be unavailable after an incident.</span></span> <span data-ttu-id="dbe0b-182">RTO が 90 分の場合、災害発生から 90 分以内にアプリケーションを実行状態に復元できる必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-182">If your RTO is 90 minutes, you must be able to restore the application to a running state within 90 minutes from the start of a disaster.</span></span> <span data-ttu-id="dbe0b-183">RTO を非常に低い値にする場合は、リージョン全体の停止を防ぐために、アクティブ/パッシブ構成の中でスタンバイ状態で継続的に実行される第 2 のリージョンのデプロイを維持する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-183">If you have a very low RTO, you might keep a second regional deployment continually running an active/passive configuration on standby, to protect against a regional outage.</span></span> <span data-ttu-id="dbe0b-184">場合によっては、アクティブ/アクティブ構成のデプロイでも、低めの RTO を実現できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-184">In some cases you might deploy an active/active configuration to achieve even lower RTO.</span></span>

- <span data-ttu-id="dbe0b-185">**回復ポイントの目標** (RPO) は、災害発生時に許容できるデータ損失の最大期間です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-185">**Recovery point objective** (RPO) is the maximum duration of data loss that is acceptable during a disaster.</span></span> <span data-ttu-id="dbe0b-186">たとえば、単一のデータベースにデータを格納し、他のデータベースへのレプリケーションなしで、毎時のバックアップを実行する場合、最大 1 時間のデータを失う可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-186">For example, if you store data in a single database, with no replication to other databases, and perform hourly backups, you could lose up to an hour of data.</span></span>

<span data-ttu-id="dbe0b-187">RTO と RPO はシステムの機能要件ではありません。これらはビジネス要件によって決定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-187">RTO and RPO are non-functional requirements of a system, and should be dictated by business requirements.</span></span> <span data-ttu-id="dbe0b-188">これらの値を得るためにリスク評価を実施し、ダウンタイムまたはデータ損失のコストを明確に理解しておくことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-188">To derive these values, it's a good idea to conduct a risk assessment, and clearly understanding the cost of downtime or data loss.</span></span>

### <a name="mttr-and-mtbf"></a><span data-ttu-id="dbe0b-189">MTTR と MTBF</span><span class="sxs-lookup"><span data-stu-id="dbe0b-189">MTTR and MTBF</span></span>

<span data-ttu-id="dbe0b-190">可用性を測定するためのその他の一般的な 2 つのメジャーとして、平均復旧時間 (MTTR) と平均故障間隔 (MTBF) があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-190">Two other common measures of availability are mean time to recover (MTTR) and mean time between failures (MTBF).</span></span> <span data-ttu-id="dbe0b-191">通常、これらのメジャーは、サービス プロバイダーがクラウド サービスに冗長性を追加する場所や顧客に提供する SLA を決定するために内部的に使用します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-191">These measures are usually used internally by service providers to determine where to add redundancy to cloud services, and which SLAs to provide to customers.</span></span>

<span data-ttu-id="dbe0b-192">**平均復旧時間** (MTTR) とは、障害発生後にコンポーネントを復旧するためにかかる平均時間です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-192">**Mean time to recover** (MTTR) is the average time that it takes to restore a component after a failure.</span></span> <span data-ttu-id="dbe0b-193">MTTR は、コンポーネントに関する経験的事実です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-193">MTTR is an empirical fact about a component.</span></span> <span data-ttu-id="dbe0b-194">各コンポーネントの MTTR に基づいて、アプリケーション全体の MTTR を見積もることができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-194">Based on the MTTR of each component, you can estimate the MTTR of an entire application.</span></span> <span data-ttu-id="dbe0b-195">MTTR 値が低い複数のコンポーネントでアプリケーションを構築すると、総合的な MTTR が低いアプリケーション、つまり障害からすばやく回復するアプリケーションを実現できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-195">Building applications from multiple components with low MTTR values results in an application with a low overall MTTR &mdash; one that recovers quickly from failures.</span></span>

<span data-ttu-id="dbe0b-196">**平均故障間隔**(MTBF) とは、次の障害が発生するまでに合理的に予期されるコンポーネントの稼働時間です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-196">**Mean time between failures** (MTBF) is the runtime that a component can reasonably expect to last between outages.</span></span> <span data-ttu-id="dbe0b-197">このメトリックは、サービスが利用不可になる頻度を計算するために役立ちます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-197">This metric can help you to calculate how frequently a service will become unavailable.</span></span> <span data-ttu-id="dbe0b-198">信頼性の低いコンポーネントでは MTBF が低いため、そのコンポーネントに対する SLA の数値は低くなります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-198">An unreliable component has a low MTBF, resulting in a low SLA number for that component.</span></span> <span data-ttu-id="dbe0b-199">ただし、MTBF の低さは、コンポーネントの複数のインスタンスをデプロイし、それらの間でフェールオーバーを実装することで軽減できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-199">However, a low MTBF can be mitigated by deploying multiple instances of the component and implementing failover between them.</span></span>

> [!NOTE]
> <span data-ttu-id="dbe0b-200">高可用性セットアップ内のコンポーネントの MTTR 値のいずれかがシステムの RTO を超えている場合、システムの障害によって容認できないビジネス上の中断が発生します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-200">If ANY of the MTTR values of components in a high-availability setup exceed the RTO of the system, then a failure in the system will cause an unacceptable business disruption.</span></span> <span data-ttu-id="dbe0b-201">定義されている RTO 内でシステムを復旧させることができなくなります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-201">It won't be possible to restore the system within the defined RTO.</span></span>

### <a name="slas"></a><span data-ttu-id="dbe0b-202">SLA</span><span class="sxs-lookup"><span data-stu-id="dbe0b-202">SLAs</span></span>

<span data-ttu-id="dbe0b-203">Azure の[サービス レベル アグリーメント][sla] (SLA) では、稼働時間と接続性に関する Microsoft のコミットメントが示されています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-203">In Azure, the [Service Level Agreement][sla] (SLA) describes Microsoft’s commitments for uptime and connectivity.</span></span> <span data-ttu-id="dbe0b-204">特定のサービスの SLA が 99.9% の場合は、そのサービスを 99.9% の確率で使用可能だと予想できることを意味します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-204">If the SLA for a particular service is 99.9%, it means you should expect the service to be available 99.9% of the time.</span></span>

> [!NOTE]
> <span data-ttu-id="dbe0b-205">また、Azure SLA には、SLA が満たされない場合にサービス クレジットを取得するための規定と、各サービスの "可用性" の詳細な定義も含まれています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-205">The Azure SLA also includes provisions for obtaining a service credit if the SLA is not met, along with specific definitions of "availability" for each service.</span></span> <span data-ttu-id="dbe0b-206">SLA のこの側面は、強制ポリシーとして機能します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-206">That aspect of the SLA acts as an enforcement policy.</span></span>

<span data-ttu-id="dbe0b-207">お客様のソリューションの各ワークロードには、独自の目標 SLA を定義することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-207">You should define your own target SLAs for each workload in your solution.</span></span> <span data-ttu-id="dbe0b-208">SLA があると、アーキテクチャがビジネス要件を満たしているかどうかを評価できるようになります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-208">An SLA makes it possible to evaluate whether the architecture meets the business requirements.</span></span> <span data-ttu-id="dbe0b-209">依存関係マッピングの操作を実行して、Active Directory または支払プロバイダーや電子メール メッセージ サービスのようなサード パーティのサービスなど、内部および外部の依存関係を特定します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-209">Perform a dependency mapping exercise to identify internal and external dependencies, such as Active Directory or third-party services such as a payment provider or e-mail messaging service.</span></span> <span data-ttu-id="dbe0b-210">特に、単一障害点になったり、イベントの間にボトルネックを生じさせたりする可能性がある外部の依存関係には、注意を払ってください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-210">In particular, pay attention to any external dependencies that can be single point of failure or cause bottlenecks during an event.</span></span> <span data-ttu-id="dbe0b-211">たとえば、ワークロードのアップタイム要件が 99.99% で、SLA が 99.9% のサービスに依存している場合、そのサービスをシステムの単一障害点にしてはなりません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-211">For example, if a workload requires 99.99% uptime, but depends on a service with a 99.9% SLA, that service cannot be a single-point of failure in the system.</span></span> <span data-ttu-id="dbe0b-212">救済策として、サービスで障害が発生した場合に備えてフォールバック パスを用意するか、そのサービスの障害から復旧する他の措置を実行する方法があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-212">One remedy is to have a fallback path in case the service fails, or take other measures to recover from a failure in that service.</span></span>

<span data-ttu-id="dbe0b-213">次の表は、さまざまな SLA レベルで考えられる累積的なダウンタイムの一覧です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-213">The following table shows the potential cumulative downtime for various SLA levels.</span></span>

| <span data-ttu-id="dbe0b-214">SLA</span><span class="sxs-lookup"><span data-stu-id="dbe0b-214">SLA</span></span> | <span data-ttu-id="dbe0b-215">週あたりのダウンタイム</span><span class="sxs-lookup"><span data-stu-id="dbe0b-215">Downtime per week</span></span> | <span data-ttu-id="dbe0b-216">月あたりのダウンタイム</span><span class="sxs-lookup"><span data-stu-id="dbe0b-216">Downtime per month</span></span> | <span data-ttu-id="dbe0b-217">年あたりのダウンタイム</span><span class="sxs-lookup"><span data-stu-id="dbe0b-217">Downtime per year</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="dbe0b-218">99%</span><span class="sxs-lookup"><span data-stu-id="dbe0b-218">99%</span></span> |<span data-ttu-id="dbe0b-219">1.68 時間</span><span class="sxs-lookup"><span data-stu-id="dbe0b-219">1.68 hours</span></span> |<span data-ttu-id="dbe0b-220">7.2 時間</span><span class="sxs-lookup"><span data-stu-id="dbe0b-220">7.2 hours</span></span> |<span data-ttu-id="dbe0b-221">3.65 日</span><span class="sxs-lookup"><span data-stu-id="dbe0b-221">3.65 days</span></span> |
| <span data-ttu-id="dbe0b-222">99.9%</span><span class="sxs-lookup"><span data-stu-id="dbe0b-222">99.9%</span></span> |<span data-ttu-id="dbe0b-223">10.1 分</span><span class="sxs-lookup"><span data-stu-id="dbe0b-223">10.1 minutes</span></span> |<span data-ttu-id="dbe0b-224">43.2 分</span><span class="sxs-lookup"><span data-stu-id="dbe0b-224">43.2 minutes</span></span> |<span data-ttu-id="dbe0b-225">8.76 時間</span><span class="sxs-lookup"><span data-stu-id="dbe0b-225">8.76 hours</span></span> |
| <span data-ttu-id="dbe0b-226">99.95%</span><span class="sxs-lookup"><span data-stu-id="dbe0b-226">99.95%</span></span> |<span data-ttu-id="dbe0b-227">5 分</span><span class="sxs-lookup"><span data-stu-id="dbe0b-227">5 minutes</span></span> |<span data-ttu-id="dbe0b-228">21.6 分</span><span class="sxs-lookup"><span data-stu-id="dbe0b-228">21.6 minutes</span></span> |<span data-ttu-id="dbe0b-229">4.38 時間</span><span class="sxs-lookup"><span data-stu-id="dbe0b-229">4.38 hours</span></span> |
| <span data-ttu-id="dbe0b-230">99.99%</span><span class="sxs-lookup"><span data-stu-id="dbe0b-230">99.99%</span></span> |<span data-ttu-id="dbe0b-231">1.01 分</span><span class="sxs-lookup"><span data-stu-id="dbe0b-231">1.01 minutes</span></span> |<span data-ttu-id="dbe0b-232">4.32 分</span><span class="sxs-lookup"><span data-stu-id="dbe0b-232">4.32 minutes</span></span> |<span data-ttu-id="dbe0b-233">52.56 分</span><span class="sxs-lookup"><span data-stu-id="dbe0b-233">52.56 minutes</span></span> |
| <span data-ttu-id="dbe0b-234">99.999%</span><span class="sxs-lookup"><span data-stu-id="dbe0b-234">99.999%</span></span> |<span data-ttu-id="dbe0b-235">6 秒</span><span class="sxs-lookup"><span data-stu-id="dbe0b-235">6 seconds</span></span> |<span data-ttu-id="dbe0b-236">25.9 秒</span><span class="sxs-lookup"><span data-stu-id="dbe0b-236">25.9 seconds</span></span> |<span data-ttu-id="dbe0b-237">5.26 分</span><span class="sxs-lookup"><span data-stu-id="dbe0b-237">5.26 minutes</span></span> |

<span data-ttu-id="dbe0b-238">当然ながら高可用性が望ましく、他の項目は同じくらいです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-238">Of course, higher availability is better, everything else being equal.</span></span> <span data-ttu-id="dbe0b-239">ただし、99.99...% の 9 の桁数を増やすにつれて、そのレベルの可用性を実現するためのコストと複雑さは増大します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-239">But as you strive for more 9s, the cost and complexity to achieve that level of availability grows.</span></span> <span data-ttu-id="dbe0b-240">99.99% のアップタイムは、月あたりの合計ダウンタイムの約 5 分に換算されます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-240">An uptime of 99.99% translates to about 5 minutes of total downtime per month.</span></span> <span data-ttu-id="dbe0b-241">5 つの 9 (99.999%) を実現するために、複雑さとコストが増大する価値はありますか。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-241">Is it worth the additional complexity and cost to reach five 9s?</span></span> <span data-ttu-id="dbe0b-242">その答えはビジネス要件によって変わります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-242">The answer depends on the business requirements.</span></span>

<span data-ttu-id="dbe0b-243">SLA を定義する場合の他の考慮事項を次に示します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-243">Here are some other considerations when defining an SLA:</span></span>

- <span data-ttu-id="dbe0b-244">4 つの 9 (99.99%) を実現するには、手動操作による障害からの復旧には依存できません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-244">To achieve four 9's (99.99%), you probably can't rely on manual intervention to recover from failures.</span></span> <span data-ttu-id="dbe0b-245">アプリケーションには自己診断機能と自己復旧機能が必要です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-245">The application must be self-diagnosing and self-healing.</span></span>
- <span data-ttu-id="dbe0b-246">4 つの 9 を超えると、SLA を満たすことができるほど迅速に障害を検出することは困難です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-246">Beyond four 9's, it is challenging to detect outages quickly enough to meet the SLA.</span></span>
- <span data-ttu-id="dbe0b-247">SLA を測定する時間枠について考慮します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-247">Think about the time window that your SLA is measured against.</span></span> <span data-ttu-id="dbe0b-248">この時間枠を短くするほど、許容度は厳格になります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-248">The smaller the window, the tighter the tolerances.</span></span> <span data-ttu-id="dbe0b-249">時間単位または日単位のアップタイムという観点で SLA を定義することはおそらく意味がありません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-249">It probably doesn't make sense to define your SLA in terms of hourly or daily uptime.</span></span>
- <span data-ttu-id="dbe0b-250">MTBF と MTTR の測定値を考慮します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-250">Consider the MTBF and MTTR measurements.</span></span> <span data-ttu-id="dbe0b-251">SLA が低ければ低いほど、サービスがダウンする可能性は低くなり、サービスをより短時間で回復させる必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-251">The lower your SLA, the less frequently the service can go down, and the quicker the service must recover.</span></span>

### <a name="composite-slas"></a><span data-ttu-id="dbe0b-252">複合 SLA</span><span class="sxs-lookup"><span data-stu-id="dbe0b-252">Composite SLAs</span></span>

<span data-ttu-id="dbe0b-253">Azure SQL Database に書き込む App Service Web アプリについて検討します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-253">Consider an App Service web app that writes to Azure SQL Database.</span></span> <span data-ttu-id="dbe0b-254">この記事の執筆時点で、このような Azure サービスには次の SLA があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-254">At the time of this writing, these Azure services have the following SLAs:</span></span>

- <span data-ttu-id="dbe0b-255">App Service Web Apps = 99.95%</span><span class="sxs-lookup"><span data-stu-id="dbe0b-255">App Service Web Apps = 99.95%</span></span>
- <span data-ttu-id="dbe0b-256">SQL Database = 99.99%</span><span class="sxs-lookup"><span data-stu-id="dbe0b-256">SQL Database = 99.99%</span></span>

![複合 SLA](./images/sla1.png)

<span data-ttu-id="dbe0b-258">このアプリケーションで予想される最大ダウンタイムはどのくらいですか。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-258">What is the maximum downtime you would expect for this application?</span></span> <span data-ttu-id="dbe0b-259">いずれかのサービスで障害が発生すると、アプリケーション全体で障害が発生します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-259">If either service fails, the whole application fails.</span></span> <span data-ttu-id="dbe0b-260">一般的に、各サービスで障害が発生する可能性は独立しているため、このアプリケーションの複合 SLA は 99.95% &times; 99.99% = 99.94% です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-260">In general, the probability of each service failing is independent, so the composite SLA for this application is 99.95% &times; 99.99% = 99.94%.</span></span> <span data-ttu-id="dbe0b-261">これは個々の SLA よりも低い値です。複数のサービスに依存するアプリケーションは潜在的な障害点が多くなるため、これは驚くことではありません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-261">That's lower than the individual SLAs, which isn't surprising, because an application that relies on multiple services has more potential failure points.</span></span>

<span data-ttu-id="dbe0b-262">一方、複合 SLA を改善するには、独立したフォールバック パスを作成する方法があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-262">On the other hand, you can improve the composite SLA by creating independent fallback paths.</span></span> <span data-ttu-id="dbe0b-263">たとえば、SQL Database が使用できない場合は、後で処理できるようにトランザクションをキューに格納します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-263">For example, if SQL Database is unavailable, put transactions into a queue, to be processed later.</span></span>

![複合 SLA](./images/sla2.png)

<span data-ttu-id="dbe0b-265">この設計の場合、データベースに接続できない場合でも、アプリケーションは使用可能な状態です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-265">With this design, the application is still available even if it can't connect to the database.</span></span> <span data-ttu-id="dbe0b-266">ただし、データベースとキューの両方で同時に障害が発生すると、アプリケーションは使用できなくなります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-266">However, it fails if the database and the queue both fail at the same time.</span></span> <span data-ttu-id="dbe0b-267">同時に障害が発生する時間の予測される割合は 0.0001 &times; 0.001 なので、この組み合わせのパスに関する複合 SLA は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-267">The expected percentage of time for a simultaneous failure is 0.0001 &times; 0.001, so the composite SLA for this combined path is:</span></span>  

- <span data-ttu-id="dbe0b-268">データベース OR キュー = 1.0 &minus; (0.0001 &times; 0.001) = 99.99999%</span><span class="sxs-lookup"><span data-stu-id="dbe0b-268">Database OR queue = 1.0 &minus; (0.0001 &times; 0.001) = 99.99999%</span></span>

<span data-ttu-id="dbe0b-269">合計複合 SLA は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-269">The total composite SLA is:</span></span>

- <span data-ttu-id="dbe0b-270">Web アプリ AND (データベース OR キュー) = 99.95% &times; 99.99999% = 99.95% 以下</span><span class="sxs-lookup"><span data-stu-id="dbe0b-270">Web app AND (database OR queue) = 99.95% &times; 99.99999% = ~99.95%</span></span>

<span data-ttu-id="dbe0b-271">ただし、この方法にはトレードオフがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-271">But there are tradeoffs to this approach.</span></span> <span data-ttu-id="dbe0b-272">アプリケーション ロジックは複雑になり、キューのコストがかかり、データの一貫性に関する問題も考慮が必要になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-272">The application logic is more complex, you are paying for the queue, and there may be data consistency issues to consider.</span></span>

<span data-ttu-id="dbe0b-273">**複数リージョン デプロイの SLA**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-273">**SLA for multi-region deployments**.</span></span> <span data-ttu-id="dbe0b-274">もう 1 つの HA 手法は、アプリケーションを複数のリージョンにデプロイし、1 つのリージョンのアプリケーションで障害が発生した場合にフェールオーバーするように Azure Traffic Manager を使用する方法です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-274">Another HA technique is to deploy the application in more than one region, and use Azure Traffic Manager to fail over if the application fails in one region.</span></span> <span data-ttu-id="dbe0b-275">マルチリージョンのデプロイの場合、複合 SLA は次のように計算されます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-275">For a multi-region deployment, the composite SLA is calculated as follows.</span></span>

<span data-ttu-id="dbe0b-276">1 つのリージョンにデプロイされるアプリケーションの複合 SLA を *N* とし、アプリケーションがデプロイされるリージョンの数を *R* とします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-276">Let *N* be the composite SLA for the application deployed in one region, and *R* be the number of regions where the application is deployed.</span></span> <span data-ttu-id="dbe0b-277">すべてのリージョンでアプリケーションの障害が発生する可能性は ((1 &minus; N) ^ R) と予測されます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-277">The expected chance that the application will fail in all regions at the same time is ((1 &minus; N) ^ R).</span></span>

<span data-ttu-id="dbe0b-278">たとえば、1 つのリージョンの SLA が 99.95% の場合は次のようになります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-278">For example, if the single-region SLA is 99.95%,</span></span>

- <span data-ttu-id="dbe0b-279">2 つのリージョンの複合 SLA = (1 &minus; (1 &minus; 0.9995) ^ 2) = 99.999975%</span><span class="sxs-lookup"><span data-stu-id="dbe0b-279">The combined SLA for two regions = (1 &minus; (1 &minus; 0.9995) ^ 2) = 99.999975%</span></span>
- <span data-ttu-id="dbe0b-280">4 つのリージョンの複合 SLA = (1 &minus; (1 &minus; 0.9995) ^ 4) = 99.999999%</span><span class="sxs-lookup"><span data-stu-id="dbe0b-280">The combined SLA for four regions = (1 &minus; (1 &minus; 0.9995) ^ 4) = 99.999999%</span></span>

<span data-ttu-id="dbe0b-281">[Traffic Manager の SLA][tm-sla] を考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-281">You must also factor in the [SLA for Traffic Manager][tm-sla].</span></span> <span data-ttu-id="dbe0b-282">この記事の執筆時点で Traffic Manager の SLA は 99.99% です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-282">At the time of this writing, the SLA for Traffic Manager SLA is 99.99%.</span></span>

<span data-ttu-id="dbe0b-283">また、アクティブ/パッシブ構成ではフェールオーバーは瞬時に完了しないので、フェールオーバー時にはある程度のダウンタイムが発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-283">Also, failing over is not instantaneous in active-passive configurations, which can result in some downtime during a failover.</span></span> <span data-ttu-id="dbe0b-284">[Traffic Manager エンドポイントの監視とフェールオーバー][tm-failover]に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-284">See [Traffic Manager endpoint monitoring and failover][tm-failover].</span></span>

<span data-ttu-id="dbe0b-285">計算された SLA 値は便利なベースラインですが、可用性のすべてを把握できる訳ではありません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-285">The calculated SLA number is a useful baseline, but it doesn't tell the whole story about availability.</span></span> <span data-ttu-id="dbe0b-286">重要ではないパスで障害が発生した場合、アプリケーションの機能を適切に低下できることがよくあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-286">Often, an application can degrade gracefully when a non-critical path fails.</span></span> <span data-ttu-id="dbe0b-287">書籍のカタログを表示するアプリケーションを例に説明します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-287">Consider an application that shows a catalog of books.</span></span> <span data-ttu-id="dbe0b-288">そのアプリケーションが表紙のサムネイル画像を取得できない場合は、プレース ホルダー イメージを表示することができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-288">If the application can't retrieve the thumbnail image for the cover, it might show a placeholder image.</span></span> <span data-ttu-id="dbe0b-289">この場合、画像を取得できないと、アプリケーションの稼働時間は減りませんが、ユーザー エクスペリエンスには影響が出ます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-289">In that case, failing to get the image does not reduce the application's uptime, although it affects the user experience.</span></span>  

## <a name="design-for-resiliency"></a><span data-ttu-id="dbe0b-290">回復性の設計</span><span class="sxs-lookup"><span data-stu-id="dbe0b-290">Design for resiliency</span></span>

<span data-ttu-id="dbe0b-291">設計フェーズで、障害モードの分析 (FMA) を実行することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-291">During the design phase, you should perform a failure mode analysis (FMA).</span></span> <span data-ttu-id="dbe0b-292">FMA の目標は、潜在的な障害点を特定し、アプリケーションがその障害に対して対応する方法を定義することです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-292">The goal of an FMA is to identify possible points of failure, and define how the application will respond to those failures.</span></span>

- <span data-ttu-id="dbe0b-293">アプリケーションはこのような障害をどのように検出するでしょうか。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-293">How will the application detect this type of failure?</span></span>
- <span data-ttu-id="dbe0b-294">アプリケーションはこのような障害にどのように対応するでしょうか。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-294">How will the application respond to this type of failure?</span></span>
- <span data-ttu-id="dbe0b-295">このような障害のログ記録と監視はどのように行うでしょうか。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-295">How will you log and monitor this type of failure?</span></span>

<span data-ttu-id="dbe0b-296">FMA プロセスの詳細と、Azure 固有の推奨事項については、[Azure 回復性ガイダンスの「障害モードの分析][fma]」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-296">For more information about the FMA process, with specific recommendations for Azure, see [Azure resiliency guidance: Failure mode analysis][fma].</span></span>

### <a name="example-of-identifying-failure-modes-and-detection-strategy"></a><span data-ttu-id="dbe0b-297">障害モードと検出戦略の特定例</span><span class="sxs-lookup"><span data-stu-id="dbe0b-297">Example of identifying failure modes and detection strategy</span></span>

<span data-ttu-id="dbe0b-298">**障害点:** 外部 Web サービス/API の呼び出し。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-298">**Failure point:** Call to an external web service / API.</span></span>

| <span data-ttu-id="dbe0b-299">障害モード</span><span class="sxs-lookup"><span data-stu-id="dbe0b-299">Failure mode</span></span> | <span data-ttu-id="dbe0b-300">検出戦略</span><span class="sxs-lookup"><span data-stu-id="dbe0b-300">Detection strategy</span></span> |
| --- | --- |
| <span data-ttu-id="dbe0b-301">サービスを使用できない</span><span class="sxs-lookup"><span data-stu-id="dbe0b-301">Service is unavailable</span></span> |<span data-ttu-id="dbe0b-302">HTTP 5xx</span><span class="sxs-lookup"><span data-stu-id="dbe0b-302">HTTP 5xx</span></span> |
| <span data-ttu-id="dbe0b-303">Throttling</span><span class="sxs-lookup"><span data-stu-id="dbe0b-303">Throttling</span></span> |<span data-ttu-id="dbe0b-304">HTTP 429 (要求が多すぎます)</span><span class="sxs-lookup"><span data-stu-id="dbe0b-304">HTTP 429 (Too Many Requests)</span></span> |
| <span data-ttu-id="dbe0b-305">Authentication</span><span class="sxs-lookup"><span data-stu-id="dbe0b-305">Authentication</span></span> |<span data-ttu-id="dbe0b-306">HTTP 401 (権限がありません)</span><span class="sxs-lookup"><span data-stu-id="dbe0b-306">HTTP 401 (Unauthorized)</span></span> |
| <span data-ttu-id="dbe0b-307">遅い応答</span><span class="sxs-lookup"><span data-stu-id="dbe0b-307">Slow response</span></span> |<span data-ttu-id="dbe0b-308">要求のタイムアウト</span><span class="sxs-lookup"><span data-stu-id="dbe0b-308">Request times out</span></span> |

### <a name="redundancy-and-designing-for-failure"></a><span data-ttu-id="dbe0b-309">障害のための冗長性と設計</span><span class="sxs-lookup"><span data-stu-id="dbe0b-309">Redundancy and designing for failure</span></span>

<span data-ttu-id="dbe0b-310">障害が及ぼす影響の範囲はさまざまです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-310">Failures can vary in the scope of their impact.</span></span> <span data-ttu-id="dbe0b-311">たとえば、ディスク障害などの一部のハードウェア障害が、1 台のホスト コンピューターに影響を及ぼすことがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-311">Some hardware failures, such as a failed disk, may affect a single host machine.</span></span> <span data-ttu-id="dbe0b-312">障害が発生したネットワーク スイッチが、サーバー ラック全体に影響する場合もあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-312">A failed network switch could affect a whole server rack.</span></span> <span data-ttu-id="dbe0b-313">データセンターの停電など、データセンター全体を中断させる障害はまれです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-313">Less common are failures that disrupt a whole datacenter, such as loss of power in a datacenter.</span></span> <span data-ttu-id="dbe0b-314">ほとんど発生しませんが、リージョン全体が利用できなくなることもあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-314">Rarely, an entire region could become unavailable.</span></span>

<span data-ttu-id="dbe0b-315">アプリケーションの回復性を実現するための 1 つの手段として、冗長性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-315">One of the main ways to make an application resilient is through redundancy.</span></span> <span data-ttu-id="dbe0b-316">ただし、この冗長性は、アプリケーションの設計時に計画しなければなりません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-316">But you need to plan for this redundancy when you design the application.</span></span> <span data-ttu-id="dbe0b-317">また、必要な冗長性のレベルはビジネス要件によって異なります。リージョン障害に備えるために、すべてのアプリケーションにリージョン間での冗長性が必要だとは限りません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-317">Also, the level of redundancy that you need depends on your business requirements &mdash; not every application needs redundancy across regions to guard against a regional outage.</span></span> <span data-ttu-id="dbe0b-318">一般的に、冗長性と信頼性を高めると、コストと複雑さが増すというトレードオフがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-318">In general, there is a tradeoff between greater redundancy and reliability versus higher cost and complexity.</span></span>  

<span data-ttu-id="dbe0b-319">Azure には、個別の VM からリージョン全体まで、あらゆる障害レベルでアプリケーションの冗長性を確保するための機能が複数用意されています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-319">Azure has a number of features to make an application redundant at every level of failure, from an individual VM to an entire region.</span></span>

![Azure の回復性の機能](./images/redundancy.svg)

<span data-ttu-id="dbe0b-321">**単一の VM**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-321">**Single VM**.</span></span> <span data-ttu-id="dbe0b-322">Azure では、単一の VM に対しては[アップタイム SLA](https://azure.microsoft.com/support/legal/sla/virtual-machines) が用意されています </span><span class="sxs-lookup"><span data-stu-id="dbe0b-322">Azure provides an [uptime SLA](https://azure.microsoft.com/support/legal/sla/virtual-machines) for single VMs.</span></span> <span data-ttu-id="dbe0b-323">(VM では、すべてのオペレーティング システム ディスクとデータ ディスク用に Premium Storage が使用されている必要があります)。2 つ以上の VM を実行すると高い SLA を得られますが、ワークロードによっては単一の VM で十分な信頼性が得られる場合もあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-323">(The VM must use premium storage for all Operating System Disks and Data Disks.) Although you can get a higher SLA by running two or more VMs, a single VM may be reliable enough for some workloads.</span></span> <span data-ttu-id="dbe0b-324">ただし、運用環境のワークロードの場合は、2 台以上の VM を使用して冗長性を確保することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-324">For production workloads, however, we recommend using two or more VMs for redundancy.</span></span>

<span data-ttu-id="dbe0b-325">**可用性セット**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-325">**Availability sets**.</span></span> <span data-ttu-id="dbe0b-326">ディスクやネットワーク スイッチの障害など、ローカライズされたハードウェアの障害から保護するには、可用性セットに 2 つ以上の VM をデプロイします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-326">To protect against localized hardware failures, such as a disk or network switch failing, deploy two or more VMs in an availability set.</span></span> <span data-ttu-id="dbe0b-327">可用性セットは、電源とネットワーク スイッチを共有する 2 つ以上の "*障害ドメイン*" で構成されます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-327">An availability set consists of two or more *fault domains* that share a common power source and network switch.</span></span> <span data-ttu-id="dbe0b-328">可用性セットの VM は複数の障害ドメインに分散されるため、ある障害ドメインがハードウェア障害の影響を受けた場合は、ネットワーク トラフィックを他の障害ドメインの VM にルーティングできます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-328">VMs in an availability set are distributed across the fault domains, so if a hardware failure affects one fault domain, network traffic can still be routed the VMs in the other fault domains.</span></span> <span data-ttu-id="dbe0b-329">可用性セットの詳細については、「[Azure での Windows 仮想マシンの可用性の管理](/azure/virtual-machines/windows/manage-availability)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-329">For more information about Availability Sets, see [Manage the availability of Windows virtual machines in Azure](/azure/virtual-machines/windows/manage-availability).</span></span>

<span data-ttu-id="dbe0b-330">**可用性ゾーン**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-330">**Availability zones**.</span></span>  <span data-ttu-id="dbe0b-331">可用性ゾーンとは、Azure リージョンの物理的に独立したゾーンのことです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-331">An Availability Zone is a physically separate zone within an Azure region.</span></span> <span data-ttu-id="dbe0b-332">可用性ゾーンはそれぞれ異なる電源、ネットワーク、および冷却装置を持ちます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-332">Each Availability Zone has a distinct power source, network, and cooling.</span></span> <span data-ttu-id="dbe0b-333">可用性ゾーンに VM をデプロイすると、データセンター全体の障害からアプリケーションを保護するのに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-333">Deploying VMs across availability zones helps to protect an application against datacenter-wide failures.</span></span> <span data-ttu-id="dbe0b-334">Availability Zones は、すべてのリージョンでサポートされているわけではありません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-334">Not all regions support Availability Zones.</span></span> <span data-ttu-id="dbe0b-335">サポートされているリージョンとサービスの一覧については、「[Azure の可用性ゾーンの概要](/azure/availability-zones/az-overview)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-335">For a list of supported regions and services, see [What are Availability Zones in Azure?](/azure/availability-zones/az-overview).</span></span>

<span data-ttu-id="dbe0b-336">デプロイの中で Availability Zones を使用する予定がある場合は、アプリケーションのアーキテクチャとコード ベースでこの構成をサポートできることを最初に確認してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-336">If you are planning to use Availability Zones in your deployment, first validate that your application architecture and code base can support this configuration.</span></span> <span data-ttu-id="dbe0b-337">市販のソフトウェアをデプロイする場合は、ソフトウェア ベンダーに問い合わせて、運用環境にデプロイする前に十分にテストしてください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-337">If you are deploying commercial off-the-shelf software, consult with the software vendor and test adequately before deploying into production.</span></span> <span data-ttu-id="dbe0b-338">アプリケーションでは、状態の管理と、構成されたゾーン内で障害が発生した場合のデータの消失防止が可能である必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-338">An application must be able to maintain state and prevent loss of data during an outage within the configured zone.</span></span> <span data-ttu-id="dbe0b-339">コード ベース内でハード コーディングされたインフラストラクチャ コンポーネントが指定されていない、エラスティックな分散されたインフラストラクチャ上での実行がサポートされる必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-339">The application must support running in an elastic and distributed infrastructure with no hard-coded infrastructure components specified in the code base.</span></span>

<span data-ttu-id="dbe0b-340">**Azure Site Recovery**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-340">**Azure Site Recovery**.</span></span>  <span data-ttu-id="dbe0b-341">ビジネス継続性とディザスター リカバリーのニーズに応じて、Azure 仮想マシンを別の Azure リージョンにレプリケートします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-341">Replicate Azure virtual machines to another Azure region for business continuity and disaster recovery needs.</span></span> <span data-ttu-id="dbe0b-342">コンプライアンスのニーズを満たしていることを確認する定期的な DR ドリルを実施できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-342">You can conduct periodic DR drills to ensure you meet the compliance needs.</span></span> <span data-ttu-id="dbe0b-343">ソース リージョンで障害が発生した場合、アプリケーションを回復できるように、選択したリージョンに指定した設定で VM がレプリケートされます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-343">The VM will be replicated with the specified settings to the selected region so that you can recover your applications in the event of outages in the source region.</span></span> <span data-ttu-id="dbe0b-344">詳細については、[ASR を使用した Azure VM のレプリケート][site-recovery]に関する記事を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-344">For more information, see [Replicate Azure VMs using ASR][site-recovery].</span></span> <span data-ttu-id="dbe0b-345">ここで、お使いのソリューションの RTO と RPO の数値を考慮し、テストの実行時に復旧時間と復旧ポイントがご自身のニーズに適していることを確認します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-345">Consider the RTO and RPO numbers for your solution here and ensure that when testing, the recovery time and recovery point is appropriate for your needs.</span></span>

<span data-ttu-id="dbe0b-346">**ペアになっているリージョン**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-346">**Paired regions**.</span></span> <span data-ttu-id="dbe0b-347">リージョンの障害からアプリケーションを保護するために、複数のリージョンにアプリケーションをデプロイし、Azure Traffic Manager を使用してインターネット トラフィックを異なるリージョンに分散できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-347">To protect an application against a regional outage, you can deploy the application across multiple regions, using Azure Traffic Manager to distribute internet traffic to the different regions.</span></span> <span data-ttu-id="dbe0b-348">各 Azure リージョンは別のリージョンとペアになります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-348">Each Azure region is paired with another region.</span></span> <span data-ttu-id="dbe0b-349">これが[リージョン ペア](/azure/best-practices-availability-paired-regions)になります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-349">Together, these form a [regional pair](/azure/best-practices-availability-paired-regions).</span></span> <span data-ttu-id="dbe0b-350">ブラジル南部を除き、リージョン ペアは、税および法の執行を目的としたデータ常駐要件を満たすために同じ地理的場所に配置されます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-350">With the exception of Brazil South, regional pairs are located within the same geography in order to meet data residency requirements for tax and law enforcement jurisdiction purposes.</span></span>

<span data-ttu-id="dbe0b-351">複数リージョンのアプリケーションを設計する場合、リージョン間のネットワーク待機時間は、リージョン内の待機時間よりも長くなることを考慮してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-351">When you design a multi-region application, take into account that network latency across regions is higher than within a region.</span></span> <span data-ttu-id="dbe0b-352">たとえば、データベースをレプリケートしてフェールオーバーを有効にするときは、リージョン間の非同期データ レプリケーションではなく、リージョン内で同期データ レプリケーションを使用します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-352">For example, if you are replicating a database to enable failover, use synchronous data replication within a region, but asynchronous data replication across regions.</span></span>

<span data-ttu-id="dbe0b-353">ペアになったリージョンを選ぶ場合は、両方のリージョンで Azure サービスが要件になっていることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-353">When you select paired regions, ensure both regions have required Azure services.</span></span> <span data-ttu-id="dbe0b-354">リージョンごとのサービスの一覧については、「[リージョン別の利用可能な製品](https://azure.microsoft.com/global-infrastructure/services/)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-354">For a list of services by region, see [Products available by region](https://azure.microsoft.com/global-infrastructure/services/).</span></span> <span data-ttu-id="dbe0b-355">RPO/RTO が短い場合には特に、ディザスター リカバリーのために適切なデプロイ トポロジを選択することも重要です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-355">It's also critical to select the right deployment topology for disaster recovery, especially if your RPO/RTO are short.</span></span> <span data-ttu-id="dbe0b-356">フェールオーバー リージョンにおいて、お使いのワークロードをサポートするだけの十分な容量が確実に保持できるように、アクティブ/パッシブ (完全なレプリカ) トポロジまたはアクティブ/アクティブ トポロジのどちらかを選択します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-356">To ensure the failover region has enough capacity to support your workload, select either an active/passive (full replica) topology or an active/active topology.</span></span> <span data-ttu-id="dbe0b-357">これらのデプロイ トポロジは、セカンダリ リージョン内のリソースが事前にプロビジョニングされることから複雑さとコストが増す場合があり、アイドル状態になる可能性があることを念頭に置いてください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-357">Keep in mind these deployment topologies might increase complexity and cost as resources in the secondary region are pre-provisioned and may sit idle.</span></span> <span data-ttu-id="dbe0b-358">詳しくは、[ディザスター リカバリーのデプロイ トポロジ][deployment-topologies]に関するページをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-358">For more information, see [Deployment topologies for disaster recovery][deployment-topologies]</span></span>

| &nbsp; | <span data-ttu-id="dbe0b-359">可用性セット</span><span class="sxs-lookup"><span data-stu-id="dbe0b-359">Availability Set</span></span> | <span data-ttu-id="dbe0b-360">可用性ゾーン</span><span class="sxs-lookup"><span data-stu-id="dbe0b-360">Availability Zone</span></span> | <span data-ttu-id="dbe0b-361">Azure Site Recovery/ペアのリージョン</span><span class="sxs-lookup"><span data-stu-id="dbe0b-361">Azure Site Recovery/Paired region</span></span> |
|--------|------------------|-------------------|---------------|
| <span data-ttu-id="dbe0b-362">障害の範囲</span><span class="sxs-lookup"><span data-stu-id="dbe0b-362">Scope of failure</span></span> | <span data-ttu-id="dbe0b-363">ラック</span><span class="sxs-lookup"><span data-stu-id="dbe0b-363">Rack</span></span> | <span data-ttu-id="dbe0b-364">データセンター</span><span class="sxs-lookup"><span data-stu-id="dbe0b-364">Datacenter</span></span> | <span data-ttu-id="dbe0b-365">リージョン</span><span class="sxs-lookup"><span data-stu-id="dbe0b-365">Region</span></span> |
| <span data-ttu-id="dbe0b-366">要求のルーティング</span><span class="sxs-lookup"><span data-stu-id="dbe0b-366">Request routing</span></span> | <span data-ttu-id="dbe0b-367">Load Balancer</span><span class="sxs-lookup"><span data-stu-id="dbe0b-367">Load Balancer</span></span> | <span data-ttu-id="dbe0b-368">クロスゾーン ロード バランサー</span><span class="sxs-lookup"><span data-stu-id="dbe0b-368">Cross-zone Load Balancer</span></span> | <span data-ttu-id="dbe0b-369">Traffic Manager</span><span class="sxs-lookup"><span data-stu-id="dbe0b-369">Traffic Manager</span></span> |
| <span data-ttu-id="dbe0b-370">ネットワーク待ち時間</span><span class="sxs-lookup"><span data-stu-id="dbe0b-370">Network latency</span></span> | <span data-ttu-id="dbe0b-371">非常に低い</span><span class="sxs-lookup"><span data-stu-id="dbe0b-371">Very low</span></span> | <span data-ttu-id="dbe0b-372">低</span><span class="sxs-lookup"><span data-stu-id="dbe0b-372">Low</span></span> | <span data-ttu-id="dbe0b-373">中～高</span><span class="sxs-lookup"><span data-stu-id="dbe0b-373">Mid to high</span></span> |
| <span data-ttu-id="dbe0b-374">仮想ネットワーク</span><span class="sxs-lookup"><span data-stu-id="dbe0b-374">Virtual network</span></span>  | <span data-ttu-id="dbe0b-375">VNet</span><span class="sxs-lookup"><span data-stu-id="dbe0b-375">VNet</span></span> | <span data-ttu-id="dbe0b-376">VNet</span><span class="sxs-lookup"><span data-stu-id="dbe0b-376">VNet</span></span> | <span data-ttu-id="dbe0b-377">リージョン間 VNet ピアリング</span><span class="sxs-lookup"><span data-stu-id="dbe0b-377">Cross-region VNet peering</span></span> |

## <a name="implement-resiliency-strategies"></a><span data-ttu-id="dbe0b-378">回復性戦略を実装する</span><span class="sxs-lookup"><span data-stu-id="dbe0b-378">Implement resiliency strategies</span></span>

<span data-ttu-id="dbe0b-379">ここでは、一般的な回復性戦略の調査について説明します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-379">This section provides a survey of some common resiliency strategies.</span></span> <span data-ttu-id="dbe0b-380">ほとんどの項目は特定のテクノロジに限定されていません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-380">Most of these are not limited to a particular technology.</span></span> <span data-ttu-id="dbe0b-381">このセクションの説明では、各手法の背後にある一般的な考えをまとめ、詳細なドキュメントのリンクを紹介しています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-381">The descriptions in this section summarize the general idea behind each technique, with links to further reading.</span></span>

<span data-ttu-id="dbe0b-382">**一時的な障害を再試行する**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-382">**Retry transient failures**.</span></span> <span data-ttu-id="dbe0b-383">一時的な障害は、ネットワーク接続の一時的な喪失、データベース接続の欠落、またはサービスがビジー状態のときのタイムアウトが原因で発生します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-383">Transient failures can be caused by momentary loss of network connectivity, a dropped database connection, or a timeout when a service is busy.</span></span> <span data-ttu-id="dbe0b-384">多くの場合、一時的な障害は、要求を再試行するだけで解決できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-384">Often, a transient failure can be resolved simply by retrying the request.</span></span> <span data-ttu-id="dbe0b-385">多くの Azure サービスでは、クライアント SDK が呼び出し元には認識されない方法の自動再試行を実装しています。詳細については、[サービス固有の再試行ガイダンス][retry-service-specific guidance]に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-385">For many Azure services, the client SDK implements automatic retries, in a way that is transparent to the caller; see [Retry service specific guidance][retry-service-specific guidance].</span></span>

<span data-ttu-id="dbe0b-386">再試行ごとに、合計待機時間が追加されます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-386">Each retry attempt adds to the total latency.</span></span> <span data-ttu-id="dbe0b-387">また、失敗した要求が多すぎると、保留中の要求がキューに蓄積されるため、ボトルネックの原因になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-387">Also, too many failed requests can cause a bottleneck, as pending requests accumulate in the queue.</span></span> <span data-ttu-id="dbe0b-388">これらのブロックされた要求が重要なシステム リソース (メモリ、しきい値、データベース接続など) を保持することで、障害が連鎖する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-388">These blocked requests might hold critical system resources such as memory, threads, database connections, and so on, which can cause cascading failures.</span></span> <span data-ttu-id="dbe0b-389">この問題を回避するために、再試行間隔を長くして、失敗した要求の合計数を制限します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-389">To avoid this, increase the delay between each retry attempt, and limit the total number of failed requests.</span></span>

![再試行の図](./images/retry.png)

<span data-ttu-id="dbe0b-391">**インスタンス間で負荷分散する**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-391">**Load balance across instances**.</span></span> <span data-ttu-id="dbe0b-392">スケーラビリティのために、インスタンス数を増やしてクラウド アプリケーションをスケールアウトすることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-392">For scalability, a cloud application should be able to scale out by adding more instances.</span></span> <span data-ttu-id="dbe0b-393">この方法では、正常ではないインスタンスをローテーションから除去できるため、回復性も改善されます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-393">This approach also improves resiliency, because unhealthy instances can be removed from rotation.</span></span> <span data-ttu-id="dbe0b-394">例: </span><span class="sxs-lookup"><span data-stu-id="dbe0b-394">For example:</span></span>

- <span data-ttu-id="dbe0b-395">複数の VM をロード バランサーの内側に配置します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-395">Put two or more VMs behind a load balancer.</span></span> <span data-ttu-id="dbe0b-396">ロード バランサーはトラフィックをすべての VM に分散します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-396">The load balancer distributes traffic to all the VMs.</span></span> <span data-ttu-id="dbe0b-397">「[Run load-balanced VMs for scalability and availability][ra-multi-vm]」(スケーラビリティと可用性のために負荷分散された VM を実行する) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-397">See [Run load-balanced VMs for scalability and availability][ra-multi-vm].</span></span>
- <span data-ttu-id="dbe0b-398">Azure App Service アプリを複数インスタンスにスケールアウトします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-398">Scale out an Azure App Service app to multiple instances.</span></span> <span data-ttu-id="dbe0b-399">App Service は自動的にインスタンス全体に負荷を分散します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-399">App Service automatically balances load across instances.</span></span> <span data-ttu-id="dbe0b-400">「[Basic web application][ra-basic-web]」(基本的な Web アプリケーション) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-400">See [Basic web application][ra-basic-web].</span></span>
- <span data-ttu-id="dbe0b-401">[Azure Traffic Manager][tm] を使用して、一連のエンドポイント全体でトラフィックを分散します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-401">Use [Azure Traffic Manager][tm] to distribute traffic across a set of endpoints.</span></span>

<span data-ttu-id="dbe0b-402">**データをレプリケートする**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-402">**Replicate data**.</span></span> <span data-ttu-id="dbe0b-403">データのレプリケートは、データ ストアの一時的ではない障害を処理する場合の一般的な戦略です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-403">Replicating data is a general strategy for handling non-transient failures in a data store.</span></span> <span data-ttu-id="dbe0b-404">Azure Storage、Azure SQL Database、Cosmos DB、Apache Cassandra など、多くのストレージ テクノロジにはレプリケーション機能が組み込まれています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-404">Many storage technologies provide built-in replication, including Azure Storage, Azure SQL Database, Cosmos DB, and Apache Cassandra.</span></span> <span data-ttu-id="dbe0b-405">読み取りパスと書き込みパスの両方を考慮することが重要です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-405">It's important to consider both the read and write paths.</span></span> <span data-ttu-id="dbe0b-406">戦略テクノロジに応じて、複数の書き込み可能なレプリカ、または単一の書き込み可能なレプリカと複数の読み取り専用レプリカを用意する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-406">Depending on the storage technology, you might have multiple writable replicas, or a single writable replica and multiple read-only replicas.</span></span>

<span data-ttu-id="dbe0b-407">可用性を最大限にするために、レプリカを複数のリージョンに配置する方法もあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-407">To maximize availability, replicas can be placed in multiple regions.</span></span> <span data-ttu-id="dbe0b-408">ただし、データをレプリケートすると待機時間が長くなります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-408">However, this increases the latency when replicating the data.</span></span> <span data-ttu-id="dbe0b-409">通常、複数リージョンをまたがるレプリケートは非同期に行われます。これは最終的な整合性モデルであり、レプリカで障害が発生した場合にはデータ損失が発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-409">Typically, replicating across regions is done asynchronously, which implies an eventual consistency model and potential data loss if a replica fails.</span></span>

<span data-ttu-id="dbe0b-410">[Azure Site Recovery][site-recovery] を使用して、異なる Azure リージョン間で Azure 仮想マシンをレプリケートします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-410">You can use [Azure Site Recovery][site-recovery] to replicate Azure virtual machines from one region to another region.</span></span> <span data-ttu-id="dbe0b-411">Site Recovery では、ターゲット リージョンに、データが継続的にレプリケートされます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-411">Site Recovery replicates data continuously to the target region.</span></span> <span data-ttu-id="dbe0b-412">プライマリ サイトで障害が発生した場合は、セカンダリ ロケーションにフェールオーバーします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-412">When an outage occurs at your primary site, you fail over to secondary location</span></span>

<span data-ttu-id="dbe0b-413">**潔く機能を減らす**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-413">**Degrade gracefully**.</span></span> <span data-ttu-id="dbe0b-414">サービスで障害が発生し、フェールオーバー パスがない場合、許容範囲のユーザー エクスペリエンスを提供した状態で、アプリケーションの機能を適切に低下させることができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-414">If a service fails and there is no failover path, the application may be able to degrade gracefully while still providing an acceptable user experience.</span></span> <span data-ttu-id="dbe0b-415">例: </span><span class="sxs-lookup"><span data-stu-id="dbe0b-415">For example:</span></span>

- <span data-ttu-id="dbe0b-416">作業項目を後で処理できるようにキューに格納します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-416">Put a work item on a queue, to be handled later.</span></span>
- <span data-ttu-id="dbe0b-417">予測値を返します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-417">Return an estimated value.</span></span>
- <span data-ttu-id="dbe0b-418">ローカルにキャッシュされたデータを使用します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-418">Use locally cached data.</span></span>
- <span data-ttu-id="dbe0b-419">ユーザーにエラー メッセージを表示します</span><span class="sxs-lookup"><span data-stu-id="dbe0b-419">Show the user an error message.</span></span> <span data-ttu-id="dbe0b-420">(この選択肢は、アプリケーションが要求への応答を停止するよりも優れています)。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-420">(This option is better than having the application stop responding to requests.)</span></span>

<span data-ttu-id="dbe0b-421">**高負荷のユーザーを調整する**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-421">**Throttle high-volume users**.</span></span> <span data-ttu-id="dbe0b-422">少数のユーザーが過剰な負荷を発生させることがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-422">Sometimes a small number of users create excessive load.</span></span> <span data-ttu-id="dbe0b-423">その結果、他のユーザーに影響が及び、アプリケーションの全体的な可用性が低くなる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-423">That can have an impact on other users, reducing the overall availability of your application.</span></span>

<span data-ttu-id="dbe0b-424">単一のクライアントが大量の要求を行った場合、一定期間、アプリケーションはクライアントを調整することができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-424">When a single client makes an excessive number of requests, the application might throttle the client for a certain period of time.</span></span> <span data-ttu-id="dbe0b-425">この調整期間、(詳細な調整戦略に基づいて) アプリケーションはそのクライアントからの要求の一部またはすべてを拒否します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-425">During the throttling period, the application refuses some or all of the requests from that client (depending on the exact throttling strategy).</span></span> <span data-ttu-id="dbe0b-426">調整のしきい値は、ユーザーのサービス レベルによって変わる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-426">The threshold for throttling might depend on the customer's service tier.</span></span>

<span data-ttu-id="dbe0b-427">調整は、クライアントが悪意を持って実行している場合に限定されません。サービス クォータを超えたというだけの理由で行われます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-427">Throttling does not imply the client was necessarily acting maliciously, only that it exceeded its service quota.</span></span> <span data-ttu-id="dbe0b-428">場合によっては、コンシューマーが常にクォータを超えているか、動作が正しくない可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-428">In some cases, a consumer might consistently exceed their quota or otherwise behave badly.</span></span> <span data-ttu-id="dbe0b-429">この場合は、さらにユーザーをブロックすることがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-429">In that case, you might go further and block the user.</span></span> <span data-ttu-id="dbe0b-430">通常、このブロックを行うには、API キーまたは IP アドレス範囲をブロックします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-430">Typically, this is done by blocking an API key or an IP address range.</span></span> <span data-ttu-id="dbe0b-431">詳細については、「[Throttling pattern][throttling-pattern]」(調整パターン) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-431">For more information, see [Throttling Pattern][throttling-pattern].</span></span>

<span data-ttu-id="dbe0b-432">**サーキット ブレーカーを使用する**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-432">**Use a circuit breaker**.</span></span> <span data-ttu-id="dbe0b-433">[サーキット ブレーカー][circuit-breaker-pattern] パターンを使用すると、失敗する可能性のある操作がアプリケーションで繰り返し再試行されるのを回避できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-433">The [Circuit Breaker][circuit-breaker-pattern] pattern can prevent an application from repeatedly trying an operation that is likely to fail.</span></span> <span data-ttu-id="dbe0b-434">サーキット ブレーカーはサービスの呼び出しをラップし、最近発生したエラーの数を追跡します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-434">The circuit breaker wraps calls to a service and tracks the number of recent failures.</span></span> <span data-ttu-id="dbe0b-435">エラーの数がしきい値を超えると、サーキット ブレーカーはサービスを呼び出さずに、エラー コードを返し始めます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-435">If the failure count exceeds a threshold, the circuit breaker starts returning an error code without calling the service.</span></span> <span data-ttu-id="dbe0b-436">これにより、サービスが復旧するための時間が確保されます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-436">This gives the service time to recover.</span></span>

<span data-ttu-id="dbe0b-437">**負荷平準化を使用してトラフィックの急増をなくす**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-437">**Use load leveling to smooth out spikes in traffic**.</span></span>
<span data-ttu-id="dbe0b-438">アプリケーションではトラフィックの急増が起きることがあり、これがバックエンドのサービスに大きな負荷をかけることがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-438">Applications may experience sudden spikes in traffic, which can overwhelm services on the backend.</span></span> <span data-ttu-id="dbe0b-439">バックエンド サービスが要求にすばやく応答できない場合、要求がキューに格納されることや (バックアップ)、サービスによってアプリケーションが調整されることがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-439">If a backend service cannot respond to requests quickly enough, it may cause requests to queue (back up), or cause the service to throttle the application.</span></span> <span data-ttu-id="dbe0b-440">この状況を回避するために、バッファーとしてキューを使用することができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-440">To avoid this, you can use a queue as a buffer.</span></span> <span data-ttu-id="dbe0b-441">新しい作業項目がある場合、バックエンド サービスを即時に呼び出すのではなく、アプリケーションで作業項目をキューに格納して非同期に実行します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-441">When there is a new work item, instead of calling the backend service immediately, the application queues a work item to run asynchronously.</span></span> <span data-ttu-id="dbe0b-442">キューは、負荷のピークを平準化するバッファーとして機能します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-442">The queue acts as a buffer that smooths out peaks in the load.</span></span> <span data-ttu-id="dbe0b-443">詳細については、[Queue-Based Load Leveling パターン][load-leveling-pattern]に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-443">For more information, see [Queue-Based Load Leveling Pattern][load-leveling-pattern].</span></span>

<span data-ttu-id="dbe0b-444">**重要なリソースを分離する**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-444">**Isolate critical resources**.</span></span> <span data-ttu-id="dbe0b-445">1 つのサブシステムで複数の障害が連鎖し、アプリケーションの他の部分で障害が発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-445">Failures in one subsystem can sometimes cascade, causing failures in other parts of the application.</span></span> <span data-ttu-id="dbe0b-446">これが起きるのは、障害によってスレッドやソケットなどのリソースが適切なタイミングで解放されない場合で、リソースの消費につながります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-446">This can happen if a failure causes some resources, such as threads or sockets, not to get freed in a timely manner, leading to resource exhaustion.</span></span>

<span data-ttu-id="dbe0b-447">これを回避するには、システムを分離グループにパーティション分割して、1 つのパーティションでの障害がシステム全体をダウンさせないようにします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-447">To avoid this, you can partition a system into isolated groups, so that a failure in one partition does not bring down the entire system.</span></span> <span data-ttu-id="dbe0b-448">この手法は、[バルクヘッド パターン][bulkhead-pattern]と呼ばれることもあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-448">This technique is sometimes called the [Bulkhead pattern][bulkhead-pattern].</span></span>

<span data-ttu-id="dbe0b-449">次に例を示します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-449">Examples:</span></span>

- <span data-ttu-id="dbe0b-450">データベースをパーティション分割し (テナント別など)、各パーティションに Web サーバー インスタンスの別プールを割り当てます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-450">Partition a database (for example, by tenant) and assign a separate pool of web server instances for each partition.</span></span>  
- <span data-ttu-id="dbe0b-451">個別のスレッド プールを使用して、異なるサービスの呼び出しを分離します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-451">Use separate thread pools to isolate calls to different services.</span></span> <span data-ttu-id="dbe0b-452">こうすることで、いずれかのサービスで障害が発生した場合の障害の連鎖を回避できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-452">This helps to prevent cascading failures if one of the services fails.</span></span> <span data-ttu-id="dbe0b-453">例については、Netflix の [Hystrix ライブラリ][hystrix]を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-453">For an example, see the Netflix [Hystrix library][hystrix].</span></span>
- <span data-ttu-id="dbe0b-454">[コンテナー][containers]を使用して、特定のサブシステムに使用できるリソースを制限します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-454">Use [containers][containers] to limit the resources available to a particular subsystem.</span></span>

![バルクヘッド パターンの図](./images/bulkhead.png)

<span data-ttu-id="dbe0b-456">**補正トランザクションを適用する**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-456">**Apply compensating transactions**.</span></span> <span data-ttu-id="dbe0b-457">[補正トランザクション][compensating-transaction-pattern]は、別の完了したトランザクションの影響を元に戻すトランザクションです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-457">A [compensating transaction][compensating-transaction-pattern] is a transaction that undoes the effects of another completed transaction.</span></span> <span data-ttu-id="dbe0b-458">分散システムでは、厳密なトランザクションの一貫性を実現することが非常に困難な可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-458">In a distributed system, it can be very difficult to achieve strong transactional consistency.</span></span> <span data-ttu-id="dbe0b-459">補正トランザクションは、各手順で元に戻すことができる一連の小規模な個別トランザクションを使用することで、一貫性を実現する方法です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-459">Compensating transactions are a way to achieve consistency by using a series of smaller, individual transactions that can be undone at each step.</span></span>

<span data-ttu-id="dbe0b-460">たとえば、旅行を予約する場合、ユーザーは車、ホテルの客室、航空便を予約する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-460">For example, to book a trip, a customer might reserve a car, a hotel room, and a flight.</span></span> <span data-ttu-id="dbe0b-461">これらいずれかの手順に失敗した場合、操作全体が失敗します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-461">If any of these steps fails, the entire operation fails.</span></span> <span data-ttu-id="dbe0b-462">操作全体に単一の分散トランザクションを使用するのではなく、各手順に補正トランザクションを定義することができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-462">Instead of trying to use a single distributed transaction for the entire operation, you can define a compensating transaction for each step.</span></span> <span data-ttu-id="dbe0b-463">たとえば、車の予約を元に戻すには、予約を取り消します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-463">For example, to undo a car reservation, you cancel the reservation.</span></span> <span data-ttu-id="dbe0b-464">操作全体を完了するために、コーディネーターは各手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-464">In order to complete the whole operation, a coordinator executes each step.</span></span> <span data-ttu-id="dbe0b-465">いずれかの手順が失敗すると、コーディネーターは補正トランザクションを適用し、完了したすべての手順を元に戻します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-465">If any step fails, the coordinator applies compensating transactions to undo any steps that were completed.</span></span>

## <a name="test-for-resiliency"></a><span data-ttu-id="dbe0b-466">回復性のテスト</span><span class="sxs-lookup"><span data-stu-id="dbe0b-466">Test for resiliency</span></span>

<span data-ttu-id="dbe0b-467">一般的に、アプリケーション機能のテストと同じ方法 (単体テストの実行など) で回復性をテストすることはできません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-467">Generally, you can't test resiliency in the same way that you test application functionality (by running unit tests and so on).</span></span> <span data-ttu-id="dbe0b-468">代わりに、断続的にのみ発生する障害条件下で、エンドツーエンドのワークロードが動作する方法をテストする必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-468">Instead, you must test how the end-to-end workload performs under failure conditions which only occur intermittently.</span></span>

<span data-ttu-id="dbe0b-469">テストは反復的なプロセスです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-469">Testing is an iterative process.</span></span> <span data-ttu-id="dbe0b-470">アプリケーションをテストし、結果を測定し、結果のすべてのエラーを分析して対応し、プロセスを繰り返します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-470">Test the application, measure the outcome, analyze and address any failures that result, and repeat the process.</span></span>

<span data-ttu-id="dbe0b-471">**フォールト挿入テスト**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-471">**Fault injection testing**.</span></span> <span data-ttu-id="dbe0b-472">実際のエラーをトリガーするまたはシミュレートすることによって、システムの障害への回復性をテストすることができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-472">Test the resiliency of the system during failures, either by triggering actual failures or by simulating them.</span></span> <span data-ttu-id="dbe0b-473">テストされる一般的な障害シナリオを次に示します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-473">Here are some common failure scenarios to test:</span></span>

- <span data-ttu-id="dbe0b-474">VM インスタンスのシャットダウン。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-474">Shut down VM instances.</span></span>
- <span data-ttu-id="dbe0b-475">プロセスのクラッシュ。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-475">Crash processes.</span></span>
- <span data-ttu-id="dbe0b-476">証明書の期限切れ。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-476">Expire certificates.</span></span>
- <span data-ttu-id="dbe0b-477">アクセス キーの変更。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-477">Change access keys.</span></span>
- <span data-ttu-id="dbe0b-478">ドメイン コントローラー上の DNS サービスのシャットダウン。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-478">Shut down the DNS service on domain controllers.</span></span>
- <span data-ttu-id="dbe0b-479">RAM やスレッド数など、使用可能なシステム リソースの制限。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-479">Limit available system resources, such as RAM or number of threads.</span></span>
- <span data-ttu-id="dbe0b-480">ディスクのマウント解除。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-480">Unmount disks.</span></span>
- <span data-ttu-id="dbe0b-481">VM の再デプロイ。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-481">Redeploy a VM.</span></span>

<span data-ttu-id="dbe0b-482">回復時間を測定し、ビジネス要件を満たしていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-482">Measure the recovery times and verify that your business requirements are met.</span></span> <span data-ttu-id="dbe0b-483">障害モードの組み合わせもテストします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-483">Test combinations of failure modes as well.</span></span> <span data-ttu-id="dbe0b-484">障害が連鎖しないこと、分離された方法で処理されることを確認します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-484">Make sure that failures don't cascade, and are handled in an isolated way.</span></span>

<span data-ttu-id="dbe0b-485">これが、設計フェーズで潜在的な障害点を分析することが重要なもう 1 つの理由です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-485">This is another reason why it's important to analyze possible failure points during the design phase.</span></span> <span data-ttu-id="dbe0b-486">この分析結果をテスト計画に反映させることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-486">The results of that analysis should be inputs into your test plan.</span></span>

<span data-ttu-id="dbe0b-487">**ロード テスト**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-487">**Load testing**.</span></span> <span data-ttu-id="dbe0b-488">ロード テストは、過負荷状態またはサービスの調整が行われているバックエンド データベースなど、負荷がかかった状態でのみ発生する障害を特定するために重要です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-488">Load testing is crucial for identifying failures that only happen under load, such as the backend database being overwhelmed or service throttling.</span></span> <span data-ttu-id="dbe0b-489">運用データまたは運用データに可能な限り近い総合的なデータを使用して、ピーク負荷の場合をテストします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-489">Test for peak load, using production data or synthetic data that is as close to production data as possible.</span></span> <span data-ttu-id="dbe0b-490">目標は、実際の条件下でアプリケーションがどのように動作するかを確認することです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-490">The goal is to see how the application behaves under real-world conditions.</span></span>

<span data-ttu-id="dbe0b-491">**ディザスター リカバリーの訓練**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-491">**Disaster recovery drills**.</span></span> <span data-ttu-id="dbe0b-492">優れたディザスター リカバリー プランを策定しただけでは不十分です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-492">It is not enough if you have a good disaster recovery plan in place.</span></span> <span data-ttu-id="dbe0b-493">問題が発生したときに復旧計画が適切に機能することを確認するために、定期的にテストを行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-493">You need to test it periodically to ensure your recovery plan works fine when it matters.</span></span> <span data-ttu-id="dbe0b-494">Azure 仮想マシンについては、[Azure Site Recovery][site-recovery] を使用することで、運用アプリケーションや進行中のレプリケーションに影響を与えることなく、レプリケーションおよび [DR 訓練を実施][site-recovery-test-failover]できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-494">For Azure virtual machines, you can use [Azure Site Recovery][site-recovery] to replicate and [perform DR drills][site-recovery-test-failover] without affecting production applications or ongoing replication.</span></span>

## <a name="deploy-using-reliable-processes"></a><span data-ttu-id="dbe0b-495">信頼性の高いプロセスを使用してデプロイする</span><span class="sxs-lookup"><span data-stu-id="dbe0b-495">Deploy using reliable processes</span></span>

<span data-ttu-id="dbe0b-496">アプリケーションを運用環境にデプロイした場合、更新プログラムがエラーの原因になることがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-496">Once an application is deployed to production, updates are a possible source of errors.</span></span> <span data-ttu-id="dbe0b-497">最悪の場合には、更新プログラムの不良でダウンタイムが発生することがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-497">In the worst case, a bad update can cause downtime.</span></span> <span data-ttu-id="dbe0b-498">この問題を回避するために、デプロイ プロセスを予測可能で反復的にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-498">To avoid this, the deployment process must be predictable and repeatable.</span></span> <span data-ttu-id="dbe0b-499">デプロイには、Azure リソースのプロビジョニング、アプリケーション コードのデプロイ、構成設定の適用が含まれます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-499">Deployment includes provisioning Azure resources, deploying application code, and applying configuration settings.</span></span> <span data-ttu-id="dbe0b-500">1 つの更新プログラムで、この 3 つすべて、または一部が行われることがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-500">An update may involve all three, or a subset.</span></span>

<span data-ttu-id="dbe0b-501">手動のデプロイはエラーが起きやすいという点が重要です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-501">The crucial point is that manual deployments are prone to error.</span></span> <span data-ttu-id="dbe0b-502">そのため、必要に応じて実行可能で、何かが失敗した場合に再実行できる自動的なべき等プロセスを用意することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-502">Therefore, it's recommended to have an automated, idempotent process that you can run on demand, and re-run if something fails.</span></span>

- <span data-ttu-id="dbe0b-503">Azure リソースのプロビジョニングを自動化するために、[Terraform][terraform]、[Ansible][ansible]、[Chef][chef]、[Puppet][puppet]、[PowerShell][powershell]、[CLI][cli]、または [Azure Resource Manager テンプレート][template-deployment]を使用できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-503">To automate provisioning of Azure resources you can use [Terraform][terraform], [Ansible][ansible], [Chef][chef], [Puppet][puppet], [PowerShell][powershell], [CLI][cli] or [Azure Resource Manager templates][template-deployment]</span></span>
- <span data-ttu-id="dbe0b-504">[Azure Automation Desired State Configuration][dsc] (DSC) を使用して VM を構成します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-504">Use [Azure Automation Desired State Configuration][dsc] (DSC) to configure VMs.</span></span> <span data-ttu-id="dbe0b-505">Linux VM では、[Cloud-init][cloud-init] を使用できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-505">For Linux VMs, you can use [Cloud-init][cloud-init].</span></span>
- <span data-ttu-id="dbe0b-506">[Azure DevOps Services][azure-devops-services] または [Jenkins][jenkins] を使用して、アプリケーションのデプロイを自動化できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-506">You can automate application deployment using [Azure DevOps Services][azure-devops-services] or [Jenkins][jenkins].</span></span>

<span data-ttu-id="dbe0b-507">*コードとしてのインフラストラクチャ*と*イミュータブル インフラストラクチャ*という回復性のデプロイに関連する 2 つの概念があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-507">Two concepts related to resilient deployment are *infrastructure as code* and *immutable infrastructure*.</span></span>

- <span data-ttu-id="dbe0b-508">**コードとしてのインフラストラクチャ**は、コードを使用してインフラストラクチャのプロビジョニングと構成を行う手法です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-508">**Infrastructure as code** is the practice of using code to provision and configure infrastructure.</span></span> <span data-ttu-id="dbe0b-509">コードとしてのインフラストラクチャには、宣言型の方法、命令型の方法 (またはその両方の組み合わせ) を使用することができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-509">Infrastructure as code may use a declarative approach or an imperative approach (or a combination of both).</span></span> <span data-ttu-id="dbe0b-510">宣言型の方法の例として、Resource Manager テンプレートがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-510">Resource Manager templates are an example of a declarative approach.</span></span> <span data-ttu-id="dbe0b-511">PowerShell スクリプトは、命令型の方法の一例です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-511">PowerShell scripts are an example of an imperative approach.</span></span>
- <span data-ttu-id="dbe0b-512">**イミュータブル インフラストラクチャ**は、運用環境にデプロイした後にインフラストラクチャを変更すべきではないという原則です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-512">**Immutable infrastructure** is the principle that you shouldn’t modify infrastructure after it’s deployed to production.</span></span> <span data-ttu-id="dbe0b-513">そうしないと、場当たりの変更が適用され、変更内容を正確に把握しづらくなり、システムについて論理的に判断しづらくなる状態に陥る可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-513">Otherwise, you can get into a state where ad hoc changes have been applied, so it's hard to know exactly what changed, and hard to reason about the system.</span></span>

<span data-ttu-id="dbe0b-514">もう 1 つの問題は、アプリケーションの更新プログラムを展開する方法です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-514">Another question is how to roll out an application update.</span></span> <span data-ttu-id="dbe0b-515">ブルーグリーン デプロイまたはカナリア リリースなどの手法を採用して高度に制御された方法で更新プログラムをプッシュし、不適切なデプロイの考えられる影響を最小限に抑えることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-515">We recommend techniques such as blue-green deployment or canary releases, which push updates in highly controlled way to minimize possible impacts from a bad deployment.</span></span>

- <span data-ttu-id="dbe0b-516">[ブルーグリーン デプロイ][blue-green]は、ライブ アプリケーションとは別の運用環境に更新プログラムをデプロイする手法です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-516">[Blue-green deployment][blue-green] is a technique where an update is deployed into a production environment separate from the live application.</span></span> <span data-ttu-id="dbe0b-517">デプロイの検証が完了したら、トラフィック ルーティングを更新されたバージョンに切り替えます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-517">After you validate the deployment, switch the traffic routing to the updated version.</span></span> <span data-ttu-id="dbe0b-518">たとえば、Azure App Service Web Apps では、[ステージング スロット][staging-slots]を利用してこれを実現できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-518">For example, Azure App Service Web Apps enables this with [staging slots][staging-slots].</span></span>
- <span data-ttu-id="dbe0b-519">[カナリア リリース][canary-release]は、ブルーグリーン デプロイと似ています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-519">[Canary releases][canary-release] are similar to blue-green deployments.</span></span> <span data-ttu-id="dbe0b-520">すべてのトラフィックを更新されたバージョンに切り替えるのではなく、トラフィックの一部を新しいデプロイにルーティングすることで更新プログラムを少数のユーザーに展開します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-520">Instead of switching all traffic to the updated version, you roll out the update to a small percentage of users, by routing a portion of the traffic to the new deployment.</span></span> <span data-ttu-id="dbe0b-521">問題が発生した場合は、以前のデプロイに戻します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-521">If there is a problem, back off and revert to the old deployment.</span></span> <span data-ttu-id="dbe0b-522">問題が発生しない場合は、より多くのトラフィックを新しいバージョンにルーティングします。トラフィックの 100% になるまでこの手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-522">Otherwise, route more of the traffic to the new version, until it gets 100% of the traffic.</span></span>

<span data-ttu-id="dbe0b-523">どの方法を採用する場合でも、新しいバージョンが機能しなかった場合に最後の正常なデプロイに戻すことができるようにします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-523">Whatever approach you take, make sure that you can roll back to the last-known-good deployment, in case the new version is not functioning.</span></span> <span data-ttu-id="dbe0b-524">また、データベースの変更や依存サービスに対するその他の変更をロールバックするための戦略を適切に配置します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-524">Also have a strategy in place to roll back database changes and any other changes to dependent services.</span></span> <span data-ttu-id="dbe0b-525">エラーが発生した場合は、アプリケーション ログによって必ずエラーの原因になったバージョンを特定できるようにします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-525">If errors occur, the application logs must indicate which version caused the error.</span></span>

## <a name="monitor-to-detect-failures"></a><span data-ttu-id="dbe0b-526">監視によって障害を検出する</span><span class="sxs-lookup"><span data-stu-id="dbe0b-526">Monitor to detect failures</span></span>

<span data-ttu-id="dbe0b-527">回復性のためには、監視が非常に重要です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-527">Monitoring is crucial for resiliency.</span></span> <span data-ttu-id="dbe0b-528">何かが失敗した場合、失敗したことを把握し、障害の原因を分析する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-528">If something fails, you need to know that it failed, and you need insights into the cause of the failure.</span></span>

<span data-ttu-id="dbe0b-529">大規模な分散システムの監視は、大きな課題です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-529">Monitoring a large-scale distributed system poses a significant challenge.</span></span> <span data-ttu-id="dbe0b-530">数十単位の VM で実行されるアプリケーションを例にして説明します。&mdash; 各 VM 1 つずつにログを記録し、ログ ファイルを確認し、問題を解決することは実用的ではありません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-530">Think about an application that runs on a few dozen VMs &mdash; it's not practical to log into each VM, one at a time, and look through log files, trying to troubleshoot a problem.</span></span> <span data-ttu-id="dbe0b-531">さらに、VM インスタンスの数はおそらく静的ではありません。アプリケーションのスケールインとスケールアウトによって VM 数は増減し、インスタンスが失敗して再プロビジョニングが必要になることがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-531">Moreover, the number of VM instances is probably not static VMs get added and removed as the application scales in and out, and occasionally an instance may fail and need to be reprovisioned.</span></span> <span data-ttu-id="dbe0b-532">さらに、一般的なクラウド アプリケーションは複数のデータ ストア (App Storage、SQL Database、Cosmos DB、Redis Cache) を使用することや、単一のユーザー アクションが複数のサブシステムに広がることがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-532">In addition, a typical cloud application might use multiple data stores (Azure storage, SQL Database, Cosmos DB, Redis cache), and a single user action may span multiple subsystems.</span></span>

<span data-ttu-id="dbe0b-533">監視プロセスは、いくつかの異なる段階があるパイプラインと捉えることができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-533">You can think of the monitoring process as a pipeline with several distinct stages:</span></span>

![複合 SLA](./images/monitoring.png)

- <span data-ttu-id="dbe0b-535">**インストルメンテーション**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-535">**Instrumentation**.</span></span> <span data-ttu-id="dbe0b-536">監視対象となる生データは、[アプリケーション ログ](/azure/application-insights/app-insights-overview?toc=/azure/azure-monitor/toc.json)、[オペレーティング システムのパフォーマンス メトリック](/azure/azure-monitor/platform/agents-overview)、[Azure リソース](/azure/monitoring-and-diagnostics/monitoring-supported-metrics?toc=/azure/azure-monitor/toc.json)、[Azure サブスクリプション](/azure/service-health/service-health-overview)、および [Azure テナント](/azure/active-directory/reports-monitoring/howto-integrate-activity-logs-with-log-analytics) を含む、さまざまなソースに由来します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-536">The raw data for monitoring comes from a variety of sources, including [application logs](/azure/application-insights/app-insights-overview?toc=/azure/azure-monitor/toc.json), [operating systems performance metrics](/azure/azure-monitor/platform/agents-overview), [Azure resources](/azure/monitoring-and-diagnostics/monitoring-supported-metrics?toc=/azure/azure-monitor/toc.json), [Azure subscriptions](/azure/service-health/service-health-overview) and [Azure tenants](/azure/active-directory/reports-monitoring/howto-integrate-activity-logs-with-log-analytics).</span></span> <span data-ttu-id="dbe0b-537">ほとんどの Azure サービスでは、問題の原因を分析して特定するために構成可能な[メトリック](/azure/azure-monitor/platform/data-collection)を公開しています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-537">Most Azure services expose [metrics](/azure/azure-monitor/platform/data-collection) that you can configure to analyze and determine the cause of problems.</span></span>
- <span data-ttu-id="dbe0b-538">**収集と保存**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-538">**Collection and storage**.</span></span> <span data-ttu-id="dbe0b-539">生インストルメンテーション データは多様な場所に多様な形式で保持される可能性があります (たとえば、アプリケーション トレース ログ、IIS ログ、パフォーマンス カウンターなど)。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-539">Raw instrumentation data can be held in various locations and with various formats (e.g., application trace logs, IIS logs, performance counters).</span></span> <span data-ttu-id="dbe0b-540">これらのさまざまなソースは収集され、統合されて、Application Insights、Azure Monitor メトリック、Service Health、ストレージ アカウント、および Log Analytics などの信頼できるデータ ストアに配置されます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-540">These disparate sources are collected, consolidated, and put into reliable data stores such as Application Insights, Azure Monitor metrics, Service Health, storage accounts and Log Analytics.</span></span>
- <span data-ttu-id="dbe0b-541">**分析と診断**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-541">**Analysis and diagnosis**.</span></span> <span data-ttu-id="dbe0b-542">データは、これらの異なるデータ ストア内で統合された後、問題を解決するために分析され、アプリケーションの正常性に関する全体的な見解を提示できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-542">After the data is consolidated in these different data stores, it can be analyzed to troubleshoot issues and provide an overall view of application health.</span></span> <span data-ttu-id="dbe0b-543">一般的には、[Kusto クエリ](/azure/log-analytics/log-analytics-queries)を使用して、Application Insights および Log Analytics 内のデータを検索できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-543">Generally, you can search for the data in Application Insights and Log Analytics using [Kusto queries](/azure/log-analytics/log-analytics-queries).</span></span> <span data-ttu-id="dbe0b-544">Azure Advisor では、[回復性](/azure/advisor/advisor-high-availability-recommendations)および[最適化](/azure/advisor/advisor-performance-recommendations)に重点を置いて推奨事項を提示します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-544">Azure Advisor provides recommendations with a focus on [resiliency](/azure/advisor/advisor-high-availability-recommendations) and [optimization](/azure/advisor/advisor-performance-recommendations).</span></span>
- <span data-ttu-id="dbe0b-545">**視覚化とアラート**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-545">**Visualization and alerts**.</span></span> <span data-ttu-id="dbe0b-546">この段階では、オペレーターが問題や傾向にすばやく気づくことができる方法で利用統計情報が表示されます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-546">In this stage, telemetry data is presented in such a way that an operator can quickly notice problems or trends.</span></span> <span data-ttu-id="dbe0b-547">たとえば、ダッシュボードや電子メールのアラートがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-547">Examples include dashboards or email alerts.</span></span> <span data-ttu-id="dbe0b-548">[Azure ダッシュボード](/azure/azure-portal/azure-portal-dashboards)を使用すると、Application Insights、Log Analytics、Azure Monitor メトリックおよびサービスの正常性を元にして、単一ウィンドウでの監視グラフのグラス ビューを構築できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-548">With [Azure dashboards](/azure/azure-portal/azure-portal-dashboards), you can build a single-pane of glass view of monitoring graphs originating from Application Insights, Log Analytics, Azure Monitor metrics and service health.</span></span> <span data-ttu-id="dbe0b-549">[Azure Monitor アラート](/azure/monitoring-and-diagnostics/monitoring-overview-alerts?toc=/azure/azure-monitor/toc.json)を使用すると、サービスの正常性およびリソースの正常性に関するアラートを作成できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-549">With [Azure Monitor alerts](/azure/monitoring-and-diagnostics/monitoring-overview-alerts?toc=/azure/azure-monitor/toc.json), you can create alerts on service health and resource health.</span></span>

<span data-ttu-id="dbe0b-550">監視は障害の検出と同じではありません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-550">Monitoring is not the same as failure detection.</span></span> <span data-ttu-id="dbe0b-551">たとえば、アプリケーションが一時的なエラーを検出して再試行し、ダウンタイムが発生しないことがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-551">For example, your application might detect a transient error and retry, resulting in no downtime.</span></span> <span data-ttu-id="dbe0b-552">それでも再試行操作はログに記録されるので、エラー率を監視して、アプリケーション正常性の全体像を把握することができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-552">But it should also log the retry operation, so that you can monitor the error rate, in order to get an overall picture of application health.</span></span>

<span data-ttu-id="dbe0b-553">アプリケーション ログは、診断データの重要なソースです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-553">Application logs are an important source of diagnostics data.</span></span> <span data-ttu-id="dbe0b-554">アプリケーションのログ記録には、次のようなベスト プラクティスがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-554">Best practices for application logging include:</span></span>

- <span data-ttu-id="dbe0b-555">運用環境でログを記録します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-555">Log in production.</span></span> <span data-ttu-id="dbe0b-556">そうしないと、最も必要な場合に洞察できません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-556">Otherwise, you lose insight where you need it most.</span></span>
- <span data-ttu-id="dbe0b-557">サービスの境界でイベントのログを記録します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-557">Log events at service boundaries.</span></span> <span data-ttu-id="dbe0b-558">フローがサービス境界をまたがる関連付け ID を含めます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-558">Include a correlation ID that flows across service boundaries.</span></span> <span data-ttu-id="dbe0b-559">トランザクション フローが複数のサービスを経由し、いずれかが失敗した場合、関連付け ID でトランザクションが失敗した理由を特定できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-559">If a transaction flows through multiple services and one of them fails, the correlation ID will help you pinpoint why the transaction failed.</span></span>
- <span data-ttu-id="dbe0b-560">セマンティック ログ (構造化ログとも呼ばれます) を使用します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-560">Use semantic logging, also known as structured logging.</span></span> <span data-ttu-id="dbe0b-561">構造化されていないログの場合、ログ データの使用と分析の自動化が困難です。こうした自動化はクラウド規模で必要になります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-561">Unstructured logs make it hard to automate the consumption and analysis of the log data, which is needed at cloud scale.</span></span>
- <span data-ttu-id="dbe0b-562">非同期のログ記録を使用します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-562">Use asynchronous logging.</span></span> <span data-ttu-id="dbe0b-563">そうしないと、ログ アプリケーションによって、ログ記録イベントの書き込みを待機中に要求がブロックされ、要求がバックアップされ、アプリケーションで障害が発生する原因になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-563">Otherwise, the logging system itself can cause the application to fail by causing requests to back up, as they block while waiting to write a logging event.</span></span>
- <span data-ttu-id="dbe0b-564">アプリケーションのログ記録は、監査と同じではありません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-564">Application logging is not the same as auditing.</span></span> <span data-ttu-id="dbe0b-565">監査は、コンプライアンスまたは法規制上の理由で行われることがあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-565">Auditing may be done for compliance or regulatory reasons.</span></span> <span data-ttu-id="dbe0b-566">そのため、監査レコードは完全である必要があります。トランザクションの処理中に削除が発生することは許容されません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-566">As such, audit records must be complete, and it's not acceptable to drop any while processing transactions.</span></span> <span data-ttu-id="dbe0b-567">アプリケーションに監査が必要な場合、診断ログとは別に維持する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-567">If an application requires auditing, this should be kept separate from diagnostics logging.</span></span>

<span data-ttu-id="dbe0b-568">監視と診断の詳細については、「[Monitoring and diagnostics guidance][monitoring-guidance]」(監査と診断のガイダンス) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-568">For more information about monitoring and diagnostics, see [Monitoring and diagnostics guidance][monitoring-guidance].</span></span>

## <a name="respond-to-failures"></a><span data-ttu-id="dbe0b-569">障害に対応する</span><span class="sxs-lookup"><span data-stu-id="dbe0b-569">Respond to failures</span></span>

<span data-ttu-id="dbe0b-570">これまでのセクションでは、高可用性に重要な自動的な復旧戦略を中心に説明してきましたが、</span><span class="sxs-lookup"><span data-stu-id="dbe0b-570">Previous sections have focused on automated recovery strategies, which are critical for high availability.</span></span> <span data-ttu-id="dbe0b-571">手動操作が必要な場合もあります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-571">However, sometimes manual intervention is needed.</span></span>

- <span data-ttu-id="dbe0b-572">**[Alerts]** (アラート)。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-572">**Alerts**.</span></span> <span data-ttu-id="dbe0b-573">アプリケーションで、積極的な介入が必要な可能性がある警告の兆候を監視します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-573">Monitor your application for warning signs that may require proactive intervention.</span></span> <span data-ttu-id="dbe0b-574">たとえば、SQL Database または Cosmos DB がアプリケーションを常に調整している場合は、データベース容量の増加や、クエリの最適化が必要な可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-574">For example, if you see that SQL Database or Cosmos DB consistently throttles your application, you might need to increase your database capacity or optimize your queries.</span></span> <span data-ttu-id="dbe0b-575">この例では、アプリケーションが調整エラーを透過的に処理している場合でも、利用統計情報でアラートが報告されるので、対応することができます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-575">In this example, even though the application might handle the throttling errors transparently, your telemetry should still raise an alert so that you can follow up.</span></span> <span data-ttu-id="dbe0b-576">サービス制限とクォータのしきい値に対して、Azure リソース メトリックと診断ログにアラートを構成することが推奨されています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-576">It is recommended to configure alerts on Azure resources metrics and diagnostics logs against the services limits and quotas thresholds.</span></span> <span data-ttu-id="dbe0b-577">診断ログに比べてメトリックは低待機時間になるため、メトリックにアラートを設定することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-577">We recommend to setup alerts on metrics as they are lower latency vs. diagnostics logs.</span></span> <span data-ttu-id="dbe0b-578">さらに、Azure では、[リソースの正常性](/azure/service-health/resource-health-checks-resource-types)を使用して、Azure サービスの調整を診断できるすぐに使える正常性ステータスを提供できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-578">In addition, Azure is able to provide with some out-of-the-box health status through [resource health](/azure/service-health/resource-health-checks-resource-types) which can help diagnose throttling of Azure services.</span></span>
- <span data-ttu-id="dbe0b-579">**フェールオーバーする**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-579">**Failover**.</span></span> <span data-ttu-id="dbe0b-580">アプリケーションのディザスター リカバリー戦略を構成します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-580">Configure a disaster recovery strategy for your application.</span></span> <span data-ttu-id="dbe0b-581">適切な戦略は、お使いの SLA に応じて変わります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-581">The appropriate strategy will depend on your SLAs.</span></span> <span data-ttu-id="dbe0b-582">ほとんどのシナリオについては、アクティブ/パッシブ実装で十分に確認できます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-582">For most scenarous, an active-passive implementation is sufficient.</span></span> <span data-ttu-id="dbe0b-583">詳しくは、[ディザスター リカバリーのデプロイ トポロジ](./disaster-recovery-azure-applications.md#deployment-topologies-for-disaster-recovery)に関するページをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-583">For more information, see [Deployment topologies for disaster recovery ](./disaster-recovery-azure-applications.md#deployment-topologies-for-disaster-recovery).</span></span> <span data-ttu-id="dbe0b-584">ほとんどの Azure サービスでは、手動または自動フェールオーバーのどちらかに対応しています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-584">Most Azure services allow for either manual or automated failover.</span></span> <span data-ttu-id="dbe0b-585">たとえば、IaaS アプリケーションでは、Web 層および論理層に [Azure Site Recovery](/azure/site-recovery/azure-to-azure-architecture) を、データベース層に [SQL AlwaysOn 可用性グループ](/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-dr)を使用します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-585">For example, in an IaaS application, use [Azure Site Recovery](/azure/site-recovery/azure-to-azure-architecture) for the web and logic tiers and [SQL AlwaysOn Availability Groups](/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-dr) for the database tier.</span></span> <span data-ttu-id="dbe0b-586">[Traffic Manager](/azure/traffic-manager/traffic-manager-overview) では、リージョン間での自動フェールオーバーを提供しています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-586">[Traffic Manager](/azure/traffic-manager/traffic-manager-overview) provides automated failover across regions.</span></span>
- <span data-ttu-id="dbe0b-587">**運用準備状況のテスト**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-587">**Operational readiness testing**.</span></span> <span data-ttu-id="dbe0b-588">セカンダリ リージョンへのフェールオーバーと、プライマリ リージョンへのフェールバックの両方について、運用準備状況のテストを実行します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-588">Perform an operational readiness test for both failover to the secondary region and failback to the primary region.</span></span> <span data-ttu-id="dbe0b-589">多くの Azure サービスでは、ディザスター リカバリー訓練のために手動フェールオーバーまたはテスト フェールオーバーをサポートしています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-589">Many Azure services support manual failover or test failover for disaster recovery drills.</span></span> <span data-ttu-id="dbe0b-590">または、サービスをシャットダウンまたは削除することで、停止をシミュレートできます。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-590">Alternatively, you can simulate an outage by shutting down or removing services.</span></span>
- <span data-ttu-id="dbe0b-591">**データ整合性チェック**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-591">**Data consistency check**.</span></span> <span data-ttu-id="dbe0b-592">データ ストアで障害が発生した場合、特にデータがレプリケートされた場合には、ストアを再び使用可能な状態にするときにデータに整合性がある必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-592">If a failure happens in a data store, there may be data inconsistencies when the store becomes available again, especially if the data was replicated.</span></span> <span data-ttu-id="dbe0b-593">リージョン間でのレプリケーションを提供する Azure サービスの場合、障害で想定されるデータ損失を把握するために RTO と RPO を確認します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-593">For Azure services that provide cross-regional replication, look at the RTO and RPO to understand the expected data loss in a failure.</span></span> <span data-ttu-id="dbe0b-594">リージョン間でのフェールオーバーが手動で開始できるか、または Microsoft によって開始されるかを把握するには、Azure サービスの SLA を確認します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-594">Review the SLAs for Azure services to understand whether cross-regional failover can be initiated manually or is initiated by Microsoft.</span></span> <span data-ttu-id="dbe0b-595">一部のサービスでは、フェールオーバーを実行するタイミングを Microsoft が判断します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-595">For some services, Microsoft decides when to perform the failover.</span></span> <span data-ttu-id="dbe0b-596">Microsoft では、プライマリ リージョンにあるデータの復旧を優先し、プライマリ リージョンにあるデータが復旧不能であると判断した場合にのみ、セカンダリ リージョンにフェールオーバーする場合があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-596">Microsoft may prioritize the recovery of data in the primary region, only failing over to a secondary region if data in the primary region is deemed unrecoverable.</span></span> <span data-ttu-id="dbe0b-597">たとえば、[Geo 冗長ストレージ](/azure/storage/common/storage-redundancy-grs)や [Key Vault](/azure/key-vault/key-vault-disaster-recovery-guidance) では、このモデルに従います。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-597">For example, [Geo-redundant storage](/azure/storage/common/storage-redundancy-grs) and [Key Vault](/azure/key-vault/key-vault-disaster-recovery-guidance) follow this model.</span></span>
- <span data-ttu-id="dbe0b-598">**バックアップからの復元**。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-598">**Restoring from backup**.</span></span> <span data-ttu-id="dbe0b-599">一部のシナリオでは、バックアップからの復元は、同じリージョン内のみで可能です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-599">In some scenarios, restoring from backup is only possible within the same region.</span></span> <span data-ttu-id="dbe0b-600">[Azure VMs Backup](/azure/backup/backup-azure-vms-first-look-arm) は、これに該当します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-600">This is the case for [Azure VMs Backup](/azure/backup/backup-azure-vms-first-look-arm).</span></span> <span data-ttu-id="dbe0b-601">他のAzure サービスでは、[Redis Cache の geo レプリカ](/azure/redis-cache/cache-how-to-geo-replication)など、geo レプリケートされたバックアップを提供しています。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-601">Other Azure services provide geo-replicated backups, such as [Redis Cache Geo-Replicas](/azure/redis-cache/cache-how-to-geo-replication).</span></span> <span data-ttu-id="dbe0b-602">バックアップの目的は、誤削除やデータの破損から保護し、アプリケーションを前の時点の動作可能なバージョンに復元することです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-602">The purpose of backups is to protect against accidental deletion or corruption of data, restoring the application to a functional version earlier in time.</span></span> <span data-ttu-id="dbe0b-603">そのため、バックアップは、場合によってはディザスター リカバリー ソリューションとしての機能できますが、逆は必ずしも当てはまりません。ディザスター リカバリーでは、誤削除やデータの破損から保護されません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-603">Therefore, while backups can serve as a disaster recovery solution in some cases, the inverse is not always true: Disaster recovery won't protect you against accidental deletion or corruption a data.</span></span>  

<span data-ttu-id="dbe0b-604">ディザスター リカバリー計画を文書化し、テストします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-604">Document and test your disaster recovery plan.</span></span> <span data-ttu-id="dbe0b-605">アプリケーションの障害によるビジネスの影響を評価します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-605">Evaluate the business impact of application failures.</span></span> <span data-ttu-id="dbe0b-606">できるだけ多くのプロセスを自動化し、手動の手順を文書化します。たとえば、バックアップからの手動のフェールオーバーやデータの復元などです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-606">Automate the process as much as possible, and document any manual steps, such as manual failover or data restoration from backups.</span></span> <span data-ttu-id="dbe0b-607">ディザスター リカバリー プロセスは定期的にテストし、計画の検証と改善を行います。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-607">Regularly test your disaster recovery process to validate and improve the plan.</span></span> <span data-ttu-id="dbe0b-608">アプリケーションによって使用される Azure サービスのアラートを設定します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-608">Set up alerts for the Azure services consumed by your application.</span></span>

## <a name="summary"></a><span data-ttu-id="dbe0b-609">まとめ</span><span class="sxs-lookup"><span data-stu-id="dbe0b-609">Summary</span></span>

<span data-ttu-id="dbe0b-610">この記事では、クラウド固有の一部の課題を特に取り上げながら、包括的な観点から回復性について説明しました。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-610">This article discussed resiliency from a holistic perspective, emphasizing some of the unique challenges of the cloud.</span></span> <span data-ttu-id="dbe0b-611">たとえば、クラウド コンピューティングの分散の特性、汎用的なハードウェアの使用、一時的なネットワーク障害の存在などです。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-611">These include the distributed nature of cloud computing, the use of commodity hardware, and the presence of transient network faults.</span></span>

<span data-ttu-id="dbe0b-612">この記事の主な点を次に示します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-612">Here are the major points to take away from this article:</span></span>

- <span data-ttu-id="dbe0b-613">回復性によって可用性が高くなり、障害からの平均復旧時間が短くなります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-613">Resiliency leads to higher availability, and lower mean time to recover from failures.</span></span>
- <span data-ttu-id="dbe0b-614">クラウドで回復性を実現するには、従来のオンプレミス ソリューションのさまざまな手法が必要です。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-614">Achieving resiliency in the cloud requires a different set of techniques from traditional on-premises solutions.</span></span>
- <span data-ttu-id="dbe0b-615">偶発的に回復性が実現することはありません。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-615">Resiliency does not happen by accident.</span></span> <span data-ttu-id="dbe0b-616">初期段階から設計し、構築する必要があります。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-616">It must be designed and built in from the start.</span></span>
- <span data-ttu-id="dbe0b-617">回復性は、計画、コーディングから運用まで、アプリケーションのライフサイクルのあらゆる部分に関係します。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-617">Resiliency touches every part of the application lifecycle, from planning and coding to operations.</span></span>
- <span data-ttu-id="dbe0b-618">テストと監視をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dbe0b-618">Test and monitor!</span></span>

<!-- links -->

[blue-green]: https://martinfowler.com/bliki/BlueGreenDeployment.html
[canary-release]: https://martinfowler.com/bliki/CanaryRelease.html
[circuit-breaker-pattern]: ../patterns/circuit-breaker.md
[compensating-transaction-pattern]: ../patterns/compensating-transaction.md
[containers]: https://en.wikipedia.org/wiki/Operating-system-level_virtualization
[dsc]: /azure/automation/automation-dsc-overview
[contingency-planning-guide]: https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-34r1.pdf
[fma]: ./failure-mode-analysis.md
[hystrix]: https://medium.com/netflix-techblog/introducing-hystrix-for-resilience-engineering-13531c1ab362
[jmeter]: https://jmeter.apache.org/
[load-leveling-pattern]: ../patterns/queue-based-load-leveling.md
[monitoring-guidance]: ../best-practices/monitoring.md
[ra-basic-web]: ../reference-architectures/app-service-web-app/basic-web-app.md
[ra-multi-vm]: ../reference-architectures/virtual-machines-windows/multi-vm.md
[checklist]: ../checklist/resiliency.md
[retry-pattern]: ../patterns/retry.md
[retry-service-specific guidance]: ../best-practices/retry-service-specific.md
[sla]: https://azure.microsoft.com/support/legal/sla/
[throttling-pattern]: ../patterns/throttling.md
[tm]: https://azure.microsoft.com/services/traffic-manager/
[tm-failover]: /azure/traffic-manager/traffic-manager-monitoring
[tm-sla]: https://azure.microsoft.com/support/legal/sla/traffic-manager
[site-recovery]: /azure/site-recovery/azure-to-azure-quickstart/
[site-recovery-test-failover]: /azure/site-recovery/azure-to-azure-tutorial-dr-drill/
[site-recovery-failover]: /azure/site-recovery/azure-to-azure-tutorial-failover-failback/
[deployment-topologies]: ./disaster-recovery-azure-applications.md#deployment-topologies-for-disaster-recovery
[bulkhead-pattern]: ../patterns/bulkhead.md
[terraform]: /azure/virtual-machines/windows/infrastructure-automation#terraform
[ansible]: /azure/virtual-machines/windows/infrastructure-automation#ansible
[chef]: /azure/virtual-machines/windows/infrastructure-automation#chef
[puppet]: /azure/virtual-machines/windows/infrastructure-automation#puppet
[template-deployment]: /azure/azure-resource-manager/resource-group-overview#template-deployment
[cloud-init]: /azure/virtual-machines/windows/infrastructure-automation#cloud-init
[azure-devops-services]: /azure/virtual-machines/windows/infrastructure-automation#azure-devops-services
[jenkins]: /azure/virtual-machines/windows/infrastructure-automation#jenkins
[staging-slots]: /azure/app-service/deploy-staging-slots
[powershell]: /powershell/azure/overview
[cli]: /cli/azure

---
title: Azure Service Fabric でのマイクロサービス アーキテクチャ
description: Azure Service Fabric にマイクロサービス アーキテクチャをデプロイします
author: PageWriter-MSFT
ms.date: 3/07/2019
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: microservices
ms.openlocfilehash: 228e3242ce9f1ca45bc15c5b34f770bfc092dd43
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/20/2019
ms.locfileid: "58244343"
---
# <a name="microservices-architecture-on-azure-service-fabric"></a><span data-ttu-id="b7a66-103">Azure Service Fabric でのマイクロサービス アーキテクチャ</span><span class="sxs-lookup"><span data-stu-id="b7a66-103">Microservices architecture on Azure Service Fabric</span></span>

<span data-ttu-id="b7a66-104">この参照アーキテクチャでは、Azure Service Fabric にデプロイされるマイクロサービス アーキテクチャを示します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-104">This reference architecture shows a microservices architecture deployed to Azure Service Fabric.</span></span> <span data-ttu-id="b7a66-105">それには、ほとんどのデプロイの出発点にすることができる基本的なクラスター構成が示されています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-105">It shows a basic cluster configuration that can be the starting point for most deployments.</span></span>

![Service Fabric の参照アーキテクチャ](./_images/ra-sf-arch.png)

> [!NOTE]
> <span data-ttu-id="b7a66-107">この記事では、Service Fabric の [Reliable Services](/azure/service-fabric/service-fabric-reliable-services-introduction) プログラミング モデルに注目します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-107">This article focuses on the [Reliable Services](/azure/service-fabric/service-fabric-reliable-services-introduction) programming model for Service Fabric.</span></span> <span data-ttu-id="b7a66-108">Service Fabric を使用した[コンテナー](/azure/service-fabric/service-fabric-containers-overview)のデプロイと管理については、この記事では説明されていません。</span><span class="sxs-lookup"><span data-stu-id="b7a66-108">Using Service Fabric to deploy and manage [containers](/azure/service-fabric/service-fabric-containers-overview) is beyond the scope of this article.</span></span>

## <a name="architecture"></a><span data-ttu-id="b7a66-109">アーキテクチャ</span><span class="sxs-lookup"><span data-stu-id="b7a66-109">Architecture</span></span>

<span data-ttu-id="b7a66-110">アーキテクチャは、次のコンポーネントで構成されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-110">The architecture consists of the following components.</span></span> <span data-ttu-id="b7a66-111">他の用語については、「[Service Fabric の用語の概要](/azure/service-fabric/service-fabric-technical-overview)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-111">For other terms, see [Service Fabric terminology overview](/azure/service-fabric/service-fabric-technical-overview).</span></span>

<span data-ttu-id="b7a66-112">**Service Fabric クラスター**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-112">**Service Fabric cluster**.</span></span> <span data-ttu-id="b7a66-113">マイクロサービスをデプロイして管理する、ネットワークで接続された一連の仮想マシン (VM)。</span><span class="sxs-lookup"><span data-stu-id="b7a66-113">A network-connected set of virtual machines (VMs) into which your microservices are deployed and managed.</span></span>

<span data-ttu-id="b7a66-114">**仮想マシン スケール セット**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-114">**Virtual machine scale sets**.</span></span> <span data-ttu-id="b7a66-115">仮想マシン スケール セットを使用すると、負荷分散と自動スケーリングが行われる同一の VM のグループを作成して管理できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-115">Virtual machine scale sets allow you to create and manage a group of identical, load balanced, and autoscaling VMs.</span></span> <span data-ttu-id="b7a66-116">障害ドメインとアップグレード ドメインも提供されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-116">It also provides the fault and upgrade domains.</span></span>

<span data-ttu-id="b7a66-117">**ノード**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-117">**Nodes**.</span></span> <span data-ttu-id="b7a66-118">ノードは、Service Fabric クラスターに属する VM です。</span><span class="sxs-lookup"><span data-stu-id="b7a66-118">The nodes are the VMs that belong to the Service Fabric cluster.</span></span>

<span data-ttu-id="b7a66-119">**ノード タイプ**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-119">**Node types**.</span></span> <span data-ttu-id="b7a66-120">ノード タイプは、ノードのコレクションをデプロイする仮想マシン スケール セットを表します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-120">A node type represents a virtual machine scale set that deploys a collection of nodes.</span></span> <span data-ttu-id="b7a66-121">Service Fabric クラスターには、少なくとも 1 つのノード タイプがあります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-121">A Service Fabric cluster has at least one node type.</span></span> <span data-ttu-id="b7a66-122">クラスターに複数のノード タイプがある場合は、その 1 つを[プライマリ ノード タイプ](/azure/service-fabric/service-fabric-cluster-capacity#primary-node-type)として宣言する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-122">In a cluster with multiple node types, one must be declared the [Primary node type](/azure/service-fabric/service-fabric-cluster-capacity#primary-node-type).</span></span> <span data-ttu-id="b7a66-123">クラスターのプライマリ ノード タイプでは、[Service Fabric システム サービス](/azure/service-fabric/service-fabric-technical-overview#system-services)が実行されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-123">The primary node type in the cluster runs the [Service Fabric system services](/azure/service-fabric/service-fabric-technical-overview#system-services).</span></span> <span data-ttu-id="b7a66-124">これらのサービスでは、Service Fabric のプラットフォーム機能が提供されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-124">These services provide the platform capabilities of Service Fabric.</span></span> <span data-ttu-id="b7a66-125">プライマリ ノード タイプは、クラスターに対する[シード ノード](/azure/service-fabric/service-fabric-disaster-recovery#random-failures-leading-to-cluster-failures)としても機能します。シード ノードは、基になるクラスターの可用性を維持するノードです。</span><span class="sxs-lookup"><span data-stu-id="b7a66-125">The primary node type also acts as the [seed nodes](/azure/service-fabric/service-fabric-disaster-recovery#random-failures-leading-to-cluster-failures) for the cluster, which are the nodes that maintain the availability of the underlying cluster.</span></span> <span data-ttu-id="b7a66-126">独自のサービスを実行するには、[追加のノード タイプ](/azure/service-fabric/service-fabric-cluster-capacity#non-primary-node-type)を構成します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-126">Configure [additional node types](/azure/service-fabric/service-fabric-cluster-capacity#non-primary-node-type) to run your services.</span></span>

<span data-ttu-id="b7a66-127">**サービス**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-127">**Services**.</span></span> <span data-ttu-id="b7a66-128">サービスでは、他のサービスから独立して開始および実行できる、スタンドアロンの機能が実行されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-128">A service performs a standalone function that can start and run independently of other services.</span></span> <span data-ttu-id="b7a66-129">サービスのインスタンスは、クラスター内のノードにデプロイされます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-129">Instances of services get deployed to nodes in the cluster.</span></span> <span data-ttu-id="b7a66-130">Service Fabric のサービスには、2 つの種類あります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-130">There are two varieties of service in Service Fabric:</span></span>

- <span data-ttu-id="b7a66-131">**ステートレス サービス**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-131">**Stateless service**.</span></span> <span data-ttu-id="b7a66-132">ステートレス サービスでは、サービス内の状態は保持されません。</span><span class="sxs-lookup"><span data-stu-id="b7a66-132">A stateless service does not maintain state within the service.</span></span> <span data-ttu-id="b7a66-133">状態の永続性が必要な場合は、Azure Cosmos DB などの外部ストアに状態を書き込み、取得します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-133">If state persistence is required, then state is written to and retrieved from an external store, such as Azure Cosmos DB.</span></span>
- <span data-ttu-id="b7a66-134">**ステートフル サービス**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-134">**Stateful service**.</span></span> <span data-ttu-id="b7a66-135">[サービスの状態](/azure/service-fabric/service-fabric-concepts-state)は、サービス自体の内部に保持されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-135">The [service state](/azure/service-fabric/service-fabric-concepts-state) is kept within the service itself.</span></span> <span data-ttu-id="b7a66-136">ほとんどのステートフル サービスでは、Service Fabric の[リライアブル コレクション](/azure/service-fabric/service-fabric-reliable-services-reliable-collections)によってこれが実装されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-136">Most stateful services implement this through Service Fabric’s [Reliable Collections](/azure/service-fabric/service-fabric-reliable-services-reliable-collections).</span></span>

<span data-ttu-id="b7a66-137">**Service Fabric Explorer**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-137">**Service Fabric Explorer**.</span></span> <span data-ttu-id="b7a66-138">[Service Fabric Explorer][sfx] は、Service Fabric クラスターを検査および管理するためのオープン ソース ツールです。</span><span class="sxs-lookup"><span data-stu-id="b7a66-138">[Service Fabric Explorer][sfx] is an open-source tool for inspecting and managing Service Fabric clusters.</span></span>

<span data-ttu-id="b7a66-139">**Azure Pipelines**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-139">**Azure Pipelines**.</span></span> <span data-ttu-id="b7a66-140">[Pipelines](/azure/devops/pipelines/?view=azure-devops) は [Azure DevOps Services](/azure/devops/index?view=azure-devops) の一部であり、自動化されたビルド、テスト、およびデプロイを実行します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-140">[Pipelines](/azure/devops/pipelines/?view=azure-devops) is part of [Azure DevOps Services](/azure/devops/index?view=azure-devops) and runs automated builds, tests, and deployments.</span></span> <span data-ttu-id="b7a66-141">Jenkins などのサードパーティ CI/CD ソリューションも使用できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-141">You can also use third-party CI/CD solutions such as Jenkins.</span></span>

<span data-ttu-id="b7a66-142">**Azure Monitor**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-142">**Azure Monitor**.</span></span> <span data-ttu-id="b7a66-143">[Azure Monitor](/azure/azure-monitor/) では、ソリューション内の Azure サービスのプラットフォーム メトリックやアプリケーション テレメトリなど、メトリックとログが収集されて格納されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-143">[Azure Monitor](/azure/azure-monitor/) collects and stores metrics and logs, including platform metrics for the Azure services in the solution and application telemetry.</span></span> <span data-ttu-id="b7a66-144">このデータは、アプリケーションを監視したり、アラートやダッシュボードを設定したり、障害の根本原因分析を実行したりするために使用します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-144">Use this data to monitor the application, set up alerts and dashboards, and perform root cause analysis of failures.</span></span> <span data-ttu-id="b7a66-145">Azure Monitor は、コントローラー、ノード、およびコンテナーからのメトリックや、コンテナー ログおよびマスター ノード ログを収集するために Service Fabric と統合します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-145">Azure Monitor integrates with Service Fabric to collect metrics from controllers, nodes, and containers, as well as container logs and master node logs.</span></span>

<span data-ttu-id="b7a66-146">**Azure Key Vault**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-146">**Azure Key Vault**.</span></span> <span data-ttu-id="b7a66-147">接続文字列など、マイクロサービスで使用されるすべてのアプリケーション シークレットを格納するには、[Key Vault](/azure/key-vault/) を使用します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-147">Use [Key Vault](/azure/key-vault/) to store any application secrets used by the microservices, such as connection strings.</span></span>

<span data-ttu-id="b7a66-148">**Azure API Management**。</span><span class="sxs-lookup"><span data-stu-id="b7a66-148">**Azure API Management**.</span></span> <span data-ttu-id="b7a66-149">このアーキテクチャの [API Management](/azure/api-management/api-management-key-concepts) は、クライアントから要求を受け取って独自のサービスにルーティングする API ゲートウェイとして機能します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-149">In this architecture, [API Management](/azure/api-management/api-management-key-concepts) acts as an API gateway that accepts requests from clients and routes them to your services.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="b7a66-150">設計上の考慮事項</span><span class="sxs-lookup"><span data-stu-id="b7a66-150">Design considerations</span></span>

<span data-ttu-id="b7a66-151">この参照アーキテクチャでは、[マイクロサービス アーキテクチャ](../../guide/architecture-styles/microservices.md)に重点が置かれています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-151">This reference architecture is focused on [microservices architectures](../../guide/architecture-styles/microservices.md).</span></span> <span data-ttu-id="b7a66-152">マイクロサービスは、独立してバージョン管理されるコードの小さな単位です。</span><span class="sxs-lookup"><span data-stu-id="b7a66-152">A microservice is a small, independently versioned unit of code.</span></span> <span data-ttu-id="b7a66-153">サービス検出メカニズムによって検出可能であり、API 経由で他のサービスと通信できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-153">It is discoverable through service discovery mechanisms and can communicate with other services over APIs.</span></span> <span data-ttu-id="b7a66-154">各サービスは自己完結型であり、1 つのビジネス機能を実装している必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-154">Each service is self-contained and should implement a single business capability.</span></span> <span data-ttu-id="b7a66-155">アプリケーション ドメインをマイクロサービスに分解する方法について詳しくは、「[Using domain analysis to model microservices (ドメイン分析を使用してマイクロサービスをモデル化する)](../../microservices/model/domain-analysis.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-155">For more information about how to decompose your application domain into microservices, see [Using domain analysis to model microservices](../../microservices/model/domain-analysis.md).</span></span>

<span data-ttu-id="b7a66-156">Service Fabric では、マイクロサービスを効率的に構築、デプロイ、およびアップグレードするためのインフラストラクチャが提供されています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-156">Service Fabric provides an infrastructure to build, deploy, and upgrade microservices efficiently.</span></span> <span data-ttu-id="b7a66-157">また、自動スケーリング、状態の管理、正常性の監視、および障害発生時のサービスの再起動に対するオプションも提供されています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-157">It also provides options for auto scaling, managing state, monitoring health, and restarting services in case of failure.</span></span>

<span data-ttu-id="b7a66-158">Service Fabric は、アプリケーションがマイクロサービスのコレクションであるアプリケーション モデルに従います。</span><span class="sxs-lookup"><span data-stu-id="b7a66-158">Service Fabric follows an application model where an application is a collection of microservices.</span></span> <span data-ttu-id="b7a66-159">アプリケーションは[アプリケーション マニフェスト](/azure/service-fabric/service-fabric-application-and-service-manifests) ファイルに記述されており、このファイルでは、そのアプリケーションに含まれるさまざまな種類のサービスと、独立したサービス パッケージへのポインターが定義されています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-159">The application is described in an [application manifest](/azure/service-fabric/service-fabric-application-and-service-manifests) file that defines the different types of service contained in that application, and pointers to the independent service packages.</span></span> <span data-ttu-id="b7a66-160">アプリケーション パッケージには、通常、サービスによって使用される特定の設定に対するオーバーライドとして機能するパラメーターも含まれています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-160">The application package also usually contains parameters that serve as overrides for certain settings used by the services.</span></span> <span data-ttu-id="b7a66-161">サービス パッケージごとにマニフェスト ファイルがあり、そのサービスのバイナリ、構成ファイル、読み取り専用データなど、そのサービスを実行するために必要な物理ファイルとフォルダーが記述されています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-161">Each service package has a manifest file that describes the physical files and folders that are necessary to run that service, including binaries, configuration files, and read-only data for that service.</span></span> <span data-ttu-id="b7a66-162">サービスとアプリケーションは、個別にバージョン管理され、アップグレード可能です。</span><span class="sxs-lookup"><span data-stu-id="b7a66-162">Services and applications are independently versioned and upgradable.</span></span>

<span data-ttu-id="b7a66-163">アプリケーション マニフェストでは、必要に応じて、アプリケーションのインスタンスが作成されるときに自動的にプロビジョニングされるサービスを記述できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-163">Optionally, the application manifest can describe services that are automatically provisioned when an instance of the application is created.</span></span> <span data-ttu-id="b7a66-164">これらは既定のサービスと呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-164">These are called default services.</span></span> <span data-ttu-id="b7a66-165">この場合、アプリケーション マニフェストでは、サービスの名前、インスタンスの数、セキュリティ/分離ポリシー、配置の制約など、これらのサービスに必要な作成方法も記述されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-165">In this case, the application manifest also describes how these services should be created, including the service’s name, instance count, security/isolation policy, and placement constraints.</span></span>

> [!NOTE]
> <span data-ttu-id="b7a66-166">独自のサービスの有効期間を制御する場合は、既定のサービスを使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-166">Avoid using default services if you want to control the life time of your services.</span></span> <span data-ttu-id="b7a66-167">既定のサービスは、アプリケーションが作成されると作成され、アプリケーションが実行されている限り実行されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-167">Default services are created when the application is created, and run as long as the application is running.</span></span>

<span data-ttu-id="b7a66-168">Service Fabric に関して詳しくは、「[Service Fabric に興味をお持ちでしょうか](/azure/service-fabric/service-fabric-content-roadmap)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-168">For more information about understanding Service Fabric, see [So you want to learn about Service Fabric?](/azure/service-fabric/service-fabric-content-roadmap)</span></span>

### <a name="choose-an-application-to-service-packaging-model"></a><span data-ttu-id="b7a66-169">アプリケーションからサービスへのパッケージ化モデルを選択する</span><span class="sxs-lookup"><span data-stu-id="b7a66-169">Choose an application-to-service packaging model</span></span>

<span data-ttu-id="b7a66-170">マイクロサービスの基本思想は、各サービスを独立してデプロイできる、というものです。</span><span class="sxs-lookup"><span data-stu-id="b7a66-170">A tenet of microservices is that each service can be independently deployed.</span></span> <span data-ttu-id="b7a66-171">Service Fabric では、すべてのサービスを 1 つのアプリケーション パッケージにグループ化した場合、1 つのサービスのアップグレードが失敗すると、アプリケーション全体のアップグレードがロールバックされ、他のサービスもアップグレードされなくなります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-171">In Service Fabric, if you group all of your services into a single application package, and one service fails to upgrade, the entire application upgrade gets rolled back, which prevents other service from being upgraded.</span></span>

<span data-ttu-id="b7a66-172">そのため、マイクロサービス アーキテクチャでは、複数のアプリケーション パッケージを使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-172">For that reason, in a microservices architecture, we recommend using multiple application packages.</span></span> <span data-ttu-id="b7a66-173">1 つのアプリケーションの種類には、1 つまたは密接に関連する複数のサービスの種類を格納します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-173">Put one or more closely related service types into a single application type.</span></span> <span data-ttu-id="b7a66-174">実行期間が同じで、同時に更新する、ライフサイクルを同じにする、または依存関係や構成などのリソースを共有する必要があるサービスのセットがある場合は、それらのサービスの種類を同じアプリケーションの種類に格納します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-174">If your team is responsible for a set of services that run for the same duration and need to be updated at the same time, have the same lifecycle, or share resources such as dependencies or configuration, then place those services types in the same application type.</span></span>

### <a name="service-fabric-programming-models"></a><span data-ttu-id="b7a66-175">Service Fabric のプログラミング モデル</span><span class="sxs-lookup"><span data-stu-id="b7a66-175">Service Fabric programming models</span></span>

<span data-ttu-id="b7a66-176">Service Fabric アプリケーションにマイクロサービスを追加するときは、高可用性で高信頼性にする必要がある状態またはデータがあるかどうかを判断します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-176">When you add a microservice to a Service Fabric application, decide whether it has state or data that needs to be made highly available and reliable.</span></span> <span data-ttu-id="b7a66-177">そうである場合、データを外部に格納できますか、それともデータはサービスの一部として含まれますか。</span><span class="sxs-lookup"><span data-stu-id="b7a66-177">If so, can it store data externally or is the data contained as part of the service?</span></span> <span data-ttu-id="b7a66-178">外部ストレージにデータを格納する必要がない場合、またはデータを格納したくない場合は、ステートレス サービスを選択します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-178">Choose a stateless service if you don’t need to store data or want to store data in external storage.</span></span> <span data-ttu-id="b7a66-179">サービスの一部として状態またはデータを維持する場合 (たとえば、そのデータがコードに近いメモリに存在する必要がある場合)、または外部ストアへの依存関係を許容できない場合は、ステートフル サービスの選択を検討します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-179">If you want to maintain state or data as part of the service (for example, you need that data to reside in memory close to the code), or cannot tolerate a dependency on an external store, consider choosing a stateful service.</span></span>

<span data-ttu-id="b7a66-180">Service Fabric で実行する既存のコードがある場合は、ゲスト実行可能ファイルとして実行できます。ゲスト実行可能ファイルは、サービスとして実行される任意の実行可能ファイルです。</span><span class="sxs-lookup"><span data-stu-id="b7a66-180">If you have existing code that you want to run on Service Fabric, you can run it as a guest executable, which is an arbitrary executable that runs as a service.</span></span> <span data-ttu-id="b7a66-181">または、デプロイに必要なすべての依存関係が含まれるコンテナーに、実行可能ファイルをパッケージ化することができます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-181">Alternatively, you can package the executable in a container that has all the dependencies needed for deployment.</span></span> <span data-ttu-id="b7a66-182">Service Fabric では、コンテナーとゲスト実行可能ファイルの両方が、ステートレス サービスとしてモデル化されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-182">Service Fabric models both containers and guest executables as stateless services.</span></span> <span data-ttu-id="b7a66-183">モデルの選択に関するガイダンスについては、「[Service Fabric プログラミング モデルの概要](/azure/service-fabric/service-fabric-choose-framework)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-183">For guidance about choosing a model, see [Service Fabric programming model overview](/azure/service-fabric/service-fabric-choose-framework).</span></span>

<span data-ttu-id="b7a66-184">ゲスト実行可能ファイルの場合は、それが実行される環境を自分で管理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-184">With guest executables, you are responsible of maintaining the environment in which it runs.</span></span> <span data-ttu-id="b7a66-185">たとえば、ゲスト実行可能ファイルで Python が必要であるとします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-185">For example, suppose that a guest executable requires Python.</span></span> <span data-ttu-id="b7a66-186">実行可能ファイルが自己完結型でない場合、必要なバージョンの Python が環境にプレインストールされていることを、自分で確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-186">If the executable is not self-contained, you need to make sure that the required version of Python is pre-installed in the environment.</span></span> <span data-ttu-id="b7a66-187">Service Fabric では、環境の管理は行われません。</span><span class="sxs-lookup"><span data-stu-id="b7a66-187">Service Fabric does not manage the environment.</span></span> <span data-ttu-id="b7a66-188">Azure では、カスタム仮想マシン イメージや拡張機能など、環境を設定する複数のメカニズムが提供されています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-188">Azure offers multiple mechanisms to set up the environment, including custom virtual machine images and extensions.</span></span>

<span data-ttu-id="b7a66-189">詳細については、次を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-189">For more information, see:</span></span>

- [<span data-ttu-id="b7a66-190">アプリケーションのパッケージ化</span><span class="sxs-lookup"><span data-stu-id="b7a66-190">Package an application</span></span>](/azure/service-fabric/service-fabric-package-apps)
- [<span data-ttu-id="b7a66-191">既存の実行可能ファイルのパッケージ化と Service Fabric へのデプロイ</span><span class="sxs-lookup"><span data-stu-id="b7a66-191">Package and deploy an existing executable to Service Fabric</span></span>](/azure/service-fabric/service-fabric-deploy-existing-app)

### <a name="api-gateway"></a><span data-ttu-id="b7a66-192">API ゲートウェイ</span><span class="sxs-lookup"><span data-stu-id="b7a66-192">API gateway</span></span>

<span data-ttu-id="b7a66-193">[API ゲートウェイ](../..//microservices/design/gateway.md) (イングレス) は、外部クライアントとマイクロサービスの間に配置されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-193">An [API gateway](../..//microservices/design/gateway.md) (ingress) sits between external clients and the microservices.</span></span> <span data-ttu-id="b7a66-194">これは、要求をクライアントからマイクロサービスにルーティングするリバース プロキシとして機能します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-194">It acts as a reverse proxy, routing requests from clients to microservices.</span></span> <span data-ttu-id="b7a66-195">さらに、認証、SSL 終了、レート制限などのさまざまな横断的タスクを実行できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-195">It may also perform various cross-cutting tasks such as authentication, SSL termination, and rate limiting.</span></span>

<span data-ttu-id="b7a66-196">ほとんどのシナリオでは Azure API Management が推奨されますが、[Træfik](https://docs.traefik.io/) は人気のあるオープン ソースの代替手段です。</span><span class="sxs-lookup"><span data-stu-id="b7a66-196">Azure API Management is recommended for most scenarios, but [Træfik](https://docs.traefik.io/) is a popular open-source alternative.</span></span> <span data-ttu-id="b7a66-197">どちらのテクノロジのオプションも、Service Fabric と統合されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-197">Both technology options are integrated with Service Fabric.</span></span>

- <span data-ttu-id="b7a66-198">API Management では、パブリック IP アドレスが公開され、サービスにトラフィックがルーティングされします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-198">API Management exposes a public IP address and routes traffic to your services.</span></span> <span data-ttu-id="b7a66-199">Service Fabric クラスターと同じ仮想ネットワーク内の専用サブネットで実行されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-199">It runs in a dedicated subnet in the same virtual network as the Service Fabric cluster.</span></span>  <span data-ttu-id="b7a66-200">プライベート IP アドレスを使用してロード バランサー経由で公開されるノード タイプのサービスにアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-200">can access services in a node type that is exposed through a load balancer with a private IP address.</span></span> <span data-ttu-id="b7a66-201">このオプションは、API Management の Premium レベルと Developer レベルでのみ使用できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-201">This option is only available in the Premium and Developer tiers of API Management.</span></span> <span data-ttu-id="b7a66-202">運用ワークロードの場合は、Premium レベルを使用します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-202">For production workloads, use the Premium tier.</span></span> <span data-ttu-id="b7a66-203">価格の情報については、「[API Management の価格](https://azure.microsoft.com/pricing/details/api-management/)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-203">Pricing information is described in [API Management pricing](https://azure.microsoft.com/pricing/details/api-management/).</span></span> <span data-ttu-id="b7a66-204">詳しくは、「[Azure Service Fabric と API Management の概要](/azure/service-fabric/service-fabric-api-management-overview)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-204">For more information, see Service Fabric with [Azure API Management overview](/azure/service-fabric/service-fabric-api-management-overview).</span></span>
- <span data-ttu-id="b7a66-205">Træfik では、ルーティング、トレース、ログ、メトリックなどの機能がサポートされています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-205">Træfik supports features such as routing, tracing, logs, and metrics.</span></span> <span data-ttu-id="b7a66-206">Træfik は、Service Fabric クラスターでステートレス サービスとして実行されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-206">Træfik runs as a stateless service in the Service Fabric cluster.</span></span> <span data-ttu-id="b7a66-207">サービスのバージョン管理は、ルーティングによってサポートできます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-207">Service versioning can be supported through routing.</span></span> <span data-ttu-id="b7a66-208">サービス イングレス用に、およびクラスター内のリバース プロキシとして、Træfik を設定する方法については、「[Azure Service Fabric Provider (Azure Service Fabric プロバイダー)](https://docs.traefik.io/configuration/backends/servicefabric/)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-208">For information on how to set up Træfik for service ingress and as the reverse proxy within the cluster, see [Azure Service Fabric Provider](https://docs.traefik.io/configuration/backends/servicefabric/).</span></span> <span data-ttu-id="b7a66-209">Service Fabric での Træfik の使用について詳しくは、「[Intelligent routing on Service Fabric with Træfik (Træfik による Service Fabric でのインテリジェントなルーティング)](https://blogs.msdn.microsoft.com/azureservicefabric/2018/04/05/intelligent-routing-on-service-fabric-with-traefik/)」 (ブログ投稿) をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-209">For more information about using Træfik with Service Fabric, see [Intelligent routing on Service Fabric with Træfik](https://blogs.msdn.microsoft.com/azureservicefabric/2018/04/05/intelligent-routing-on-service-fabric-with-traefik/) (blog post).</span></span>

<span data-ttu-id="b7a66-210">API Managementment のその他のオプションとしては、[Azure Application Gateway](/azure/application-gateway/) と [Azure Front Door](/azure/frontdoor/) があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-210">Other API Managementment options include [Azure Application Gateway](/azure/application-gateway/) and [Azure Front Door](/azure/frontdoor/).</span></span> <span data-ttu-id="b7a66-211">これらのサービスを API Management と組み合わせて使用し、ルーティング、SSL 終了、ファイアウォールなどのタスクを実行できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-211">These services can be used in conjunction with API Management to perform tasks such as routing, SSL termination, and firewall.</span></span>

### <a name="interservice-communication"></a><span data-ttu-id="b7a66-212">サービス間の通信</span><span class="sxs-lookup"><span data-stu-id="b7a66-212">Interservice communication</span></span>

<span data-ttu-id="b7a66-213">サービス間の通信を容易にするには、通信プロトコルとして HTTP を使用することを検討します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-213">To facilitate service-to-service communication, consider using HTTP as the communication protocol.</span></span> <span data-ttu-id="b7a66-214">ほとんどのシナリオのベースラインとして、サービスの検出に[リバース プロキシ サービス](/azure/service-fabric/service-fabric-reverseproxy)を使うことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-214">As a baseline for most scenarios, we recommend using [the reverse proxy service](/azure/service-fabric/service-fabric-reverseproxy) for service discovery.</span></span>

- <span data-ttu-id="b7a66-215">通信プロトコル。</span><span class="sxs-lookup"><span data-stu-id="b7a66-215">Communication protocol.</span></span> <span data-ttu-id="b7a66-216">マイクロサービス アーキテクチャでは、サービス同士が実行時に最小限の結合で通信する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-216">In a microservices architecture, services need to communicate with each other with minimum coupling at runtime.</span></span> <span data-ttu-id="b7a66-217">言語に依存しないで通信を行う手段としては HTTP が業界標準であり、さまざまな言語で利用できる広範なツールと HTTP サーバーのすべてが、Service Fabric でサポートされています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-217">To enable language-agnostic communication, HTTP is an industry-standard with a wide range of tools and HTTP servers that are available in different languages, all supported by Service Fabric.</span></span> <span data-ttu-id="b7a66-218">したがって、Service Fabric に組み込まれているサービス リモート処理の代わりに HTTP を使用することが、ほとんどのワークロードで推奨されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-218">Therefore, using HTTP instead of Service Fabric’s built in service remoting is recommended for most workloads.</span></span>
- <span data-ttu-id="b7a66-219">サービス検出。</span><span class="sxs-lookup"><span data-stu-id="b7a66-219">Service discovery.</span></span> <span data-ttu-id="b7a66-220">クラスター内の他のサービスと通信するには、クライアント サービスで対象サービスの現在の場所を解決する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-220">To communicate with other services within a cluster, a client service needs to resolve the target service’s current location.</span></span> <span data-ttu-id="b7a66-221">Service fabric では、サービスはノード間を移動できるため、サービス エンドポイントは動的に変化します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-221">In Service Fabric, services can move between nodes, causing the service endpoints to change dynamically.</span></span> <span data-ttu-id="b7a66-222">古いエンドポイントへの接続を防ぐには、Service Fabric の Naming Service を使用して、更新されたエンドポイント情報を取得できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-222">To avoid connections to stale endpoints, Service Fabric’s Naming Service can be used to retrieve updated endpoint information.</span></span> <span data-ttu-id="b7a66-223">ただし、Service Fabric では、ネーム サービスを抽象化する組み込みの[リバース プロキシ サービス](/azure/service-fabric/service-fabric-reverseproxy)も提供されています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-223">However, Service Fabric also provides a built-in [reverse proxy service](/azure/service-fabric/service-fabric-reverseproxy) that abstracts the naming service.</span></span> <span data-ttu-id="b7a66-224">このオプションの方が簡単に使用でき、コードがシンプルになります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-224">This option is easier to use and results in simpler code.</span></span>

<span data-ttu-id="b7a66-225">サービス間通信用のオプションとしては、他に次のものがあります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-225">Other options for interservice communication include,</span></span>

- <span data-ttu-id="b7a66-226">高度なルーティング用の [Træfik](https://docs.traefik.io/)。</span><span class="sxs-lookup"><span data-stu-id="b7a66-226">[Træfik](https://docs.traefik.io/) for advanced routing.</span></span>
- <span data-ttu-id="b7a66-227">DNS を使用する必要があるサービスとの互換性シナリオ用の [DNS](/azure/dns/)。</span><span class="sxs-lookup"><span data-stu-id="b7a66-227">[DNS](/azure/dns/) for compatibility scenarios where a service expects to use DNS.</span></span>
- <span data-ttu-id="b7a66-228">[ServicePartitionClient&lt;TCommunicationClient&gt;](/dotnet/api/microsoft.servicefabric.services.communication.client.servicepartitionclient-1?view=azure-dotnet) クラス。</span><span class="sxs-lookup"><span data-stu-id="b7a66-228">[ServicePartitionClient&lt;TCommunicationClient&gt;](/dotnet/api/microsoft.servicefabric.services.communication.client.servicepartitionclient-1?view=azure-dotnet) class.</span></span> <span data-ttu-id="b7a66-229">サービス エンドポイントをキャッシュするクラスであり、仲介者やカスタム プロトコルを必要とせずにサービス間で直接呼び出しが行われるので、パフォーマンスが向上します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-229">The class caches service endpoints and can enable better performance, as calls go directly between services without intermediaries or custom protocols.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="b7a66-230">スケーラビリティに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="b7a66-230">Scalability considerations</span></span>

<span data-ttu-id="b7a66-231">Service Fabric では、次のクラスター エンティティのスケーリングがサポートされています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-231">Service Fabric supports scaling these cluster entities:</span></span>

- <span data-ttu-id="b7a66-232">各ノード タイプのノード数のスケーリング。</span><span class="sxs-lookup"><span data-stu-id="b7a66-232">Scaling the number of nodes for each node type.</span></span>
- <span data-ttu-id="b7a66-233">サービスのスケーリング。</span><span class="sxs-lookup"><span data-stu-id="b7a66-233">Scaling services.</span></span>

<span data-ttu-id="b7a66-234">このセクションでは、自動スケーリングに注目します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-234">This section is focused on autoscaling.</span></span> <span data-ttu-id="b7a66-235">それが適切な状況では、手動スケーリングを選択できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-235">You can choose to manually scale in situations where appropriate.</span></span> <span data-ttu-id="b7a66-236">たとえば、インスタンスの数を設定するために手動による介入が必要な状況です。</span><span class="sxs-lookup"><span data-stu-id="b7a66-236">For example, a situation where manual intervention is required to set the number of instances.</span></span>  

### <a name="initial-cluster-configuration-for-scalability"></a><span data-ttu-id="b7a66-237">スケーラビリティのための初期クラスター構成</span><span class="sxs-lookup"><span data-stu-id="b7a66-237">Initial cluster configuration for scalability</span></span>

<span data-ttu-id="b7a66-238">Service Fabric クラスターを作成するときに、セキュリティとスケーラビリティのニーズに基づいて、ノード タイプをプロビジョニングします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-238">When you create a Service Fabric cluster, provision the node types based on your security and scalability needs.</span></span> <span data-ttu-id="b7a66-239">各ノード タイプは 1 つの仮想マシン スケール セットにマップされ、独立してスケーリングできます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-239">Each node type is mapped to a virtual machine scale set and can be scaled independently.</span></span>

- <span data-ttu-id="b7a66-240">スケーラビリティまたはリソースの要件が異なるサービスのグループごとに、ノード タイプを作成します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-240">Create a node type for each group of services that have different scalability or resource requirements.</span></span> <span data-ttu-id="b7a66-241">最初に、Service Fabric システム サービス用のノード タイプをプロビジョニングします (これが [プライマリ ノード タイプ](/azure/service-fabric/service-fabric-cluster-capacity#primary-node-type)になります)。</span><span class="sxs-lookup"><span data-stu-id="b7a66-241">Start by provisioning a node type (which becomes the [primary node type](/azure/service-fabric/service-fabric-cluster-capacity#primary-node-type)) for the Service Fabric system services.</span></span> <span data-ttu-id="b7a66-242">その後、パブリック サービスまたはフロントエンド サービスを実行するための別のノード タイプを作成し、バックエンドのプライベート サービスまたは分離サービス用の他のノード タイプを必要に応じて作成します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-242">Then create separate node types to run your public or front-end services, and other node types as necessary for your backend and private or isolated services.</span></span> <span data-ttu-id="b7a66-243">サービスが目的のノード タイプにのみデプロイされるように、[配置の制約](/azure/service-fabric/service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies)を指定します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-243">Specify [placement constraints](/azure/service-fabric/service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies) so that the services are only deployed to the intended node types.</span></span>
- <span data-ttu-id="b7a66-244">各ノード タイプの持続性層を指定します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-244">Specify the durability tier for each node type.</span></span> <span data-ttu-id="b7a66-245">持続性層は、仮想マシン スケール セットの更新とメンテナンス操作に対して Service Fabric が影響を与える機能を表します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-245">The durability tier represents the ability for Service Fabric to influence virtual machine scale set updates and maintenance operations.</span></span> <span data-ttu-id="b7a66-246">運用ワークロードでは、シルバー以上の持続性層を選択します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-246">For production workloads, choose the Silver or higher durability tier.</span></span> <span data-ttu-id="b7a66-247">各層については、「[クラスターの耐久性の特徴](/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-247">For information about each tier, see [The durability characteristics of the cluster](/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster).</span></span>
- <span data-ttu-id="b7a66-248">ブロンズ持続性層を使用する場合は、特定の操作で手動手順が必要になります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-248">If using the Bronze durability tier, certain operations require manual steps.</span></span>  <span data-ttu-id="b7a66-249">ブロンズ持続性層のノード タイプでは、スケールインの間に追加の手順が必要です。</span><span class="sxs-lookup"><span data-stu-id="b7a66-249">For node types with Bronze durability tier additional steps are required during scale in.</span></span> <span data-ttu-id="b7a66-250">スケーリング操作について詳しくは、[こちらのガイド](/azure/service-fabric/service-fabric-cluster-scale-up-down)をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-250">For more information on scaling operations, see [this guide](/azure/service-fabric/service-fabric-cluster-scale-up-down).</span></span>

### <a name="scaling-nodes"></a><span data-ttu-id="b7a66-251">ノードのスケーリング</span><span class="sxs-lookup"><span data-stu-id="b7a66-251">Scaling nodes</span></span>

<span data-ttu-id="b7a66-252">Service Fabric では、スケールインとスケールアウトに対する自動スケーリングがサポートされています。ノード タイプごとに個別に自動スケーリングを構成できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-252">Service Fabric supports autoscaling for scale-in and scale-out. Each node type can be configured for autoscaling independently.</span></span>

<span data-ttu-id="b7a66-253">各ノード タイプは、最大 100 個のノードを持つことができます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-253">Each node type can have a maximum of 100 nodes.</span></span> <span data-ttu-id="b7a66-254">少数のノード セットで開始し、負荷に応じてノードを追加します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-254">Start with a smaller set of nodes and add more nodes depending on your load.</span></span> <span data-ttu-id="b7a66-255">1 つのノード タイプで必要なノードが 100 個を超える場合は、ノード タイプをさらに追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-255">If you require more than 100 nodes in a node type, you will need to add more node types.</span></span> <span data-ttu-id="b7a66-256">詳しくは、「[Service Fabric クラスターの容量計画に関する考慮事項](/azure/service-fabric/service-fabric-cluster-capacity)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-256">For details, see [Service Fabric cluster capacity planning considerations](/azure/service-fabric/service-fabric-cluster-capacity).</span></span> <span data-ttu-id="b7a66-257">仮想マシン スケール セットは瞬時にはスケーリングしないので、自動スケーリングの規則を設定するときは、そのことを考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-257">A virtual machine scale set does not scale instantaneously, so consider that factor when you set up autoscale rules.</span></span>

<span data-ttu-id="b7a66-258">自動スケールインをサポートするには、シルバーまたはゴールドの持続性層を持つようにノード タイプを構成します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-258">To support automatic scale-in, configure the node type to have the Silver or Gold durability tier.</span></span> <span data-ttu-id="b7a66-259">これにより、Service Fabric でサービスの再配置が完了するまでスケールインがデプロイされ、仮想マシン スケール セットから Service Fabric に VM が単に一時的にダウンしたのではなく削除されたことが通知されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-259">This makes sure that scaling in is delayed until Service Fabric is finished relocating services and that the virtual machine scale sets inform Service Fabric that the VMs are removed, not just down temporarily.</span></span>

<span data-ttu-id="b7a66-260">ノード/クラスター レベルでのスケーリングについて詳しくは、「[Azure Service Fabric クラスターのスケーリング](/azure/service-fabric/service-fabric-cluster-scaling)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-260">For more information about scaling at the node/cluster level, see [Scaling Azure Service Fabric clusters](/azure/service-fabric/service-fabric-cluster-scaling).</span></span>

### <a name="scaling-services"></a><span data-ttu-id="b7a66-261">サービスのスケーリング</span><span class="sxs-lookup"><span data-stu-id="b7a66-261">Scaling services</span></span>

<span data-ttu-id="b7a66-262">ステートレス サービスとステートフル サービスでは、適用されるスケーリングのアプローチが異なります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-262">Stateless and stateful services apply different approaches to scaling.</span></span>

#### <a name="autoscaling-for-stateless-services"></a><span data-ttu-id="b7a66-263">ステートレス サービスの場合の自動スケーリング</span><span class="sxs-lookup"><span data-stu-id="b7a66-263">Autoscaling for stateless services</span></span>

- <span data-ttu-id="b7a66-264">パーティションの平均負荷トリガーを使用します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-264">Use the average partition load trigger.</span></span> <span data-ttu-id="b7a66-265">このトリガーでは、スケーリング ポリシーで指定されている負荷のしきい値に基づいて、サービスがスケールインまたはスケールアウトされるタイミングが決定されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-265">This trigger determines when the service is scaled in or out, based on a load threshold value specified in the scaling policy.</span></span> <span data-ttu-id="b7a66-266">トリガーをチェックする頻度も設定できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-266">You can also set how often the trigger is checked.</span></span> <span data-ttu-id="b7a66-267">「[インスタンス ベースのスケーリングで使用するパーティションの平均負荷トリガー](/azure/service-fabric/service-fabric-cluster-resource-manager-autoscaling#average-partition-load-trigger-with-instance-based-scaling)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-267">See [Average partition load trigger with instance-based scaling](/azure/service-fabric/service-fabric-cluster-resource-manager-autoscaling#average-partition-load-trigger-with-instance-based-scaling).</span></span> <span data-ttu-id="b7a66-268">これにより、使用可能なノードの数までスケールアップできます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-268">This allows you to scale up to the number of available nodes.</span></span>
- <span data-ttu-id="b7a66-269">サービス マニフェストで **InstanceCount** を -1 に設定すると、すべてのノードでサービスのインスタンスを実行するよう Service Fabric に指示されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-269">Set **InstanceCount** to -1 in the service manifest, which tells Service Fabric to run an instance of the service on every node.</span></span> <span data-ttu-id="b7a66-270">この方法では、クラスターのスケーリングに合わせてサービスを動的にスケーリングできます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-270">This approach enables the service to scale dynamically as the cluster scales.</span></span> <span data-ttu-id="b7a66-271">クラスターのノードの数が変化すると、Service Fabric はそれと一致するようにサービス インスタンスを自動的に作成および削除します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-271">As the number of nodes in the cluster changes, Service Fabric automatically creates and deletes service instances to match.</span></span>

> [!NOTE]
> <span data-ttu-id="b7a66-272">場合によっては、サービスを手動でスケーリングしたいことがあります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-272">In some cases, you might want to manually scale your service.</span></span>  <span data-ttu-id="b7a66-273">たとえば、Event Hubs から読み取るサービスがある場合、パーティションへの同時アクセスを回避するため、専用のインスタンスで各イベント ハブ パーティションからの読み取りを行うことがあります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-273">For example, if you have a service that reads from Event Hubs, you might want a dedicated instance to read from each event hub partition, to avoid concurrent access to the partition.</span></span>  

#### <a name="scaling-for-stateful-services"></a><span data-ttu-id="b7a66-274">ステートフル サービスのスケーリング</span><span class="sxs-lookup"><span data-stu-id="b7a66-274">Scaling for stateful services</span></span>

<span data-ttu-id="b7a66-275">ステートフル サービスでのスケーリングは、パーティションの数、各パーティションのサイズ、および特定のマシンで実行されるパーティション/レプリカの数によって制御されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-275">For a stateful service, scaling is controlled by the number of partitions, the size of each partition, and the number of partitions/replicas running on a given machine.</span></span>

- <span data-ttu-id="b7a66-276">パーティション分割されたサービスを作成する場合は、小さいサイズのパーティションを多数作成することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-276">If you are creating partitioned services, we recommend having a high number of partitions that are small in size.</span></span> <span data-ttu-id="b7a66-277">ノードが追加される場合、Service Fabric は既定で新しいマシンにワークロードを分配します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-277">If more nodes are added, Service Fabric distributes the workloads onto the new machines by default.</span></span> <span data-ttu-id="b7a66-278">たとえば、5 個のノードと 10 個のパーティションがある場合、既定では、Service Fabric は 2 個のプライマリ レプリカを各ノードに配置します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-278">For example, if there are 5 nodes and 10 partitions, by default Service Fabric will place two primary replicas on each node.</span></span> <span data-ttu-id="b7a66-279">ノードをスケールアウトすると、より多くのリソースに作業が均等に分配されるため、パフォーマンスを向上させることができます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-279">If you scale out the nodes, you can achieve greater performance, because the work is evenly distributed across more resources.</span></span> <span data-ttu-id="b7a66-280">この戦略を利用するシナリオについては、「[Service Fabric での拡大縮小](/azure/service-fabric/service-fabric-concepts-scalability)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-280">For information about scenarios that take advantage of this strategy, see [Scaling in Service Fabric](/azure/service-fabric/service-fabric-concepts-scalability).</span></span>
- <span data-ttu-id="b7a66-281">パーティションの追加または削除は、あまり適切にサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="b7a66-281">Adding or removing partitions is not well supported.</span></span> <span data-ttu-id="b7a66-282">スケーリングによく使用されるもう 1 つのオプションは、サービスまたはアプリケーション インスタンス全体を動的に作成または削除することです。</span><span class="sxs-lookup"><span data-stu-id="b7a66-282">Another option commonly used to scale is to dynamically create or delete services or whole application instances.</span></span> <span data-ttu-id="b7a66-283">そのパターンの例については、「[新しい名前付きサービスの作成または削除による拡大縮小](/azure/service-fabric/service-fabric-concepts-scalability#scaling-by-creating-or-removing-new-named-services)」で説明されています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-283">An example of that pattern is described in [Scaling by creating or removing new named services](/azure/service-fabric/service-fabric-concepts-scalability#scaling-by-creating-or-removing-new-named-services).</span></span>

<span data-ttu-id="b7a66-284">詳細については、次を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-284">For more information, see:</span></span>

- [<span data-ttu-id="b7a66-285">自動スケール ルールを使用した、または手動による Service Fabric クラスターのスケールインとスケールアウト</span><span class="sxs-lookup"><span data-stu-id="b7a66-285">Scale a Service Fabric cluster in or out using autoscale rules or manually</span></span>](/azure/service-fabric/service-fabric-cluster-scale-up-down)
- [<span data-ttu-id="b7a66-286">プログラムによる Service Fabric クラスターのスケール</span><span class="sxs-lookup"><span data-stu-id="b7a66-286">Scale a Service Fabric cluster programmatically</span></span>](/azure/service-fabric/service-fabric-cluster-programmatic-scaling)
- [<span data-ttu-id="b7a66-287">仮想マシン スケール セットを追加して Service Fabric クラスターをスケールアウトする</span><span class="sxs-lookup"><span data-stu-id="b7a66-287">Scale a Service Fabric cluster out by adding a Virtual Machine Scale Set</span></span>](/azure/service-fabric/virtual-machine-scale-set-scale-node-type-scale-out)

### <a name="using-metrics-to-balance-load"></a><span data-ttu-id="b7a66-288">メトリックを使用して負荷を分散させる</span><span class="sxs-lookup"><span data-stu-id="b7a66-288">Using metrics to balance load</span></span>

<span data-ttu-id="b7a66-289">パーティションの設計方法によっては、あるノードのレプリカに他よりも多くのトラフィックが送られることがあります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-289">Depending on how you design the partition, you might have nodes with replicas that get more traffic than others.</span></span> <span data-ttu-id="b7a66-290">このような状況を避けるには、すべてのパーティションに分散されるようにサービスの状態をパーティション分割します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-290">To avoid this situation, partition the service state so that it is distributed across all partitions.</span></span> <span data-ttu-id="b7a66-291">範囲パーティション構成と適切なハッシュ アルゴリズムを使用します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-291">Use the range partitioning scheme with a good hash algorithm.</span></span> <span data-ttu-id="b7a66-292">「[パーティション分割の使用](/azure/service-fabric/service-fabric-concepts-partitioning#get-started-with-partitioning)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-292">See [Get started with partitioning](/azure/service-fabric/service-fabric-concepts-partitioning#get-started-with-partitioning).</span></span>

<span data-ttu-id="b7a66-293">Service Fabric では、メトリックを使用して、クラスター内にサービスを配置してバランスを取る方法が認識されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-293">Service Fabric uses metrics to know how to place and balance services within a cluster.</span></span> <span data-ttu-id="b7a66-294">サービスを作成するときに、そのサービスに関連付けられる各メトリックの既定の負荷を指定することができます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-294">You can specify a default load for each metric associated with a service when that service is created.</span></span> <span data-ttu-id="b7a66-295">その後、Service Fabric では、サービスを配置するとき、またはクラスター内のノードのバランスを取るために (たとえば、アップグレード中に) サービスを移動する必要があるとき常に、その負荷が考慮されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-295">Service Fabric then takes that load into account when placing the service, or whenever the service needs to move (for example, during upgrades) to try to balance the nodes in the cluster.</span></span>

<span data-ttu-id="b7a66-296">サービスに対して最初に指定された既定の負荷は、サービスの有効期間を通して変更されません。</span><span class="sxs-lookup"><span data-stu-id="b7a66-296">The initially specified default load for a service will not change over the lifetime of the service.</span></span> <span data-ttu-id="b7a66-297">特定のサービスについて変化するメトリックをキャプチャするため、サービスを監視して負荷を動的にレポートすることお勧めします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-297">To capture changing metrics for a given service, we recommend that you monitor your service and then report the load dynamically.</span></span> <span data-ttu-id="b7a66-298">これにより、Service Fabric では特定の時点に報告される負荷に基づいて割り当てを調整できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-298">This allows Service Fabric to adjust the allocation based on the reported load at a given time.</span></span> <span data-ttu-id="b7a66-299">カスタム メトリックを報告するには、[IServicePartition.ReportLoad](/dotnet/api/system.fabric.iservicepartition.reportload?view=azure-dotnet) メソッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-299">Use the [IServicePartition.ReportLoad](/dotnet/api/system.fabric.iservicepartition.reportload?view=azure-dotnet) method to report custom metrics.</span></span> <span data-ttu-id="b7a66-300">詳しくは、「[動的な負荷](/azure/service-fabric/service-fabric-cluster-resource-manager-metrics#dynamic-load)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-300">For more information, see [Dynamic load](/azure/service-fabric/service-fabric-cluster-resource-manager-metrics#dynamic-load).</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="b7a66-301">可用性に関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="b7a66-301">Availability considerations</span></span>

<span data-ttu-id="b7a66-302">プライマリ ノード タイプ以外のノード タイプに、サービスを配置します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-302">Place your services in a node type other than the primary node type.</span></span> <span data-ttu-id="b7a66-303">Service Fabric のシステム サービスは、プライマリ ノード タイプに常にデプロイされます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-303">The Service Fabric system services are always deployed to the primary node type.</span></span> <span data-ttu-id="b7a66-304">独自のサービスをプライマリ ノード タイプにデプロイすると、リソースがシステム サービスと競合し、システム サービスを干渉する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-304">If your services are deployed to the primary node type, they might compete with system services for resources and interfere with the system services.</span></span> <span data-ttu-id="b7a66-305">ノード タイプでステートフル サービスをホストすることが予想される場合は、ノード インスタンスの数を 5 個以上にして、シルバーまたはゴールドの持続性層を選択します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-305">If a node type is expected to host stateful services, make sure there are at least five node instances and you select the Silver or Gold Durability tier.</span></span>

<span data-ttu-id="b7a66-306">サービスのリソースを制限することを検討します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-306">Consider constraining the resources of your services.</span></span> <span data-ttu-id="b7a66-307">「[リソース ガバナンスのメカニズム](/azure/service-fabric/service-fabric-resource-governance#resource-governance-mechanism)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-307">See [Resource governance mechanism](/azure/service-fabric/service-fabric-resource-governance#resource-governance-mechanism).</span></span>

- <span data-ttu-id="b7a66-308">リソース管理サービスとリソース非管理サービスを、同じノード タイプに混在させないでください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-308">Do not mix resource governed and resource non-governed services on the same node type.</span></span> <span data-ttu-id="b7a66-309">非管理サービスによって消費されるリソースが多すぎて、リソース管理サービスに影響する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-309">The non-governed services might consume too many resources, affecting the resource governed services.</span></span> <span data-ttu-id="b7a66-310">これらの種類のサービスが同じノードのセットで実行されないようにするには、[配置の制約](/azure/service-fabric/service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies)を指定します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-310">Specify [placement constraints](/azure/service-fabric/service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies) to make sure that those types of services do not run on the same set of nodes.</span></span> <span data-ttu-id="b7a66-311">「[リソース ガバナンスの指定](/azure/service-fabric/service-fabric-resource-governance#specify-resource-governance)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-311">See [Specify resource governance](/azure/service-fabric/service-fabric-resource-governance#specify-resource-governance).</span></span> <span data-ttu-id="b7a66-312">(これは、[バルクヘッド パターン](../../patterns/bulkhead.md)の例です)。</span><span class="sxs-lookup"><span data-stu-id="b7a66-312">(This is an example of the [Bulkhead pattern](../../patterns/bulkhead.md).)</span></span>
- <span data-ttu-id="b7a66-313">サービス インスタンス用に予約する CPU コア数とメモリを指定します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-313">Specify the CPU cores and memory to reserve for a service instance.</span></span> <span data-ttu-id="b7a66-314">リソース ガバナンス ポリシーの使用と制限事項については、「[リソース ガバナンス](/azure/service-fabric/service-fabric-resource-governance)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-314">For information about usage and limitations of resource governance policies, see [Resource governance](/azure/service-fabric/service-fabric-resource-governance).</span></span>

<span data-ttu-id="b7a66-315">単一障害点 (SPOF) を回避するため、すべてのサービスのターゲット インスタンスまたはレプリカの数を 1 より大きくします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-315">Make sure every service’s target instance or replica count is greater than 1 to avoid a single point of failure (SPOF).</span></span> <span data-ttu-id="b7a66-316">サービス インスタンスまたはレプリカの数として使用できる最大数は、サービスが制約されているノードの数と同じです。</span><span class="sxs-lookup"><span data-stu-id="b7a66-316">The largest number that you can use as service instance or replica count equals the number nodes that to which the service is constrained.</span></span>

<span data-ttu-id="b7a66-317">すべてのステートフル サービスに、少なくとも 2 つのアクティブなセカンダリ レプリカがあるようにします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-317">Make sure every stateful service has at least two active secondary replicas.</span></span> <span data-ttu-id="b7a66-318">運用ワークロードでは 5 個のレプリカをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-318">Five replicas are recommended for production workloads.</span></span>

<span data-ttu-id="b7a66-319">詳しくは、「[Service Fabric サービスの可用性](/azure/service-fabric/service-fabric-availability-services)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-319">For more information, see [Availability of Service Fabric services](/azure/service-fabric/service-fabric-availability-services).</span></span>

## <a name="security-considerations"></a><span data-ttu-id="b7a66-320">セキュリティに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="b7a66-320">Security considerations</span></span>

<span data-ttu-id="b7a66-321">Service Fabric でアプリケーションを保護するための重要な点を次に示します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-321">Here are some key points for securing your application on Service Fabric:</span></span>

### <a name="virtual-network"></a><span data-ttu-id="b7a66-322">仮想ネットワーク</span><span class="sxs-lookup"><span data-stu-id="b7a66-322">Virtual network</span></span>

<span data-ttu-id="b7a66-323">各仮想マシン スケール セットにサブネット境界を定義し、通信のフローを制御することを検討します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-323">Consider defining subnet boundaries for each virtual machine scale set to control the flow of communication.</span></span> <span data-ttu-id="b7a66-324">各ノード タイプには、Service Fabric クラスターの仮想ネットワーク内のサブネットに、専用の仮想マシン スケール セットがあります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-324">Each node type has its own virtual machine scale set in a subnet within the Service Fabric cluster's virtual network.</span></span> <span data-ttu-id="b7a66-325">ネットワーク セキュリティ グループ (NSG) をサブネットに追加して、ネットワーク トラフィックを許可または拒否できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-325">Network Security Groups (NSGs) can be added to the subnets to allow or reject network traffic.</span></span> <span data-ttu-id="b7a66-326">たとえば、フロントエンドとバックエンドのノード タイプでは、バックエンドのサブネットに NSG を追加し、フロントエンドのサブネットだけで受信トラフィックを受け取ることができます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-326">For example, with front-end and back-end node types, you can add an NSG to the backend subnet to accept inbound traffic only the front-end subnet.</span></span>

<span data-ttu-id="b7a66-327">クラスターから外部の Azure サービスを呼び出すとき、Azure サービスでサポートされている場合は、[仮想ネットワーク サービス エンドポイント](/azure/virtual-network/virtual-network-service-endpoints-overview)を使用します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-327">When calling external Azure Services from the cluster, use [Virtual Network service endpoints](/azure/virtual-network/virtual-network-service-endpoints-overview) if the Azure service supports it.</span></span> <span data-ttu-id="b7a66-328">サービス エンドポイントを使用すると、サービスはクラスターの仮想ネットワークのみに固定されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-328">Using a service endpoint secures the service to only the cluster’s Virtual Network.</span></span> <span data-ttu-id="b7a66-329">たとえば、Cosmos DB を使用してデータを格納する場合は、サービス エンドポイントで Cosmos DB アカウントを構成し、特定のサブネットからのアクセスのみを許可します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-329">For example, if you are using Cosmos DB to store data, configure the Cosmos DB account with a service endpoint to allow access only from a specific subnet.</span></span> <span data-ttu-id="b7a66-330">「[仮想ネットワークから Azure Cosmos DB リソースへのアクセス](/azure/cosmos-db/vnet-service-endpoint)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-330">See [Access Azure Cosmos DB resources from virtual networks](/azure/cosmos-db/vnet-service-endpoint).</span></span>

### <a name="endpoints-and-interservice-communication"></a><span data-ttu-id="b7a66-331">エンドポイントとサービス間の通信</span><span class="sxs-lookup"><span data-stu-id="b7a66-331">Endpoints and interservice communication</span></span>

<span data-ttu-id="b7a66-332">セキュリティ保護されていない Service Fabric クラスターを作成しないでください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-332">Do not create an unsecured Service Fabric cluster.</span></span> <span data-ttu-id="b7a66-333">クラスターでパブリック インターネットに管理エンドポイントを公開している場合、匿名ユーザーがそのクラスターに接続できるようになります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-333">If the cluster exposes management endpoints to the public internet, anonymous users can connect to it.</span></span> <span data-ttu-id="b7a66-334">セキュリティで保護されていないクラスターは、運用ワークロードでサポートされません。</span><span class="sxs-lookup"><span data-stu-id="b7a66-334">Unsecured clusters are not supported for production workloads.</span></span> <span data-ttu-id="b7a66-335">参照:[Service Fabric クラスターのセキュリティに関するシナリオ](/azure/service-fabric/service-fabric-cluster-security)。</span><span class="sxs-lookup"><span data-stu-id="b7a66-335">See: [Service Fabric cluster security scenarios](/azure/service-fabric/service-fabric-cluster-security).</span></span>

<span data-ttu-id="b7a66-336">サービス間の通信をセキュリティ保護するには:</span><span class="sxs-lookup"><span data-stu-id="b7a66-336">To secure your interservice communications:</span></span>

- <span data-ttu-id="b7a66-337">ASP.NET Core サービスまたは Java Web サービスでは、HTTPS エンドポイントを有効にすることを考えます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-337">Consider enabling HTTPS endpoints in your ASP.NET Core or Java web services.</span></span>
- <span data-ttu-id="b7a66-338">リバース プロキシとサービスの間に、セキュリティ保護された接続を確立します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-338">Establish a secure connection between the reverse proxy and services.</span></span>  <span data-ttu-id="b7a66-339">詳しくは、[セキュリティで保護されたサービスへの接続](/azure/service-fabric/service-fabric-reverseproxy-configure-secure-communication)に関する記事をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-339">For details, see [Connect to a secure service](/azure/service-fabric/service-fabric-reverseproxy-configure-secure-communication).</span></span>

<span data-ttu-id="b7a66-340">[API ゲートウェイ](../../microservices/design/gateway.md)を使用している場合は、ゲートウェイに[認証をオフロードする](../../patterns/gateway-offloading.md)ことができます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-340">If you are using an [API gateway](../../microservices/design/gateway.md), you can [offload authentication](../../patterns/gateway-offloading.md) to the gateway.</span></span> <span data-ttu-id="b7a66-341">メッセージがゲートウェイから送られて来たのかどうかを認証する追加のセキュリティが設定されていない限り、個々のサービスに直接 (API ゲートウェイなしで) アクセスできないようにします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-341">Make sure that the individual services cannot be reached directly (without the API gateway) unless additional security is in place to authenticate messages whether they come from the gateway.</span></span>

<span data-ttu-id="b7a66-342">Service Fabric のリバース プロキシをパブリックに公開しないでください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-342">Do not expose the Service Fabric reverse proxy publicly.</span></span> <span data-ttu-id="b7a66-343">そのようにすると、HTTP エンドポイントを公開するすべてのサービスが、クラスターの外部からアドレス指定可能になり、セキュリティの脆弱性が発生して、その他の情報が不必要にクラスターの外部に公開される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-343">Doing so causes all services that expose HTTP endpoints to be addressable from outside the cluster, introducing security vulnerabilities and potentially exposing additional information outside the cluster unnecessarily.</span></span> <span data-ttu-id="b7a66-344">サービスをパブリックにアクセス可能にする場合は、API ゲートウェイを使用します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-344">If you want to access a service publicly, use an API gateway.</span></span> <span data-ttu-id="b7a66-345">いくつかのオプションが、「[API ゲートウェイ](#api-gateway)」セクションで説明されています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-345">Some options are mentioned in the [API gateway](#api-gateway) section.</span></span>

<span data-ttu-id="b7a66-346">リモート デスクトップは診断とトラブルシューティングに便利ですが、開いたままにしないようにしてください。そうしないと、セキュリティ ホールの原因になります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-346">Remote desktop is useful for diagnostic and troubleshooting, but make sure not to leave it open otherwise it causes a security hole.</span></span>

### <a name="secrets-and-certificates"></a><span data-ttu-id="b7a66-347">シークレットと証明書</span><span class="sxs-lookup"><span data-stu-id="b7a66-347">Secrets and certificates</span></span>

<span data-ttu-id="b7a66-348">Service Fabric サービスから Key Vault のシークレットにアクセスするには、サービスがホストされている仮想マシン スケール セットで[マネージド ID](/azure/active-directory/managed-identities-azure-resources/services-support-msi#azure-virtual-machine-scale-sets) を有効にします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-348">To access Key Vault secrets from a Service Fabric service, enable [managed identity](/azure/active-directory/managed-identities-azure-resources/services-support-msi#azure-virtual-machine-scale-sets) on the virtual machine scale set that hosts the service.</span></span> <span data-ttu-id="b7a66-349">サンプル コード:マネージド サービス ID を使用して App Service から Key Vault を使用します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-349">Sample code: Use Key Vault from App Service with Managed Service Identity.</span></span>

<span data-ttu-id="b7a66-350">クライアント証明書を使用して Service Fabric Explorer にアクセスしないでください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-350">Do not use client certificates to access Service Fabric Explorer.</span></span> <span data-ttu-id="b7a66-351">代わりに、Azure Active Directory (Azure AD) を使用します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-351">Instead, use Azure Active Directory (Azure AD).</span></span> <span data-ttu-id="b7a66-352">「[Azure AD 認証をサポートしている Azure サービス](/azure/active-directory/managed-identities-azure-resources/services-support-msi%23azure-services-that-support-azure-ad-authentication)」もご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-352">Also see, [Azure services that support Azure AD authentication](/azure/active-directory/managed-identities-azure-resources/services-support-msi%23azure-services-that-support-azure-ad-authentication).</span></span>

<span data-ttu-id="b7a66-353">運用環境では自己署名証明書を使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-353">Do not use self-signed certificates for production.</span></span>

<span data-ttu-id="b7a66-354">Service Fabric のセキュリティ保護について詳しくは、以下をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-354">For more information about securing Service Fabric, see:</span></span>

- [<span data-ttu-id="b7a66-355">Azure Service Fabric のセキュリティの概要</span><span class="sxs-lookup"><span data-stu-id="b7a66-355">Azure Service Fabric security overview</span></span>](/azure/security/azure-service-fabric-security-overview)
- [<span data-ttu-id="b7a66-356">Azure Service Fabric のセキュリティに関するベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="b7a66-356">Azure Service Fabric security best practices</span></span>](/azure/security/azure-service-fabric-security-best-practices)
- [<span data-ttu-id="b7a66-357">Azure Service Fabric セキュリティのチェックリスト</span><span class="sxs-lookup"><span data-stu-id="b7a66-357">Azure Service Fabric security checklist</span></span>](/azure/security/azure-service-fabric-security-checklist)

## <a name="monitoring-considerations"></a><span data-ttu-id="b7a66-358">監視に関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="b7a66-358">Monitoring considerations</span></span>

<span data-ttu-id="b7a66-359">監視オプションを調べる前に、[Service Fabric での一般的なシナリオの診断](/azure/service-fabric/service-fabric-diagnostics-common-scenarios)に関するこちらの記事を読むことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-359">Before you explore the monitoring options, we recommend you read this article about [diagnosing common scenarios with Service Fabric](/azure/service-fabric/service-fabric-diagnostics-common-scenarios).</span></span> <span data-ttu-id="b7a66-360">データの監視については以下のセットで考えることができます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-360">You can think of monitoring data in these sets:</span></span>

- [<span data-ttu-id="b7a66-361">アプリケーションのメトリックとログ</span><span class="sxs-lookup"><span data-stu-id="b7a66-361">Application metrics and logs</span></span>](#application-metrics-and-logs)
- [<span data-ttu-id="b7a66-362">Service Fabric の正常性とイベント データ</span><span class="sxs-lookup"><span data-stu-id="b7a66-362">Service Fabric health and event data</span></span>](#service-fabric-health-and-event-data)
- [<span data-ttu-id="b7a66-363">インフラストラクチャのメトリックとログ</span><span class="sxs-lookup"><span data-stu-id="b7a66-363">Infrastructure metrics and logs</span></span>](#infrastructure-metrics-and-logs)
- [<span data-ttu-id="b7a66-364">依存サービスのメトリックとログ</span><span class="sxs-lookup"><span data-stu-id="b7a66-364">Metrics and logs for dependent services</span></span>](#dependent-service-metrics)

<span data-ttu-id="b7a66-365">そのデータを分析するための主なオプションは次の 2 つです。</span><span class="sxs-lookup"><span data-stu-id="b7a66-365">These are the two main options for analyzing that data:</span></span>

- <span data-ttu-id="b7a66-366">Application Insights</span><span class="sxs-lookup"><span data-stu-id="b7a66-366">Application Insights</span></span>
- <span data-ttu-id="b7a66-367">Log Analytics</span><span class="sxs-lookup"><span data-stu-id="b7a66-367">Log Analytics</span></span>

<span data-ttu-id="b7a66-368">Azure Monitor を使用して、監視用のダッシュボードを設定し、オペレーターにアラートを送信することができます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-368">You can use Azure Monitor to set up dashboards for monitoring and to send alerts to operators.</span></span> <span data-ttu-id="b7a66-369">Dynatrace など、Service Fabric と統合できるサード パーティ製の監視ツールもあります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-369">There are also some third-party monitoring tools that are integrated with Service Fabric, such as Dynatrace.</span></span> <span data-ttu-id="b7a66-370">詳しくは、「[Azure Service Fabric 監視パートナー](/azure/service-fabric/service-fabric-diagnostics-partners)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-370">For details, see [Azure Service Fabric Monitoring Partners](/azure/service-fabric/service-fabric-diagnostics-partners).</span></span>

### <a name="application-metrics-and-logs"></a><span data-ttu-id="b7a66-371">アプリケーションのメトリックとログ</span><span class="sxs-lookup"><span data-stu-id="b7a66-371">Application metrics and logs</span></span>

<span data-ttu-id="b7a66-372">アプリケーションのテレメトリでは、サービスの正常性を監視して問題を特定するのに役立つ、サービスに関するデータが提供されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-372">Application telemetry provides data about your service that can help you monitor the health of your service and identify issues.</span></span> <span data-ttu-id="b7a66-373">サービスでトレースとイベントを追加するには:</span><span class="sxs-lookup"><span data-stu-id="b7a66-373">To add traces and events in your service:</span></span>

- <span data-ttu-id="b7a66-374">ASP.NET Core でサービスを開発している場合は、[Microsoft.Extensions.Logging](/azure/service-fabric/service-fabric-how-to-diagnostics-log#microsoftextensionslogging)。</span><span class="sxs-lookup"><span data-stu-id="b7a66-374">[Microsoft.Extensions.Logging](/azure/service-fabric/service-fabric-how-to-diagnostics-log#microsoftextensionslogging) if you are developing your service with ASP.NET Core.</span></span> <span data-ttu-id="b7a66-375">他のフレームワークの場合は、Serilog などの適当なログ記録ライブラリを使用します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-375">For other frameworks, use a logging library of your choice such as Serilog.</span></span>
- <span data-ttu-id="b7a66-376">SDK の [TelemetryClient](/dotnet/api/microsoft.applicationinsights.telemetryclient?view=azure-dotnet) クラスを使用して独自のインストルメンテーションを追加し、Application Insights でデータを表示することができます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-376">You can add your own instrumentation by using the [TelemetryClient](/dotnet/api/microsoft.applicationinsights.telemetryclient?view=azure-dotnet) class in the SDK and view the data in Application Insights.</span></span> <span data-ttu-id="b7a66-377">「[カスタム インストルメンテーションをアプリケーションに追加する](/azure/service-fabric/service-fabric-tutorial-monitoring-aspnet#add-custom-instrumentation-to-your-application)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-377">See [Add custom instrumentation to your application](/azure/service-fabric/service-fabric-tutorial-monitoring-aspnet#add-custom-instrumentation-to-your-application).</span></span>
- <span data-ttu-id="b7a66-378">[EventSource](/azure/service-fabric/service-fabric-diagnostics-event-generation-app#eventsource) を使用して、ETW イベントをログに記録します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-378">Log ETW events by using [EventSource](/azure/service-fabric/service-fabric-diagnostics-event-generation-app#eventsource).</span></span> <span data-ttu-id="b7a66-379">このオプションは、Visual Studio の Service Fabric ソリューションにおいて既定で使用できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-379">This option is available by default in a Visual Studio Service Fabric solution.</span></span>

<span data-ttu-id="b7a66-380">トレースとイベント ログを表示するには、構造化ログのシンクの 1 つとして [Application Insights](/azure/service-fabric/service-fabric-diagnostics-event-analysis-appinsights) を使用し、サービスでトレースとイベントを視覚化できるようにします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-380">To view the trace and event logs, use [Application Insights](/azure/service-fabric/service-fabric-diagnostics-event-analysis-appinsights) as one of the sinks for structured logging so that your service can visualize traces and events.</span></span> <span data-ttu-id="b7a66-381">Application Insights には、多くの組み込みテレメトリ (要求、トレース、イベント、例外、メトリック、依存関係) が用意されています。</span><span class="sxs-lookup"><span data-stu-id="b7a66-381">Application Insights provides a lot of built-in telemetry: requests, traces, events, exceptions, metrics, dependencies.</span></span> <span data-ttu-id="b7a66-382">Application Insights に対するサービスのインストルメント化については、次の記事をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-382">For information about instrumenting your service for Application Insights, see these articles:</span></span>

- <span data-ttu-id="b7a66-383">[チュートリアル:Application Insights を使用して Service Fabric 上の ASP.NET Core アプリケーションを監視および診断する](/azure/service-fabric/service-fabric-tutorial-monitoring-aspnet)。</span><span class="sxs-lookup"><span data-stu-id="b7a66-383">[Tutorial: Monitor and diagnose an ASP.NET Core application on Service Fabric using Application Insights](/azure/service-fabric/service-fabric-tutorial-monitoring-aspnet).</span></span>
- [<span data-ttu-id="b7a66-384">Application Insights for ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="b7a66-384">Application Insights for ASP.NET Core</span></span>](/azure/application-insights/app-insights-asp-net-core)
- [<span data-ttu-id="b7a66-385">Application Insights .NET SDK</span><span class="sxs-lookup"><span data-stu-id="b7a66-385">Application Insights .NET SDK</span></span>](/azure/application-insights/app-insights-api-custom-events-metrics)
- [<span data-ttu-id="b7a66-386">Application Insights SDK for Service Fabric</span><span class="sxs-lookup"><span data-stu-id="b7a66-386">Application Insights SDK for Service Fabric</span></span>](https://github.com/Microsoft/ApplicationInsights-ServiceFabric)

<span data-ttu-id="b7a66-387">ASP.NET Core サービスでは、アプリケーション ログ記録に [ILogger インターフェイス](/aspnet/core/fundamentals/logging/?view=aspnetcore-2.2)が使用されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-387">ASP.NET Core services use the [ILogger interface](/aspnet/core/fundamentals/logging/?view=aspnetcore-2.2) for application logging.</span></span> <span data-ttu-id="b7a66-388">これらのアプリケーション ログを Azure Monitor で使用できるようにするには、`ILogger` イベントを Application Insights に送信します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-388">To make these application logs available in Azure Monitor, send the `ILogger` events to Application Insights.</span></span> <span data-ttu-id="b7a66-389">詳しくは、「[ILogger in an ASP.NET Core application (ASP.NET Core アプリケーションでの ILogger)](https://github.com/Microsoft/ApplicationInsights-dotnet-logging/blob/develop/src/ILogger/Readme.md#aspnet-core-application)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-389">For more information, see [ILogger in an ASP.NET Core application](https://github.com/Microsoft/ApplicationInsights-dotnet-logging/blob/develop/src/ILogger/Readme.md#aspnet-core-application).</span></span> <span data-ttu-id="b7a66-390">Application Insights では、相関関係プロパティを ILogger イベントに追加できます。これは、分散トレースの視覚化に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-390">Application Insights can add correlation properties to ILogger events, which is useful for visualizing distributed tracing.</span></span>

<span data-ttu-id="b7a66-391">詳細については、次を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-391">For more information, see:</span></span>

- [<span data-ttu-id="b7a66-392">アプリケーションのログ記録</span><span class="sxs-lookup"><span data-stu-id="b7a66-392">Application logging</span></span>](/azure/service-fabric/service-fabric-diagnostics-event-generation-app)
- [<span data-ttu-id="b7a66-393">Service Fabric アプリケーションにログ記録を追加する</span><span class="sxs-lookup"><span data-stu-id="b7a66-393">Add logging to your Service Fabric application</span></span>](/azure/azure-monitor/app/correlation)

### <a name="service-fabric-health-and-event-data"></a><span data-ttu-id="b7a66-394">Service Fabric の正常性とイベント データ</span><span class="sxs-lookup"><span data-stu-id="b7a66-394">Service Fabric health and event data</span></span>

<span data-ttu-id="b7a66-395">Service Fabric のテレメトリには、Service Fabric クラスターとそのエンティティ (ノード、アプリケーション、サービス、パーティション、レプリカ) の操作とパフォーマンスに関する正常性メトリックとイベントが含まれます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-395">Service Fabric telemetry includes health metrics and events about the operation and performance of a Service Fabric cluster and its entities: its nodes, applications, services, partitions, and replicas.</span></span>

- <span data-ttu-id="b7a66-396">[EventStore](/azure/service-fabric/service-fabric-diagnostics-eventstore)。</span><span class="sxs-lookup"><span data-stu-id="b7a66-396">[EventStore](/azure/service-fabric/service-fabric-diagnostics-eventstore).</span></span> <span data-ttu-id="b7a66-397">クラスターとそのエンティティに関連するイベントを収集するステートフルなシステム サービスです。</span><span class="sxs-lookup"><span data-stu-id="b7a66-397">A stateful system service that collects events related to the cluster and its entities.</span></span> <span data-ttu-id="b7a66-398">Service Fabric では EventStore を使用して [Service Fabric イベント](/azure/service-fabric/service-fabric-diagnostics-event-generation-operational)が書き込まれてクラスターに関する情報が提供され、状態の更新、トラブルシューティング、監視に使用できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-398">Service Fabric uses EventStore to write [Service Fabric events](/azure/service-fabric/service-fabric-diagnostics-event-generation-operational) to provide information about your cluster and can be used for status updates, troubleshooting, monitoring.</span></span> <span data-ttu-id="b7a66-399">また、特定の時点でのさまざまなエンティティからのイベントが関連付けられ、クラスター内の問題が識別されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-399">It can also correlate events from different entities at a given time to identify issues in the cluster.</span></span> <span data-ttu-id="b7a66-400">サービスでは、REST API を介してこれらのイベントが公開されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-400">The service exposes those events through a REST API.</span></span> <span data-ttu-id="b7a66-401">EventStore API のクエリを実行する方法については、「[クラスター イベントに対して EventStore API のクエリを実行する](/azure/service-fabric/service-fabric-diagnostics-eventstore-query)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-401">For information about how to query the EventStore APIs, see [Query EventStore APIs for cluster events](/azure/service-fabric/service-fabric-diagnostics-eventstore-query).</span></span> <span data-ttu-id="b7a66-402">WAD 拡張機能でクラスターを構成することにより、Log Analytics で EventStore からのイベントを表示できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-402">You can view the events from EventStore in Log Analytics by configuring your cluster with WAD extension.</span></span>
- <span data-ttu-id="b7a66-403">[HealthStore](/azure/service-fabric/service-fabric-health-introduction)。</span><span class="sxs-lookup"><span data-stu-id="b7a66-403">[HealthStore](/azure/service-fabric/service-fabric-health-introduction).</span></span> <span data-ttu-id="b7a66-404">クラスターの現在の正常性のスナップショットが提供されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-404">Provides a snapshot of the current health of the cluster.</span></span> <span data-ttu-id="b7a66-405">階層内のエンティティによって報告されたすべての正常性データを集約するステートフル サービスです。</span><span class="sxs-lookup"><span data-stu-id="b7a66-405">A stateful service that aggregates all health data reported by entities in a hierarchy.</span></span> <span data-ttu-id="b7a66-406">データは、[Service Fabric Explorer][sfx] で視覚化されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-406">The data is visualized in [Service Fabric Explorer][sfx].</span></span> <span data-ttu-id="b7a66-407">HealthStore では、アプリケーションのアップグレードも監視されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-407">The HealthStore also monitors application upgrades.</span></span> <span data-ttu-id="b7a66-408">PowerShell、.NET アプリケーション、または REST API で、正常性クエリを使用できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-408">You can use health queries in PowerShell, a .NET application, or REST APIs.</span></span> <span data-ttu-id="b7a66-409">「[Service Fabric の正常性モニタリングの概要](/azure/service-fabric/service-fabric-health-introduction)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-409">See, [Introduction to Service Fabric health monitoring](/azure/service-fabric/service-fabric-health-introduction).</span></span>
- <span data-ttu-id="b7a66-410">内部カスタム ウォッチドッグ サービスの実装を検討します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-410">Consider implementing internal custom watchdog services.</span></span> <span data-ttu-id="b7a66-411">それらのサービスでは、実行中のサービスの障害の状態など、カスタム正常性データを定期的に報告できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-411">Those services can periodically report custom health data such as faulty states of running services.</span></span> <span data-ttu-id="b7a66-412">詳しくは、[カスタム正常性レポート](/azure/service-fabric/service-fabric-report-health)に関する記事をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-412">For more information, see [Custom health reports](/azure/service-fabric/service-fabric-report-health).</span></span> <span data-ttu-id="b7a66-413">Service Fabric Explorer を使用して正常性レポートを読み取ることができます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-413">You can read the health reports using the Service Fabric explorer.</span></span>  

### <a name="infrastructure-metrics-and-logs"></a><span data-ttu-id="b7a66-414">インフラストラクチャのメトリックとログ</span><span class="sxs-lookup"><span data-stu-id="b7a66-414">Infrastructure metrics and logs</span></span>

<span data-ttu-id="b7a66-415">インフラストラクチャのメトリックを使用すると、クラスター内のリソース割り当てを理解できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-415">Infrastructure metrics help you to understand resource allocation in the cluster.</span></span> <span data-ttu-id="b7a66-416">この情報を収集するための主なオプションを次に示します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-416">Here are the main options for collecting this information:</span></span>

- <span data-ttu-id="b7a66-417">Windows Azure Diagnostics (WAD)。</span><span class="sxs-lookup"><span data-stu-id="b7a66-417">Windows Azure Diagnostics (WAD).</span></span> <span data-ttu-id="b7a66-418">Windows のノード レベルでログとメトリックを収集します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-418">Collect logs and metrics at the node level on Windows.</span></span> <span data-ttu-id="b7a66-419">ノード タイプにマップされる任意の仮想マシン スケール セットで IaaSDiagnostics VM 拡張機能を構成することによって WAD を使用して、Windows イベント ログ、パフォーマンス カウンター、ETW/マニフェスト システムと運用イベント、カスタム ログなどの診断イベントを収集できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-419">You can use WAD by configuring the IaaSDiagnostics VM extension on any virtual machine scale set that is mapped to a node type to collect diagnostic events, such as Windows event logs, performance counters, ETW/manifests system and operational events, and custom logs.</span></span>
- <span data-ttu-id="b7a66-420">Log Analytics エージェント。</span><span class="sxs-lookup"><span data-stu-id="b7a66-420">Log Analytics agent.</span></span> <span data-ttu-id="b7a66-421">MicrosoftMonitoringAgent VM 拡張機能を構成し、Windows イベント ログ、パフォーマンス カウンター、カスタム ログを Log Analytics に送信します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-421">Configure the MicrosoftMonitoringAgent VM extension to send Windows event logs, performance counters, and custom logs to Log Analytics.</span></span>

<span data-ttu-id="b7a66-422">パフォーマンス カウンターなど、上記のメカニズムを通じて収集されるメトリックの種類にはいくつか重複するものがあります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-422">There is some overlap in the type of metrics collected through the preceding mechanisms, such as performance counters.</span></span> <span data-ttu-id="b7a66-423">重複する部分がある場合は、Log Analytics エージェントを使うことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="b7a66-423">Where there is overlap, we recommend using the Log Analytics agent.</span></span> <span data-ttu-id="b7a66-424">Log Analytics エージェントの場合は Azure ストレージがないため、待ち時間が短くなります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-424">Because there is no Azure storage for the Log Analytics agent, there is low latency.</span></span> <span data-ttu-id="b7a66-425">また、IaaSDiagnostics のパフォーマンス カウンターでは、Log Analytics に簡単にフィードできません。</span><span class="sxs-lookup"><span data-stu-id="b7a66-425">Also, the performance counters in IaaSDiagnostics cannot be fed into Log Analytics easily.</span></span>

![Service Fabric でのインフラストラクチャの監視](./_images/ra-sf-monitoring.png)

<span data-ttu-id="b7a66-427">VM 拡張機能の使用については、「[Azure 仮想マシンの拡張機能と機能](/azure/virtual-machines/extensions/overview)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-427">For information about using VM extensions, see [Azure virtual machine extensions and features](/azure/virtual-machines/extensions/overview).</span></span>

<span data-ttu-id="b7a66-428">データを表示するには、WAD によって収集されたデータを表示するように Log Analytics を構成します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-428">To view the data, configure Log Analytics to view the data collected through WAD.</span></span> <span data-ttu-id="b7a66-429">ストレージ アカウントからイベントを読み取るように Log Analytics を構成する方法については、「[クラスターに Log Analytics を設定する](/azure/service-fabric/service-fabric-diagnostics-oms-setup)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-429">For information about how to configure Log Analytics to read events from a storage account, see [Set up Log Analytics for a cluster](/azure/service-fabric/service-fabric-diagnostics-oms-setup).</span></span>

<span data-ttu-id="b7a66-430">Service Fabric クラスター、ワークロード、ネットワーク トラフィック、保留中の更新プログラムなどに関連するパフォーマンス ログと テレメトリ データを表示することもできます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-430">You can also view performance logs and telemetry data related to a Service Fabric cluster, workloads, network traffic, pending updates, and more.</span></span> <span data-ttu-id="b7a66-431">「[Log Analytics でのパフォーマンスの監視](/azure/service-fabric/service-fabric-diagnostics-oms-agent)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-431">See [Performance Monitoring with Log Analytics](/azure/service-fabric/service-fabric-diagnostics-oms-agent).</span></span>

<span data-ttu-id="b7a66-432">[Log Analytics の Service Map ソリューション](/azure/azure-monitor/insights/service-map)では、クラスターのトポロジ (つまり、各ノードで実行されているプロセス) に関する情報が提供されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-432">[Service Map solution in Log Analytics](/azure/azure-monitor/insights/service-map) provides information about the topology of the cluster (that is, the processes running in each node).</span></span> <span data-ttu-id="b7a66-433">ストレージ アカウント内のデータを [Application Insights](/azure/monitoring-and-diagnostics/azure-diagnostics-configure-application-insights) に送信します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-433">Send the data in the storage account to [Application Insights](/azure/monitoring-and-diagnostics/azure-diagnostics-configure-application-insights).</span></span> <span data-ttu-id="b7a66-434">Application Insights へのデータの取得には若干の遅延がある可能性があります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-434">There might be some delay in getting data into Application Insights.</span></span> <span data-ttu-id="b7a66-435">データをリアルタイムで見たい場合は、シンクとチャネルを使用して [Event Hubs](/azure/monitoring-and-diagnostics/azure-diagnostics-streaming-event-hubs) を構成することを考えます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-435">If you want to see the data real time, consider configuring [Event Hub](/azure/monitoring-and-diagnostics/azure-diagnostics-streaming-event-hubs) using sinks and channels.</span></span> <span data-ttu-id="b7a66-436">詳しくは、「[Windows Azure 診断を使用したイベントの集計と収集](/azure/service-fabric/service-fabric-diagnostics-event-aggregation-wad)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-436">For more information, see [Event aggregation and collection using Windows Azure Diagnostics](/azure/service-fabric/service-fabric-diagnostics-event-aggregation-wad).</span></span>

### <a name="dependent-service-metrics"></a><span data-ttu-id="b7a66-437">依存サービスのメトリック</span><span class="sxs-lookup"><span data-stu-id="b7a66-437">Dependent service metrics</span></span>

- <span data-ttu-id="b7a66-438">[Application Insights のアプリケーション マップ](/azure/azure-monitor/app/app-map)では、インストールされている Application Insights SDK によりサービス間で行われた HTTP 依存関係呼び出しを使用して、アプリケーションのトポロジが提供されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-438">[Application Insights Application Map](/azure/azure-monitor/app/app-map) provides the topology of the application by using HTTP dependency calls made between services, with the installed Application Insights SDK.</span></span>
- <span data-ttu-id="b7a66-439">[Log Analytics の Service Map ソリューション](/azure/azure-monitor/insights/service-map)では、外部サービスとの間の受信および送信トラフィックについての情報が提供されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-439">[Service Map solution in Log Analytics](/azure/azure-monitor/insights/service-map) provides information about inbound and outbound traffic from/to external services.</span></span> <span data-ttu-id="b7a66-440">さらに、Service Map は、更新やセキュリティなどの他のソリューションと統合します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-440">In addition, Service Map integrates with other solutions such as updates or security.</span></span>
- <span data-ttu-id="b7a66-441">カスタム ウォッチドッグを使用すると、外部サービスでのエラー状態をレポートできます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-441">Custom watchdogs can be used to report error conditions on external services.</span></span> <span data-ttu-id="b7a66-442">たとえば、サービスは、外部サービスまたはデータ ストレージ (Azure Cosmos DB) にアクセスできない場合に、エラー正常性レポートを報告します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-442">For example, the service could report an error health report if it cannot access an external service or data storage (Azure Cosmos DB).</span></span>  

### <a name="distributed-tracing"></a><span data-ttu-id="b7a66-443">分散トレース</span><span class="sxs-lookup"><span data-stu-id="b7a66-443">Distributed tracing</span></span>

<span data-ttu-id="b7a66-444">マイクロサービス アーキテクチャでは、タスクを完了するために複数のサービスが参加することがよくあります。</span><span class="sxs-lookup"><span data-stu-id="b7a66-444">In microservices architecture, several services often participate to complete a task.</span></span> <span data-ttu-id="b7a66-445">それらの各サービスからのテレメトリは、分散トレースのコンテキスト フィールド (操作 ID、要求 ID など) を使用して関連付けられます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-445">The telemetry from each of those services is correlated by using context fields (operation ID, request ID, and so forth) in a distributed trace.</span></span> <span data-ttu-id="b7a66-446">Application Insights で[アプリケーション マップ](/azure/azure-monitor/app/app-map)を使用することにより、分散型論理操作のビューを構築し、アプリケーションのサービス グラフ全体を視覚化できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-446">By using [Application Map](/azure/azure-monitor/app/app-map) in Application Insights, you can build the view of distributed logical operation and visualize the entire service graph of your application.</span></span> <span data-ttu-id="b7a66-447">また、Application Insight でトランザクション診断を使用して、サーバー側テレメトリを関連付けることもできます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-447">You can also use transaction diagnostics in Application Insight to correlate server-side telemetry.</span></span> <span data-ttu-id="b7a66-448">くわしくは、「[統合されたコンポーネント間のトランザクションの診断](/azure/application-insights/app-insights-transaction-diagnostics)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-448">For more information, see [Unified cross-component transaction diagnostics](/azure/application-insights/app-insights-transaction-diagnostics).</span></span>

<span data-ttu-id="b7a66-449">[Application Insights のアプリケーション マップ](/azure/azure-monitor/app/app-map)では、インストールされている Application Insights SDK によりサービス間で行われた HTTP 依存関係呼び出しを使用して、アプリケーションのトポロジが提供されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-449">[Application Insights Application Map](/azure/azure-monitor/app/app-map) provides the topology of the application by using HTTP dependency calls made between  services, with the installed Application Insights SDK.</span></span> <span data-ttu-id="b7a66-450">キューを使用して非同期にディスパッチされるタスクを関連付けることも重要です。</span><span class="sxs-lookup"><span data-stu-id="b7a66-450">It’s also important to correlate tasks that are dispatched asynchronously using a queue.</span></span> <span data-ttu-id="b7a66-451">キュー メッセージで相関関係テレメトリを送信する方法について詳しくは、「[キューのインストルメンテーション](/azure/azure-monitor/app/custom-operations-tracking#queue-instrumentation)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-451">For details about sending correlation telemetry in a queue message, see [Queue instrumentation](/azure/azure-monitor/app/custom-operations-tracking#queue-instrumentation).</span></span>

<span data-ttu-id="b7a66-452">詳細については、次を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-452">For more information, see:</span></span>

- [<span data-ttu-id="b7a66-453">複数のリソース間でのクエリの実行</span><span class="sxs-lookup"><span data-stu-id="b7a66-453">Performing a query across multiple resources</span></span>](/azure/azure-monitor/log-query/cross-workspace-query#performing-a-query-across-multiple-resources)
- [<span data-ttu-id="b7a66-454">Application Insights におけるテレメトリの相関付け</span><span class="sxs-lookup"><span data-stu-id="b7a66-454">Telemetry correlation in Application Insights</span></span>](/azure/azure-monitor/app/correlation)

#### <a name="alerts-and-dashboards"></a><span data-ttu-id="b7a66-455">アラートとダッシュボード</span><span class="sxs-lookup"><span data-stu-id="b7a66-455">Alerts and Dashboards</span></span>

<span data-ttu-id="b7a66-456">Application Insights と Log Analytics では[広範なクエリ言語](/azure/log-analytics/query-language/get-started-queries) (Kusto クエリ言語) がサポートされており、ログ データを取得して分析できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-456">Application Insights and Log Analytics support an [extensive query language](/azure/log-analytics/query-language/get-started-queries) (Kusto query language) that lets you retrieve and analyze log data.</span></span> <span data-ttu-id="b7a66-457">クエリを使用してデータ セットを作成し、診断ダッシュボードでそれを視覚化します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-457">Use the queries to create data sets and visualize it in diagnostics dashboards.</span></span>

<span data-ttu-id="b7a66-458">Azure Monitor のアラートを使用して、特定のリソースで特定の状態が発生したときにシステム管理者に通知します。</span><span class="sxs-lookup"><span data-stu-id="b7a66-458">Use Azure Monitor alerts to notify sysadmins when certain conditions occur in specific resources.</span></span> <span data-ttu-id="b7a66-459">通知には、メール、Azure 関数、Webhook の呼び出しなどを使用できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-459">The notification could be an email, Azure function, call a web hook, and so on.</span></span> <span data-ttu-id="b7a66-460">詳しくは、[Azure Monitor でのアラート](/azure/azure-monitor/platform/alerts-overview)に関する記事をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="b7a66-460">For more information, see [Alerts in Azure Monitor](/azure/azure-monitor/platform/alerts-overview).</span></span>

<span data-ttu-id="b7a66-461">[ログ検索アラート ルール](/azure/azure-monitor/platform/alerts-unified-log)では、Kusto クエリを定義し、一定の間隔で Log Analytics ワークスペースに対して実行できます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-461">[Log search alert rules](/azure/azure-monitor/platform/alerts-unified-log) allow you to define and run a Kusto query against a Log Analytics workspace at regular intervals.</span></span> <span data-ttu-id="b7a66-462">クエリの結果が特定の条件に一致する場合は、アラートが作成されます。</span><span class="sxs-lookup"><span data-stu-id="b7a66-462">An alert is created if the query result matches a certain condition.</span></span>

## <a name="next-steps"></a><span data-ttu-id="b7a66-463">次の手順</span><span class="sxs-lookup"><span data-stu-id="b7a66-463">Next steps</span></span>

- [<span data-ttu-id="b7a66-464">ドメイン分析を使用したマイクロサービスのモデル化</span><span class="sxs-lookup"><span data-stu-id="b7a66-464">Using domain analysis to model microservices</span></span>](../../microservices/model/domain-analysis.md)
- [<span data-ttu-id="b7a66-465">マイクロサービス アーキテクチャの設計</span><span class="sxs-lookup"><span data-stu-id="b7a66-465">Designing a microservices architecture</span></span>](../../microservices/design/index.md)

[sfx]: /azure/service-fabric/service-fabric-visualizing-your-cluster

---
title: 高可用性のためのマルチリージョン n 層アプリケーション
titleSuffix: Azure Reference Architectures
description: 高可用性と回復性を得るために複数のリージョンの Azure 仮想マシンにアプリケーションをデプロイします。
author: MikeWasson
ms.date: 07/19/2018
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: seodec18
ms.openlocfilehash: 9fce082a0e762e25981929f6fa8685033017f3eb
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/20/2019
ms.locfileid: "58245473"
---
# <a name="run-an-n-tier-application-in-multiple-azure-regions-for-high-availability"></a><span data-ttu-id="ff86e-103">高可用性を得るために複数の Azure リージョンで N 層アプリケーションを実行する</span><span class="sxs-lookup"><span data-stu-id="ff86e-103">Run an N-tier application in multiple Azure regions for high availability</span></span>

<span data-ttu-id="ff86e-104">このリファレンス アーキテクチャは、可用性と堅牢な災害復旧インフラストラクチャを実現するために、複数の Azure リージョンで N 層アプリケーションを実行するための一連の実証済みのプラクティスを示しています。</span><span class="sxs-lookup"><span data-stu-id="ff86e-104">This reference architecture shows a set of proven practices for running an N-tier application in multiple Azure regions, in order to achieve availability and a robust disaster recovery infrastructure.</span></span>

![Azure の N 層アプリケーション用の可用性の高いネットワーク アーキテクチャ"](./images/multi-region-sql-server.png)

<span data-ttu-id="ff86e-106">"*このアーキテクチャの [Visio ファイル][visio-download]をダウンロードします。*"</span><span class="sxs-lookup"><span data-stu-id="ff86e-106">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="ff86e-107">アーキテクチャ</span><span class="sxs-lookup"><span data-stu-id="ff86e-107">Architecture</span></span>

<span data-ttu-id="ff86e-108">このアーキテクチャは、「[SQL Server を使用した n 層アプリケーション](n-tier-sql-server.md)」に示されているアーキテクチャの上に構築されています。</span><span class="sxs-lookup"><span data-stu-id="ff86e-108">This architecture builds on the one shown in [N-tier application with SQL Server](n-tier-sql-server.md).</span></span>

- <span data-ttu-id="ff86e-109">**プライマリ リージョンとセカンダリ リージョン**。</span><span class="sxs-lookup"><span data-stu-id="ff86e-109">**Primary and secondary regions**.</span></span> <span data-ttu-id="ff86e-110">2 つのリージョンを使用して高可用性を実現します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-110">Use two regions to achieve higher availability.</span></span> <span data-ttu-id="ff86e-111">1 つはプライマリ リージョンであり、</span><span class="sxs-lookup"><span data-stu-id="ff86e-111">One is the primary region.</span></span> <span data-ttu-id="ff86e-112">他方のリージョンはフェールオーバー用です。</span><span class="sxs-lookup"><span data-stu-id="ff86e-112">The other region is for failover.</span></span>

- <span data-ttu-id="ff86e-113">**Azure Traffic Manager**。</span><span class="sxs-lookup"><span data-stu-id="ff86e-113">**Azure Traffic Manager**.</span></span> <span data-ttu-id="ff86e-114">[Traffic Manager][traffic-manager] は、着信要求をいずれかのリージョンにルーティングします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-114">[Traffic Manager][traffic-manager] routes incoming requests to one of the regions.</span></span> <span data-ttu-id="ff86e-115">通常の運用中は、プライマリ リージョンに要求をルーティングします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-115">During normal operations, it routes requests to the primary region.</span></span> <span data-ttu-id="ff86e-116">そのリージョンが使用できなくなった場合、Traffic Manager はセカンダリ リージョンへのフェールオーバーを実行します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-116">If that region becomes unavailable, Traffic Manager fails over to the secondary region.</span></span> <span data-ttu-id="ff86e-117">詳細については、「[Traffic Manager の構成](#traffic-manager-configuration)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-117">For more information, see the section [Traffic Manager configuration](#traffic-manager-configuration).</span></span>

- <span data-ttu-id="ff86e-118">**リソース グループ**。</span><span class="sxs-lookup"><span data-stu-id="ff86e-118">**Resource groups**.</span></span> <span data-ttu-id="ff86e-119">プライマリ リージョン、セカンダリ リージョン、および Traffic Manager 用の個別の[リソース グループ][resource groups]を作成します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-119">Create separate [resource groups][resource groups] for the primary region, the secondary region, and for Traffic Manager.</span></span> <span data-ttu-id="ff86e-120">これにより、各リージョンをリソースの 1 つのコレクションとして柔軟に管理できます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-120">This gives you the flexibility to manage each region as a single collection of resources.</span></span> <span data-ttu-id="ff86e-121">たとえば、片方のリージョンの再デプロイを、他方のリージョンをダウンさせずに実行できます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-121">For example, you could redeploy one region, without taking down the other one.</span></span> <span data-ttu-id="ff86e-122">[リソース グループをリンク][resource-group-links]して、アプリケーション用のすべてのリソースを一覧表示するクエリを実行できるようにします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-122">[Link the resource groups][resource-group-links], so that you can run a query to list all the resources for the application.</span></span>

- <span data-ttu-id="ff86e-123">**VNets**。</span><span class="sxs-lookup"><span data-stu-id="ff86e-123">**VNets**.</span></span> <span data-ttu-id="ff86e-124">リージョンごとに個別の VNet を作成します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-124">Create a separate VNet for each region.</span></span> <span data-ttu-id="ff86e-125">アドレス空間が重複していないことを確認してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-125">Make sure the address spaces do not overlap.</span></span>

- <span data-ttu-id="ff86e-126">**SQL Server Always On 可用性グループ**。</span><span class="sxs-lookup"><span data-stu-id="ff86e-126">**SQL Server Always On Availability Group**.</span></span> <span data-ttu-id="ff86e-127">SQL Server を使用している場合は、[SQL Always On 可用性グループ][sql-always-on]を使用して高可用性を実現することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-127">If you are using SQL Server, we recommend [SQL Always On Availability Groups][sql-always-on] for high availability.</span></span> <span data-ttu-id="ff86e-128">両方のリージョンの SQL Server インスタンスを含む単一の可用性グループを作成します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-128">Create a single availability group that includes the SQL Server instances in both regions.</span></span>

    > [!NOTE]
    > <span data-ttu-id="ff86e-129">[Azure SQL Database][azure-sql-db] の使用も検討してください。リレーショナル データベースがクラウドサービスとして提供されます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-129">Also consider [Azure SQL Database][azure-sql-db], which provides a relational database as a cloud service.</span></span> <span data-ttu-id="ff86e-130">SQL Database では、可用性グループの構成やフェールオーバーの管理は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="ff86e-130">With SQL Database, you don't need to configure an availability group or manage failover.</span></span>
    >

- <span data-ttu-id="ff86e-131">**VPN ゲートウェイ**。</span><span class="sxs-lookup"><span data-stu-id="ff86e-131">**VPN Gateways**.</span></span> <span data-ttu-id="ff86e-132">各 VNet 内に [VPN ゲートウェイ][vpn-gateway]を作成し、[VNet 間接続][vnet-to-vnet]を構成して、2 つの VNet 間のネットワーク トラフィックが可能になるようにします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-132">Create a [VPN gateway][vpn-gateway] in each VNet, and configure a [VNet-to-VNet connection][vnet-to-vnet], to enable network traffic between the two VNets.</span></span> <span data-ttu-id="ff86e-133">これは、SQL Always On 可用性グループで必要です。</span><span class="sxs-lookup"><span data-stu-id="ff86e-133">This is required for the SQL Always On Availability Group.</span></span>

## <a name="recommendations"></a><span data-ttu-id="ff86e-134">Recommendations</span><span class="sxs-lookup"><span data-stu-id="ff86e-134">Recommendations</span></span>

<span data-ttu-id="ff86e-135">マルチリージョン アーキテクチャは、単一のリージョンにデプロイするよりも高い可用性を提供できます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-135">A multi-region architecture can provide higher availability than deploying to a single region.</span></span> <span data-ttu-id="ff86e-136">地域的な停止がプライマリ リージョンに影響する場合は、[Traffic Manager][traffic-manager] を使用して、セカンダリ リージョンにフェールオーバーできます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-136">If a regional outage affects the primary region, you can use [Traffic Manager][traffic-manager] to fail over to the secondary region.</span></span> <span data-ttu-id="ff86e-137">このアーキテクチャは、アプリケーションの個々のサブシステムが失敗した場合にも役立ちます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-137">This architecture can also help if an individual subsystem of the application fails.</span></span>

<span data-ttu-id="ff86e-138">リージョン間で高可用性を実現する一般的な方法はいくつかあります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-138">There are several general approaches to achieving high availability across regions:</span></span>

- <span data-ttu-id="ff86e-139">アクティブ/パッシブ (ホット スタンバイ)。</span><span class="sxs-lookup"><span data-stu-id="ff86e-139">Active/passive with hot standby.</span></span> <span data-ttu-id="ff86e-140">トラフィックが片方のリージョンにルーティングされている間、他方のリージョンは、ホット スタンバイ状態で待機します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-140">Traffic goes to one region, while the other waits on hot standby.</span></span> <span data-ttu-id="ff86e-141">ホット スタンバイとは、セカンダリ リージョン内の VM が割り当て済みであり、常に実行されていることを意味します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-141">Hot standby means the VMs in the secondary region are allocated and running at all times.</span></span>
- <span data-ttu-id="ff86e-142">アクティブ/パッシブ (コールド スタンバイ)。</span><span class="sxs-lookup"><span data-stu-id="ff86e-142">Active/passive with cold standby.</span></span> <span data-ttu-id="ff86e-143">トラフィックが片方のリージョンにルーティングされている間、他方のリージョンは、コールド スタンバイ状態で待機します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-143">Traffic goes to one region, while the other waits on cold standby.</span></span> <span data-ttu-id="ff86e-144">コールド スタンバイとは、セカンダリ リージョン内の VM がフェールオーバーが必要になるまで割り当てられないことを意味します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-144">Cold standby means the VMs in the secondary region are not allocated until needed for failover.</span></span> <span data-ttu-id="ff86e-145">この方法のほうが実行コストは低くなりますが、ほとんどの場合、障害発生時にオンラインになるまでの時間が長くなります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-145">This approach costs less to run, but will generally take longer to come online during a failure.</span></span>
- <span data-ttu-id="ff86e-146">アクティブ/アクティブ。</span><span class="sxs-lookup"><span data-stu-id="ff86e-146">Active/active.</span></span> <span data-ttu-id="ff86e-147">両方のリージョンがアクティブであり、要求はそれらの間で負荷分散されます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-147">Both regions are active, and requests are load balanced between them.</span></span> <span data-ttu-id="ff86e-148">片方のリージョンが使用できなくなった場合は、ローテーションから外されます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-148">If one region becomes unavailable, it is taken out of rotation.</span></span>

<span data-ttu-id="ff86e-149">この参照アーキテクチャでは、Traffic Manager を使用してフェールオーバーを行うアクティブ/パッシブ (ホット スタンバイ) に焦点を当てています。</span><span class="sxs-lookup"><span data-stu-id="ff86e-149">This reference architecture focuses on active/passive with hot standby, using Traffic Manager for failover.</span></span> <span data-ttu-id="ff86e-150">ホット スタンバイ用の少数の VM をデプロイした後、必要に応じてスケール アウトできることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-150">Note that you could deploy a small number of VMs for hot standby and then scale out as needed.</span></span>

### <a name="regional-pairing"></a><span data-ttu-id="ff86e-151">リージョンのペアリング</span><span class="sxs-lookup"><span data-stu-id="ff86e-151">Regional pairing</span></span>

<span data-ttu-id="ff86e-152">各 Azure リージョンは、同じ地区内の別のリージョンとペアリングされます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-152">Each Azure region is paired with another region within the same geography.</span></span> <span data-ttu-id="ff86e-153">通常は、同じリージョン ペアからリージョンを選択します (たとえば、米国東部 2 と米国中部)。</span><span class="sxs-lookup"><span data-stu-id="ff86e-153">In general, choose regions from the same regional pair (for example, East US 2 and US Central).</span></span> <span data-ttu-id="ff86e-154">これには、次のような利点があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-154">Benefits of doing so include:</span></span>

- <span data-ttu-id="ff86e-155">広範囲にわたる停止が発生した場合は、すべてのペアで、少なくとも 1 つのリージョンの復旧が優先的に実行されます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-155">If there is a broad outage, recovery of at least one region out of every pair is prioritized.</span></span>
- <span data-ttu-id="ff86e-156">Azure システムの計画的更新は、起こり得るダウンタイムを最小限に抑えるために、ペアになっているリージョンに対して順にロールアウトされます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-156">Planned Azure system updates are rolled out to paired regions sequentially, to minimize possible downtime.</span></span>
- <span data-ttu-id="ff86e-157">ペアは、データの所在地要件を満たすために同じ地区内に所在します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-157">Pairs reside within the same geography, to meet data residency requirements.</span></span>

<span data-ttu-id="ff86e-158">ただし、両方のリージョンでアプリケーションに必要なすべての Azure サービスがサポートされていることを確認してください ([リージョン別サービス][services-by-region]に関する記事を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="ff86e-158">However, make sure that both regions support all of the Azure services needed for your application (see [Services by region][services-by-region]).</span></span> <span data-ttu-id="ff86e-159">リージョン ペアの詳細については、「[ビジネス継続性とディザスター リカバリー (BCDR):Azure のペアになっているリージョン][regional-pairs]」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-159">For more information about regional pairs, see [Business continuity and disaster recovery (BCDR): Azure Paired Regions][regional-pairs].</span></span>

### <a name="traffic-manager-configuration"></a><span data-ttu-id="ff86e-160">Traffic Manager の構成</span><span class="sxs-lookup"><span data-stu-id="ff86e-160">Traffic Manager configuration</span></span>

<span data-ttu-id="ff86e-161">Traffic Manager を構成するときは、次の点を検討してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-161">Consider the following points when configuring Traffic Manager:</span></span>

- <span data-ttu-id="ff86e-162">**ルーティング**。</span><span class="sxs-lookup"><span data-stu-id="ff86e-162">**Routing**.</span></span> <span data-ttu-id="ff86e-163">Traffic Manager は、さまざまな[ルーティング アルゴリズム][tm-routing]をサポートしています。</span><span class="sxs-lookup"><span data-stu-id="ff86e-163">Traffic Manager supports several [routing algorithms][tm-routing].</span></span> <span data-ttu-id="ff86e-164">この記事で説明するシナリオでは、"*優先度による*" ルーティング (旧称 "*フェールオーバー*" ルーティング) を使用します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-164">For the scenario described in this article, use *priority* routing (formerly called *failover* routing).</span></span> <span data-ttu-id="ff86e-165">この設定では、プライマリ リージョンが到達不能にならない限り、Traffic Manager はプライマリ リージョンにすべての要求を送信します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-165">With this setting, Traffic Manager sends all requests to the primary region, unless the primary region becomes unreachable.</span></span> <span data-ttu-id="ff86e-166">到達不能になった時点で、セカンダリ リージョンに自動的にフェールオーバーします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-166">At that point, it automatically fails over to the secondary region.</span></span> <span data-ttu-id="ff86e-167">[フェールオーバーのルーティング方法の構成][tm-configure-failover]に関する記事を参照してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-167">See [Configure Failover routing method][tm-configure-failover].</span></span>
- <span data-ttu-id="ff86e-168">**正常性プローブ**。</span><span class="sxs-lookup"><span data-stu-id="ff86e-168">**Health probe**.</span></span> <span data-ttu-id="ff86e-169">Traffic Manager は、HTTP (または HTTPS) [プローブ][tm-monitoring]を使用して、各リージョンの可用性を監視します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-169">Traffic Manager uses an HTTP (or HTTPS) [probe][tm-monitoring] to monitor the availability of each region.</span></span> <span data-ttu-id="ff86e-170">プローブは、特定の URL パスの HTTP 200 応答をチェックします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-170">The probe checks for an HTTP 200 response for a specified URL path.</span></span> <span data-ttu-id="ff86e-171">ベスト プラクティスとして、アプリケーションの全体的な正常性を報告するエンドポイントを作成し、そのエンドポイントを正常性プローブ用に使用します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-171">As a best practice, create an endpoint that reports the overall health of the application, and use this endpoint for the health probe.</span></span> <span data-ttu-id="ff86e-172">これを行わなかった場合、プローブは、アプリケーションの重要な部分で実際には障害が発生しているにもかかわらず、エンドポイントが正常であると報告する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-172">Otherwise, the probe might report a healthy endpoint when critical parts of the application are actually failing.</span></span> <span data-ttu-id="ff86e-173">詳細については、「[正常性エンドポイントの監視パターン][health-endpoint-monitoring-pattern]」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-173">For more information, see [Health Endpoint Monitoring pattern][health-endpoint-monitoring-pattern].</span></span>

<span data-ttu-id="ff86e-174">Traffic Manager がフェールオーバーを実行すると、クライアントがアプリケーションに到達できない時間が発生します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-174">When Traffic Manager fails over there is a period of time when clients cannot reach the application.</span></span> <span data-ttu-id="ff86e-175">この持続時間は、次の要因に影響されます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-175">The duration is affected by the following factors:</span></span>

- <span data-ttu-id="ff86e-176">正常性プローブが、プライマリ リージョンが到達不能になっていることを検出する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-176">The health probe must detect that the primary region has become unreachable.</span></span>
- <span data-ttu-id="ff86e-177">DNS サーバーが、IP アドレスのキャッシュされた DNS レコードを更新する必要があります。これは DNS 有効期限 (TTL) に依存します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-177">DNS servers must update the cached DNS records for the IP address, which depends on the DNS time-to-live (TTL).</span></span> <span data-ttu-id="ff86e-178">TTL の既定値は 300 秒 (5 分) ですが、この値は、Traffic Manager プロファイルを作成するときに構成できます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-178">The default TTL is 300 seconds (5 minutes), but you can configure this value when you create the Traffic Manager profile.</span></span>

<span data-ttu-id="ff86e-179">詳細については、「[Traffic Manager の監視について][tm-monitoring]」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-179">For details, see [About Traffic Manager Monitoring][tm-monitoring].</span></span>

<span data-ttu-id="ff86e-180">Traffic Manager でフェールオーバーを実行する場合は、自動フェールバックを実装するのではなく、手動でフェールバックを実行することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-180">If Traffic Manager fails over, we recommend performing a manual failback rather than implementing an automatic failback.</span></span> <span data-ttu-id="ff86e-181">これを行わなかった場合、リージョン間でアプリケーションが切り替わる状況が発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-181">Otherwise, you can create a situation where the application flips back and forth between regions.</span></span> <span data-ttu-id="ff86e-182">フェールバックする前に、すべてのアプリケーション サブシステムが正常であることを確認します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-182">Verify that all application subsystems are healthy before failing back.</span></span>

<span data-ttu-id="ff86e-183">Traffic Manager は、既定では自動的にフェールバックすることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-183">Note that Traffic Manager automatically fails back by default.</span></span> <span data-ttu-id="ff86e-184">これが起こらないようにするには、フェールオーバー イベントの後、手動でプライマリ リージョンの優先度を下げます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-184">To prevent this, manually lower the priority of the primary region after a failover event.</span></span> <span data-ttu-id="ff86e-185">たとえば、プライマリ リージョンの優先度は 1、セカンダリ リージョンの優先度は 2 であるとします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-185">For example, suppose the primary region is priority 1 and the secondary is priority 2.</span></span> <span data-ttu-id="ff86e-186">フェールオーバーした後、プライマリ リージョンの優先度を 3 に設定して、自動フェールバックが起こらないにします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-186">After a failover, set the primary region to priority 3, to prevent automatic failback.</span></span> <span data-ttu-id="ff86e-187">元に戻す準備ができたら、優先度を 1 に更新します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-187">When you are ready to switch back, update the priority to 1.</span></span>

<span data-ttu-id="ff86e-188">次の [Azure CLI][azure-cli] コマンドは、優先度を更新します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-188">The following [Azure CLI][azure-cli] command updates the priority:</span></span>

```azurecli
az network traffic-manager endpoint update --resource-group <resource-group> --profile-name <profile>
    --name <endpoint-name> --type azureEndpoints --priority 3
```

<span data-ttu-id="ff86e-189">別の方法は、フェールバックの準備ができるまで、エンドポイントを一時的に無効にすることです。</span><span class="sxs-lookup"><span data-stu-id="ff86e-189">Another approach is to temporarily disable the endpoint until you are ready to fail back:</span></span>

```azurecli
az network traffic-manager endpoint update --resource-group <resource-group> --profile-name <profile>
    --name <endpoint-name> --type azureEndpoints --endpoint-status Disabled
```

<span data-ttu-id="ff86e-190">フェールオーバーの原因によっては、リソースをリージョン内に再デプロイする必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-190">Depending on the cause of a failover, you might need to redeploy the resources within a region.</span></span> <span data-ttu-id="ff86e-191">フェールバックする前に、運用準備テストを実行します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-191">Before failing back, perform an operational readiness test.</span></span> <span data-ttu-id="ff86e-192">このテストでは、以下のような点を検証する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-192">The test should verify things like:</span></span>

- <span data-ttu-id="ff86e-193">VM が正しく構成されている </span><span class="sxs-lookup"><span data-stu-id="ff86e-193">VMs are configured correctly.</span></span> <span data-ttu-id="ff86e-194">(すべての必要なソフトウェアがインストールされていること、IIS が実行されていることなど)。</span><span class="sxs-lookup"><span data-stu-id="ff86e-194">(All required software is installed, IIS is running, and so on.)</span></span>
- <span data-ttu-id="ff86e-195">アプリケーションのサブシステムが正常である。</span><span class="sxs-lookup"><span data-stu-id="ff86e-195">Application subsystems are healthy.</span></span>
- <span data-ttu-id="ff86e-196">機能テスト </span><span class="sxs-lookup"><span data-stu-id="ff86e-196">Functional testing.</span></span> <span data-ttu-id="ff86e-197">(たとえば、Web 層からデータベース層に到達可能である)。</span><span class="sxs-lookup"><span data-stu-id="ff86e-197">(For example, the database tier is reachable from the web tier.)</span></span>

### <a name="configure-sql-server-always-on-availability-groups"></a><span data-ttu-id="ff86e-198">SQL Server Always On 可用性グループを構成する</span><span class="sxs-lookup"><span data-stu-id="ff86e-198">Configure SQL Server Always On Availability Groups</span></span>

<span data-ttu-id="ff86e-199">Windows Server 2016 より前に、SQL Server Always On 可用性グループではドメイン コントローラーを必要とし、可用性グループ内のすべてのノードが同じ Active Directory (AD) ドメイン内にある必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-199">Prior to Windows Server 2016, SQL Server Always On Availability Groups require a domain controller, and all nodes in the availability group must be in the same Active Directory (AD) domain.</span></span>

<span data-ttu-id="ff86e-200">可用性グループを構成するには:</span><span class="sxs-lookup"><span data-stu-id="ff86e-200">To configure the availability group:</span></span>

- <span data-ttu-id="ff86e-201">各リージョンに少なくとも 2 つのドメイン コントローラーを配置します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-201">At a minimum, place two domain controllers in each region.</span></span>
- <span data-ttu-id="ff86e-202">各ドメイン コントローラーに静的 IP アドレスを指定します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-202">Give each domain controller a static IP address.</span></span>
- <span data-ttu-id="ff86e-203">VNet 間接続を作成して、VNet 間の通信を可能にします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-203">Create a VNet-to-VNet connection to enable communication between the VNets.</span></span>
- <span data-ttu-id="ff86e-204">各 VNet で、DNS サーバーの一覧に (両方のリージョンの) ドメイン コントローラーの IP アドレスを追加します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-204">For each VNet, add the IP addresses of the domain controllers (from both regions) to the DNS server list.</span></span> <span data-ttu-id="ff86e-205">次の CLI コマンドを使用できます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-205">You can use the following CLI command.</span></span> <span data-ttu-id="ff86e-206">詳細については、「[DNS サーバーの変更][vnet-dns]」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-206">For more information, see [Change DNS servers][vnet-dns].</span></span>

    ```azurecli
    az network vnet update --resource-group <resource-group> --name <vnet-name> --dns-servers "10.0.0.4,10.0.0.6,172.16.0.4,172.16.0.6"
    ```

- <span data-ttu-id="ff86e-207">両方のリージョンの SQL Server インスタンスを含む [Windows Server フェールオーバー クラスタリング][wsfc] (WSFC) クラスターを作成します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-207">Create a [Windows Server Failover Clustering][wsfc] (WSFC) cluster that includes the SQL Server instances in both regions.</span></span>
- <span data-ttu-id="ff86e-208">プライマリ リージョンとセカンダリ リージョンの SQL Server インスタンスを含む SQL Server Always On 可用性グループを作成します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-208">Create a SQL Server Always On Availability Group that includes the SQL Server instances in both the primary and secondary regions.</span></span> <span data-ttu-id="ff86e-209">手順については、[Always On 可用性グループのリモート Azure データセンターへの拡張 (PowerShell)](https://techcommunity.microsoft.com/t5/DataCAT/Extending-AlwaysOn-Availability-Group-to-Remote-Azure-Datacenter/ba-p/305217)に関する記事を参照してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-209">See [Extending Always On Availability Group to Remote Azure Datacenter (PowerShell)](https://techcommunity.microsoft.com/t5/DataCAT/Extending-AlwaysOn-Availability-Group-to-Remote-Azure-Datacenter/ba-p/305217) for the steps.</span></span>

  - <span data-ttu-id="ff86e-210">プライマリ レプリカをプライマリ リージョンに配置します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-210">Put the primary replica in the primary region.</span></span>
  - <span data-ttu-id="ff86e-211">1 つ以上のセカンダリ レプリカをプライマリ リージョンに配置します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-211">Put one or more secondary replicas in the primary region.</span></span> <span data-ttu-id="ff86e-212">それらを自動フェールオーバーを伴う同期コミット モードを使用するように構成します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-212">Configure these to use synchronous commit with automatic failover.</span></span>
  - <span data-ttu-id="ff86e-213">1 つ以上のセカンダリ レプリカをセカンダリ リージョンに配置します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-213">Put one or more secondary replicas in the secondary region.</span></span> <span data-ttu-id="ff86e-214">パフォーマンス上の理由で、それらは*非同期*コミットを使用するように構成します </span><span class="sxs-lookup"><span data-stu-id="ff86e-214">Configure these to use *asynchronous* commit, for performance reasons.</span></span> <span data-ttu-id="ff86e-215">(これを行わなかった場合、すべての T-SQL トランザクションがセカンダリ リージョンへのネットワーク上にラウンド トリップで待機する必要があります)。</span><span class="sxs-lookup"><span data-stu-id="ff86e-215">(Otherwise, all T-SQL transactions have to wait on a round trip over the network to the secondary region.)</span></span>

    > [!NOTE]
    > <span data-ttu-id="ff86e-216">非同期コミット レプリカは、自動フェールオーバーをサポートしません。</span><span class="sxs-lookup"><span data-stu-id="ff86e-216">Asynchronous commit replicas do not support automatic failover.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="ff86e-217">可用性に関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="ff86e-217">Availability considerations</span></span>

<span data-ttu-id="ff86e-218">複雑な N 層アプリケーションでは、アプリケーション全体をセカンダリ リージョンにレプリケートする必要はない場合があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-218">With a complex N-tier app, you may not need to replicate the entire application in the secondary region.</span></span> <span data-ttu-id="ff86e-219">代わりに、ビジネス継続性をサポートするために必要な重要なサブシステムのみをレプリケートできます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-219">Instead, you might just replicate a critical subsystem that is needed to support business continuity.</span></span>

<span data-ttu-id="ff86e-220">Traffic Manager は、システムの障害ポイントになる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-220">Traffic Manager is a possible failure point in the system.</span></span> <span data-ttu-id="ff86e-221">Traffic Manager サービスが失敗すると、クライアントは、ダウンタイム中はアプリケーションにアクセスできなくなります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-221">If the Traffic Manager service fails, clients cannot access your application during the downtime.</span></span> <span data-ttu-id="ff86e-222">「[Traffic Manager の SLA][tm-sla]」を確認して、Traffic Manager の使用だけで高可用性のビジネス要件が満たされるかどうかを確かめてください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-222">Review the [Traffic Manager SLA][tm-sla], and determine whether using Traffic Manager alone meets your business requirements for high availability.</span></span> <span data-ttu-id="ff86e-223">満たされない場合は、フェールバックとして別のトラフィック管理ソリューションを追加することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-223">If not, consider adding another traffic management solution as a failback.</span></span> <span data-ttu-id="ff86e-224">Azure Traffic Manager サービスで障害が発生した場合は、他のトラフィック管理サービスを参照するように、DNS の CNAME レコードを変更します </span><span class="sxs-lookup"><span data-stu-id="ff86e-224">If the Azure Traffic Manager service fails, change your CNAME records in DNS to point to the other traffic management service.</span></span> <span data-ttu-id="ff86e-225">(この手順は手動で実行する必要があり、DNS の変更が反映されるまでアプリケーションを使用することはできません)。</span><span class="sxs-lookup"><span data-stu-id="ff86e-225">(This step must be performed manually, and your application will be unavailable until the DNS changes are propagated.)</span></span>

<span data-ttu-id="ff86e-226">SQL Server クラスターでは、2 つのフェールオーバー シナリオを考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-226">For the SQL Server cluster, there are two failover scenarios to consider:</span></span>

- <span data-ttu-id="ff86e-227">プライマリ リージョン内のすべての SQL Server データベースのレプリカが失敗する。</span><span class="sxs-lookup"><span data-stu-id="ff86e-227">All of the SQL Server database replicas in the primary region fail.</span></span> <span data-ttu-id="ff86e-228">これは、たとえば地域的な停止中に発生することがあります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-228">For example, this could happen during a regional outage.</span></span> <span data-ttu-id="ff86e-229">この場合は、Traffic Manager がフロント エンドで自動的にフェールオーバーを実行する場合でも、可用性グループを手動でフェールオーバーする必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-229">In that case, you must manually fail over the availability group, even though Traffic Manager automatically fails over on the front end.</span></span> <span data-ttu-id="ff86e-230">「[Perform a Forced Manual Failover of a SQL Server Availability Group](https://msdn.microsoft.com/library/ff877957.aspx)」(SQL Server 可用性グループの強制手動フェールオーバーを実行する) の手順に従います。この記事では、SQL Server 2016 で SQL Server Management Studio、Transact-SQL、または PowerShell を使用して強制フェールオーバーを実行する方法が説明されています。</span><span class="sxs-lookup"><span data-stu-id="ff86e-230">Follow the steps in [Perform a Forced Manual Failover of a SQL Server Availability Group](https://msdn.microsoft.com/library/ff877957.aspx), which describes how to perform a forced failover by using SQL Server Management Studio, Transact-SQL, or PowerShell in SQL Server 2016.</span></span>

   > [!WARNING]
   > <span data-ttu-id="ff86e-231">強制フェールオーバーには、データ損失のリスクがあります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-231">With forced failover, there is a risk of data loss.</span></span> <span data-ttu-id="ff86e-232">プライマリ リージョンがオンラインに戻ったら、データベースのスナップショットを取得し、[tablediff] を使用して差異を検出してください。</span><span class="sxs-lookup"><span data-stu-id="ff86e-232">Once the primary region is back online, take a snapshot of the database and use [tablediff] to find the differences.</span></span>

- <span data-ttu-id="ff86e-233">Traffic Manager がセカンダリ リージョンへのフェールオーバーを実行するが、SQL Server データベースのプライマリ レプリカが引き続き使用可能である。</span><span class="sxs-lookup"><span data-stu-id="ff86e-233">Traffic Manager fails over to the secondary region, but the primary SQL Server database replica is still available.</span></span> <span data-ttu-id="ff86e-234">たとえば SQL Server VM に影響しない障害がフロント エンド層で発生することがあります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-234">For example, the front-end tier might fail, without affecting the SQL Server VMs.</span></span> <span data-ttu-id="ff86e-235">この場合、インターネット トラフィックはセカンダリ リージョンにルーティングされますが、セカンダリ リージョンは引き続きプライマリ レプリカに接続できます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-235">In that case, Internet traffic is routed to the secondary region, and that region can still connect to the primary replica.</span></span> <span data-ttu-id="ff86e-236">ただし、SQL Server の接続がリージョンにまたがるため、待機時間が長くなります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-236">However, there will be increased latency, because the SQL Server connections are going across regions.</span></span> <span data-ttu-id="ff86e-237">この状況では、次のように手動フェールオーバーを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff86e-237">In this situation, you should perform a manual failover as follows:</span></span>

   1. <span data-ttu-id="ff86e-238">セカンダリ リージョンの SQL Server データベースのレプリカを一時的に*同期*コミットに切り替えます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-238">Temporarily switch a SQL Server database replica in the secondary region to *synchronous* commit.</span></span> <span data-ttu-id="ff86e-239">これにより、フェールオーバー中にデータの損失が発生しないことが保証されます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-239">This ensures there won't be data loss during the failover.</span></span>
   2. <span data-ttu-id="ff86e-240">そのレプリカにフェールオーバーします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-240">Fail over to that replica.</span></span>
   3. <span data-ttu-id="ff86e-241">プライマリ リージョンにフェールバックするときに、設定を非同期コミットに戻します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-241">When you fail back to the primary region, restore the asynchronous commit setting.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="ff86e-242">管理容易性に関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="ff86e-242">Manageability considerations</span></span>

<span data-ttu-id="ff86e-243">デプロイを更新するときは、一度に 1 つのリージョンを更新することで、アプリケーションの不適切な構成やエラーによってグローバル エラーが発生する機会を減らします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-243">When you update your deployment, update one region at a time to reduce the chance of a global failure from an incorrect configuration or an error in the application.</span></span>

<span data-ttu-id="ff86e-244">システムのエラーに対する回復性をテストします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-244">Test the resiliency of the system to failures.</span></span> <span data-ttu-id="ff86e-245">テストされる一般的な障害シナリオを次に示します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-245">Here are some common failure scenarios to test:</span></span>

- <span data-ttu-id="ff86e-246">VM インスタンスのシャットダウン。</span><span class="sxs-lookup"><span data-stu-id="ff86e-246">Shut down VM instances.</span></span>
- <span data-ttu-id="ff86e-247">CPU やメモリなどのリソースへの負荷。</span><span class="sxs-lookup"><span data-stu-id="ff86e-247">Pressure resources such as CPU and memory.</span></span>
- <span data-ttu-id="ff86e-248">ネットワークの切断/遅延。</span><span class="sxs-lookup"><span data-stu-id="ff86e-248">Disconnect/delay network.</span></span>
- <span data-ttu-id="ff86e-249">プロセスのクラッシュ。</span><span class="sxs-lookup"><span data-stu-id="ff86e-249">Crash processes.</span></span>
- <span data-ttu-id="ff86e-250">証明書の期限切れ。</span><span class="sxs-lookup"><span data-stu-id="ff86e-250">Expire certificates.</span></span>
- <span data-ttu-id="ff86e-251">ハードウェア障害のシミュレート。</span><span class="sxs-lookup"><span data-stu-id="ff86e-251">Simulate hardware faults.</span></span>
- <span data-ttu-id="ff86e-252">ドメイン コントローラー上の DNS サービスのシャットダウン。</span><span class="sxs-lookup"><span data-stu-id="ff86e-252">Shut down the DNS service on the domain controllers.</span></span>

<span data-ttu-id="ff86e-253">回復時間を測定し、ビジネス要件を満たしていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="ff86e-253">Measure the recovery times and verify they meet your business requirements.</span></span> <span data-ttu-id="ff86e-254">障害モードの組み合わせもテストします。</span><span class="sxs-lookup"><span data-stu-id="ff86e-254">Test combinations of failure modes, as well.</span></span>

## <a name="related-resources"></a><span data-ttu-id="ff86e-255">関連リソース</span><span class="sxs-lookup"><span data-stu-id="ff86e-255">Related resources</span></span>

<span data-ttu-id="ff86e-256">同じテクノロジの一部を使用する具体的なソリューションを示す次の [Azure のサンプル シナリオ](/azure/architecture/example-scenario)をレビューできます。</span><span class="sxs-lookup"><span data-stu-id="ff86e-256">You may wish to review the following [Azure example scenarios](/azure/architecture/example-scenario) that demonstrate specific solutions using some of the same technologies:</span></span>

- [<span data-ttu-id="ff86e-257">Azure における高可用性とディザスター リカバリー用にビルドされた多層 Web アプリケーション</span><span class="sxs-lookup"><span data-stu-id="ff86e-257">Multitier web application built for high availability and disaster recovery on Azure</span></span>](/azure/architecture/example-scenario/infrastructure/multi-tier-app-disaster-recovery)
- [<span data-ttu-id="ff86e-258">Azure 上の Windows Server を使用した、セキュリティで保護された Web アプリケーションの構築</span><span class="sxs-lookup"><span data-stu-id="ff86e-258">Building secure web applications with Windows virtual machines on Azure</span></span>](/azure/architecture/example-scenario/infrastructure/regulated-multitier-app)

<!-- links -->

[hybrid-vpn]: ../hybrid-networking/vpn.md
[azure-dns]: /azure/dns/dns-overview
[azure-sla]: https://azure.microsoft.com/support/legal/sla/
[azure-sql-db]: /azure/sql-database/
[health-endpoint-monitoring-pattern]: https://msdn.microsoft.com/library/dn589789.aspx
[azure-cli]: /cli/azure/
[regional-pairs]: /azure/best-practices-availability-paired-regions
[resource groups]: /azure/azure-resource-manager/resource-group-overview
[resource-group-links]: /azure/resource-group-link-resources
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview
[services-by-region]: https://azure.microsoft.com/regions/#services
[sql-always-on]: https://msdn.microsoft.com/library/hh510230.aspx
[tablediff]: https://msdn.microsoft.com/library/ms162843.aspx
[tm-configure-failover]: /azure/traffic-manager/traffic-manager-configure-failover-routing-method
[tm-monitoring]: /azure/traffic-manager/traffic-manager-monitoring
[tm-routing]: /azure/traffic-manager/traffic-manager-routing-methods
[tm-sla]: https://azure.microsoft.com/support/legal/sla/traffic-manager
[traffic-manager]: https://azure.microsoft.com/services/traffic-manager
[visio-download]: https://archcenter.blob.core.windows.net/cdn/vm-reference-architectures.vsdx
[vnet-dns]: /azure/virtual-network/manage-virtual-network#change-dns-servers
[vnet-to-vnet]: /azure/vpn-gateway/vpn-gateway-vnet-vnet-rm-ps
[vpn-gateway]: /azure/vpn-gateway/vpn-gateway-about-vpngateways
[wsfc]: https://msdn.microsoft.com/library/hh270278.aspx

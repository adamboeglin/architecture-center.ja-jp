---
title: 高可用性のネットワーク仮想アプライアンスをデプロイする
titleSuffix: Azure Reference Architectures
description: 高可用性のネットワーク仮想アプライアンスをデプロイします。
author: telmosampaio
ms.date: 12/08/2018
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: seodec18, networking
ms.openlocfilehash: 18a8620d835488be7a3639e8fbde86f9f10f946c
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/20/2019
ms.locfileid: "58244993"
---
# <a name="deploy-highly-available-network-virtual-appliances"></a><span data-ttu-id="e49ce-103">高可用性のネットワーク仮想アプライアンスをデプロイする</span><span class="sxs-lookup"><span data-stu-id="e49ce-103">Deploy highly available network virtual appliances</span></span>

<span data-ttu-id="e49ce-104">この記事では、高可用性のネットワーク仮想アプライアンス (NVA) セットを Azure にデプロイする方法を示します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-104">This article shows how to deploy a set of network virtual appliances (NVAs) for high availability in Azure.</span></span> <span data-ttu-id="e49ce-105">NVA は、通常は、境界ネットワーク (DMZ とも呼ばれます) から他のネットワークまたはサブネットへのネットワーク トラフィックのフローを制御するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-105">An NVA is typically used to control the flow of network traffic from a perimeter network, also known as a DMZ, to other networks or subnets.</span></span> <span data-ttu-id="e49ce-106">Azure での DMZ の実装については、「[Microsoft クラウド サービスとネットワーク セキュリティ][cloud-security]」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="e49ce-106">To learn about implementing a DMZ in Azure, see [Microsoft cloud services and network security][cloud-security].</span></span> <span data-ttu-id="e49ce-107">この記事には、イングレスのみ、エグレスのみ、イングレスとエグレスの両方を行うアーキテクチャの例が含まれています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-107">The article includes example architectures for ingress only, egress only, and both ingress and egress.</span></span>

<span data-ttu-id="e49ce-108">**前提条件:** この記事は、Azure のネットワーク、[Azure ロード バランサー][lb-overview]、および[ユーザー定義ルート][udr-overview] (UDR) の基本的な知識があることを前提としています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-108">**Prerequisites:** This article assumes a basic understanding of Azure networking, [Azure load balancers][lb-overview], and [user-defined routes][udr-overview] (UDRs).</span></span>

## <a name="architecture-diagrams"></a><span data-ttu-id="e49ce-109">アーキテクチャの図</span><span class="sxs-lookup"><span data-stu-id="e49ce-109">Architecture diagrams</span></span>

<span data-ttu-id="e49ce-110">NVA は、さまざまなアーキテクチャの DMZ に配置できます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-110">An NVA can be deployed to a DMZ in many different architectures.</span></span> <span data-ttu-id="e49ce-111">たとえば、次の図は、イングレス用の[単一の NVA][nva-scenario] の使用を示しています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-111">For example, the following figure illustrates the use of a [single NVA][nva-scenario] for ingress.</span></span>

<span data-ttu-id="e49ce-112">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="e49ce-112">![[0]][0]</span></span>

<span data-ttu-id="e49ce-113">このアーキテクチャでは、NVA は、すべての着信ネットワーク トラフィックと発信ネットワーク トラフィックをチェックし、ネットワーク セキュリティ ルールを満たしているトラフィックのみを渡すことによって、セキュリティで保護されたネットワーク境界を提供します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-113">In this architecture, the NVA provides a secure network boundary by checking all inbound and outbound network traffic and passing only the traffic that meets network security rules.</span></span> <span data-ttu-id="e49ce-114">ただし、すべてのネットワーク トラフィックが NVA を通過する必要があるという事実は、NVA がネットワークの単一障害点であることを意味します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-114">However, the fact that all network traffic must pass through the NVA means that the NVA is a single point of failure in the network.</span></span> <span data-ttu-id="e49ce-115">この NVA で障害が発生した場合、ネットワーク トラフィック用の他のパスが存在しないため、すべてのバックエンド サブネットが使用不能になります。</span><span class="sxs-lookup"><span data-stu-id="e49ce-115">If the NVA fails, there is no other path for network traffic and all the back-end subnets are unavailable.</span></span>

<span data-ttu-id="e49ce-116">NVA に高可用性を持たせるには、複数の NVA を可用性セットにデプロイします。</span><span class="sxs-lookup"><span data-stu-id="e49ce-116">To make an NVA highly available, deploy more than one NVA into an availability set.</span></span>

<span data-ttu-id="e49ce-117">以下のアーキテクチャは、高可用性の NVA で必要なリソースと構成について説明しています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-117">The following architectures describe the resources and configuration necessary for highly available NVAs:</span></span>

<!-- markdownlint-disable MD033 -->

| <span data-ttu-id="e49ce-118">解決策</span><span class="sxs-lookup"><span data-stu-id="e49ce-118">Solution</span></span> | <span data-ttu-id="e49ce-119">メリット</span><span class="sxs-lookup"><span data-stu-id="e49ce-119">Benefits</span></span> | <span data-ttu-id="e49ce-120">考慮事項</span><span class="sxs-lookup"><span data-stu-id="e49ce-120">Considerations</span></span> |
| --- | --- | --- |
| <span data-ttu-id="e49ce-121">[第 7 層で NVA を使用するイングレス][ingress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="e49ce-121">[Ingress with layer 7 NVAs][ingress-with-layer-7]</span></span> |<span data-ttu-id="e49ce-122">すべての NVA ノードがアクティブ</span><span class="sxs-lookup"><span data-stu-id="e49ce-122">All NVA nodes are active</span></span> |<span data-ttu-id="e49ce-123">接続を終了し SNAT を使用できる NVA が必要</span><span class="sxs-lookup"><span data-stu-id="e49ce-123">Requires an NVA that can terminate connections and use SNAT</span></span><br/> <span data-ttu-id="e49ce-124">インターネットからのトラフィックと Azure からのトラフィック用に別個の NVA セットが必要</span><span class="sxs-lookup"><span data-stu-id="e49ce-124">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> <br/> <span data-ttu-id="e49ce-125">Azure の外部から発信されるトラフィックでのみ使用可能</span><span class="sxs-lookup"><span data-stu-id="e49ce-125">Can only be used for traffic originating outside Azure</span></span> |
| <span data-ttu-id="e49ce-126">[第 7 層で NVA を使用するエグレス][egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="e49ce-126">[Egress with layer 7 NVAs][egress-with-layer-7]</span></span> |<span data-ttu-id="e49ce-127">すべての NVA ノードがアクティブ</span><span class="sxs-lookup"><span data-stu-id="e49ce-127">All NVA nodes are active</span></span> | <span data-ttu-id="e49ce-128">接続を終了し、ソース ネットワーク アドレス変換 (SNAT) を実装できる NVA が必要</span><span class="sxs-lookup"><span data-stu-id="e49ce-128">Requires an NVA that can terminate connections and implements source network address translation (SNAT)</span></span>
| <span data-ttu-id="e49ce-129">[第 7 層で NVA を使用するイングレスとエグレス][ingress-egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="e49ce-129">[Ingress-Egress with layer 7 NVAs][ingress-egress-with-layer-7]</span></span> |<span data-ttu-id="e49ce-130">すべてのノードがアクティブ</span><span class="sxs-lookup"><span data-stu-id="e49ce-130">All nodes are active</span></span><br/><span data-ttu-id="e49ce-131">Azure で発信されたトラフィックを処理可能</span><span class="sxs-lookup"><span data-stu-id="e49ce-131">Able to handle traffic originated in Azure</span></span> |<span data-ttu-id="e49ce-132">接続を終了し SNAT を使用できる NVA が必要</span><span class="sxs-lookup"><span data-stu-id="e49ce-132">Requires an NVA that can terminate connections and use SNAT</span></span><br/><span data-ttu-id="e49ce-133">インターネットからのトラフィックと Azure からのトラフィック用に別個の NVA セットが必要</span><span class="sxs-lookup"><span data-stu-id="e49ce-133">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> |
| <span data-ttu-id="e49ce-134">[PIP-UDR スイッチ][pip-udr-switch]</span><span class="sxs-lookup"><span data-stu-id="e49ce-134">[PIP-UDR switch][pip-udr-switch]</span></span> |<span data-ttu-id="e49ce-135">すべてのトラフィック用の単一の NVA セット</span><span class="sxs-lookup"><span data-stu-id="e49ce-135">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="e49ce-136">すべてのトラフィックを処理可能 (ポート規則に制限なし)</span><span class="sxs-lookup"><span data-stu-id="e49ce-136">Can handle all traffic (no limit on port rules)</span></span> |<span data-ttu-id="e49ce-137">アクティブ/パッシブ</span><span class="sxs-lookup"><span data-stu-id="e49ce-137">Active-passive</span></span><br/><span data-ttu-id="e49ce-138">フェールオーバー プロセスが必要</span><span class="sxs-lookup"><span data-stu-id="e49ce-138">Requires a failover process</span></span> |
| [<span data-ttu-id="e49ce-139">SNAT なしのPIP-UDR</span><span class="sxs-lookup"><span data-stu-id="e49ce-139">PIP-UDR without SNAT</span></span>](#pip-udr-nvas-without-snat) | <span data-ttu-id="e49ce-140">すべてのトラフィック用の単一の NVA セット</span><span class="sxs-lookup"><span data-stu-id="e49ce-140">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="e49ce-141">すべてのトラフィックを処理可能 (ポート規則に制限なし)</span><span class="sxs-lookup"><span data-stu-id="e49ce-141">Can handle all traffic (no limit on port rules)</span></span><br/><span data-ttu-id="e49ce-142">着信要求に対して SNAT を構成する必要なし</span><span class="sxs-lookup"><span data-stu-id="e49ce-142">Does not require configuring SNAT for inbound requests</span></span> |<span data-ttu-id="e49ce-143">アクティブ/パッシブ</span><span class="sxs-lookup"><span data-stu-id="e49ce-143">Active-passive</span></span><br/><span data-ttu-id="e49ce-144">フェールオーバー プロセスが必要</span><span class="sxs-lookup"><span data-stu-id="e49ce-144">Requires a failover process</span></span><br/><span data-ttu-id="e49ce-145">調査とフェールオーバーのロジックを仮想ネットワークの外部で実行</span><span class="sxs-lookup"><span data-stu-id="e49ce-145">Probing and failover logic run outside the virtual network</span></span> |

<!-- markdown-enable MD033 -->

## <a name="ingress-with-layer-7-nvas"></a><span data-ttu-id="e49ce-146">第 7 層で NVA を使用するイングレス</span><span class="sxs-lookup"><span data-stu-id="e49ce-146">Ingress with layer 7 NVAs</span></span>

<span data-ttu-id="e49ce-147">次の図は、インターネットに接続するロード バランサーの背後にイングレス DMZ を実装する高可用性アーキテクチャを示しています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-147">The following figure shows a high availability architecture that implements an ingress DMZ behind an internet-facing load balancer.</span></span> <span data-ttu-id="e49ce-148">このアーキテクチャは、第 7 層のトラフィックで Azure ワークロードへの HTTP や HTTPS などの接続を提供するように設計されています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-148">This architecture is designed to provide connectivity to Azure workloads for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="e49ce-149">![[1]][1]</span><span class="sxs-lookup"><span data-stu-id="e49ce-149">![[1]][1]</span></span>

<span data-ttu-id="e49ce-150">このアーキテクチャの利点は、すべての NVA がアクティブであることであり、片方の NVA で障害が発生すると、ロード バランサーが他方の NVA にネットワーク トラフィックを送信します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-150">The benefit of this architecture is that all NVAs are active, and if one fails the load balancer directs network traffic to the other NVA.</span></span> <span data-ttu-id="e49ce-151">両方の NVA がトラフィックを内部ロード バランサーにルーティングするため、1 つの NVA がアクティブである限り、トラフィックが停止することはありません。</span><span class="sxs-lookup"><span data-stu-id="e49ce-151">Both NVAs route traffic to the internal load balancer so as long as one NVA is active, traffic continues to flow.</span></span> <span data-ttu-id="e49ce-152">Web 層の VM を対象とする SSL トラフィックを終了するには、NVA が必要です。</span><span class="sxs-lookup"><span data-stu-id="e49ce-152">The NVAs are required to terminate SSL traffic intended for the web tier VMs.</span></span> <span data-ttu-id="e49ce-153">オンプレミスのトラフィックには独自のネットワーク ルートを持つ NVA の別の専用セットが必要であるため、これらの NVA をオンプレミスのトラフィックを処理するように拡張することはできません。</span><span class="sxs-lookup"><span data-stu-id="e49ce-153">These NVAs cannot be extended to handle on-premises traffic because on-premises traffic requires another dedicated set of NVAs with their own network routes.</span></span>

> [!NOTE]
> <span data-ttu-id="e49ce-154">このアーキテクチャは、[Azure とオンプレミスのデータセンターの間の DMZ][dmz-on-premises] リファレンス アーキテクチャと [ Azure とインターネットの間の DMZ][dmz-internet] リファレンス アーキテクチャで使用されています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-154">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-premises] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="e49ce-155">これらのリファレンス アーキテクチャのそれぞれに、使用できるデプロイ ソリューションが含まれています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-155">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="e49ce-156">詳細については、リンクを参照してください。</span><span class="sxs-lookup"><span data-stu-id="e49ce-156">Follow the links for more information.</span></span>

## <a name="egress-with-layer-7-nvas"></a><span data-ttu-id="e49ce-157">第 7 層で NVA を使用するエグレス</span><span class="sxs-lookup"><span data-stu-id="e49ce-157">Egress with layer 7 NVAs</span></span>

<span data-ttu-id="e49ce-158">前述のアーキテクチャを拡張して、Azure ワークロードから発信される要求を処理するエグレス DMZ を提供できます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-158">The previous architecture can be expanded to provide an egress DMZ for requests originating in the Azure workload.</span></span> <span data-ttu-id="e49ce-159">次のアーキテクチャは、DMZ 内の NVA に、HTTP や HTTPS などの第 7 層のトラフィックで高可用性を提供するように設計されています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-159">The following architecture is designed to provide high availability of the NVAs in the DMZ for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="e49ce-160">![[2]][2]</span><span class="sxs-lookup"><span data-stu-id="e49ce-160">![[2]][2]</span></span>

<span data-ttu-id="e49ce-161">このアーキテクチャでは、Azure から発信されるすべてのトラフィックが内部ロード バランサーにルーティングされます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-161">In this architecture, all traffic originating in Azure is routed to an internal load balancer.</span></span> <span data-ttu-id="e49ce-162">ロード バランサーは、発信要求を NVA セットに分散します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-162">The load balancer distributes outgoing requests between a set of NVAs.</span></span> <span data-ttu-id="e49ce-163">これらの NVA は、それぞれのパブリック IP アドレスを使用して、インターネットにトラフィックを送信します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-163">These NVAs direct traffic to the Internet using their individual public IP addresses.</span></span>

> [!NOTE]
> <span data-ttu-id="e49ce-164">このアーキテクチャは、[Azure とオンプレミスのデータセンターの間の DMZ][dmz-on-premises] リファレンス アーキテクチャと [ Azure とインターネットの間の DMZ][dmz-internet] リファレンス アーキテクチャで使用されています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-164">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-premises] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="e49ce-165">これらのリファレンス アーキテクチャのそれぞれに、使用できるデプロイ ソリューションが含まれています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-165">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="e49ce-166">詳細については、リンクを参照してください。</span><span class="sxs-lookup"><span data-stu-id="e49ce-166">Follow the links for more information.</span></span>

## <a name="ingress-egress-with-layer-7-nvas"></a><span data-ttu-id="e49ce-167">第 7 層で NVA を使用する イングレスとエグレス</span><span class="sxs-lookup"><span data-stu-id="e49ce-167">Ingress-egress with layer 7 NVAs</span></span>

<span data-ttu-id="e49ce-168">前述の 2 つのアーキテクチャでは、イングレス用とエグレス用に別個の DMZ がありました。</span><span class="sxs-lookup"><span data-stu-id="e49ce-168">In the two previous architectures, there was a separate DMZ for ingress and egress.</span></span> <span data-ttu-id="e49ce-169">次のアーキテクチャは、第 7 層のトラフィックで、HTTP や HTTPS などのイングレスとエグレスの両方で使用できる DMZ の作成方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-169">The following architecture demonstrates how to create a DMZ that can be used for both ingress and egress for layer 7 traffic, such as HTTP or HTTPS:</span></span>

![[4]][4]

<span data-ttu-id="e49ce-171">このアーキテクチャでは、NVA は、アプリケーション ゲートウェイから着信する要求を処理します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-171">In this architecture, the NVAs process incoming requests from the application gateway.</span></span> <span data-ttu-id="e49ce-172">NVA は、ロード バランサーのバックエンド プール内のワークロード VM から発信された要求も処理します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-172">The NVAs also process outgoing requests from the workload VMs in the back-end pool of the load balancer.</span></span> <span data-ttu-id="e49ce-173">着信トラフィックはアプリケーション ゲートウェイによってルーティングされ、発信トラフィックはロード バランサーによってルーティングされるため、NVA は、セッション アフィニティも担当します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-173">Because incoming traffic is routed with an application gateway and outgoing traffic is routed with a load balancer, the NVAs are responsible for maintaining session affinity.</span></span> <span data-ttu-id="e49ce-174">つまり、着信要求と発信要求のマッピングはアプリケーション ゲートウェイが管理するため、最初の要求元に適切な応答を転送できます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-174">That is, the application gateway maintains a mapping of inbound and outbound requests so it can forward the correct response to the original requestor.</span></span> <span data-ttu-id="e49ce-175">ただし、内部ロード バランサーはアプリケーション ゲートウェイのマッピングにアクセスできないため、独自のロジックを使用して NVA への応答を送信します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-175">However, the internal load balancer does not have access to the application gateway mappings, and uses its own logic to send responses to the NVAs.</span></span> <span data-ttu-id="e49ce-176">ロード バランサーは、アプリケーション ゲートウェイから要求を受信していない NVA に応答を送信する場合があります。</span><span class="sxs-lookup"><span data-stu-id="e49ce-176">It's possible the load balancer could send a response to an NVA that did not initially receive the request from the application gateway.</span></span> <span data-ttu-id="e49ce-177">この場合、適切な NVA がアプリケーション ゲートウェイに応答を転送できるように、NVA 間で通信を行って応答を転送する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e49ce-177">In this case, the NVAs must communicate and transfer the response between them so the correct NVA can forward the response to the application gateway.</span></span>

> [!NOTE]
> <span data-ttu-id="e49ce-178">NVA がインバウンドのソース ネットワーク アドレス変換 (SNAT) を確実に実行することで、非対称ルーティングの問題を解決することもできます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-178">You can also solve the asymmetric routing issue by ensuring the NVAs perform inbound source network address translation (SNAT).</span></span> <span data-ttu-id="e49ce-179">これにより、要求元のソース IP が、インバウンド フローで使用される NVA のいずれかの IP アドレスに置き換えられます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-179">This would replace the original source IP of the requestor to one of the IP addresses of the NVA used on the inbound flow.</span></span> <span data-ttu-id="e49ce-180">これで、ルートの対称性を維持しながら、一度に複数の NVA を使用できます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-180">This ensures that you can use multiple NVAs at a time, while preserving the route symmetry.</span></span>

## <a name="pip-udr-switch-with-layer-4-nvas"></a><span data-ttu-id="e49ce-181">第 4 層で NVA を使用する PIP-UDR の切り替え</span><span class="sxs-lookup"><span data-stu-id="e49ce-181">PIP-UDR switch with layer 4 NVAs</span></span>

<span data-ttu-id="e49ce-182">次のアーキテクチャは、1 つのアクティブ NVA と 1 つのパッシブ NVA があるアーキテクチャを示しています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-182">The following architecture demonstrates an architecture with one active and one passive NVA.</span></span> <span data-ttu-id="e49ce-183">このアーキテクチャでは、第 4 層のトラフィックでのイングレスとエグレスの両方を処理します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-183">This architecture handles both ingress and egress for layer 4 traffic:</span></span>

<span data-ttu-id="e49ce-184">![[3]][3]</span><span class="sxs-lookup"><span data-stu-id="e49ce-184">![[3]][3]</span></span>

> [!TIP]
> <span data-ttu-id="e49ce-185">このアーキテクチャの完全なソリューションについては、[GitHub][pnp-ha-nva] を参照してください。</span><span class="sxs-lookup"><span data-stu-id="e49ce-185">A complete solution for this architecture is available on [GitHub][pnp-ha-nva].</span></span>

<span data-ttu-id="e49ce-186">このアーキテクチャは、この記事で説明した最初のアーキテクチャに似ています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-186">This architecture is similar to the first architecture discussed in this article.</span></span> <span data-ttu-id="e49ce-187">そのアーキテクチャには、第 4 層の着信要求を受け取ってフィルター処理する単一の NVA が含まれていました。</span><span class="sxs-lookup"><span data-stu-id="e49ce-187">That architecture included a single NVA accepting and filtering incoming layer 4 requests.</span></span> <span data-ttu-id="e49ce-188">このアーキテクチャでは、2 つ目のパッシブ NVA を追加して、高可用性を実現します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-188">This architecture adds a second passive NVA to provide high availability.</span></span> <span data-ttu-id="e49ce-189">アクティブ NVA で障害が発生した場合は、パッシブ NVA がアクティブになり、その時点でアクティブな NVA の NIC をポイントするように UDR と PIP が変更されます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-189">If the active NVA fails, the passive NVA is made active and the UDR and PIP are changed to point to the NICs on the now active NVA.</span></span> <span data-ttu-id="e49ce-190">UDR と PIP に対するこれらの変更は、手動で実行するか、自動化されたプロセスを使用して実行できます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-190">These changes to the UDR and PIP can either be done manually or using an automated process.</span></span> <span data-ttu-id="e49ce-191">自動化されたプロセスは、通常はデーモンまたは Azure で実行されている他の監視サービスです。</span><span class="sxs-lookup"><span data-stu-id="e49ce-191">The automated process is typically daemon or other monitoring service running in Azure.</span></span> <span data-ttu-id="e49ce-192">プロセスは、アクティブ NVA の正常性プローブをクエリし、NVA の障害を検出したときに、UDR と PIP の切り替えを実行します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-192">It queries a health probe on the active NVA and performs the UDR and PIP switch when it detects a failure of the NVA.</span></span>

<span data-ttu-id="e49ce-193">上記の図は、高可用性デーモンがある [ZooKeeper][zookeeper] クラスターの例を示しています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-193">The preceding figure shows an example [ZooKeeper][zookeeper] cluster providing a high availability daemon.</span></span> <span data-ttu-id="e49ce-194">ZooKeeper クラスター内では、ノードのクォーラムがリーダーを選出します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-194">Within the ZooKeeper cluster, a quorum of nodes elects a leader.</span></span> <span data-ttu-id="e49ce-195">リーダーで障害が発生した場合は、残りのノードによって新しいリーダーが選出されます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-195">If the leader fails, the remaining nodes hold an election to elect a new leader.</span></span> <span data-ttu-id="e49ce-196">このアーキテクチャでは、リーダー ノードが、NVA の正常性エンドポイントをクエリするデーモンを実行します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-196">For this architecture, the leader node executes the daemon that queries the health endpoint on the NVA.</span></span> <span data-ttu-id="e49ce-197">NVA が正常性プローブに応答できなければ、デーモンがパッシブ NVA をアクティブにします。</span><span class="sxs-lookup"><span data-stu-id="e49ce-197">If the NVA fails to respond to the health probe, the daemon activates the passive NVA.</span></span> <span data-ttu-id="e49ce-198">その後、デーモンは、Azure REST API を呼び出して、障害が発生した NVA から PIP を削除して新しくアクティブになった NVA にアタッチします。</span><span class="sxs-lookup"><span data-stu-id="e49ce-198">The daemon then calls the Azure REST API to remove the PIP from the failed NVA and attaches it to newly activated NVA.</span></span> <span data-ttu-id="e49ce-199">次に、デーモンは、新しくアクティブになった NVA の内部 IP アドレスをポイントするように UDR を変更します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-199">The daemon then modifies the UDR to point to the newly activated NVA's internal IP address.</span></span>

<span data-ttu-id="e49ce-200">NVA を含むルートを使用してのみアクセスできるサブネットに ZooKeeper ノードを配置しないでください。</span><span class="sxs-lookup"><span data-stu-id="e49ce-200">Do not include the ZooKeeper nodes in a subnet that is only accessible using a route that includes the NVA.</span></span> <span data-ttu-id="e49ce-201">配置すると、NVA で障害が発生した場合に ZooKeeper ノードにアクセスできなくなります。</span><span class="sxs-lookup"><span data-stu-id="e49ce-201">Otherwise, the ZooKeeper nodes are inaccessible if the NVA fails.</span></span> <span data-ttu-id="e49ce-202">デーモンが何らかの理由で失敗した場合に、ZooKeeper ノードにアクセスして問題を診断することができなくなります。</span><span class="sxs-lookup"><span data-stu-id="e49ce-202">Should the daemon fail for any reason, you won't be able to access any of the ZooKeeper nodes to diagnose the problem.</span></span>

<span data-ttu-id="e49ce-203">サンプル コードを含む完全なソリューションを確認するには、[GitHub リポジトリ][pnp-ha-nva]内のファイルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="e49ce-203">To see the complete solution including sample code, see the files in the [GitHub repository][pnp-ha-nva].</span></span>

## <a name="pip-udr-nvas-without-snat"></a><span data-ttu-id="e49ce-204">SNAT なしのPIP-UDR NVA</span><span class="sxs-lookup"><span data-stu-id="e49ce-204">PIP-UDR NVAs without SNAT</span></span>

<span data-ttu-id="e49ce-205">このアーキテクチャでは、2 つの Azure 仮想マシンを使用して、自動化されたフェールオーバーをサポートしても送信元ネットワーク アドレス変換 (SNAT) を必要としないアクティブ/パッシブ構成で NVA ファイアウォールをホストします。</span><span class="sxs-lookup"><span data-stu-id="e49ce-205">This architecture uses two Azure virtual machines to host the NVA firewall in an active-passive configuration that supports automated failover but does not require Source Network Address Translation (SNAT).</span></span>

![SNAT アーキテクチャなしのPIP-UDR NVA](./images/nva-ha/pip-udr-without-snat.png)

> [!TIP]
> <span data-ttu-id="e49ce-207">このアーキテクチャの完全なソリューションについては、[GitHub][ha-nva-fo] を参照してください。</span><span class="sxs-lookup"><span data-stu-id="e49ce-207">A complete solution for this architecture is available on [GitHub][ha-nva-fo].</span></span>

<span data-ttu-id="e49ce-208">このソリューションは、NVA ファイアウォールで着信要求に SNAT を構成できない Azure のお客様向けに設計されています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-208">This solution is designed for Azure customers who cannot configure SNAT for inbound requests on their NVA firewalls.</span></span> <span data-ttu-id="e49ce-209">SNAT は、元のソース クライアントの IP アドレスを隠します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-209">SNAT hides the original source client IP address.</span></span> <span data-ttu-id="e49ce-210">元の IP を記録する必要があるか、それを NVA の背後にある他の複数層セキュリティ コンポーネント内で使用した場合は、このソリューションに基本的なアプローチが用意されています。</span><span class="sxs-lookup"><span data-stu-id="e49ce-210">If you need to log the original IPs or used them within other layered security components behind your NVAs, this solution offers a basic approach.</span></span>

<span data-ttu-id="e49ce-211">UDR テーブル エントリのフェールオーバーは、アクティブな NVA ファイアウォールの仮想マシン上のインターフェイスの IP アドレスに設定された次ホップ アドレスによって自動化されます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-211">The failover of UDR table entries is automated by a next-hop address set to the IP address of an interface on the active NVA firewall virtual machine.</span></span> <span data-ttu-id="e49ce-212">自動化されたフェールオーバーのロジックは、[Azure Functions](/azure/azure-functions/) を使用して作成する関数アプリでホストされます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-212">The automated failover logic is hosted in a function app that you create using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="e49ce-213">フェールオーバーのコードは、Azure Functions 内でサーバーレス関数として実行されます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-213">The failover code runs as a serverless function inside Azure Functions.</span></span> <span data-ttu-id="e49ce-214">デプロイは、便利でコスト効率に優れ、管理とカスタマイズが簡単です。</span><span class="sxs-lookup"><span data-stu-id="e49ce-214">Deployment is convenient, cost-effective, and easy to maintain and customize.</span></span> <span data-ttu-id="e49ce-215">さらに、関数アプリは Azure Functions 内でホストされるため、仮想ネットワークでの依存関係がありません。</span><span class="sxs-lookup"><span data-stu-id="e49ce-215">In addition, the function app is hosted within Azure Functions, so it has no dependencies on the virtual network.</span></span> <span data-ttu-id="e49ce-216">仮想ネットワークに対する変更が NVA ファイアウォールに影響する場合、関数アプリは独立して実行を続けます。</span><span class="sxs-lookup"><span data-stu-id="e49ce-216">If changes to the virtual network impact the NVA firewalls, the function app continues to run independently.</span></span> <span data-ttu-id="e49ce-217">また、テストもより正確です。着信クライアント要求と同じルートを使用して、仮想ネットワークの外部で実行されるためです。</span><span class="sxs-lookup"><span data-stu-id="e49ce-217">Testing is more accurate as well, because it takes place outside the virtual network using the same route as the inbound client requests.</span></span>

<span data-ttu-id="e49ce-218">NVA ファイアウォールの可用性を確認するため、関数アプリ コードは、次の 2 つの方法のいずれかでそれをプローブします。</span><span class="sxs-lookup"><span data-stu-id="e49ce-218">To check the availability of the NVA firewall, the function app code probes it in one of two ways:</span></span>

- <span data-ttu-id="e49ce-219">NVA ファイアウォールをホストする Azure 仮想マシンの状態を監視する。</span><span class="sxs-lookup"><span data-stu-id="e49ce-219">By monitoring the state of the Azure virtual machines hosting the NVA firewall.</span></span>

- <span data-ttu-id="e49ce-220">バックエンド Web サーバーに対してファイアウォール経由で開かれたポートがあるかどうかをテストする。</span><span class="sxs-lookup"><span data-stu-id="e49ce-220">By testing whether there is an open port through the firewall to the back-end web server.</span></span> <span data-ttu-id="e49ce-221">このオプションは、NVA がテストする関数アプリ コードの PIP を使用してソケットを公開する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e49ce-221">For this option, the NVA must expose a socket via PIP for the function app code to test.</span></span>

<span data-ttu-id="e49ce-222">関数アプリを構成するときに使用するプローブの種類を選択します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-222">You choose the type of probe you want to use when you configure the function app.</span></span> <span data-ttu-id="e49ce-223">サンプル コードを含む完全なソリューションを確認するには、[GitHub リポジトリ][ha-nva-fo]内のファイルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="e49ce-223">To see the complete solution including sample code, see the files in the [GitHub repository][ha-nva-fo].</span></span>

## <a name="next-steps"></a><span data-ttu-id="e49ce-224">次の手順</span><span class="sxs-lookup"><span data-stu-id="e49ce-224">Next steps</span></span>

- <span data-ttu-id="e49ce-225">第 7 層の NVA を使用して [Azure とオンプレミスのデータセンターの間に DMZ を実装する][dmz-on-premises]方法を確認します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-225">Learn how to [implement a DMZ between Azure and your on-premises datacenter][dmz-on-premises] using layer-7 NVAs.</span></span>
- <span data-ttu-id="e49ce-226">第 7 層の NVA を使用して [Azure とインターネットの間に DMZ を実装する][dmz-internet]方法を確認します。</span><span class="sxs-lookup"><span data-stu-id="e49ce-226">Learn how to [implement a DMZ between Azure and the Internet][dmz-internet] using layer-7 NVAs.</span></span>
- [<span data-ttu-id="e49ce-227">Azure でのネットワーク仮想アプライアンスに関する問題のトラブルシューティング</span><span class="sxs-lookup"><span data-stu-id="e49ce-227">Troubleshoot network virtual appliance issues in Azure</span></span>](/azure/virtual-network/virtual-network-troubleshoot-nva)

<!-- links -->

[cloud-security]: /azure/best-practices-network-security
[dmz-on-premises]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/
[pnp-ha-nva]: https://github.com/mspnp/ha-nva
[ha-nva-fo]: https://aka.ms/ha-nva-fo

<!-- images -->

[0]: ./images/nva-ha/single-nva.png "単一 NVA アーキテクチャ"
[1]: ./images/nva-ha/l7-ingress.png "第 7 層のイングレス"
[2]: ./images/nva-ha/l7-ingress-egress.png "第 7 層のエグレス"
[3]: ./images/nva-ha/active-passive.png "アクティブ/パッシブ クラスター"
[4]: ./images/nva-ha/l7-ingress-egress-ag.png

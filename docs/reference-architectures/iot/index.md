---
title: Azure IoT 参照アーキテクチャ
description: PaaS (サービスとしてのプラットフォーム) コンポーネントを使用する Azure の IoT アプリケーションの推奨アーキテクチャ
titleSuffix: Azure Reference Architectures
author: MikeWasson
ms.date: 01/09/2019
---

# <a name="azure-iot-reference-architecture"></a><span data-ttu-id="474a8-103">Azure IoT 参照アーキテクチャ</span><span class="sxs-lookup"><span data-stu-id="474a8-103">Azure IoT reference architecture</span></span>

<span data-ttu-id="474a8-104">この参照アーキテクチャは、PaaS (サービスとしてのプラットフォーム) コンポーネントを使用する Azure の IoT アプリケーションの推奨アーキテクチャを示しています。</span><span class="sxs-lookup"><span data-stu-id="474a8-104">This reference architecture shows a recommended architecture for IoT applications on Azure using PaaS (platform-as-a-service) components.</span></span>

![アーキテクチャの図](./_images/iot.png)

<span data-ttu-id="474a8-106">IoT アプリケーションは、**分析情報**を生成するデータを送信する**もの** (デバイス) として説明することができます。</span><span class="sxs-lookup"><span data-stu-id="474a8-106">IoT applications can be described as **things** (devices) sending data that generates **insights**.</span></span> <span data-ttu-id="474a8-107">これらの分析情報によりビジネスやプロセスを改善するための**アクション**が生成されます。</span><span class="sxs-lookup"><span data-stu-id="474a8-107">These insights generate **actions** to improve a business or process.</span></span> <span data-ttu-id="474a8-108">温度データを送信するエンジン (もの) はその一例です。</span><span class="sxs-lookup"><span data-stu-id="474a8-108">An example is an engine (the thing) sending temperature data.</span></span> <span data-ttu-id="474a8-109">このデータは、エンジンが想定どおりに実行されているかどうかを評価するために使用されます (分析情報)。</span><span class="sxs-lookup"><span data-stu-id="474a8-109">This data is used to evaluate whether the engine is performing as expected (the insight).</span></span> <span data-ttu-id="474a8-110">分析情報は、エンジンのメンテナンス スケジュールを事前に優先順位付けするのに使用されます (アクション)。</span><span class="sxs-lookup"><span data-stu-id="474a8-110">The insight is used to proactively prioritize the maintenance schedule for the engine (the action).</span></span>

<span data-ttu-id="474a8-111">この参照アーキテクチャでは、Azure PaaS (サービスとしてのプラットフォーム) コンポーネントを使用します。</span><span class="sxs-lookup"><span data-stu-id="474a8-111">This reference architecture uses Azure PaaS (platform-as-a-service) components.</span></span> <span data-ttu-id="474a8-112">Azure で IoT ソリューションをビルドするためのその他のオプションには、次のものがあります。</span><span class="sxs-lookup"><span data-stu-id="474a8-112">Other options for building IoT solutions on Azure include:</span></span>

- <span data-ttu-id="474a8-113">[Azure IoT Central](/azure/iot-central/)。</span><span class="sxs-lookup"><span data-stu-id="474a8-113">[Azure IoT Central](/azure/iot-central/).</span></span> <span data-ttu-id="474a8-114">IoT Central は、フル マネージド SaaS (サービスとしてのソフトウェア) ソリューションです。</span><span class="sxs-lookup"><span data-stu-id="474a8-114">IoT Central is a fully managed SaaS (software-as-a-service) solution.</span></span> <span data-ttu-id="474a8-115">技術的な選択肢を抽象化することで、自分のソリューションだけに注力できるようにします。</span><span class="sxs-lookup"><span data-stu-id="474a8-115">It abstracts the technical choices and lets you focus on your solution exclusively.</span></span> <span data-ttu-id="474a8-116">この簡素化には、PaaS ベースのソリューションと比べてカスタマイズしにくいというトレードオフが伴います。</span><span class="sxs-lookup"><span data-stu-id="474a8-116">This simplicity comes with a tradeoff in being less customizable than a PaaS-based solution.</span></span>
- <span data-ttu-id="474a8-117">Azure VM にデプロイされた SMACK スタック (Spark、Mesos、Akka、Cassandra、Kafka) などの OSS コンポーネントの使用。</span><span class="sxs-lookup"><span data-stu-id="474a8-117">Using OSS components such as the SMACK stack (Spark, Mesos, Akka, Cassandra, Kafka) deployed on Azure VMs.</span></span> <span data-ttu-id="474a8-118">この方法では、多くの制御が可能ですが、より複雑になります。</span><span class="sxs-lookup"><span data-stu-id="474a8-118">This approach offers a great deal of control but is more complex.</span></span>

<span data-ttu-id="474a8-119">テレメトリ データの処理方法には、大まかに言ってホット パスとコールド パスの 2 種類があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-119">At a high level, there are two ways to process telemetry data, hot path and cold path.</span></span> <span data-ttu-id="474a8-120">違いは、待機時間とデータ アクセスの要件にあります。</span><span class="sxs-lookup"><span data-stu-id="474a8-120">The difference has to do with requirements for latency and data access.</span></span>

- <span data-ttu-id="474a8-121">**ホット パス**は、データが到着すると、ほぼリアルタイムでそのデータを分析します。</span><span class="sxs-lookup"><span data-stu-id="474a8-121">The **hot path** analyzes data in near-real-time, as it arrives.</span></span> <span data-ttu-id="474a8-122">ホット パスでは、非常に短い待機時間でテレメトリを処理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-122">In the hot path, telemetry must be processed with very low latency.</span></span> <span data-ttu-id="474a8-123">ホット パスは通常、ストリーム処理エンジンを使用して実装されます。</span><span class="sxs-lookup"><span data-stu-id="474a8-123">The hot path is typically implemented using a stream processing engine.</span></span> <span data-ttu-id="474a8-124">出力は、アラートをトリガーしたり、分析ツールを使用してクエリ可能な構造化された形式に書き込むことができます。</span><span class="sxs-lookup"><span data-stu-id="474a8-124">The output may trigger an alert, or be written to a structured format that can be queried using analytical tools.</span></span>
- <span data-ttu-id="474a8-125">**コールド パス**は、より長い間隔 (毎時または毎日) でバッチ処理を実行します。</span><span class="sxs-lookup"><span data-stu-id="474a8-125">The **cold path** performs batch processing at longer intervals (hourly or daily).</span></span> <span data-ttu-id="474a8-126">コールド パスは通常、大量のデータで動作しますが、結果は、ホット パスほどタイムリーである必要はありません。</span><span class="sxs-lookup"><span data-stu-id="474a8-126">The cold path typically operates over large volumes of data, but the results don't need to be as timely as the hot path.</span></span> <span data-ttu-id="474a8-127">コールド パスでは、未加工のテレメトリがキャプチャされ、バッチ処理にフィードされます。</span><span class="sxs-lookup"><span data-stu-id="474a8-127">In the cold path, raw telemetry is captured and then fed into a batch process.</span></span>

## <a name="architecture"></a><span data-ttu-id="474a8-128">アーキテクチャ</span><span class="sxs-lookup"><span data-stu-id="474a8-128">Architecture</span></span>

<span data-ttu-id="474a8-129">このアーキテクチャは、次のコンポーネントで構成されます。</span><span class="sxs-lookup"><span data-stu-id="474a8-129">This architecture consists of the following components.</span></span> <span data-ttu-id="474a8-130">アプリケーションの中には、以下に一覧表示するすべてのコンポーネントを必要としないものもあります。</span><span class="sxs-lookup"><span data-stu-id="474a8-130">Some applications may not require every component listed here.</span></span>

<span data-ttu-id="474a8-131">**IoT デバイス**。</span><span class="sxs-lookup"><span data-stu-id="474a8-131">**IoT devices**.</span></span> <span data-ttu-id="474a8-132">デバイスはクラウドに安全に登録でき、クラウドに接続してデータを送受信できます。</span><span class="sxs-lookup"><span data-stu-id="474a8-132">Devices can securely register with the cloud, and can connect to the cloud to send and receive data.</span></span> <span data-ttu-id="474a8-133">一部のデバイスは、デバイス自体でまたはフィールド ゲートウェイで一部のデータ処理を実行する**エッジ デバイス**の場合があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-133">Some devices may be **edge devices** that perform some data processing on the device itself or in a field gateway.</span></span> <span data-ttu-id="474a8-134">エッジ処理には、[Azure IoT Edge](/azure/iot-edge/) をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-134">We recommend [Azure IoT Edge](/azure/iot-edge/) for edge processing.</span></span>

<span data-ttu-id="474a8-135">**クラウド ゲートウェイ**。</span><span class="sxs-lookup"><span data-stu-id="474a8-135">**Cloud gateway**.</span></span> <span data-ttu-id="474a8-136">クラウド ゲートウェイは、デバイスがクラウドに安全に接続してデータを送信するためのクラウド ハブを提供します。</span><span class="sxs-lookup"><span data-stu-id="474a8-136">A cloud gateway provides a cloud hub for devices to connect securely to the cloud and send data.</span></span> <span data-ttu-id="474a8-137">デバイスの管理や、コマンドやデバイスの制御などの機能も提供します。</span><span class="sxs-lookup"><span data-stu-id="474a8-137">It also provides device management, capabilities, including command and control of devices.</span></span> <span data-ttu-id="474a8-138">クラウド ゲートウェイには、[IoT Hub](/azure/iot-hub/) をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-138">For the cloud gateway, we recommend [IoT Hub](/azure/iot-hub/).</span></span> <span data-ttu-id="474a8-139">IoT Hub は、デバイスからイベントを取り込むホスト型クラウド サービスで、デバイスとバックエンド サービス間のメッセージ ブローカーとして機能します。</span><span class="sxs-lookup"><span data-stu-id="474a8-139">IoT Hub is a hosted cloud service that ingests events from devices, acting as a message broker between devices and backend services.</span></span> <span data-ttu-id="474a8-140">IoT Hub は、セキュリティで保護された接続、イベント インジェスト、双方向通信、およびデバイス管理を提供します。</span><span class="sxs-lookup"><span data-stu-id="474a8-140">IoT Hub provides secure connectivity, event ingestion, bidirectional communication, and device management.</span></span>

<span data-ttu-id="474a8-141">**デバイス プロビジョニング**。</span><span class="sxs-lookup"><span data-stu-id="474a8-141">**Device provisioning.**</span></span> <span data-ttu-id="474a8-142">多数のデバイスの登録と接続には、[IoT Hub Device Provisioning Service](/azure/iot-dps/) (DPS) の使用をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-142">For registering and connecting large sets of devices, we recommend using the [IoT Hub Device Provisioning Service](/azure/iot-dps/) (DPS).</span></span> <span data-ttu-id="474a8-143">DPS を使用すると、デバイスを特定の Azure IoT Hub エンドポイントに大規模に割り当てて登録することができます。</span><span class="sxs-lookup"><span data-stu-id="474a8-143">DPS lets you assign and register devices to specific Azure IoT Hub endpoints at scale.</span></span>

<span data-ttu-id="474a8-144">**ストリーム処理**。</span><span class="sxs-lookup"><span data-stu-id="474a8-144">**Stream processing**.</span></span> <span data-ttu-id="474a8-145">ストリーム処理は、データ レコードの大規模なストリームを分析し、これらのストリームの規則を評価します。</span><span class="sxs-lookup"><span data-stu-id="474a8-145">Stream processing analyzes large streams of data records and evaluates rules for those streams.</span></span> <span data-ttu-id="474a8-146">ストリーム処理には、[Azure Stream Analytics](/azure/stream-analytics/) をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-146">For stream processing, we recommend [Azure Stream Analytics](/azure/stream-analytics/).</span></span> <span data-ttu-id="474a8-147">Stream Analytics では、time windowing 関数、ストリーム集計、外部データ ソース結合を使用して、大規模で複雑な分析を実行できます。</span><span class="sxs-lookup"><span data-stu-id="474a8-147">Stream Analytics can execute complex analysis at scale, using time windowing functions, stream aggregations, and external data source joins.</span></span> <span data-ttu-id="474a8-148">もう 1 つのオプションは、[Azure Databricks](/azure/azure-databricks/) の Apache Spark です。</span><span class="sxs-lookup"><span data-stu-id="474a8-148">Another option is Apache Spark on [Azure Databricks](/azure/azure-databricks/).</span></span>

<span data-ttu-id="474a8-149">機械学習では、履歴テレメトリ データに対して予測アルゴリズムを実行できるようにすることで、予測メンテナンスなどのシナリオを可能にします。</span><span class="sxs-lookup"><span data-stu-id="474a8-149">Machine learning allows predictive algorithms to be executed over historical telemetry data, enabling scenarios such as predictive maintenance.</span></span> <span data-ttu-id="474a8-150">機械学習には、[Azure Machine Learning Service](/azure/machine-learning/service/) をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-150">For machine learning, we recommend [Azure Machine Learning Service](/azure/machine-learning/service/).</span></span>

<span data-ttu-id="474a8-151">**ウォーム パス ストレージ**には、レポートと視覚化のためにデバイスからすぐに使用できる必要があるデータが保持されます。</span><span class="sxs-lookup"><span data-stu-id="474a8-151">**Warm path storage** holds data that must be available immediately from device for reporting and visualization.</span></span> <span data-ttu-id="474a8-152">ウォーム パス ストレージには、[Cosmos DB](/azure/cosmos-db/introduction) をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-152">For warm path storage, we recommend [Cosmos DB](/azure/cosmos-db/introduction).</span></span> <span data-ttu-id="474a8-153">Cosmos DB は、グローバル分散型のマルチモデル データベースです。</span><span class="sxs-lookup"><span data-stu-id="474a8-153">Cosmos DB is a globally distributed, multi-model database.</span></span>

<span data-ttu-id="474a8-154">**コールド パス ストレージ**には、長期間保持され、バッチ処理に使用されるデータが保持されます。</span><span class="sxs-lookup"><span data-stu-id="474a8-154">**Cold path storage** holds data that is kept longer term and is used for batch processing.</span></span> <span data-ttu-id="474a8-155">コールド パス ストレージには、[Azure Blob Storage](/azure/storage/blobs/storage-blobs-introduction) をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-155">For cold path storage, we recommend [Azure Blob Storage](/azure/storage/blobs/storage-blobs-introduction).</span></span> <span data-ttu-id="474a8-156">データは、低コストで無期限に Blob Storage にアーカイブすることができ、バッチ処理のために簡単にアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="474a8-156">Data can be archived in Blob storage indefinitely at low cost, and is easily accessible for batch processing.</span></span>

<span data-ttu-id="474a8-157">**データ変換**は、テレメトリ ストリームを操作または集計します。</span><span class="sxs-lookup"><span data-stu-id="474a8-157">**Data transformation** manipulates or aggregates the telemetry stream.</span></span> <span data-ttu-id="474a8-158">例には、バイナリ データの JSON への変換などのプロトコル変換や、データ ポイントの結合が含まれます。</span><span class="sxs-lookup"><span data-stu-id="474a8-158">Examples include protocol transformation, such as converting binary data to JSON, or combining data points.</span></span> <span data-ttu-id="474a8-159">IoT Hub に到達する前にデータを変換する必要がある場合は、[プロトコル ゲートウェイ](/azure/iot-hub/iot-hub-protocol-gateway) (示されていません) の使用をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-159">If the data must be transformed before reaching IoT Hub, we recommend using a [protocol gateway](/azure/iot-hub/iot-hub-protocol-gateway) (not shown).</span></span> <span data-ttu-id="474a8-160">そうでない場合、データは IoT Hub に到達した後で変換できます。</span><span class="sxs-lookup"><span data-stu-id="474a8-160">Otherwise, data can be transformed after it reaches IoT Hub.</span></span> <span data-ttu-id="474a8-161">その場合は、[Azure Functions](/azure/azure-functions/) の使用をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-161">In that case, we recommend using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="474a8-162">Functions には、IoT Hub、Cosmos DB、および Blob Storage とのビルトイン統合があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-162">Functions has built-in integration with IoT Hub, Cosmos DB, and Blob Storage.</span></span>

<span data-ttu-id="474a8-163">**ビジネス プロセス統合**は、デバイス データからの分析情報に基づいてアクションを実行します。</span><span class="sxs-lookup"><span data-stu-id="474a8-163">**Business process integration** performs actions based on insights from the device data.</span></span> <span data-ttu-id="474a8-164">これには、情報メッセージの格納、アラームの発生、電子メールまたは SMS メッセージの送信、CRM との統合などが含まれる場合があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-164">This could include storing informational messages, raising alarms, sending email or SMS messages, or integrating with CRM.</span></span> <span data-ttu-id="474a8-165">ビジネス プロセス統合には、[Azure Logic Apps](/azure/logic-apps/logic-apps-overview) の使用をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-165">We recommend using [Azure Logic Apps](/azure/logic-apps/logic-apps-overview) for business process integration.</span></span>

<span data-ttu-id="474a8-166">**ユーザー管理**は、デバイスでファームウェアのアップグレードなどのアクションを実行できるユーザーまたはグループを制限します。</span><span class="sxs-lookup"><span data-stu-id="474a8-166">**User management** restricts which users or groups can perform actions on devices, such as upgrading firmware.</span></span> <span data-ttu-id="474a8-167">アプリケーションでユーザーが利用できる機能も定義します。</span><span class="sxs-lookup"><span data-stu-id="474a8-167">It also defines capabilities for users in applications.</span></span> <span data-ttu-id="474a8-168">ユーザーの認証と承認には、[Azure Active Directory](/azure/active-directory/) の使用をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-168">We recommend using [Azure Active Directory](/azure/active-directory/) to authenticate and authorize users.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="474a8-169">スケーラビリティに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="474a8-169">Scalability considerations</span></span>

<span data-ttu-id="474a8-170">IoT アプリケーションは、個別にスケールできる個別のサービスとしてビルドする必要があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-170">An IoT application should be built as discrete services that can scale independently.</span></span> <span data-ttu-id="474a8-171">次のスケーラビリティ ポイントを検討してください。</span><span class="sxs-lookup"><span data-stu-id="474a8-171">Consider the following scalability points:</span></span>

<span data-ttu-id="474a8-172">**IoT Hub**。</span><span class="sxs-lookup"><span data-stu-id="474a8-172">**IoTHub**.</span></span> <span data-ttu-id="474a8-173">IoT Hub については、次のスケール係数を検討してください。</span><span class="sxs-lookup"><span data-stu-id="474a8-173">For IoT Hub, consider the following scale factors:</span></span>

- <span data-ttu-id="474a8-174">IoT Hub に送信されるメッセージの[日単位の最大クォータ](/azure/iot-hub/iot-hub-devguide-quotas-throttling)。</span><span class="sxs-lookup"><span data-stu-id="474a8-174">The maximum [daily quota](/azure/iot-hub/iot-hub-devguide-quotas-throttling) of messages into IoT Hub.</span></span>
- <span data-ttu-id="474a8-175">IoT Hub インスタンスで接続されたデバイスのクォータ。</span><span class="sxs-lookup"><span data-stu-id="474a8-175">The quota of connected devices in an IoT Hub instance.</span></span>
- <span data-ttu-id="474a8-176">インジェストのスループット &mdash; IoT Hub がメッセージを取り込むことができる速度。</span><span class="sxs-lookup"><span data-stu-id="474a8-176">Ingestion throughput &mdash; how quickly IoT Hub can ingest messages.</span></span>
- <span data-ttu-id="474a8-177">処理スループット &mdash; 受信メッセージの処理速度。</span><span class="sxs-lookup"><span data-stu-id="474a8-177">Processing throughput &mdash; how quickly the incoming messages are processed.</span></span>

<span data-ttu-id="474a8-178">各 IoT Hub は、特定のレベルのユニット数でプロビジョニングされます。</span><span class="sxs-lookup"><span data-stu-id="474a8-178">Each IoT hub is provisioned with a certain number of units in a specific tier.</span></span> <span data-ttu-id="474a8-179">レベルとユニット数により、デバイスがハブに送信できるメッセージの 1 日あたりの最大クォータが決定されます。</span><span class="sxs-lookup"><span data-stu-id="474a8-179">The tier and number of units determine the maximum daily quota of messages that devices can send to the hub.</span></span> <span data-ttu-id="474a8-180">詳細については、IoT Hub のクォータと調整に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="474a8-180">For more information, see IoT Hub quotas and throttling.</span></span> <span data-ttu-id="474a8-181">既存の操作を中断することなく、ハブをスケール アップすることができます。</span><span class="sxs-lookup"><span data-stu-id="474a8-181">You can scale up a hub without interrupting existing operations.</span></span>

<span data-ttu-id="474a8-182">**Stream Analytics**。</span><span class="sxs-lookup"><span data-stu-id="474a8-182">**Stream Analytics**.</span></span> <span data-ttu-id="474a8-183">Stream Analytics ジョブは、クエリへの入力から出力まで、Stream Analytics パイプラインのすべてのポイントで並列化されると最適にスケールされます。</span><span class="sxs-lookup"><span data-stu-id="474a8-183">Stream Analytics jobs scale best if they are parallel at all points in the Stream Analytics pipeline, from input to query to output.</span></span> <span data-ttu-id="474a8-184">完全な並列ジョブにより、Stream Analytics は複数のコンピューティング ノード間で作業を分割することができます。</span><span class="sxs-lookup"><span data-stu-id="474a8-184">A fully parallel job allows Stream Analytics to split the work across multiple compute nodes.</span></span> <span data-ttu-id="474a8-185">それ以外の場合、Stream Analytics はストリーム データを 1 つの場所に結合する必要があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-185">Otherwise, Stream Analytics has to combine the stream data into one place.</span></span> <span data-ttu-id="474a8-186">詳細については、「[Azure Stream Analytics でのクエリの並列処理の活用](/azure/stream-analytics/stream-analytics-parallelization)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="474a8-186">For more information, see [Leverage query parallelization in Azure Stream Analytics](/azure/stream-analytics/stream-analytics-parallelization).</span></span>

<span data-ttu-id="474a8-187">デバイス ID に基づいて、IoT Hub によりデバイス メッセージが自動的にパーティション分割されます。</span><span class="sxs-lookup"><span data-stu-id="474a8-187">IoT Hub automatically partitions device messages based on the device ID.</span></span> <span data-ttu-id="474a8-188">特定のデバイスからのメッセージはすべて、常に同じパーティションに送信されますが、1 つのパーティションが複数のデバイスからのメッセージを受け取ります。</span><span class="sxs-lookup"><span data-stu-id="474a8-188">All of the messages from a particular device will always arrive on the same partition, but a single partition will have messages from multiple devices.</span></span> <span data-ttu-id="474a8-189">そのため、並列処理の単位はパーティション ID です。</span><span class="sxs-lookup"><span data-stu-id="474a8-189">Therefore, the unit of parallelization is the partition ID.</span></span>

<span data-ttu-id="474a8-190">**Functions**。</span><span class="sxs-lookup"><span data-stu-id="474a8-190">**Functions**.</span></span> <span data-ttu-id="474a8-191">Event Hubs エンドポイントから読み取る場合、イベント ハブ パーティションごとに関数のインスタンスの最大値があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-191">When reading from the Event Hubs endpoint, there is a maximum of function instance per event hub partition.</span></span> <span data-ttu-id="474a8-192">最大処理レートは、1 つの関数インスタンスが 1 つのパーティションからイベントを処理できる速度によって決まります。</span><span class="sxs-lookup"><span data-stu-id="474a8-192">The maximum processing rate is determined by how fast one function instance can process the events from a single partition.</span></span> <span data-ttu-id="474a8-193">この関数は、メッセージをバッチで処理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-193">The function should process messages in batches.</span></span>

<span data-ttu-id="474a8-194">**Cosmos DB**。</span><span class="sxs-lookup"><span data-stu-id="474a8-194">**Cosmos DB**.</span></span> <span data-ttu-id="474a8-195">Cosmos DB コレクションをスケール アウトするには、パーティション キーを使用してコレクションを作成し、記述する各ドキュメントにそのパーティション キーを含めます。</span><span class="sxs-lookup"><span data-stu-id="474a8-195">To scale out a Cosmos DB collection, create the collection with a partition key and include the partition key in each document that you write.</span></span> <span data-ttu-id="474a8-196">詳細については、[パーティション キーを選択する際のベスト プラクティス](/azure/cosmos-db/partition-data#best-practices-when-choosing-a-partition-key)に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="474a8-196">For more information, see [Best practices when choosing a partition key](/azure/cosmos-db/partition-data#best-practices-when-choosing-a-partition-key).</span></span>

- <span data-ttu-id="474a8-197">デバイスごとに 1 つのドキュメントを格納して更新する場合、デバイス ID が適切なパーティション キーとなります。</span><span class="sxs-lookup"><span data-stu-id="474a8-197">If you store and update a single document per device, the device ID is a good partition key.</span></span> <span data-ttu-id="474a8-198">書き込みはキー間で均等に分散されます。</span><span class="sxs-lookup"><span data-stu-id="474a8-198">Writes are evenly distributed across the keys.</span></span> <span data-ttu-id="474a8-199">キー値ごとに 1 つのドキュメントが存在するため、各パーティションのサイズは厳密にバインドされます。</span><span class="sxs-lookup"><span data-stu-id="474a8-199">The size of each partition is strictly bounded, because there is a single document for each key value.</span></span>
- <span data-ttu-id="474a8-200">すべてのデバイス メッセージに対して個別のドキュメントを保存する場合、パーティション キーとしてデバイス ID を使用すると、パーティションあたり 10 GB の制限をすぐに超えてしまいます。</span><span class="sxs-lookup"><span data-stu-id="474a8-200">If you store a separate document for every device message, using the device ID as a partition key would quickly exceed the 10-GB limit per partition.</span></span> <span data-ttu-id="474a8-201">その場合は、メッセージ ID の方が適切なパーティション キーとなります。</span><span class="sxs-lookup"><span data-stu-id="474a8-201">Message ID is a better partition key in that case.</span></span> <span data-ttu-id="474a8-202">通常、インデックス作成とクエリのため、ドキュメントにデバイス ID を含めることもできます。</span><span class="sxs-lookup"><span data-stu-id="474a8-202">Typically you would still include device ID in the document for indexing and querying.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="474a8-203">セキュリティに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="474a8-203">Security considerations</span></span>

### <a name="trustworthy-and-secure-communication"></a><span data-ttu-id="474a8-204">信頼できるセキュリティで保護された通信</span><span class="sxs-lookup"><span data-stu-id="474a8-204">Trustworthy and secure communication</span></span>

<span data-ttu-id="474a8-205">デバイスと送受信するすべての情報は、信頼できる必要があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-205">All information received from and sent to a device must be trustworthy.</span></span> <span data-ttu-id="474a8-206">デバイスで次の暗号化機能をサポートできないのであれば、そのデバイスをローカル ネットワークに制限し、すべてのネットワーク間通信をフィールド ゲートウェイを経由して行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-206">Unless a device can support the following cryptographic capabilities, it should be constrained to local networks and all internetwork communication should go through a field gateway:</span></span>

- <span data-ttu-id="474a8-207">証明可能な安全性を備え、公的に分析され、広く実装されている対称キー暗号化アルゴリズムを使用したデータの暗号化。</span><span class="sxs-lookup"><span data-stu-id="474a8-207">Data encryption with a provably secure, publicly analyzed, and broadly implemented symmetric-key encryption algorithm.</span></span>
- <span data-ttu-id="474a8-208">証明可能な安全性を備え、公的に分析され、広く実装されていいる対称キー署名アルゴリズムを使用したデジタル署名。</span><span class="sxs-lookup"><span data-stu-id="474a8-208">Digital signature with a provably secure, publicly analyzed, and broadly implemented symmetric-key signature algorithm.</span></span>
- <span data-ttu-id="474a8-209">TCP またはその他のストリーム ベースの通信パス向けの TLS 1.2、またはデータグラム ベースの通信パス向けの DTLS 1.2 のいずれかのサポート。</span><span class="sxs-lookup"><span data-stu-id="474a8-209">Support for either TLS 1.2 for TCP or other stream-based communication paths or DTLS 1.2 for datagram-based communication paths.</span></span> <span data-ttu-id="474a8-210">X.509 証明書の処理のサポートはオプションで、より計算効率が高く転送効率の高い TLS の事前共有キー モードで置き換えることができます。このモードは、AES および SHA-2 のアルゴリズムをサポートするために実装できます。</span><span class="sxs-lookup"><span data-stu-id="474a8-210">Support of X.509 certificate handling is optional and can be replaced by the more compute-efficient and wire-efficient pre-shared key mode for TLS, which can be implemented with support for the AES and SHA-2 algorithms.</span></span>
- <span data-ttu-id="474a8-211">更新可能なキー ストアとデバイスごとのキー。</span><span class="sxs-lookup"><span data-stu-id="474a8-211">Updateable key-store and per-device keys.</span></span> <span data-ttu-id="474a8-212">各デバイスには、システムに対して認証を行う一意のキー マテリアルまたはトークンが必要です。</span><span class="sxs-lookup"><span data-stu-id="474a8-212">Each device must have unique key material or tokens that identify it toward the system.</span></span> <span data-ttu-id="474a8-213">デバイスは、(セキュリティで保護されたキー ストアを使用するなどして) キーを安全に保存する必要があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-213">The devices should store the key securely on the device (for example, using a secure key-store).</span></span> <span data-ttu-id="474a8-214">デバイスは、キーまたはトークンを定期的、またはシステムのセキュリティ侵害などの緊急の状況では事後的に更新できる必要があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-214">The device should be able to update the keys or tokens periodically, or reactively in emergency situations such as a system breach.</span></span>
- <span data-ttu-id="474a8-215">デバイスのファームウェアとアプリケーション ソフトウェアは、更新プログラムが検出されたセキュリティの脆弱性を修復できるようする必要があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-215">The firmware and application software on the device must allow for updates to enable the repair of discovered security vulnerabilities.</span></span>

<span data-ttu-id="474a8-216">ただし、多くのデバイスでは、制約が多すぎてこれらの要件をサポートできません。</span><span class="sxs-lookup"><span data-stu-id="474a8-216">However, many devices are too constrained to support these requirements.</span></span> <span data-ttu-id="474a8-217">その場合は、フィールド ゲートウェイを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-217">In that case, a field gateway should be used.</span></span> <span data-ttu-id="474a8-218">デバイスは、ローカル エリア ネットワーク経由でフィールド ゲートウェイに安全に接続し、ゲートウェイはクラウドへのセキュリティで保護された通信を有効にします。</span><span class="sxs-lookup"><span data-stu-id="474a8-218">Devices connect securely to the field gateway through a local area network, and the gateway enables secure communication to the cloud.</span></span>

### <a name="physical-tamper-proofing"></a><span data-ttu-id="474a8-219">物理的な改ざん防止</span><span class="sxs-lookup"><span data-stu-id="474a8-219">Physical tamper proofing</span></span>

<span data-ttu-id="474a8-220">セキュリティの整合性とシステム全体の信頼性を確保するため、デバイスの設計に物理操作の試行を防御する機能を組み込むことを強くお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-220">It is strongly recommended that device design incorporates features that defend against physical manipulation attempts, to help ensure the security integrity and trustworthiness of the overall system.</span></span>

<span data-ttu-id="474a8-221">例: </span><span class="sxs-lookup"><span data-stu-id="474a8-221">For example:</span></span>

- <span data-ttu-id="474a8-222">セキュリティで保護されたストレージを備え、トラステッド プラットフォーム モジュール (TPM) の統合などの暗号化キー マテリアルを使用する、マイクロコントローラー/マイクロプロセッサまたは補助ハードウェアを選択します。</span><span class="sxs-lookup"><span data-stu-id="474a8-222">Choose microcontrollers/microprocessors or auxiliary hardware that provide secure storage and use of cryptographic key material, such as trusted platform module (TPM) integration.</span></span>
- <span data-ttu-id="474a8-223">TPM に固定されている、セキュリティで保護されたブート ローダーとセキュリティで保護されたソフトウェアの読み込み。</span><span class="sxs-lookup"><span data-stu-id="474a8-223">Secure boot loader and secure software loading, anchored in the TPM.</span></span>
- <span data-ttu-id="474a8-224">センサーを使用して、侵入の試みや、アラートを生成したりデバイスの "デジタル自己破壊" を引き起こす可能性があるデバイス環境の操作を検出します。</span><span class="sxs-lookup"><span data-stu-id="474a8-224">Use sensors to detect intrusion attempts and attempts to manipulate the device environment with alerting and potentially “digital self-destruction” of the device.</span></span>

<span data-ttu-id="474a8-225">セキュリティに関するその他の考慮事項については、「[モノのインターネット (IoT) のセキュリティ アーキテクチャ](/azure/iot-fundamentals/iot-security-architecture)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="474a8-225">For additional security considerations, see [Internet of Things (IoT) security architecture](/azure/iot-fundamentals/iot-security-architecture).</span></span>

### <a name="monitoring-and-logging"></a><span data-ttu-id="474a8-226">監視およびログ記録</span><span class="sxs-lookup"><span data-stu-id="474a8-226">Monitoring and logging</span></span>

<span data-ttu-id="474a8-227">ログ記録と監視システムは、ソリューションが機能しているかどうかを判断するため、および問題のトラブルシューティングのために使用されます。</span><span class="sxs-lookup"><span data-stu-id="474a8-227">Logging and monitoring systems are used to determine whether the solution is functioning and to help troubleshoot problems.</span></span> <span data-ttu-id="474a8-228">監視とログ記録システムは、次の運用上の質問に答えるときに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="474a8-228">Monitoring and logging systems help answer the following operational questions:</span></span>

- <span data-ttu-id="474a8-229">デバイスまたはシステムはエラー状態か。</span><span class="sxs-lookup"><span data-stu-id="474a8-229">Are devices or systems in an error condition?</span></span>
- <span data-ttu-id="474a8-230">デバイスまたはシステムは正しく構成されているか。</span><span class="sxs-lookup"><span data-stu-id="474a8-230">Are devices or systems correctly configured?</span></span>
- <span data-ttu-id="474a8-231">デバイスまたはシステムは正確なデータを生成しているか。</span><span class="sxs-lookup"><span data-stu-id="474a8-231">Are devices or systems generating accurate data?</span></span>
- <span data-ttu-id="474a8-232">システムは企業の顧客とエンド カスタマーの両方の期待を満たしているか。</span><span class="sxs-lookup"><span data-stu-id="474a8-232">Are systems meeting the expectations of both the business and end customers?</span></span>

<span data-ttu-id="474a8-233">ログ記録と監視ツールは通常、次の 4 つの構成要素で構成されます。</span><span class="sxs-lookup"><span data-stu-id="474a8-233">Logging and monitoring tools are typically comprised of the following four components:</span></span>

- <span data-ttu-id="474a8-234">システムを監視し、基本的なトラブルシューティングを行うためのシステム パフォーマンスとタイムライン視覚化ツール。</span><span class="sxs-lookup"><span data-stu-id="474a8-234">System performance and timeline visualization tools to monitor the system and for basic troubleshooting.</span></span>
- <span data-ttu-id="474a8-235">ログ データをバッファーするバッファー処理されたデータ インジェスト。</span><span class="sxs-lookup"><span data-stu-id="474a8-235">Buffered data ingestion, to buffer log data.</span></span>
- <span data-ttu-id="474a8-236">ログ データを格納する永続化ストア。</span><span class="sxs-lookup"><span data-stu-id="474a8-236">Persistence store to store log data.</span></span>
- <span data-ttu-id="474a8-237">詳細なトラブルシューティングで使用するためにログ データを表示する検索とクエリ機能。</span><span class="sxs-lookup"><span data-stu-id="474a8-237">Search and query capabilities, to view log data for use in detailed troubleshooting.</span></span>

<span data-ttu-id="474a8-238">監視システムは、正常性、セキュリティ、および安定性に関する分析情報と、IoT ソリューションのパフォーマンスを提供します。</span><span class="sxs-lookup"><span data-stu-id="474a8-238">Monitoring systems provide insights into the health, security, and stability, and performance of an IoT solution.</span></span> <span data-ttu-id="474a8-239">これらのシステムは、より詳細なビューも提供できます。コンポーネントの構成変更を記録し、潜在的なセキュリティの脆弱性を明らかにし、インシデント管理プロセスを強化し、システムの所有者が問題をトラブルシューティングするのに役立つ、抽出したログ データを提供します。</span><span class="sxs-lookup"><span data-stu-id="474a8-239">These systems can also provide a more detailed view, recording component configuration changes and providing extracted logging data that can surface potential security vulnerabilities, enhance the incident management process, and help the owner of the system troubleshoot problems.</span></span> <span data-ttu-id="474a8-240">包括的な監視ソリューションには、特定のサブシステムの情報や複数のサブシステムの集計に対してクエリを実行する機能が含まれます。</span><span class="sxs-lookup"><span data-stu-id="474a8-240">Comprehensive monitoring solutions include the ability to query information for specific subsystems or aggregating across multiple subsystems.</span></span>

<span data-ttu-id="474a8-241">監視システムの開発は、正常な動作、規制に対するコンプライアンス、監査要件を定義することから始める必要があります。</span><span class="sxs-lookup"><span data-stu-id="474a8-241">Monitoring system development should begin by defining healthy operation, regulatory compliance, and audit requirements.</span></span> <span data-ttu-id="474a8-242">収集されるメトリックには、次のものが含まれます。</span><span class="sxs-lookup"><span data-stu-id="474a8-242">Metrics collected may include:</span></span>

- <span data-ttu-id="474a8-243">構成の変更を報告している物理デバイス、エッジ デバイス、およびインフラストラクチャ コンポーネント。</span><span class="sxs-lookup"><span data-stu-id="474a8-243">Physical devices, edge devices, and infrastructure components reporting configuration changes.</span></span>
- <span data-ttu-id="474a8-244">構成の変更を報告しているアプリケーション、セキュリティ監査ログ、要求レート、応答時間、エラー率、およびマネージド言語のガベージ コレクションの統計情報。</span><span class="sxs-lookup"><span data-stu-id="474a8-244">Applications reporting configuration changes, security audit logs, request rates, response times, error rates, and garbage collection statistics for managed languages.</span></span>
- <span data-ttu-id="474a8-245">データベース、永続化ストア、クエリと書き込みのパフォーマンスを報告しているキャッシュ、スキーマの変更、セキュリティ監査ログ、ロックまたはデッドロック、インデックスのパフォーマンス、CPU、メモリ、ディスク使用量。</span><span class="sxs-lookup"><span data-stu-id="474a8-245">Databases, persistence stores, and caches reporting query and write performance, schema changes, security audit log, locks or deadlocks, index performance, CPU, memory, and disk usage.</span></span>
- <span data-ttu-id="474a8-246">正常性メトリックと依存システムの正常性とパフォーマンスに影響を与える構成の変更を報告しているマネージド サービス (IaaS、PaaS、SaaS、FaaS)。</span><span class="sxs-lookup"><span data-stu-id="474a8-246">Managed services (IaaS, PaaS, SaaS, and FaaS) reporting health metrics and configuration changes that impact dependent system health and performance.</span></span>

<span data-ttu-id="474a8-247">監視メトリックを視覚化することで、システムが不安定であることをオペレーターに警告し、インシデント対応を促します。</span><span class="sxs-lookup"><span data-stu-id="474a8-247">Visualization of monitoring metrics alert operators to system instabilities and facilitate incident response.</span></span>

### <a name="tracing-telemetry"></a><span data-ttu-id="474a8-248">テレメトリのトレース</span><span class="sxs-lookup"><span data-stu-id="474a8-248">Tracing telemetry</span></span>

<span data-ttu-id="474a8-249">テレメトリをトレースすることで、オペレーターはシステム全体で作成時からテレメトリを追跡することができます。</span><span class="sxs-lookup"><span data-stu-id="474a8-249">Tracing telemetry allows an operator to follow the journey of a piece of telemetry from creation through the system.</span></span> <span data-ttu-id="474a8-250">トレースは、デバッグとトラブルシューティングにとって重要です。</span><span class="sxs-lookup"><span data-stu-id="474a8-250">Tracing is important for debugging and troubleshooting.</span></span> <span data-ttu-id="474a8-251">Azure IoT Hub および [IoT Hub Device SDK](/azure/iot-hub/iot-hub-devguide-sdks) を使用する IoT ソリューションの場合、データグラムのトレースは、クラウドからデバイスへのメッセージとして始めることができ、テレメトリ ストリームに含めることができます。</span><span class="sxs-lookup"><span data-stu-id="474a8-251">For IoT solutions that use Azure IoT Hub and the [IoT Hub Device SDKs](/azure/iot-hub/iot-hub-devguide-sdks), tracing datagrams can be originated as Cloud-to-Device messages and included in the telemetry stream.</span></span>

### <a name="logging"></a><span data-ttu-id="474a8-252">ログの記録</span><span class="sxs-lookup"><span data-stu-id="474a8-252">Logging</span></span>

<span data-ttu-id="474a8-253">ログ記録システムは、ソリューションが実行したアクションまたはアクティビティの内容、発生したエラーを把握するうえで不可欠で、こうしたエラーを修正するのにも役立ちます。</span><span class="sxs-lookup"><span data-stu-id="474a8-253">Logging systems are integral in understanding what actions or activities a solution has performed, failures that have occurred, and can provide help in fixing those failures.</span></span> <span data-ttu-id="474a8-254">ログは分析して、エラー状態の理解と修正、パフォーマンス特性の強化、および適用される規則や法令の順守に役立てることができます。</span><span class="sxs-lookup"><span data-stu-id="474a8-254">Logs can be analyzed to help understand and remedy error conditions, enhance performance characteristics, and ensure compliance with governing rule and regulations.</span></span>

<span data-ttu-id="474a8-255">プレーン テキスト ログは、開発の初期コストへの影響はあまりありませんが、マシンでの解析/読み取りがより困難になります。</span><span class="sxs-lookup"><span data-stu-id="474a8-255">Though plain-text logging is lower impact on upfront development costs, it is more challenging for a machine to parse/read.</span></span> <span data-ttu-id="474a8-256">収集された情報はマシンで解析可能で人間が判読できるため、構造化ログを使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="474a8-256">We recommend structured logging be used, as collected information is both machine parsable and human readable.</span></span> <span data-ttu-id="474a8-257">構造化ログにより、状況コンテキストとメタデータがログ情報に追加されます。</span><span class="sxs-lookup"><span data-stu-id="474a8-257">Structured logging adds situational context and metadata to the log information.</span></span> <span data-ttu-id="474a8-258">構造化ログでは、プロパティは、検索およびクエリ機能を強化するために、キー/値のペアとしてまたは固定スキーマで書式設定された重要な要素です。</span><span class="sxs-lookup"><span data-stu-id="474a8-258">In structured logging, properties are first class citizens formatted as key/value pairs, or with a fixed schema, to enhance search and query capabilities.</span></span>

## <a name="next-steps"></a><span data-ttu-id="474a8-259">次の手順</span><span class="sxs-lookup"><span data-stu-id="474a8-259">Next steps</span></span>

- <span data-ttu-id="474a8-260">推奨されるアーキテクチャと実装の選択の詳細については、「[Microsoft Azure IoT Reference Architecture](http://aka.ms/iotrefarchitecture)」 (Microsoft Azure IoT 参照アーキテクチャ) (PDF) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="474a8-260">For a more detailed discussion of the recommended architecture and implementation choices, see [Microsoft Azure IoT Reference Architecture](http://aka.ms/iotrefarchitecture) (PDF).</span></span>

- <span data-ttu-id="474a8-261">各種 Azure IoT サービスの詳細なドキュメントについては、「[Azure IoT の基礎](/azure/iot-fundamentals/)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="474a8-261">For detailed documentation of the various Azure IoT services, see [Azure IoT Fundamentals](/azure/iot-fundamentals/).</span></span>

- <span data-ttu-id="474a8-262">サンプル IoT 実装は [GitHub](https://github.com/mspnp/iot-guidance) で入手できます。</span><span class="sxs-lookup"><span data-stu-id="474a8-262">A sample IoT implementation is available on [GitHub](https://github.com/mspnp/iot-guidance).</span></span>

---
title: バレット キー パターン
titleSuffix: Cloud Design Patterns
description: 特定のリソースまたはサービスへの限定的な直接アクセスをクライアントに提供する、トークンまたはキーを使用します。
keywords: 設計パターン
author: dragon119
ms.date: 06/23/2017
ms.topic: design-pattern
ms.service: architecture-center
ms.subservice: cloud-fundamentals
ms.custom: seodec18
ms.openlocfilehash: c0d507a1826716f6d4f2bab9a894be2fe941f3a3
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/20/2019
ms.locfileid: "58243553"
---
# <a name="valet-key-pattern"></a><span data-ttu-id="5b638-104">バレット キー パターン</span><span class="sxs-lookup"><span data-stu-id="5b638-104">Valet Key pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="5b638-105">アプリケーションからのデータ転送をオフロードするため、クライアントに特定リソースへの限定的な直接アクセスを提供するトークンを使用します。</span><span class="sxs-lookup"><span data-stu-id="5b638-105">Use a token that provides clients with restricted direct access to a specific resource, in order to offload data transfer from the application.</span></span> <span data-ttu-id="5b638-106">これは特に、クラウドでホストされるストレージ システムやキューを使用するアプリケーションで役に立ち、コストを最小限にしてスケーラビリティとパフォーマンスを最大化できます。</span><span class="sxs-lookup"><span data-stu-id="5b638-106">This is particularly useful in applications that use cloud-hosted storage systems or queues, and can minimize cost and maximize scalability and performance.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="5b638-107">コンテキストと問題</span><span class="sxs-lookup"><span data-stu-id="5b638-107">Context and problem</span></span>

<span data-ttu-id="5b638-108">クライアント プログラムや Web ブラウザーは、多くの場合、アプリケーションのストレージとの間でファイルまたはデータ ストリームを読み書きする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-108">Client programs and web browsers often need to read and write files or data streams to and from an application’s storage.</span></span> <span data-ttu-id="5b638-109">アプリケーションは通常、データをストレージからフェッチしてクライアントにストリーミングするか、クライアントからアップロードされたストリームを読み取ってそれをデータ ストアに格納することによって、データの移動を処理します。</span><span class="sxs-lookup"><span data-stu-id="5b638-109">Typically, the application will handle the movement of the data &mdash; either by fetching it from storage and streaming it to the client, or by reading the uploaded stream from the client and storing it in the data store.</span></span> <span data-ttu-id="5b638-110">ただし、このアプローチでは、計算、メモリ、帯域幅などの貴重なリソースが取られます。</span><span class="sxs-lookup"><span data-stu-id="5b638-110">However, this approach absorbs valuable resources such as compute, memory, and bandwidth.</span></span>

<span data-ttu-id="5b638-111">データ ストアには、データのアップロードとダウンロードを直接処理する機能があり、このデータを移動するための処理を実行するようアプリケーションに要求しません。</span><span class="sxs-lookup"><span data-stu-id="5b638-111">Data stores have the ability to handle upload and download of data directly, without requiring that the application perform any processing to move this data.</span></span> <span data-ttu-id="5b638-112">しかし通常は、クライアントが、ストアのセキュリティ資格情報に対するアクセス権を持っているようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-112">But, this typically requires the client to have access to the security credentials for the store.</span></span> <span data-ttu-id="5b638-113">これは、データ転送のコストと、アプリケーションをスケール アウトするための要件を最小限にして、パフォーマンスを最大化するうえで便利な方法となります。</span><span class="sxs-lookup"><span data-stu-id="5b638-113">This can be a useful technique to minimize data transfer costs and the requirement to scale out the application, and to maximize performance.</span></span> <span data-ttu-id="5b638-114">ただしこれは、アプリケーションがデータのセキュリティを管理できなくなることを意味します。</span><span class="sxs-lookup"><span data-stu-id="5b638-114">It means, though, that the application is no longer able to manage the security of the data.</span></span> <span data-ttu-id="5b638-115">クライアントがデータ ストアへの接続を備え、直接アクセスを行うようになると、アプリケーションがゲートキーパーとして機能することはできません。</span><span class="sxs-lookup"><span data-stu-id="5b638-115">After the client has a connection to the data store for direct access, the application can't act as the gatekeeper.</span></span> <span data-ttu-id="5b638-116">アプリケーションはもはやプロセスを制御しておらず、データ ストアからの後続のアップロードやダウンロードを防げません。</span><span class="sxs-lookup"><span data-stu-id="5b638-116">It's no longer in control of the process and can't prevent subsequent uploads or downloads from the data store.</span></span>

<span data-ttu-id="5b638-117">これは、信頼されていないクライアントにサービスを提供する必要のある分散システムでは現実的なアプローチではありません。</span><span class="sxs-lookup"><span data-stu-id="5b638-117">This isn't a realistic approach in distributed systems that need to serve untrusted clients.</span></span> <span data-ttu-id="5b638-118">それよりも、アプリケーションはきめ細かな方法でデータへのアクセスを安全に制御できる一方で、この接続を設定し、その後クライアントがデータ ストアと直接通信して必要な読み取りまたは書き込み操作を実行できるようにして、サーバーでの負荷を軽減できる必要があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-118">Instead, applications must be able to securely control access to data in a granular way, but still reduce the load on the server by setting up this connection and then allowing the client to communicate directly with the data store to perform the required read or write operations.</span></span>

## <a name="solution"></a><span data-ttu-id="5b638-119">解決策</span><span class="sxs-lookup"><span data-stu-id="5b638-119">Solution</span></span>

<span data-ttu-id="5b638-120">ストアがクライアントの認証と承認を管理できないデータ ストアへのアクセスを制御する問題を解決する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-120">You need to resolve the problem of controlling access to a data store where the store can't manage authentication and authorization of clients.</span></span> <span data-ttu-id="5b638-121">一般的な 1 つの解決策は、データ ストアのパブリック接続へのアクセスを制限し、データ ストアが検証できるキーまたはトークンをクライアントに提供することです。</span><span class="sxs-lookup"><span data-stu-id="5b638-121">One typical solution is to restrict access to the data store’s public connection and provide the client with a key or token that the data store can validate.</span></span>

<span data-ttu-id="5b638-122">このキーまたはトークンは、通常、バレット キーと呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="5b638-122">This key or token is usually referred to as a valet key.</span></span> <span data-ttu-id="5b638-123">これにより、特定のリソースへの時間制限付きアクセスを提供し、ストレージやキューに対する読み取りと書き込み、Web ブラウザーでのアップロードとダウンロードなど、定義済みの操作のみを許可します。</span><span class="sxs-lookup"><span data-stu-id="5b638-123">It provides time-limited access to specific resources and allows only predefined operations such as reading and writing to storage or queues, or uploading and downloading in a web browser.</span></span> <span data-ttu-id="5b638-124">アプリケーションはすばやく容易にバレット キーを作成してクライアント デバイスや Web ブラウザーに発行し、クライアントに必要な操作の実行を許可できます。アプリケーションがデータ転送を直接処理する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="5b638-124">Applications can create and issue valet keys to client devices and web browsers quickly and easily, allowing clients to perform the required operations without requiring the application to directly handle the data transfer.</span></span> <span data-ttu-id="5b638-125">これによって、アプリケーションとサーバーに起因する、処理のオーバーヘッドと、パフォーマンスやスケーラビリティへの影響がなくなります。</span><span class="sxs-lookup"><span data-stu-id="5b638-125">This removes the processing overhead, and the impact on performance and scalability, from the application and the server.</span></span>

<span data-ttu-id="5b638-126">図に示すように、クライアントは特定の期間のみ、アクセス許可に関して特定の制限があるデータ ストア内の特定のリソースに、このトークンを使用してアクセスします。</span><span class="sxs-lookup"><span data-stu-id="5b638-126">The client uses this token to access a specific resource in the data store for only a specific period, and with specific restrictions on access permissions, as shown in the figure.</span></span> <span data-ttu-id="5b638-127">指定された期間の後にキーは無効になり、リソースへのアクセスは許可されなくなります。</span><span class="sxs-lookup"><span data-stu-id="5b638-127">After the specified period, the key becomes invalid and won't allow access to the resource.</span></span>

![図 1 - パターンの概要](./_images/valet-key-pattern.png)

<span data-ttu-id="5b638-129">データの範囲など、他の依存関係があるキーを構成することもできます。</span><span class="sxs-lookup"><span data-stu-id="5b638-129">It's also possible to configure a key that has other dependencies, such as the scope of the data.</span></span> <span data-ttu-id="5b638-130">たとえば、データ ストアの機能に応じて、キーでデータ ストア内のテーブル全体を指定することも、テーブル内の特定の行だけを指定することもできます。</span><span class="sxs-lookup"><span data-stu-id="5b638-130">For example, depending on the data store capabilities, the key can specify a complete table in a data store, or only specific rows in a table.</span></span> <span data-ttu-id="5b638-131">クラウド ストレージ システム内では、キーによって、コンテナーを指定することも、コンテナー内の特定項目だけを指定することもできます。</span><span class="sxs-lookup"><span data-stu-id="5b638-131">In cloud storage systems the key can specify a container, or just a specific item within a container.</span></span>

<span data-ttu-id="5b638-132">キーは、アプリケーションによって無効にすることも可能です。</span><span class="sxs-lookup"><span data-stu-id="5b638-132">The key can also be invalidated by the application.</span></span> <span data-ttu-id="5b638-133">これは、クライアントがサーバーに、データ転送操作が完了したことを通知する場合に役立つアプローチです。</span><span class="sxs-lookup"><span data-stu-id="5b638-133">This is a useful approach if the client notifies the server that the data transfer operation is complete.</span></span> <span data-ttu-id="5b638-134">サーバーはその後、そのキーを無効にして、それ以上のアクセスを停止できます。</span><span class="sxs-lookup"><span data-stu-id="5b638-134">The server can then invalidate that key to prevent further access.</span></span>

<span data-ttu-id="5b638-135">このパターンを使用すると、ユーザーを作成して認証し、アクセス許可を与え、その後ユーザーを再度削除する必要がないため、リソースへのアクセスの管理を簡略化できます。</span><span class="sxs-lookup"><span data-stu-id="5b638-135">Using this pattern can simplify managing access to resources because there's no requirement to create and authenticate a user, grant permissions, and then remove the user again.</span></span> <span data-ttu-id="5b638-136">場所、アクセス許可、および有効期間の制限も容易になり、すべて実行時にキーを生成するだけです。</span><span class="sxs-lookup"><span data-stu-id="5b638-136">It also makes it easy to limit the location, the permission, and the validity period&mdash;all by simply generating a key at runtime.</span></span> <span data-ttu-id="5b638-137">重要な要素は、受信者がリソースを意図した目的にのみ使用できるように、有効期間と、特にリソースの場所をできるだけ厳しく制限することです。</span><span class="sxs-lookup"><span data-stu-id="5b638-137">The important factors are to limit the validity period, and especially the location of the resource, as tightly as possible so that the recipient can only use it for the intended purpose.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="5b638-138">問題と注意事項</span><span class="sxs-lookup"><span data-stu-id="5b638-138">Issues and considerations</span></span>

<span data-ttu-id="5b638-139">このパターンの実装方法を決めるときには、以下の点に注意してください。</span><span class="sxs-lookup"><span data-stu-id="5b638-139">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="5b638-140">**有効状態とキーの期間を管理します**。</span><span class="sxs-lookup"><span data-stu-id="5b638-140">**Manage the validity status and period of the key**.</span></span> <span data-ttu-id="5b638-141">漏えいやセキュリティ侵害が発生した場合、キーによってターゲット項目のロックが効果的に解除され、有効期間中は悪用が可能になります。</span><span class="sxs-lookup"><span data-stu-id="5b638-141">If leaked or compromised, the key effectively unlocks the target item and makes it available for malicious use during the validity period.</span></span> <span data-ttu-id="5b638-142">キーは通常、発行された方法に応じて、取り消すことまたは無効することができます。</span><span class="sxs-lookup"><span data-stu-id="5b638-142">A key can usually be revoked or disabled, depending on how it was issued.</span></span> <span data-ttu-id="5b638-143">サーバー側のポリシーを変更するか、署名に使用されたサーバー キーを無効にすることが可能です。</span><span class="sxs-lookup"><span data-stu-id="5b638-143">Server-side policies can be changed or, the server key it was signed with can be invalidated.</span></span> <span data-ttu-id="5b638-144">承認されていない操作がデータ ストアに対して発生するリスクを最小限にするため、短い有効期間を指定してください。</span><span class="sxs-lookup"><span data-stu-id="5b638-144">Specify a short validity period to minimize the risk of allowing unauthorized operations to take place against the data store.</span></span> <span data-ttu-id="5b638-145">ただし、有効期間が短すぎると、キーの有効期限が切れる前にクライアントが操作を完了できない可能性があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-145">However, if the validity period is too short, the client might not be able to complete the operation before the key expires.</span></span> <span data-ttu-id="5b638-146">保護されたリソースに対して複数のアクセスが必要な場合は、有効期間が終わる前に、承認されたユーザーがキーを更新できるようにします。</span><span class="sxs-lookup"><span data-stu-id="5b638-146">Allow authorized users to renew the key before the validity period expires if multiple accesses to the protected resource are required.</span></span>

<span data-ttu-id="5b638-147">**キーによって提供するアクセスのレベルを制御します**。</span><span class="sxs-lookup"><span data-stu-id="5b638-147">**Control the level of access the key will provide**.</span></span> <span data-ttu-id="5b638-148">通常、キーでは、クライアントがデータ ストアにデータをアップロードできてはいけない場合、読み取り専用アクセスなど、操作を完了するために必要な操作のみを実行できるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-148">Typically, the key should allow the user to only perform the actions necessary to complete the operation, such as read-only access if the client shouldn't be able to upload data to the data store.</span></span> <span data-ttu-id="5b638-149">ファイルのアップロードの場合、書き込み専用のアクセス許可を提供し、場所と有効期間を示すキーを指定するのが普通です。</span><span class="sxs-lookup"><span data-stu-id="5b638-149">For file uploads, it's common to specify a key that provides write-only permission, as well as the location and the validity period.</span></span> <span data-ttu-id="5b638-150">キーが適用されるリソースまたは一連のリソースを正確に指定することが非常に重要です。</span><span class="sxs-lookup"><span data-stu-id="5b638-150">It's critical to accurately specify the resource or the set of resources to which the key applies.</span></span>

<span data-ttu-id="5b638-151">**ユーザーの動作を制御する方法を検討します**。</span><span class="sxs-lookup"><span data-stu-id="5b638-151">**Consider how to control users’ behavior**.</span></span> <span data-ttu-id="5b638-152">このパターンを実装することは、ユーザーにアクセスが付与されたリソースに対する制御の一部が失われることを意味します。</span><span class="sxs-lookup"><span data-stu-id="5b638-152">Implementing this pattern means some loss of control over the resources users are granted access to.</span></span> <span data-ttu-id="5b638-153">用いることができる制御のレベルは、サービスまたはターゲット データ ストアで使用できるポリシーとアクセス許可の機能によって制限されます。</span><span class="sxs-lookup"><span data-stu-id="5b638-153">The level of control that can be exerted is limited by the capabilities of the policies and permissions available for the service or the target data store.</span></span> <span data-ttu-id="5b638-154">たとえば、通常、ストレージに書き込まれるデータのサイズや、ファイルにアクセスするためにキーを使用できる回数を制限するキーを作成することはできません。</span><span class="sxs-lookup"><span data-stu-id="5b638-154">For example, it's usually not possible to create a key that limits the size of the data to be written to storage, or the number of times the key can be used to access a file.</span></span> <span data-ttu-id="5b638-155">これにより、意図したクライアントによって使用された場合でもデータ転送のコストが予期せず大きくなる可能性があり、アップロードやダウンロードの繰り返しを引き起こすコードのエラーによって、これが発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-155">This can result in huge unexpected costs for data transfer, even when used by the intended client, and might be caused by an error in the code that causes repeated upload or download.</span></span> <span data-ttu-id="5b638-156">ファイルをアップロードできる回数を制限するには、可能な場合には 1 つの操作が完了した時点でそれをアプリケーションに通知するようクライアントに強制します。</span><span class="sxs-lookup"><span data-stu-id="5b638-156">To limit the number of times a file can be uploaded, where possible, force the client to notify the application when one operation has completed.</span></span> <span data-ttu-id="5b638-157">たとえば、一部のデータ ストアでは、操作を監視してユーザー動作を制御するためにアプリケーション コードで使用できるイベントが発生します。</span><span class="sxs-lookup"><span data-stu-id="5b638-157">For example, some data stores raise events the application code can use to monitor operations and control user behavior.</span></span> <span data-ttu-id="5b638-158">ただし、1 つのテナントのすべてのユーザーが同じキーを使用するマルチテナント シナリオでは、個々のユーザーにクォータを適用するのは困難です。</span><span class="sxs-lookup"><span data-stu-id="5b638-158">However, it's hard to enforce quotas for individual users in a multi-tenant scenario where the same key is used by all the users from one tenant.</span></span>

<span data-ttu-id="5b638-159">**アップロードされたすべてのデータを検証し、必要に応じて不要部分を削除します**。</span><span class="sxs-lookup"><span data-stu-id="5b638-159">**Validate, and optionally sanitize, all uploaded data**.</span></span> <span data-ttu-id="5b638-160">キーへのアクセスを取得した悪意のあるユーザーは、システムを侵害するように設計されたデータをアップロードする可能性があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-160">A malicious user that gains access to the key could upload data designed to compromise the system.</span></span> <span data-ttu-id="5b638-161">一方、承認されたユーザーが、無効で、処理されるとエラーやシステム エラーになり得るデータをアップロードする可能性もあります。</span><span class="sxs-lookup"><span data-stu-id="5b638-161">Alternatively, authorized users might upload data that's invalid and, when processed, could result in an error or system failure.</span></span> <span data-ttu-id="5b638-162">これに対する保護のため、アップロードされたすべてのデータが検証され、使用前に悪意のある内容がないかチェックされるようにします。</span><span class="sxs-lookup"><span data-stu-id="5b638-162">To protect against this, ensure that all uploaded data is validated and checked for malicious content before use.</span></span>

<span data-ttu-id="5b638-163">**すべての操作を監査します**。</span><span class="sxs-lookup"><span data-stu-id="5b638-163">**Audit all operations**.</span></span> <span data-ttu-id="5b638-164">多くのキー ベースのメカニズムは、アップロードやダウンロードなどの操作とエラーを記録できます。</span><span class="sxs-lookup"><span data-stu-id="5b638-164">Many key-based mechanisms can log operations such as uploads, downloads, and failures.</span></span> <span data-ttu-id="5b638-165">これらのログは通常、監査プロセスに組み込むことができ、ユーザーがファイル サイズやデータ量に基づいて課金される場合は課金にも使用できます。</span><span class="sxs-lookup"><span data-stu-id="5b638-165">These logs can usually be incorporated into an audit process, and also used for billing if the user is charged based on file size or data volume.</span></span> <span data-ttu-id="5b638-166">このログを使用して、キー プロバイダーの問題や、保存されたアクセス ポリシーの偶発的削除によって発生する可能性がある認証エラーを検出します。</span><span class="sxs-lookup"><span data-stu-id="5b638-166">Use the logs to detect authentication failures that might be caused by issues with the key provider, or accidental removal of a stored access policy.</span></span>

<span data-ttu-id="5b638-167">**キーを安全に配信します**。</span><span class="sxs-lookup"><span data-stu-id="5b638-167">**Deliver the key securely**.</span></span> <span data-ttu-id="5b638-168">ユーザーが Web ページでアクティブにする URL に埋め込むことも、ダウンロードが自動的に発生するようにサーバーのリダイレクト操作で使用することもできます。</span><span class="sxs-lookup"><span data-stu-id="5b638-168">It can be embedded in a URL that the user activates in a web page, or it can be used in a server redirection operation so that the download occurs automatically.</span></span> <span data-ttu-id="5b638-169">常に HTTPS を使用して、セキュリティで保護されたチャネルでキーを配信します。</span><span class="sxs-lookup"><span data-stu-id="5b638-169">Always use HTTPS to deliver the key over a secure channel.</span></span>

<span data-ttu-id="5b638-170">**転送中の機密データを保護します**。</span><span class="sxs-lookup"><span data-stu-id="5b638-170">**Protect sensitive data in transit**.</span></span> <span data-ttu-id="5b638-171">アプリケーション経由の機密データの配信は、通常、SSL または TLS を使用して行われ、データ ストアに直接アクセスするクライアントにはこれを強制する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-171">Sensitive data delivered through the application will usually take place using SSL or TLS, and this should be enforced for clients accessing the data store directly.</span></span>

<span data-ttu-id="5b638-172">このパターンの実装時に注意すべきその他の問題は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="5b638-172">Other issues to be aware of when implementing this pattern are:</span></span>

- <span data-ttu-id="5b638-173">クライアントが、操作の完了をサーバーに通知しない、またはできない場合、唯一の制限はキーの有効期限であり、アプリケーションはアップロードやダウンロードの回数をカウントしたり、複数のアップロードやダウンロードを防止したりするなどの監査操作を実行できなくなります。</span><span class="sxs-lookup"><span data-stu-id="5b638-173">If the client doesn't, or can't, notify the server of completion of the operation, and the only limit is the expiration period of the key, the application won't be able to perform auditing operations such as counting the number of uploads or downloads, or preventing multiple uploads or downloads.</span></span>

- <span data-ttu-id="5b638-174">生成できるキーのポリシーの柔軟性が限られる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-174">The flexibility of key policies that can be generated might be limited.</span></span> <span data-ttu-id="5b638-175">たとえば、一部のメカニズムでは、時間を指定した有効期間のみを使用できます。</span><span class="sxs-lookup"><span data-stu-id="5b638-175">For example, some mechanisms only allow the use of a timed expiration period.</span></span> <span data-ttu-id="5b638-176">他のメカニズムでは、十分な細分性の読み取り/書き込みアクセス許可を指定することができません。</span><span class="sxs-lookup"><span data-stu-id="5b638-176">Others aren't able to specify a sufficient granularity of read/write permissions.</span></span>

- <span data-ttu-id="5b638-177">キーやトークンの有効期間の開始時刻を指定する場合は、クライアントの時計が少し同期していなくてもよいように、現在のサーバー時刻よりも少し前であるようにします。</span><span class="sxs-lookup"><span data-stu-id="5b638-177">If the start time for the key or token validity period is specified, ensure that it's a little earlier than the current server time to allow for client clocks that might be slightly out of synchronization.</span></span> <span data-ttu-id="5b638-178">指定しない場合の既定値は、通常、現在のサーバー時刻です。</span><span class="sxs-lookup"><span data-stu-id="5b638-178">The default, if not specified, is usually the current server time.</span></span>

- <span data-ttu-id="5b638-179">キーを含む URL はサーバーのログ ファイルに記録されます。</span><span class="sxs-lookup"><span data-stu-id="5b638-179">The URL containing the key will be recorded in server log files.</span></span> <span data-ttu-id="5b638-180">キーは通常、ログ ファイルが分析のために使用される前に有効期限が切れますが、ログ ファイルへのアクセスを確実に制限してください。</span><span class="sxs-lookup"><span data-stu-id="5b638-180">While the key will typically have expired before the log files are used for analysis, ensure that you limit access to them.</span></span> <span data-ttu-id="5b638-181">ログ データが監視システムに送信されたり別の場所に保存されたりする場合は、キーの漏えいを防ぐため、有効期間が切れる後までの待機時間を実装することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="5b638-181">If log data is transmitted to a monitoring system or stored in another location, consider implementing a delay to prevent leakage of keys until after their validity period has expired.</span></span>

- <span data-ttu-id="5b638-182">クライアント コードが Web ブラウザーで実行される場合、Web ブラウザー内で実行されるコードを有効にしてページを提供するものとは異なるドメイン内のデータにアクセスするため、ブラウザーがクロス オリジン リソース共有 (CORS) サポートしている必要がある場合もあります。</span><span class="sxs-lookup"><span data-stu-id="5b638-182">If the client code runs in a web browser, the browser might need to support cross-origin resource sharing (CORS) to enable code that executes within the web browser to access data in a different domain from the one that served the page.</span></span> <span data-ttu-id="5b638-183">古いブラウザーやデータ ストアには CORS をサポートしないものがあり、これらのブラウザーで実行するコードでは、バレット キーを使用して、クラウド ストレージ アカウントなど、別のドメイン内のデータへのアクセスを提供できる場合があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-183">Some older browsers and some data stores don't support CORS, and code that runs in these browsers might be able to use a valet key to provide access to data in a different domain, such as a cloud storage account.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="5b638-184">このパターンを使用する状況</span><span class="sxs-lookup"><span data-stu-id="5b638-184">When to use this pattern</span></span>

<span data-ttu-id="5b638-185">このパターンは次の状況で役立ちます。</span><span class="sxs-lookup"><span data-stu-id="5b638-185">This pattern is useful for the following situations:</span></span>

- <span data-ttu-id="5b638-186">リソースの読み込みを最小限にして、パフォーマンスとスケーラビリティを最大化する場合。</span><span class="sxs-lookup"><span data-stu-id="5b638-186">To minimize resource loading and maximize performance and scalability.</span></span> <span data-ttu-id="5b638-187">リソースをロックする必要がないバレット キーを使用すると、リモート サーバーの呼び出しが不要です。発行できるバレット キーの数に制限はありません。また、アプリケーションを介したデータ転送を実行することで生じる単一障害点が回避されます。</span><span class="sxs-lookup"><span data-stu-id="5b638-187">Using a valet key doesn't require the resource to be locked, no remote server call is required, there's no limit on the number of valet keys that can be issued, and it avoids a single point of failure resulting from performing the data transfer through the application code.</span></span> <span data-ttu-id="5b638-188">バレット キーの作成は、通常、キーを含む文字列を署名する単純な暗号操作です。</span><span class="sxs-lookup"><span data-stu-id="5b638-188">Creating a valet key is typically a simple cryptographic operation of signing a string with a key.</span></span>

- <span data-ttu-id="5b638-189">運用コストを最小限に抑える場合。</span><span class="sxs-lookup"><span data-stu-id="5b638-189">To minimize operational cost.</span></span> <span data-ttu-id="5b638-190">ストアとキューへの直接アクセスを有効にすることは、リソースとコストの面で効率的であり、ネットワーク ラウンド トリップの数が減少する結果になる可能性があります。また、必要な計算リソースの数を削減できる場合もあります。</span><span class="sxs-lookup"><span data-stu-id="5b638-190">Enabling direct access to stores and queues is resource and cost efficient, can result in fewer network round trips, and might allow for a reduction in the number of compute resources required.</span></span>

- <span data-ttu-id="5b638-191">クライアントが定期的にデータのアップロードまたはダウンロードを行う場合。特に、大容量のボリュームがある場合や、各操作に大きなファイルが含まれる場合。</span><span class="sxs-lookup"><span data-stu-id="5b638-191">When clients regularly upload or download data, particularly where there's a large volume or when each operation involves large files.</span></span>

- <span data-ttu-id="5b638-192">ホスティングの制限またはコスト上の考慮事項のために、アプリケーションで使用できる計算リソースが限られている場合。</span><span class="sxs-lookup"><span data-stu-id="5b638-192">When the application has limited compute resources available, either due to hosting limitations or cost considerations.</span></span> <span data-ttu-id="5b638-193">このシナリオでは、アプリケーションがデータ転送の処理から解放されるため、同時のデータ アップロードやダウンロードが多数ある場合はこのパターンがさらに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="5b638-193">In this scenario, the pattern is even more helpful if there are many concurrent data uploads or downloads because it relieves the application from handling the data transfer.</span></span>

- <span data-ttu-id="5b638-194">データがリモート データ ストアまたは異なるデータ センターに格納される場合。</span><span class="sxs-lookup"><span data-stu-id="5b638-194">When the data is stored in a remote data store or a different datacenter.</span></span> <span data-ttu-id="5b638-195">アプリケーションがゲートキーパーとして機能する必要がある場合、データ転送をデータ センター間やクライアントとアプリケーション間のパブリック ネットワークまたはプライベート ネットワークにわたって行い、その後アプリケーションとデータ ストアの間で行う追加の帯域幅のために料金が生じる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-195">If the application was required to act as a gatekeeper, there might be a charge for the additional bandwidth of transferring the data between datacenters, or across public or private networks between the client and the application, and then between the application and the data store.</span></span>

<span data-ttu-id="5b638-196">このパターンは、次の状況では有効でない場合があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-196">This pattern might not be useful in the following situations:</span></span>

- <span data-ttu-id="5b638-197">データが格納される前やクライアントに送信される前に、アプリケーションがデータに対していくつかのタスクを実行する必要がある場合。</span><span class="sxs-lookup"><span data-stu-id="5b638-197">If the application must perform some task on the data before it's stored or before it's sent to the client.</span></span> <span data-ttu-id="5b638-198">たとえば、アプリケーションで検証を行う、アクセスの成功をログに記録する、データに対する変換を実行する必要がある場合。</span><span class="sxs-lookup"><span data-stu-id="5b638-198">For example, if the application needs to perform validation, log access success, or execute a transformation on the data.</span></span> <span data-ttu-id="5b638-199">ただし、一部のデータ ストアやクライアントは、圧縮や圧縮解除などの単純な変換をネゴシエートして実行できます (たとえば、Web ブラウザーは通常、GZip 形式を処理できます)。</span><span class="sxs-lookup"><span data-stu-id="5b638-199">However, some data stores and clients are able to negotiate and carry out simple transformations such as compression and decompression (for example, a web browser can usually handle GZip formats).</span></span>

- <span data-ttu-id="5b638-200">既存のアプリケーションの設計により、パターンの組み込みが困難になっている場合。</span><span class="sxs-lookup"><span data-stu-id="5b638-200">If the design of an existing application makes it difficult to incorporate the pattern.</span></span> <span data-ttu-id="5b638-201">このパターンを使用するには、通常、データを送受信する場合とは異なるアーキテクチャのアプローチが必要とされます。</span><span class="sxs-lookup"><span data-stu-id="5b638-201">Using this pattern typically requires a different architectural approach for delivering and receiving data.</span></span>

- <span data-ttu-id="5b638-202">監査証跡を管理したり、データ転送操作が実行される回数を制御したりする必要があり、これらの操作を管理するためにサーバーが使用できる通知を、使用中のバレット キー メカニズムがサポートしていない場合。</span><span class="sxs-lookup"><span data-stu-id="5b638-202">If it's necessary to maintain audit trails or control the number of times a data transfer operation is executed, and the valet key mechanism in use doesn't support notifications that the server can use to manage these operations.</span></span>

- <span data-ttu-id="5b638-203">特にアップロード操作中に、データのサイズを制限することが必要な場合。</span><span class="sxs-lookup"><span data-stu-id="5b638-203">If it's necessary to limit the size of the data, especially during upload operations.</span></span> <span data-ttu-id="5b638-204">これに対しては、操作完了後にアプリケーションでデータのサイズをチェックするか、指定した期間の後またはスケジュールに従ってアップロードのサイズをチェックすることが唯一の解決策です。</span><span class="sxs-lookup"><span data-stu-id="5b638-204">The only solution to this is for the application to check the data size after the operation is complete, or check the size of uploads after a specified period or on a scheduled basis.</span></span>

## <a name="example"></a><span data-ttu-id="5b638-205">例</span><span class="sxs-lookup"><span data-stu-id="5b638-205">Example</span></span>

<span data-ttu-id="5b638-206">Azure は、BLOB、テーブル、およびキュー内のデータへのきめ細かいアクセス制御と、Service Bus のキューおよびトピックのため、Azure Storage での Shared Access Signature をサポートしています。</span><span class="sxs-lookup"><span data-stu-id="5b638-206">Azure supports shared access signatures on Azure Storage for granular access control to data in blobs, tables, and queues, and for Service Bus queues and topics.</span></span> <span data-ttu-id="5b638-207">Shared Access Signature トークンを構成し、特定のテーブル、テーブル内のキーの範囲、キュー、BLOB、または BLOB コンテナーに対する読み取り、書き込み、更新、削除などの特定のアクセス権を提供できます。</span><span class="sxs-lookup"><span data-stu-id="5b638-207">A shared access signature token can be configured to provide specific access rights such as read, write, update, and delete to a specific table; a key range within a table; a queue; a blob; or a blob container.</span></span> <span data-ttu-id="5b638-208">有効性は、指定した時間とするか、時間制限なしにすることが可能です。</span><span class="sxs-lookup"><span data-stu-id="5b638-208">The validity can be a specified time period or with no time limit.</span></span>

<span data-ttu-id="5b638-209">Azure Shared Access Signature は、テーブルや BLOB などの特定のリソースに関連付けることができる、サーバーに保存されるアクセス ポリシーもサポートしています。</span><span class="sxs-lookup"><span data-stu-id="5b638-209">Azure shared access signatures also support server-stored access policies that can be associated with a specific resource such as a table or blob.</span></span> <span data-ttu-id="5b638-210">この機能は、アプリケーションで生成される Shared Access Signature トークンと比べて制御性と柔軟性が優れていて、可能な場合には常に使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-210">This feature provides additional control and flexibility compared to application-generated shared access signature tokens, and should be used whenever possible.</span></span> <span data-ttu-id="5b638-211">サーバーに保存されたポリシーで定義されている設定は変更可能で、新しいトークンを発行する必要なくトークンに反映されますが、トークン内に定義されている設定は、新しいトークンを発行せずに変更することができません。</span><span class="sxs-lookup"><span data-stu-id="5b638-211">Settings defined in a server-stored policy can be changed and are reflected in the token without requiring a new token to be issued, but settings defined in the token can't be changed without issuing a new token.</span></span> <span data-ttu-id="5b638-212">このアプローチによって、有効期限が切れる前に有効な Shared Access Signature トークンを取り消すことも可能になっています。</span><span class="sxs-lookup"><span data-stu-id="5b638-212">This approach also makes it possible to revoke a valid shared access signature token before it's expired.</span></span>

> <span data-ttu-id="5b638-213">詳細については、MSDN の「[Introducing Table SAS (Shared Access Signature), Queue SAS and update to Blob SAS (テーブル SAS (Shared Access Signature)、キュー SAS、および BLOB SAS の更新の概要)](https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas/)」と「[Shared Access Signature の使用](/azure/storage/common/storage-dotnet-shared-access-signature-part-1)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="5b638-213">For more information see [Introducing Table SAS (Shared Access Signature), Queue SAS and update to Blob SAS](https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas/) and [Using Shared Access Signatures](/azure/storage/common/storage-dotnet-shared-access-signature-part-1) on MSDN.</span></span>

<span data-ttu-id="5b638-214">次のコードは、5 分間有効な Shared Access Signature トークンを作成する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="5b638-214">The following code shows how to create a shared access signature token that's valid for five minutes.</span></span> <span data-ttu-id="5b638-215">`GetSharedAccessReferenceForUpload` メソッドは、ファイルを Azure Blob Storage にアップロードするために使用できる Shared Access Signature トークンを返します。</span><span class="sxs-lookup"><span data-stu-id="5b638-215">The `GetSharedAccessReferenceForUpload` method returns a shared access signatures token that can be used to upload a file to Azure Blob Storage.</span></span>

```csharp
public class ValuesController : ApiController
{
  private readonly CloudStorageAccount account;
  private readonly string blobContainer;
  ...
  /// <summary>
  /// Return a limited access key that allows the caller to upload a file
  /// to this specific destination for a defined period of time.
  /// </summary>
  private StorageEntitySas GetSharedAccessReferenceForUpload(string blobName)
  {
    var blobClient = this.account.CreateCloudBlobClient();
    var container = blobClient.GetContainerReference(this.blobContainer);

    var blob = container.GetBlockBlobReference(blobName);

    var policy = new SharedAccessBlobPolicy
    {
      Permissions = SharedAccessBlobPermissions.Write,

      // Specify a start time five minutes earlier to allow for client clock skew.
      SharedAccessStartTime = DateTime.UtcNow.AddMinutes(-5),

      // Specify a validity period of five minutes starting from now.
      SharedAccessExpiryTime = DateTime.UtcNow.AddMinutes(5)
    };

    // Create the signature.
    var sas = blob.GetSharedAccessSignature(policy);

    return new StorageEntitySas
    {
      BlobUri = blob.Uri,
      Credentials = sas,
      Name = blobName
    };
  }

  public struct StorageEntitySas
  {
    public string Credentials;
    public Uri BlobUri;
    public string Name;
  }
}
```

> <span data-ttu-id="5b638-216">完全なサンプルは、[GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key) からダウンロードできる ValetKey ソリューションに収録されています。</span><span class="sxs-lookup"><span data-stu-id="5b638-216">The complete sample is available in the ValetKey solution available for download from [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key).</span></span> <span data-ttu-id="5b638-217">このソリューションの ValetKey.Web プロジェクトには、上に示した `ValuesController` クラスを含む Web アプリケーションが含まれています。</span><span class="sxs-lookup"><span data-stu-id="5b638-217">The ValetKey.Web project in this solution contains a web application that includes the `ValuesController` class shown above.</span></span> <span data-ttu-id="5b638-218">この Web アプリケーションを使用して Shared Access Signature キーを取得し、ファイルを BLOB ストレージにアップロードするサンプル クライアント アプリケーションは、ValetKey.Client プロジェクトに収録されています。</span><span class="sxs-lookup"><span data-stu-id="5b638-218">A sample client application that uses this web application to retrieve a shared access signatures key and upload a file to blob storage is available in the ValetKey.Client project.</span></span>

## <a name="next-steps"></a><span data-ttu-id="5b638-219">次の手順</span><span class="sxs-lookup"><span data-stu-id="5b638-219">Next steps</span></span>

<span data-ttu-id="5b638-220">このパターンを実装する場合は、次のパターンとガイダンスも関連している可能性があります。</span><span class="sxs-lookup"><span data-stu-id="5b638-220">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="5b638-221">このパターンを示すサンプルは [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key) から入手できます。</span><span class="sxs-lookup"><span data-stu-id="5b638-221">A sample that demonstrates this pattern is available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key).</span></span>
- <span data-ttu-id="5b638-222">[ゲートキーパー パターン](./gatekeeper.md)。</span><span class="sxs-lookup"><span data-stu-id="5b638-222">[Gatekeeper pattern](./gatekeeper.md).</span></span> <span data-ttu-id="5b638-223">このパターンはバレット キー パターンと併用し、クライアントとアプリケーションまたはサービスの間でブローカーとして機能する専用のホスト インスタンスを使用してアプリケーションとサービスを保護できます。</span><span class="sxs-lookup"><span data-stu-id="5b638-223">This pattern can be used in conjunction with the Valet Key pattern to protect applications and services by using a dedicated host instance that acts as a broker between clients and the application or service.</span></span> <span data-ttu-id="5b638-224">ゲートキーパーは、要求を検証して不要部分を削除し、クライアントとアプリケーションの間で要求とデータを渡します。</span><span class="sxs-lookup"><span data-stu-id="5b638-224">The gatekeeper validates and sanitizes requests, and passes requests and data between the client and the application.</span></span> <span data-ttu-id="5b638-225">セキュリティの追加の層を提供し、システムの攻撃対象領域を減らすことができます。</span><span class="sxs-lookup"><span data-stu-id="5b638-225">Can provide an additional layer of security, and reduce the attack surface of the system.</span></span>
- <span data-ttu-id="5b638-226">[静的コンテンツ ホスティング パターン](./static-content-hosting.md)。</span><span class="sxs-lookup"><span data-stu-id="5b638-226">[Static Content Hosting pattern](./static-content-hosting.md).</span></span> <span data-ttu-id="5b638-227">高価なコンピューティング インスタンスの要件を低減するするため、これらのリソースをクライアントに直接提供できるクラウド ベースのストレージ サービスに静的リソースをデプロイする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="5b638-227">Describes how to deploy static resources to a cloud-based storage service that can deliver these resources directly to the client to reduce the requirement for expensive compute instances.</span></span> <span data-ttu-id="5b638-228">リソースを一般に公開する予定がない場合は、バレット キー パターンを使用してそれらを保護できます。</span><span class="sxs-lookup"><span data-stu-id="5b638-228">Where the resources aren't intended to be publicly available, the Valet Key pattern can be used to secure them.</span></span>
- [<span data-ttu-id="5b638-229">Introducing Table SAS (Shared Access Signature), Queue SAS and update to Blob SAS (テーブル SAS (Shared Access Signature)、キュー SAS、および BLOB SAS の更新の概要)</span><span class="sxs-lookup"><span data-stu-id="5b638-229">Introducing Table SAS (Shared Access Signature), Queue SAS and update to Blob SAS</span></span>](https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas/)
- [<span data-ttu-id="5b638-230">Shared Access Signatures の使用</span><span class="sxs-lookup"><span data-stu-id="5b638-230">Using Shared Access Signatures</span></span>](/azure/storage/common/storage-dotnet-shared-access-signature-part-1)
- [<span data-ttu-id="5b638-231">Service Bus による Shared Access Signature 認証</span><span class="sxs-lookup"><span data-stu-id="5b638-231">Shared Access Signature Authentication with Service Bus</span></span>](/azure/service-bus-messaging/service-bus-sas)
